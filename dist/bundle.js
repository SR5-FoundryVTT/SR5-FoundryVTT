(()=>{var al=Object.defineProperty,rl=Object.defineProperties;var il=Object.getOwnPropertyDescriptors;var nn=Object.getOwnPropertySymbols,nl=Object.getPrototypeOf,sl=Object.prototype.hasOwnProperty,ol=Object.prototype.propertyIsEnumerable,ll=Reflect.get;var Ii=(n,e,t)=>e in n?al(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,J=(n,e)=>{for(var t in e||(e={}))sl.call(e,t)&&Ii(n,t,e[t]);if(nn)for(var t of nn(e))ol.call(e,t)&&Ii(n,t,e[t]);return n},ut=(n,e)=>rl(n,il(e));var Q=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var ge=(n,e,t)=>(Ii(n,typeof e!="symbol"?e+"":e,t),t);var Y=(n,e,t)=>ll(nl(n),t,e);var u=(n,e,t)=>new Promise((a,r)=>{var i=l=>{try{o(t.next(l))}catch(c){r(c)}},s=l=>{try{o(t.throw(l))}catch(c){r(c)}},o=l=>l.done?a(l.value):Promise.resolve(l.value).then(i,s);o((t=t.apply(n,e)).next())});var ar=Q(Mi=>{(function(){Mi.defaults={"0.1":{explicitCharkey:!1,trim:!0,normalize:!0,normalizeTags:!1,attrkey:"@",charkey:"#",explicitArray:!1,ignoreAttrs:!1,mergeAttrs:!1,explicitRoot:!1,validator:null,xmlns:!1,explicitChildren:!1,childkey:"@@",charsAsChildren:!1,includeWhiteChars:!1,async:!1,strict:!0,attrNameProcessors:null,attrValueProcessors:null,tagNameProcessors:null,valueProcessors:null,emptyTag:""},"0.2":{explicitCharkey:!1,trim:!1,normalize:!1,normalizeTags:!1,attrkey:"$",charkey:"_",explicitArray:!0,ignoreAttrs:!1,mergeAttrs:!1,explicitRoot:!0,validator:null,xmlns:!1,explicitChildren:!1,preserveChildrenOrder:!1,childkey:"$$",charsAsChildren:!1,includeWhiteChars:!1,async:!1,strict:!0,attrNameProcessors:null,attrValueProcessors:null,tagNameProcessors:null,valueProcessors:null,rootName:"root",xmldec:{version:"1.0",encoding:"UTF-8",standalone:!0},doctype:null,renderOpts:{pretty:!0,indent:"  ",newline:`
`},headless:!1,chunkSize:1e4,emptyTag:"",cdata:!1}}}).call(Mi)});var oe=Q((Rn,Re)=>{(function(){var n,e,t,a,r,i,s,o=[].slice,l={}.hasOwnProperty;n=function(){var c,d,p,g,y,S;if(S=arguments[0],y=2<=arguments.length?o.call(arguments,1):[],r(Object.assign))Object.assign.apply(null,arguments);else for(c=0,p=y.length;c<p;c++)if(g=y[c],g!=null)for(d in g)!l.call(g,d)||(S[d]=g[d]);return S},r=function(c){return!!c&&Object.prototype.toString.call(c)==="[object Function]"},i=function(c){var d;return!!c&&((d=typeof c)=="function"||d==="object")},t=function(c){return r(Array.isArray)?Array.isArray(c):Object.prototype.toString.call(c)==="[object Array]"},a=function(c){var d;if(t(c))return!c.length;for(d in c)if(!!l.call(c,d))return!1;return!0},s=function(c){var d,p;return i(c)&&(p=Object.getPrototypeOf(c))&&(d=p.constructor)&&typeof d=="function"&&d instanceof d&&Function.prototype.toString.call(d)===Function.prototype.toString.call(Object)},e=function(c){return r(c.valueOf)?c.valueOf():c},Re.exports.assign=n,Re.exports.isFunction=r,Re.exports.isObject=i,Re.exports.isArray=t,Re.exports.isEmpty=a,Re.exports.isPlainObject=s,Re.exports.getValue=e}).call(Rn)});var Ei=Q((xn,Mn)=>{(function(){var n;Mn.exports=n=function(){function e(){}return e.prototype.hasFeature=function(t,a){return!0},e.prototype.createDocumentType=function(t,a,r){throw new Error("This DOM method is not implemented.")},e.prototype.createDocument=function(t,a,r){throw new Error("This DOM method is not implemented.")},e.prototype.createHTMLDocument=function(t){throw new Error("This DOM method is not implemented.")},e.prototype.getFeature=function(t,a){throw new Error("This DOM method is not implemented.")},e}()}).call(xn)});var _n=Q((En,Cn)=>{(function(){var n;Cn.exports=n=function(){function e(){}return e.prototype.handleError=function(t){throw new Error(t)},e}()}).call(En)});var Ln=Q((Pn,On)=>{(function(){var n;On.exports=n=function(){function e(t){this.arr=t||[]}return Object.defineProperty(e.prototype,"length",{get:function(){return this.arr.length}}),e.prototype.item=function(t){return this.arr[t]||null},e.prototype.contains=function(t){return this.arr.indexOf(t)!==-1},e}()}).call(Pn)});var qn=Q((Fn,Nn)=>{(function(){var n,e,t;e=_n(),t=Ln(),Nn.exports=n=function(){function a(){var r;this.defaultParams={"canonical-form":!1,"cdata-sections":!1,comments:!1,"datatype-normalization":!1,"element-content-whitespace":!0,entities:!0,"error-handler":new e,infoset:!0,"validate-if-schema":!1,namespaces:!0,"namespace-declarations":!0,"normalize-characters":!1,"schema-location":"","schema-type":"","split-cdata-sections":!0,validate:!1,"well-formed":!0},this.params=r=Object.create(this.defaultParams)}return Object.defineProperty(a.prototype,"parameterNames",{get:function(){return new t(Object.keys(this.defaultParams))}}),a.prototype.getParameter=function(r){return this.params.hasOwnProperty(r)?this.params[r]:null},a.prototype.canSetParameter=function(r,i){return!0},a.prototype.setParameter=function(r,i){return i!=null?this.params[r]=i:delete this.params[r]},a}()}).call(Fn)});var bt=Q((Bn,Vn)=>{(function(){Vn.exports={Element:1,Attribute:2,Text:3,CData:4,EntityReference:5,EntityDeclaration:6,ProcessingInstruction:7,Comment:8,Document:9,DocType:10,DocumentFragment:11,NotationDeclaration:12,Declaration:201,Raw:202,AttributeDeclaration:203,ElementDeclaration:204,Dummy:205}}).call(Bn)});var Ci=Q((Un,Hn)=>{(function(){var n,e,t;n=bt(),t=Gt(),Hn.exports=e=function(){function a(r,i,s){if(this.parent=r,this.parent&&(this.options=this.parent.options,this.stringify=this.parent.stringify),i==null)throw new Error("Missing attribute name. "+this.debugInfo(i));this.name=this.stringify.name(i),this.value=this.stringify.attValue(s),this.type=n.Attribute,this.isId=!1,this.schemaTypeInfo=null}return Object.defineProperty(a.prototype,"nodeType",{get:function(){return this.type}}),Object.defineProperty(a.prototype,"ownerElement",{get:function(){return this.parent}}),Object.defineProperty(a.prototype,"textContent",{get:function(){return this.value},set:function(r){return this.value=r||""}}),Object.defineProperty(a.prototype,"namespaceURI",{get:function(){return""}}),Object.defineProperty(a.prototype,"prefix",{get:function(){return""}}),Object.defineProperty(a.prototype,"localName",{get:function(){return this.name}}),Object.defineProperty(a.prototype,"specified",{get:function(){return!0}}),a.prototype.clone=function(){return Object.create(this)},a.prototype.toString=function(r){return this.options.writer.attribute(this,this.options.writer.filterOptions(r))},a.prototype.debugInfo=function(r){return r=r||this.name,r==null?"parent: <"+this.parent.name+">":"attribute: {"+r+"}, parent: <"+this.parent.name+">"},a.prototype.isEqualNode=function(r){return!(r.namespaceURI!==this.namespaceURI||r.prefix!==this.prefix||r.localName!==this.localName||r.value!==this.value)},a}()}).call(Un)});var rr=Q(($n,jn)=>{(function(){var n;jn.exports=n=function(){function e(t){this.nodes=t}return Object.defineProperty(e.prototype,"length",{get:function(){return Object.keys(this.nodes).length||0}}),e.prototype.clone=function(){return this.nodes=null},e.prototype.getNamedItem=function(t){return this.nodes[t]},e.prototype.setNamedItem=function(t){var a;return a=this.nodes[t.nodeName],this.nodes[t.nodeName]=t,a||null},e.prototype.removeNamedItem=function(t){var a;return a=this.nodes[t],delete this.nodes[t],a||null},e.prototype.item=function(t){return this.nodes[Object.keys(this.nodes)[t]]||null},e.prototype.getNamedItemNS=function(t,a){throw new Error("This DOM method is not implemented.")},e.prototype.setNamedItemNS=function(t){throw new Error("This DOM method is not implemented.")},e.prototype.removeNamedItemNS=function(t,a){throw new Error("This DOM method is not implemented.")},e}()}).call($n)});var ir=Q((Gn,zn)=>{(function(){var n,e,t,a,r,i,s,o,l,c=function(p,g){for(var y in g)d.call(g,y)&&(p[y]=g[y]);function S(){this.constructor=p}return S.prototype=g.prototype,p.prototype=new S,p.__super__=g.prototype,p},d={}.hasOwnProperty;l=oe(),o=l.isObject,s=l.isFunction,i=l.getValue,r=Gt(),n=bt(),e=Ci(),a=rr(),zn.exports=t=function(p){c(g,p);function g(y,S,M){var L,R,F,D;if(g.__super__.constructor.call(this,y),S==null)throw new Error("Missing element name. "+this.debugInfo());if(this.name=this.stringify.name(S),this.type=n.Element,this.attribs={},this.schemaTypeInfo=null,M!=null&&this.attribute(M),y.type===n.Document&&(this.isRoot=!0,this.documentObject=y,y.rootObject=this,y.children)){for(D=y.children,R=0,F=D.length;R<F;R++)if(L=D[R],L.type===n.DocType){L.name=this.name;break}}}return Object.defineProperty(g.prototype,"tagName",{get:function(){return this.name}}),Object.defineProperty(g.prototype,"namespaceURI",{get:function(){return""}}),Object.defineProperty(g.prototype,"prefix",{get:function(){return""}}),Object.defineProperty(g.prototype,"localName",{get:function(){return this.name}}),Object.defineProperty(g.prototype,"id",{get:function(){throw new Error("This DOM method is not implemented."+this.debugInfo())}}),Object.defineProperty(g.prototype,"className",{get:function(){throw new Error("This DOM method is not implemented."+this.debugInfo())}}),Object.defineProperty(g.prototype,"classList",{get:function(){throw new Error("This DOM method is not implemented."+this.debugInfo())}}),Object.defineProperty(g.prototype,"attributes",{get:function(){return(!this.attributeMap||!this.attributeMap.nodes)&&(this.attributeMap=new a(this.attribs)),this.attributeMap}}),g.prototype.clone=function(){var y,S,M,L;M=Object.create(this),M.isRoot&&(M.documentObject=null),M.attribs={},L=this.attribs;for(S in L)!d.call(L,S)||(y=L[S],M.attribs[S]=y.clone());return M.children=[],this.children.forEach(function(R){var F;return F=R.clone(),F.parent=M,M.children.push(F)}),M},g.prototype.attribute=function(y,S){var M,L;if(y!=null&&(y=i(y)),o(y))for(M in y)!d.call(y,M)||(L=y[M],this.attribute(M,L));else s(S)&&(S=S.apply()),this.options.keepNullAttributes&&S==null?this.attribs[y]=new e(this,y,""):S!=null&&(this.attribs[y]=new e(this,y,S));return this},g.prototype.removeAttribute=function(y){var S,M,L;if(y==null)throw new Error("Missing attribute name. "+this.debugInfo());if(y=i(y),Array.isArray(y))for(M=0,L=y.length;M<L;M++)S=y[M],delete this.attribs[S];else delete this.attribs[y];return this},g.prototype.toString=function(y){return this.options.writer.element(this,this.options.writer.filterOptions(y))},g.prototype.att=function(y,S){return this.attribute(y,S)},g.prototype.a=function(y,S){return this.attribute(y,S)},g.prototype.getAttribute=function(y){return this.attribs.hasOwnProperty(y)?this.attribs[y].value:null},g.prototype.setAttribute=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getAttributeNode=function(y){return this.attribs.hasOwnProperty(y)?this.attribs[y]:null},g.prototype.setAttributeNode=function(y){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.removeAttributeNode=function(y){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getElementsByTagName=function(y){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getAttributeNS=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.setAttributeNS=function(y,S,M){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.removeAttributeNS=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getAttributeNodeNS=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.setAttributeNodeNS=function(y){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getElementsByTagNameNS=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.hasAttribute=function(y){return this.attribs.hasOwnProperty(y)},g.prototype.hasAttributeNS=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.setIdAttribute=function(y,S){return this.attribs.hasOwnProperty(y)?this.attribs[y].isId:S},g.prototype.setIdAttributeNS=function(y,S,M){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.setIdAttributeNode=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getElementsByTagName=function(y){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getElementsByTagNameNS=function(y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.getElementsByClassName=function(y){throw new Error("This DOM method is not implemented."+this.debugInfo())},g.prototype.isEqualNode=function(y){var S,M,L;if(!g.__super__.isEqualNode.apply(this,arguments).isEqualNode(y)||y.namespaceURI!==this.namespaceURI||y.prefix!==this.prefix||y.localName!==this.localName||y.attribs.length!==this.attribs.length)return!1;for(S=M=0,L=this.attribs.length-1;0<=L?M<=L:M>=L;S=0<=L?++M:--M)if(!this.attribs[S].isEqualNode(y.attribs[S]))return!1;return!0},g}(r)}).call(Gn)});var ka=Q((Wn,Xn)=>{(function(){var n,e,t=function(r,i){for(var s in i)a.call(i,s)&&(r[s]=i[s]);function o(){this.constructor=r}return o.prototype=i.prototype,r.prototype=new o,r.__super__=i.prototype,r},a={}.hasOwnProperty;e=Gt(),Xn.exports=n=function(r){t(i,r);function i(s){i.__super__.constructor.call(this,s),this.value=""}return Object.defineProperty(i.prototype,"data",{get:function(){return this.value},set:function(s){return this.value=s||""}}),Object.defineProperty(i.prototype,"length",{get:function(){return this.value.length}}),Object.defineProperty(i.prototype,"textContent",{get:function(){return this.value},set:function(s){return this.value=s||""}}),i.prototype.clone=function(){return Object.create(this)},i.prototype.substringData=function(s,o){throw new Error("This DOM method is not implemented."+this.debugInfo())},i.prototype.appendData=function(s){throw new Error("This DOM method is not implemented."+this.debugInfo())},i.prototype.insertData=function(s,o){throw new Error("This DOM method is not implemented."+this.debugInfo())},i.prototype.deleteData=function(s,o){throw new Error("This DOM method is not implemented."+this.debugInfo())},i.prototype.replaceData=function(s,o,l){throw new Error("This DOM method is not implemented."+this.debugInfo())},i.prototype.isEqualNode=function(s){return!(!i.__super__.isEqualNode.apply(this,arguments).isEqualNode(s)||s.data!==this.data)},i}(e)}).call(Wn)});var nr=Q((Kn,Yn)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;n=bt(),t=ka(),Yn.exports=e=function(i){a(s,i);function s(o,l){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing CDATA text. "+this.debugInfo());this.name="#cdata-section",this.type=n.CData,this.value=this.stringify.cdata(l)}return s.prototype.clone=function(){return Object.create(this)},s.prototype.toString=function(o){return this.options.writer.cdata(this,this.options.writer.filterOptions(o))},s}(t)}).call(Kn)});var sr=Q((Qn,Jn)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;n=bt(),e=ka(),Jn.exports=t=function(i){a(s,i);function s(o,l){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing comment text. "+this.debugInfo());this.name="#comment",this.type=n.Comment,this.value=this.stringify.comment(l)}return s.prototype.clone=function(){return Object.create(this)},s.prototype.toString=function(o){return this.options.writer.comment(this,this.options.writer.filterOptions(o))},s}(e)}).call(Qn)});var or=Q((Zn,ts)=>{(function(){var n,e,t,a,r=function(s,o){for(var l in o)i.call(o,l)&&(s[l]=o[l]);function c(){this.constructor=s}return c.prototype=o.prototype,s.prototype=new c,s.__super__=o.prototype,s},i={}.hasOwnProperty;a=oe().isObject,t=Gt(),n=bt(),ts.exports=e=function(s){r(o,s);function o(l,c,d,p){var g;o.__super__.constructor.call(this,l),a(c)&&(g=c,c=g.version,d=g.encoding,p=g.standalone),c||(c="1.0"),this.type=n.Declaration,this.version=this.stringify.xmlVersion(c),d!=null&&(this.encoding=this.stringify.xmlEncoding(d)),p!=null&&(this.standalone=this.stringify.xmlStandalone(p))}return o.prototype.toString=function(l){return this.options.writer.declaration(this,this.options.writer.filterOptions(l))},o}(t)}).call(Zn)});var lr=Q((es,as)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;t=Gt(),n=bt(),as.exports=e=function(i){a(s,i);function s(o,l,c,d,p,g){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing DTD element name. "+this.debugInfo());if(c==null)throw new Error("Missing DTD attribute name. "+this.debugInfo(l));if(!d)throw new Error("Missing DTD attribute type. "+this.debugInfo(l));if(!p)throw new Error("Missing DTD attribute default. "+this.debugInfo(l));if(p.indexOf("#")!==0&&(p="#"+p),!p.match(/^(#REQUIRED|#IMPLIED|#FIXED|#DEFAULT)$/))throw new Error("Invalid default value type; expected: #REQUIRED, #IMPLIED, #FIXED or #DEFAULT. "+this.debugInfo(l));if(g&&!p.match(/^(#FIXED|#DEFAULT)$/))throw new Error("Default value only applies to #FIXED or #DEFAULT. "+this.debugInfo(l));this.elementName=this.stringify.name(l),this.type=n.AttributeDeclaration,this.attributeName=this.stringify.name(c),this.attributeType=this.stringify.dtdAttType(d),g&&(this.defaultValue=this.stringify.dtdAttDefault(g)),this.defaultValueType=p}return s.prototype.toString=function(o){return this.options.writer.dtdAttList(this,this.options.writer.filterOptions(o))},s}(t)}).call(es)});var cr=Q((rs,is)=>{(function(){var n,e,t,a,r=function(s,o){for(var l in o)i.call(o,l)&&(s[l]=o[l]);function c(){this.constructor=s}return c.prototype=o.prototype,s.prototype=new c,s.__super__=o.prototype,s},i={}.hasOwnProperty;a=oe().isObject,t=Gt(),n=bt(),is.exports=e=function(s){r(o,s);function o(l,c,d,p){if(o.__super__.constructor.call(this,l),d==null)throw new Error("Missing DTD entity name. "+this.debugInfo(d));if(p==null)throw new Error("Missing DTD entity value. "+this.debugInfo(d));if(this.pe=!!c,this.name=this.stringify.name(d),this.type=n.EntityDeclaration,!a(p))this.value=this.stringify.dtdEntityValue(p),this.internal=!0;else{if(!p.pubID&&!p.sysID)throw new Error("Public and/or system identifiers are required for an external entity. "+this.debugInfo(d));if(p.pubID&&!p.sysID)throw new Error("System identifier is required for a public external entity. "+this.debugInfo(d));if(this.internal=!1,p.pubID!=null&&(this.pubID=this.stringify.dtdPubID(p.pubID)),p.sysID!=null&&(this.sysID=this.stringify.dtdSysID(p.sysID)),p.nData!=null&&(this.nData=this.stringify.dtdNData(p.nData)),this.pe&&this.nData)throw new Error("Notation declaration is not allowed in a parameter entity. "+this.debugInfo(d))}}return Object.defineProperty(o.prototype,"publicId",{get:function(){return this.pubID}}),Object.defineProperty(o.prototype,"systemId",{get:function(){return this.sysID}}),Object.defineProperty(o.prototype,"notationName",{get:function(){return this.nData||null}}),Object.defineProperty(o.prototype,"inputEncoding",{get:function(){return null}}),Object.defineProperty(o.prototype,"xmlEncoding",{get:function(){return null}}),Object.defineProperty(o.prototype,"xmlVersion",{get:function(){return null}}),o.prototype.toString=function(l){return this.options.writer.dtdEntity(this,this.options.writer.filterOptions(l))},o}(t)}).call(rs)});var ur=Q((ns,ss)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;t=Gt(),n=bt(),ss.exports=e=function(i){a(s,i);function s(o,l,c){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing DTD element name. "+this.debugInfo());c||(c="(#PCDATA)"),Array.isArray(c)&&(c="("+c.join(",")+")"),this.name=this.stringify.name(l),this.type=n.ElementDeclaration,this.value=this.stringify.dtdElementValue(c)}return s.prototype.toString=function(o){return this.options.writer.dtdElement(this,this.options.writer.filterOptions(o))},s}(t)}).call(ns)});var dr=Q((os,ls)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;t=Gt(),n=bt(),ls.exports=e=function(i){a(s,i);function s(o,l,c){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing DTD notation name. "+this.debugInfo(l));if(!c.pubID&&!c.sysID)throw new Error("Public or system identifiers are required for an external entity. "+this.debugInfo(l));this.name=this.stringify.name(l),this.type=n.NotationDeclaration,c.pubID!=null&&(this.pubID=this.stringify.dtdPubID(c.pubID)),c.sysID!=null&&(this.sysID=this.stringify.dtdSysID(c.sysID))}return Object.defineProperty(s.prototype,"publicId",{get:function(){return this.pubID}}),Object.defineProperty(s.prototype,"systemId",{get:function(){return this.sysID}}),s.prototype.toString=function(o){return this.options.writer.dtdNotation(this,this.options.writer.filterOptions(o))},s}(t)}).call(os)});var mr=Q((cs,us)=>{(function(){var n,e,t,a,r,i,s,o,l,c=function(p,g){for(var y in g)d.call(g,y)&&(p[y]=g[y]);function S(){this.constructor=p}return S.prototype=g.prototype,p.prototype=new S,p.__super__=g.prototype,p},d={}.hasOwnProperty;l=oe().isObject,o=Gt(),n=bt(),e=lr(),a=cr(),t=ur(),r=dr(),s=rr(),us.exports=i=function(p){c(g,p);function g(y,S,M){var L,R,F,D,h,m;if(g.__super__.constructor.call(this,y),this.type=n.DocType,y.children){for(D=y.children,R=0,F=D.length;R<F;R++)if(L=D[R],L.type===n.Element){this.name=L.name;break}}this.documentObject=y,l(S)&&(h=S,S=h.pubID,M=h.sysID),M==null&&(m=[S,M],M=m[0],S=m[1]),S!=null&&(this.pubID=this.stringify.dtdPubID(S)),M!=null&&(this.sysID=this.stringify.dtdSysID(M))}return Object.defineProperty(g.prototype,"entities",{get:function(){var y,S,M,L,R;for(L={},R=this.children,S=0,M=R.length;S<M;S++)y=R[S],y.type===n.EntityDeclaration&&!y.pe&&(L[y.name]=y);return new s(L)}}),Object.defineProperty(g.prototype,"notations",{get:function(){var y,S,M,L,R;for(L={},R=this.children,S=0,M=R.length;S<M;S++)y=R[S],y.type===n.NotationDeclaration&&(L[y.name]=y);return new s(L)}}),Object.defineProperty(g.prototype,"publicId",{get:function(){return this.pubID}}),Object.defineProperty(g.prototype,"systemId",{get:function(){return this.sysID}}),Object.defineProperty(g.prototype,"internalSubset",{get:function(){throw new Error("This DOM method is not implemented."+this.debugInfo())}}),g.prototype.element=function(y,S){var M;return M=new t(this,y,S),this.children.push(M),this},g.prototype.attList=function(y,S,M,L,R){var F;return F=new e(this,y,S,M,L,R),this.children.push(F),this},g.prototype.entity=function(y,S){var M;return M=new a(this,!1,y,S),this.children.push(M),this},g.prototype.pEntity=function(y,S){var M;return M=new a(this,!0,y,S),this.children.push(M),this},g.prototype.notation=function(y,S){var M;return M=new r(this,y,S),this.children.push(M),this},g.prototype.toString=function(y){return this.options.writer.docType(this,this.options.writer.filterOptions(y))},g.prototype.ele=function(y,S){return this.element(y,S)},g.prototype.att=function(y,S,M,L,R){return this.attList(y,S,M,L,R)},g.prototype.ent=function(y,S){return this.entity(y,S)},g.prototype.pent=function(y,S){return this.pEntity(y,S)},g.prototype.not=function(y,S){return this.notation(y,S)},g.prototype.up=function(){return this.root()||this.documentObject},g.prototype.isEqualNode=function(y){return!(!g.__super__.isEqualNode.apply(this,arguments).isEqualNode(y)||y.name!==this.name||y.publicId!==this.publicId||y.systemId!==this.systemId)},g}(o)}).call(cs)});var pr=Q((ds,ms)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;n=bt(),e=Gt(),ms.exports=t=function(i){a(s,i);function s(o,l){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing raw text. "+this.debugInfo());this.type=n.Raw,this.value=this.stringify.raw(l)}return s.prototype.clone=function(){return Object.create(this)},s.prototype.toString=function(o){return this.options.writer.raw(this,this.options.writer.filterOptions(o))},s}(e)}).call(ds)});var fr=Q((ps,fs)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;n=bt(),e=ka(),fs.exports=t=function(i){a(s,i);function s(o,l){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing element text. "+this.debugInfo());this.name="#text",this.type=n.Text,this.value=this.stringify.text(l)}return Object.defineProperty(s.prototype,"isElementContentWhitespace",{get:function(){throw new Error("This DOM method is not implemented."+this.debugInfo())}}),Object.defineProperty(s.prototype,"wholeText",{get:function(){var o,l,c;for(c="",l=this.previousSibling;l;)c=l.data+c,l=l.previousSibling;for(c+=this.data,o=this.nextSibling;o;)c=c+o.data,o=o.nextSibling;return c}}),s.prototype.clone=function(){return Object.create(this)},s.prototype.toString=function(o){return this.options.writer.text(this,this.options.writer.filterOptions(o))},s.prototype.splitText=function(o){throw new Error("This DOM method is not implemented."+this.debugInfo())},s.prototype.replaceWholeText=function(o){throw new Error("This DOM method is not implemented."+this.debugInfo())},s}(e)}).call(ps)});var hr=Q((hs,gs)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;n=bt(),e=ka(),gs.exports=t=function(i){a(s,i);function s(o,l,c){if(s.__super__.constructor.call(this,o),l==null)throw new Error("Missing instruction target. "+this.debugInfo());this.type=n.ProcessingInstruction,this.target=this.stringify.insTarget(l),this.name=this.target,c&&(this.value=this.stringify.insValue(c))}return s.prototype.clone=function(){return Object.create(this)},s.prototype.toString=function(o){return this.options.writer.processingInstruction(this,this.options.writer.filterOptions(o))},s.prototype.isEqualNode=function(o){return!(!s.__super__.isEqualNode.apply(this,arguments).isEqualNode(o)||o.target!==this.target)},s}(e)}).call(hs)});var _i=Q((ys,bs)=>{(function(){var n,e,t,a=function(i,s){for(var o in s)r.call(s,o)&&(i[o]=s[o]);function l(){this.constructor=i}return l.prototype=s.prototype,i.prototype=new l,i.__super__=s.prototype,i},r={}.hasOwnProperty;t=Gt(),n=bt(),bs.exports=e=function(i){a(s,i);function s(o){s.__super__.constructor.call(this,o),this.type=n.Dummy}return s.prototype.clone=function(){return Object.create(this)},s.prototype.toString=function(o){return""},s}(t)}).call(ys)});var Ss=Q((ws,Ds)=>{(function(){var n;Ds.exports=n=function(){function e(t){this.nodes=t}return Object.defineProperty(e.prototype,"length",{get:function(){return this.nodes.length||0}}),e.prototype.clone=function(){return this.nodes=null},e.prototype.item=function(t){return this.nodes[t]||null},e}()}).call(ws)});var Is=Q((vs,Ts)=>{(function(){Ts.exports={Disconnected:1,Preceding:2,Following:4,Contains:8,ContainedBy:16,ImplementationSpecific:32}}).call(vs)});var Gt=Q((As,ks)=>{(function(){var n,e,t,a,r,i,s,o,l,c,d,p,g,y,S,M,L,R,F,D={}.hasOwnProperty;F=oe(),R=F.isObject,L=F.isFunction,M=F.isEmpty,S=F.getValue,o=null,t=null,a=null,r=null,i=null,g=null,y=null,p=null,s=null,e=null,d=null,l=null,n=null,ks.exports=c=function(){function h(m){this.parent=m,this.parent&&(this.options=this.parent.options,this.stringify=this.parent.stringify),this.value=null,this.children=[],this.baseURI=null,o||(o=ir(),t=nr(),a=sr(),r=or(),i=mr(),g=pr(),y=fr(),p=hr(),s=_i(),e=bt(),d=Ss(),l=rr(),n=Is())}return Object.defineProperty(h.prototype,"nodeName",{get:function(){return this.name}}),Object.defineProperty(h.prototype,"nodeType",{get:function(){return this.type}}),Object.defineProperty(h.prototype,"nodeValue",{get:function(){return this.value}}),Object.defineProperty(h.prototype,"parentNode",{get:function(){return this.parent}}),Object.defineProperty(h.prototype,"childNodes",{get:function(){return(!this.childNodeList||!this.childNodeList.nodes)&&(this.childNodeList=new d(this.children)),this.childNodeList}}),Object.defineProperty(h.prototype,"firstChild",{get:function(){return this.children[0]||null}}),Object.defineProperty(h.prototype,"lastChild",{get:function(){return this.children[this.children.length-1]||null}}),Object.defineProperty(h.prototype,"previousSibling",{get:function(){var m;return m=this.parent.children.indexOf(this),this.parent.children[m-1]||null}}),Object.defineProperty(h.prototype,"nextSibling",{get:function(){var m;return m=this.parent.children.indexOf(this),this.parent.children[m+1]||null}}),Object.defineProperty(h.prototype,"ownerDocument",{get:function(){return this.document()||null}}),Object.defineProperty(h.prototype,"textContent",{get:function(){var m,T,k,v,_;if(this.nodeType===e.Element||this.nodeType===e.DocumentFragment){for(_="",v=this.children,T=0,k=v.length;T<k;T++)m=v[T],m.textContent&&(_+=m.textContent);return _}else return null},set:function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())}}),h.prototype.setParent=function(m){var T,k,v,_,A;for(this.parent=m,m&&(this.options=m.options,this.stringify=m.stringify),_=this.children,A=[],k=0,v=_.length;k<v;k++)T=_[k],A.push(T.setParent(this));return A},h.prototype.element=function(m,T,k){var v,_,A,E,B,U,tt,ot,z,Dt,it;if(U=null,T===null&&k==null&&(z=[{},null],T=z[0],k=z[1]),T==null&&(T={}),T=S(T),R(T)||(Dt=[T,k],k=Dt[0],T=Dt[1]),m!=null&&(m=S(m)),Array.isArray(m))for(A=0,tt=m.length;A<tt;A++)_=m[A],U=this.element(_);else if(L(m))U=this.element(m.apply());else if(R(m)){for(B in m)if(!!D.call(m,B))if(it=m[B],L(it)&&(it=it.apply()),!this.options.ignoreDecorators&&this.stringify.convertAttKey&&B.indexOf(this.stringify.convertAttKey)===0)U=this.attribute(B.substr(this.stringify.convertAttKey.length),it);else if(!this.options.separateArrayItems&&Array.isArray(it)&&M(it))U=this.dummy();else if(R(it)&&M(it))U=this.element(B);else if(!this.options.keepNullNodes&&it==null)U=this.dummy();else if(!this.options.separateArrayItems&&Array.isArray(it))for(E=0,ot=it.length;E<ot;E++)_=it[E],v={},v[B]=_,U=this.element(v);else R(it)?!this.options.ignoreDecorators&&this.stringify.convertTextKey&&B.indexOf(this.stringify.convertTextKey)===0?U=this.element(it):(U=this.element(B),U.element(it)):U=this.element(B,it)}else!this.options.keepNullNodes&&k===null?U=this.dummy():!this.options.ignoreDecorators&&this.stringify.convertTextKey&&m.indexOf(this.stringify.convertTextKey)===0?U=this.text(k):!this.options.ignoreDecorators&&this.stringify.convertCDataKey&&m.indexOf(this.stringify.convertCDataKey)===0?U=this.cdata(k):!this.options.ignoreDecorators&&this.stringify.convertCommentKey&&m.indexOf(this.stringify.convertCommentKey)===0?U=this.comment(k):!this.options.ignoreDecorators&&this.stringify.convertRawKey&&m.indexOf(this.stringify.convertRawKey)===0?U=this.raw(k):!this.options.ignoreDecorators&&this.stringify.convertPIKey&&m.indexOf(this.stringify.convertPIKey)===0?U=this.instruction(m.substr(this.stringify.convertPIKey.length),k):U=this.node(m,T,k);if(U==null)throw new Error("Could not create any elements with: "+m+". "+this.debugInfo());return U},h.prototype.insertBefore=function(m,T,k){var v,_,A,E,B;if(m?.type)return A=m,E=T,A.setParent(this),E?(_=children.indexOf(E),B=children.splice(_),children.push(A),Array.prototype.push.apply(children,B)):children.push(A),A;if(this.isRoot)throw new Error("Cannot insert elements at root level. "+this.debugInfo(m));return _=this.parent.children.indexOf(this),B=this.parent.children.splice(_),v=this.parent.element(m,T,k),Array.prototype.push.apply(this.parent.children,B),v},h.prototype.insertAfter=function(m,T,k){var v,_,A;if(this.isRoot)throw new Error("Cannot insert elements at root level. "+this.debugInfo(m));return _=this.parent.children.indexOf(this),A=this.parent.children.splice(_+1),v=this.parent.element(m,T,k),Array.prototype.push.apply(this.parent.children,A),v},h.prototype.remove=function(){var m,T;if(this.isRoot)throw new Error("Cannot remove the root element. "+this.debugInfo());return m=this.parent.children.indexOf(this),[].splice.apply(this.parent.children,[m,m-m+1].concat(T=[])),this.parent},h.prototype.node=function(m,T,k){var v,_;return m!=null&&(m=S(m)),T||(T={}),T=S(T),R(T)||(_=[T,k],k=_[0],T=_[1]),v=new o(this,m,T),k!=null&&v.text(k),this.children.push(v),v},h.prototype.text=function(m){var T;return R(m)&&this.element(m),T=new y(this,m),this.children.push(T),this},h.prototype.cdata=function(m){var T;return T=new t(this,m),this.children.push(T),this},h.prototype.comment=function(m){var T;return T=new a(this,m),this.children.push(T),this},h.prototype.commentBefore=function(m){var T,k,v;return k=this.parent.children.indexOf(this),v=this.parent.children.splice(k),T=this.parent.comment(m),Array.prototype.push.apply(this.parent.children,v),this},h.prototype.commentAfter=function(m){var T,k,v;return k=this.parent.children.indexOf(this),v=this.parent.children.splice(k+1),T=this.parent.comment(m),Array.prototype.push.apply(this.parent.children,v),this},h.prototype.raw=function(m){var T;return T=new g(this,m),this.children.push(T),this},h.prototype.dummy=function(){var m;return m=new s(this),m},h.prototype.instruction=function(m,T){var k,v,_,A,E;if(m!=null&&(m=S(m)),T!=null&&(T=S(T)),Array.isArray(m))for(A=0,E=m.length;A<E;A++)k=m[A],this.instruction(k);else if(R(m))for(k in m)!D.call(m,k)||(v=m[k],this.instruction(k,v));else L(T)&&(T=T.apply()),_=new p(this,m,T),this.children.push(_);return this},h.prototype.instructionBefore=function(m,T){var k,v,_;return v=this.parent.children.indexOf(this),_=this.parent.children.splice(v),k=this.parent.instruction(m,T),Array.prototype.push.apply(this.parent.children,_),this},h.prototype.instructionAfter=function(m,T){var k,v,_;return v=this.parent.children.indexOf(this),_=this.parent.children.splice(v+1),k=this.parent.instruction(m,T),Array.prototype.push.apply(this.parent.children,_),this},h.prototype.declaration=function(m,T,k){var v,_;return v=this.document(),_=new r(v,m,T,k),v.children.length===0?v.children.unshift(_):v.children[0].type===e.Declaration?v.children[0]=_:v.children.unshift(_),v.root()||v},h.prototype.dtd=function(m,T){var k,v,_,A,E,B,U,tt,ot,z;for(v=this.document(),_=new i(v,m,T),ot=v.children,A=E=0,U=ot.length;E<U;A=++E)if(k=ot[A],k.type===e.DocType)return v.children[A]=_,_;for(z=v.children,A=B=0,tt=z.length;B<tt;A=++B)if(k=z[A],k.isRoot)return v.children.splice(A,0,_),_;return v.children.push(_),_},h.prototype.up=function(){if(this.isRoot)throw new Error("The root node has no parent. Use doc() if you need to get the document object.");return this.parent},h.prototype.root=function(){var m;for(m=this;m;){if(m.type===e.Document)return m.rootObject;if(m.isRoot)return m;m=m.parent}},h.prototype.document=function(){var m;for(m=this;m;){if(m.type===e.Document)return m;m=m.parent}},h.prototype.end=function(m){return this.document().end(m)},h.prototype.prev=function(){var m;if(m=this.parent.children.indexOf(this),m<1)throw new Error("Already at the first node. "+this.debugInfo());return this.parent.children[m-1]},h.prototype.next=function(){var m;if(m=this.parent.children.indexOf(this),m===-1||m===this.parent.children.length-1)throw new Error("Already at the last node. "+this.debugInfo());return this.parent.children[m+1]},h.prototype.importDocument=function(m){var T;return T=m.root().clone(),T.parent=this,T.isRoot=!1,this.children.push(T),this},h.prototype.debugInfo=function(m){var T,k;return m=m||this.name,m==null&&!((T=this.parent)!=null&&T.name)?"":m==null?"parent: <"+this.parent.name+">":(k=this.parent)!=null&&k.name?"node: <"+m+">, parent: <"+this.parent.name+">":"node: <"+m+">"},h.prototype.ele=function(m,T,k){return this.element(m,T,k)},h.prototype.nod=function(m,T,k){return this.node(m,T,k)},h.prototype.txt=function(m){return this.text(m)},h.prototype.dat=function(m){return this.cdata(m)},h.prototype.com=function(m){return this.comment(m)},h.prototype.ins=function(m,T){return this.instruction(m,T)},h.prototype.doc=function(){return this.document()},h.prototype.dec=function(m,T,k){return this.declaration(m,T,k)},h.prototype.e=function(m,T,k){return this.element(m,T,k)},h.prototype.n=function(m,T,k){return this.node(m,T,k)},h.prototype.t=function(m){return this.text(m)},h.prototype.d=function(m){return this.cdata(m)},h.prototype.c=function(m){return this.comment(m)},h.prototype.r=function(m){return this.raw(m)},h.prototype.i=function(m,T){return this.instruction(m,T)},h.prototype.u=function(){return this.up()},h.prototype.importXMLBuilder=function(m){return this.importDocument(m)},h.prototype.replaceChild=function(m,T){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.removeChild=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.appendChild=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.hasChildNodes=function(){return this.children.length!==0},h.prototype.cloneNode=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.normalize=function(){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.isSupported=function(m,T){return!0},h.prototype.hasAttributes=function(){return this.attribs.length!==0},h.prototype.compareDocumentPosition=function(m){var T,k;return T=this,T===m?0:this.document()!==m.document()?(k=n.Disconnected|n.ImplementationSpecific,Math.random()<.5?k|=n.Preceding:k|=n.Following,k):T.isAncestor(m)?n.Contains|n.Preceding:T.isDescendant(m)?n.Contains|n.Following:T.isPreceding(m)?n.Preceding:n.Following},h.prototype.isSameNode=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.lookupPrefix=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.isDefaultNamespace=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.lookupNamespaceURI=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.isEqualNode=function(m){var T,k,v;if(m.nodeType!==this.nodeType||m.children.length!==this.children.length)return!1;for(T=k=0,v=this.children.length-1;0<=v?k<=v:k>=v;T=0<=v?++k:--k)if(!this.children[T].isEqualNode(m.children[T]))return!1;return!0},h.prototype.getFeature=function(m,T){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.setUserData=function(m,T,k){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.getUserData=function(m){throw new Error("This DOM method is not implemented."+this.debugInfo())},h.prototype.contains=function(m){return m?m===this||this.isDescendant(m):!1},h.prototype.isDescendant=function(m){var T,k,v,_,A;for(A=this.children,v=0,_=A.length;v<_;v++)if(T=A[v],m===T||(k=T.isDescendant(m),k))return!0;return!1},h.prototype.isAncestor=function(m){return m.isDescendant(this)},h.prototype.isPreceding=function(m){var T,k;return T=this.treePosition(m),k=this.treePosition(this),T===-1||k===-1?!1:T<k},h.prototype.isFollowing=function(m){var T,k;return T=this.treePosition(m),k=this.treePosition(this),T===-1||k===-1?!1:T>k},h.prototype.treePosition=function(m){var T,k;return k=0,T=!1,this.foreachTreeNode(this.document(),function(v){if(k++,!T&&v===m)return T=!0}),T?k:-1},h.prototype.foreachTreeNode=function(m,T){var k,v,_,A,E;for(m||(m=this.document()),A=m.children,v=0,_=A.length;v<_;v++){if(k=A[v],E=T(k))return E;if(E=this.foreachTreeNode(k,T),E)return E}},h}()}).call(As)});var Pi=Q((Rs,xs)=>{(function(){var n,e=function(a,r){return function(){return a.apply(r,arguments)}},t={}.hasOwnProperty;xs.exports=n=function(){function a(r){this.assertLegalName=e(this.assertLegalName,this),this.assertLegalChar=e(this.assertLegalChar,this);var i,s,o;r||(r={}),this.options=r,this.options.version||(this.options.version="1.0"),s=r.stringify||{};for(i in s)!t.call(s,i)||(o=s[i],this[i]=o)}return a.prototype.name=function(r){return this.options.noValidation?r:this.assertLegalName(""+r||"")},a.prototype.text=function(r){return this.options.noValidation?r:this.assertLegalChar(this.textEscape(""+r||""))},a.prototype.cdata=function(r){return this.options.noValidation?r:(r=""+r||"",r=r.replace("]]>","]]]]><![CDATA[>"),this.assertLegalChar(r))},a.prototype.comment=function(r){if(this.options.noValidation)return r;if(r=""+r||"",r.match(/--/))throw new Error("Comment text cannot contain double-hypen: "+r);return this.assertLegalChar(r)},a.prototype.raw=function(r){return this.options.noValidation?r:""+r||""},a.prototype.attValue=function(r){return this.options.noValidation?r:this.assertLegalChar(this.attEscape(r=""+r||""))},a.prototype.insTarget=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.insValue=function(r){if(this.options.noValidation)return r;if(r=""+r||"",r.match(/\?>/))throw new Error("Invalid processing instruction value: "+r);return this.assertLegalChar(r)},a.prototype.xmlVersion=function(r){if(this.options.noValidation)return r;if(r=""+r||"",!r.match(/1\.[0-9]+/))throw new Error("Invalid version number: "+r);return r},a.prototype.xmlEncoding=function(r){if(this.options.noValidation)return r;if(r=""+r||"",!r.match(/^[A-Za-z](?:[A-Za-z0-9._-])*$/))throw new Error("Invalid encoding: "+r);return this.assertLegalChar(r)},a.prototype.xmlStandalone=function(r){return this.options.noValidation?r:r?"yes":"no"},a.prototype.dtdPubID=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.dtdSysID=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.dtdElementValue=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.dtdAttType=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.dtdAttDefault=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.dtdEntityValue=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.dtdNData=function(r){return this.options.noValidation?r:this.assertLegalChar(""+r||"")},a.prototype.convertAttKey="@",a.prototype.convertPIKey="?",a.prototype.convertTextKey="#text",a.prototype.convertCDataKey="#cdata",a.prototype.convertCommentKey="#comment",a.prototype.convertRawKey="#raw",a.prototype.assertLegalChar=function(r){var i,s;if(this.options.noValidation)return r;if(i="",this.options.version==="1.0"){if(i=/[\0-\x08\x0B\f\x0E-\x1F\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,s=r.match(i))throw new Error("Invalid character in string: "+r+" at index "+s.index)}else if(this.options.version==="1.1"&&(i=/[\0\uFFFE\uFFFF]|[\uD800-\uDBFF](?![\uDC00-\uDFFF])|(?:[^\uD800-\uDBFF]|^)[\uDC00-\uDFFF]/,s=r.match(i)))throw new Error("Invalid character in string: "+r+" at index "+s.index);return r},a.prototype.assertLegalName=function(r){var i;if(this.options.noValidation)return r;if(this.assertLegalChar(r),i=/^([:A-Z_a-z\xC0-\xD6\xD8-\xF6\xF8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])([\x2D\.0-:A-Z_a-z\xB7\xC0-\xD6\xD8-\xF6\xF8-\u037D\u037F-\u1FFF\u200C\u200D\u203F\u2040\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]|[\uD800-\uDB7F][\uDC00-\uDFFF])*$/,!r.match(i))throw new Error("Invalid character in name");return r},a.prototype.textEscape=function(r){var i;return this.options.noValidation?r:(i=this.options.noDoubleEncoding?/(?!&\S+;)&/g:/&/g,r.replace(i,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\r/g,"&#xD;"))},a.prototype.attEscape=function(r){var i;return this.options.noValidation?r:(i=this.options.noDoubleEncoding?/(?!&\S+;)&/g:/&/g,r.replace(i,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/\t/g,"&#x9;").replace(/\n/g,"&#xA;").replace(/\r/g,"&#xD;"))},a}()}).call(Rs)});var Ra=Q((Ms,Es)=>{(function(){Es.exports={None:0,OpenTag:1,InsideTag:2,CloseTag:3}}).call(Ms)});var Oi=Q((Cs,_s)=>{(function(){var n,e,t,a,r,i,s,o,l,c,d,p,g,y,S,M,L,R={}.hasOwnProperty;L=oe().assign,n=bt(),l=or(),c=mr(),t=nr(),a=sr(),p=ir(),y=pr(),S=fr(),g=hr(),d=_i(),r=lr(),i=ur(),s=cr(),o=dr(),e=Ra(),_s.exports=M=function(){function F(D){var h,m,T;D||(D={}),this.options=D,m=D.writer||{};for(h in m)!R.call(m,h)||(T=m[h],this["_"+h]=this[h],this[h]=T)}return F.prototype.filterOptions=function(D){var h,m,T,k,v,_,A,E;return D||(D={}),D=L({},this.options,D),h={writer:this},h.pretty=D.pretty||!1,h.allowEmpty=D.allowEmpty||!1,h.indent=(m=D.indent)!=null?m:"  ",h.newline=(T=D.newline)!=null?T:`
`,h.offset=(k=D.offset)!=null?k:0,h.dontPrettyTextNodes=(v=(_=D.dontPrettyTextNodes)!=null?_:D.dontprettytextnodes)!=null?v:0,h.spaceBeforeSlash=(A=(E=D.spaceBeforeSlash)!=null?E:D.spacebeforeslash)!=null?A:"",h.spaceBeforeSlash===!0&&(h.spaceBeforeSlash=" "),h.suppressPrettyCount=0,h.user={},h.state=e.None,h},F.prototype.indent=function(D,h,m){var T;return!h.pretty||h.suppressPrettyCount?"":h.pretty&&(T=(m||0)+h.offset+1,T>0)?new Array(T).join(h.indent):""},F.prototype.endline=function(D,h,m){return!h.pretty||h.suppressPrettyCount?"":h.newline},F.prototype.attribute=function(D,h,m){var T;return this.openAttribute(D,h,m),T=" "+D.name+'="'+D.value+'"',this.closeAttribute(D,h,m),T},F.prototype.cdata=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<![CDATA[",h.state=e.InsideTag,T+=D.value,h.state=e.CloseTag,T+="]]>"+this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.comment=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<!-- ",h.state=e.InsideTag,T+=D.value,h.state=e.CloseTag,T+=" -->"+this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.declaration=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<?xml",h.state=e.InsideTag,T+=' version="'+D.version+'"',D.encoding!=null&&(T+=' encoding="'+D.encoding+'"'),D.standalone!=null&&(T+=' standalone="'+D.standalone+'"'),h.state=e.CloseTag,T+=h.spaceBeforeSlash+"?>",T+=this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.docType=function(D,h,m){var T,k,v,_,A;if(m||(m=0),this.openNode(D,h,m),h.state=e.OpenTag,_=this.indent(D,h,m),_+="<!DOCTYPE "+D.root().name,D.pubID&&D.sysID?_+=' PUBLIC "'+D.pubID+'" "'+D.sysID+'"':D.sysID&&(_+=' SYSTEM "'+D.sysID+'"'),D.children.length>0){for(_+=" [",_+=this.endline(D,h,m),h.state=e.InsideTag,A=D.children,k=0,v=A.length;k<v;k++)T=A[k],_+=this.writeChildNode(T,h,m+1);h.state=e.CloseTag,_+="]"}return h.state=e.CloseTag,_+=h.spaceBeforeSlash+">",_+=this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),_},F.prototype.element=function(D,h,m){var T,k,v,_,A,E,B,U,tt,ot,z,Dt,it,Fe;m||(m=0),ot=!1,z="",this.openNode(D,h,m),h.state=e.OpenTag,z+=this.indent(D,h,m)+"<"+D.name,Dt=D.attribs;for(tt in Dt)!R.call(Dt,tt)||(T=Dt[tt],z+=this.attribute(T,h,m));if(v=D.children.length,_=v===0?null:D.children[0],v===0||D.children.every(function(Zt){return(Zt.type===n.Text||Zt.type===n.Raw)&&Zt.value===""}))h.allowEmpty?(z+=">",h.state=e.CloseTag,z+="</"+D.name+">"+this.endline(D,h,m)):(h.state=e.CloseTag,z+=h.spaceBeforeSlash+"/>"+this.endline(D,h,m));else if(h.pretty&&v===1&&(_.type===n.Text||_.type===n.Raw)&&_.value!=null)z+=">",h.state=e.InsideTag,h.suppressPrettyCount++,ot=!0,z+=this.writeChildNode(_,h,m+1),h.suppressPrettyCount--,ot=!1,h.state=e.CloseTag,z+="</"+D.name+">"+this.endline(D,h,m);else{if(h.dontPrettyTextNodes){for(it=D.children,A=0,B=it.length;A<B;A++)if(k=it[A],(k.type===n.Text||k.type===n.Raw)&&k.value!=null){h.suppressPrettyCount++,ot=!0;break}}for(z+=">"+this.endline(D,h,m),h.state=e.InsideTag,Fe=D.children,E=0,U=Fe.length;E<U;E++)k=Fe[E],z+=this.writeChildNode(k,h,m+1);h.state=e.CloseTag,z+=this.indent(D,h,m)+"</"+D.name+">",ot&&h.suppressPrettyCount--,z+=this.endline(D,h,m),h.state=e.None}return this.closeNode(D,h,m),z},F.prototype.writeChildNode=function(D,h,m){switch(D.type){case n.CData:return this.cdata(D,h,m);case n.Comment:return this.comment(D,h,m);case n.Element:return this.element(D,h,m);case n.Raw:return this.raw(D,h,m);case n.Text:return this.text(D,h,m);case n.ProcessingInstruction:return this.processingInstruction(D,h,m);case n.Dummy:return"";case n.Declaration:return this.declaration(D,h,m);case n.DocType:return this.docType(D,h,m);case n.AttributeDeclaration:return this.dtdAttList(D,h,m);case n.ElementDeclaration:return this.dtdElement(D,h,m);case n.EntityDeclaration:return this.dtdEntity(D,h,m);case n.NotationDeclaration:return this.dtdNotation(D,h,m);default:throw new Error("Unknown XML node type: "+D.constructor.name)}},F.prototype.processingInstruction=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<?",h.state=e.InsideTag,T+=D.target,D.value&&(T+=" "+D.value),h.state=e.CloseTag,T+=h.spaceBeforeSlash+"?>",T+=this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.raw=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m),h.state=e.InsideTag,T+=D.value,h.state=e.CloseTag,T+=this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.text=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m),h.state=e.InsideTag,T+=D.value,h.state=e.CloseTag,T+=this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.dtdAttList=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<!ATTLIST",h.state=e.InsideTag,T+=" "+D.elementName+" "+D.attributeName+" "+D.attributeType,D.defaultValueType!=="#DEFAULT"&&(T+=" "+D.defaultValueType),D.defaultValue&&(T+=' "'+D.defaultValue+'"'),h.state=e.CloseTag,T+=h.spaceBeforeSlash+">"+this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.dtdElement=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<!ELEMENT",h.state=e.InsideTag,T+=" "+D.name+" "+D.value,h.state=e.CloseTag,T+=h.spaceBeforeSlash+">"+this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.dtdEntity=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<!ENTITY",h.state=e.InsideTag,D.pe&&(T+=" %"),T+=" "+D.name,D.value?T+=' "'+D.value+'"':(D.pubID&&D.sysID?T+=' PUBLIC "'+D.pubID+'" "'+D.sysID+'"':D.sysID&&(T+=' SYSTEM "'+D.sysID+'"'),D.nData&&(T+=" NDATA "+D.nData)),h.state=e.CloseTag,T+=h.spaceBeforeSlash+">"+this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.dtdNotation=function(D,h,m){var T;return this.openNode(D,h,m),h.state=e.OpenTag,T=this.indent(D,h,m)+"<!NOTATION",h.state=e.InsideTag,T+=" "+D.name,D.pubID&&D.sysID?T+=' PUBLIC "'+D.pubID+'" "'+D.sysID+'"':D.pubID?T+=' PUBLIC "'+D.pubID+'"':D.sysID&&(T+=' SYSTEM "'+D.sysID+'"'),h.state=e.CloseTag,T+=h.spaceBeforeSlash+">"+this.endline(D,h,m),h.state=e.None,this.closeNode(D,h,m),T},F.prototype.openNode=function(D,h,m){},F.prototype.closeNode=function(D,h,m){},F.prototype.openAttribute=function(D,h,m){},F.prototype.closeAttribute=function(D,h,m){},F}()}).call(Cs)});var gr=Q((Ps,Os)=>{(function(){var n,e,t=function(r,i){for(var s in i)a.call(i,s)&&(r[s]=i[s]);function o(){this.constructor=r}return o.prototype=i.prototype,r.prototype=new o,r.__super__=i.prototype,r},a={}.hasOwnProperty;e=Oi(),Os.exports=n=function(r){t(i,r);function i(s){i.__super__.constructor.call(this,s)}return i.prototype.document=function(s,o){var l,c,d,p,g;for(o=this.filterOptions(o),p="",g=s.children,c=0,d=g.length;c<d;c++)l=g[c],p+=this.writeChildNode(l,o,0);return o.pretty&&p.slice(-o.newline.length)===o.newline&&(p=p.slice(0,-o.newline.length)),p},i}(e)}).call(Ps)});var Li=Q((Ls,Fs)=>{(function(){var n,e,t,a,r,i,s,o,l=function(d,p){for(var g in p)c.call(p,g)&&(d[g]=p[g]);function y(){this.constructor=d}return y.prototype=p.prototype,d.prototype=new y,d.__super__=p.prototype,d},c={}.hasOwnProperty;o=oe().isPlainObject,t=Ei(),e=qn(),r=Gt(),n=bt(),s=Pi(),i=gr(),Fs.exports=a=function(d){l(p,d);function p(g){p.__super__.constructor.call(this,null),this.name="#document",this.type=n.Document,this.documentURI=null,this.domConfig=new e,g||(g={}),g.writer||(g.writer=new i),this.options=g,this.stringify=new s(g)}return Object.defineProperty(p.prototype,"implementation",{value:new t}),Object.defineProperty(p.prototype,"doctype",{get:function(){var g,y,S,M;for(M=this.children,y=0,S=M.length;y<S;y++)if(g=M[y],g.type===n.DocType)return g;return null}}),Object.defineProperty(p.prototype,"documentElement",{get:function(){return this.rootObject||null}}),Object.defineProperty(p.prototype,"inputEncoding",{get:function(){return null}}),Object.defineProperty(p.prototype,"strictErrorChecking",{get:function(){return!1}}),Object.defineProperty(p.prototype,"xmlEncoding",{get:function(){return this.children.length!==0&&this.children[0].type===n.Declaration?this.children[0].encoding:null}}),Object.defineProperty(p.prototype,"xmlStandalone",{get:function(){return this.children.length!==0&&this.children[0].type===n.Declaration?this.children[0].standalone==="yes":!1}}),Object.defineProperty(p.prototype,"xmlVersion",{get:function(){return this.children.length!==0&&this.children[0].type===n.Declaration?this.children[0].version:"1.0"}}),Object.defineProperty(p.prototype,"URL",{get:function(){return this.documentURI}}),Object.defineProperty(p.prototype,"origin",{get:function(){return null}}),Object.defineProperty(p.prototype,"compatMode",{get:function(){return null}}),Object.defineProperty(p.prototype,"characterSet",{get:function(){return null}}),Object.defineProperty(p.prototype,"contentType",{get:function(){return null}}),p.prototype.end=function(g){var y;return y={},g?o(g)&&(y=g,g=this.options.writer):g=this.options.writer,g.document(this,g.filterOptions(y))},p.prototype.toString=function(g){return this.options.writer.document(this,this.options.writer.filterOptions(g))},p.prototype.createElement=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createDocumentFragment=function(){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createTextNode=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createComment=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createCDATASection=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createProcessingInstruction=function(g,y){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createAttribute=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createEntityReference=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.getElementsByTagName=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.importNode=function(g,y){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createElementNS=function(g,y){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createAttributeNS=function(g,y){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.getElementsByTagNameNS=function(g,y){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.getElementById=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.adoptNode=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.normalizeDocument=function(){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.renameNode=function(g,y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.getElementsByClassName=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createEvent=function(g){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createRange=function(){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createNodeIterator=function(g,y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},p.prototype.createTreeWalker=function(g,y,S){throw new Error("This DOM method is not implemented."+this.debugInfo())},p}(r)}).call(Ls)});var Bs=Q((Ns,qs)=>{(function(){var n,e,t,a,r,i,s,o,l,c,d,p,g,y,S,M,L,R,F,D,h,m,T,k,v={}.hasOwnProperty;k=oe(),m=k.isObject,h=k.isFunction,T=k.isPlainObject,D=k.getValue,n=bt(),p=Li(),y=ir(),a=nr(),r=sr(),M=pr(),F=fr(),S=hr(),c=or(),d=mr(),i=lr(),o=cr(),s=ur(),l=dr(),t=Ci(),R=Pi(),L=gr(),e=Ra(),qs.exports=g=function(){function _(A,E,B){var U;this.name="?xml",this.type=n.Document,A||(A={}),U={},A.writer?T(A.writer)&&(U=A.writer,A.writer=new L):A.writer=new L,this.options=A,this.writer=A.writer,this.writerOptions=this.writer.filterOptions(U),this.stringify=new R(A),this.onDataCallback=E||function(){},this.onEndCallback=B||function(){},this.currentNode=null,this.currentLevel=-1,this.openTags={},this.documentStarted=!1,this.documentCompleted=!1,this.root=null}return _.prototype.createChildNode=function(A){var E,B,U,tt,ot,z,Dt,it;switch(A.type){case n.CData:this.cdata(A.value);break;case n.Comment:this.comment(A.value);break;case n.Element:U={},Dt=A.attribs;for(B in Dt)!v.call(Dt,B)||(E=Dt[B],U[B]=E.value);this.node(A.name,U);break;case n.Dummy:this.dummy();break;case n.Raw:this.raw(A.value);break;case n.Text:this.text(A.value);break;case n.ProcessingInstruction:this.instruction(A.target,A.value);break;default:throw new Error("This XML node type is not supported in a JS object: "+A.constructor.name)}for(it=A.children,ot=0,z=it.length;ot<z;ot++)tt=it[ot],this.createChildNode(tt),tt.type===n.Element&&this.up();return this},_.prototype.dummy=function(){return this},_.prototype.node=function(A,E,B){var U;if(A==null)throw new Error("Missing node name.");if(this.root&&this.currentLevel===-1)throw new Error("Document can only have one root node. "+this.debugInfo(A));return this.openCurrent(),A=D(A),E==null&&(E={}),E=D(E),m(E)||(U=[E,B],B=U[0],E=U[1]),this.currentNode=new y(this,A,E),this.currentNode.children=!1,this.currentLevel++,this.openTags[this.currentLevel]=this.currentNode,B!=null&&this.text(B),this},_.prototype.element=function(A,E,B){var U,tt,ot,z,Dt,it;if(this.currentNode&&this.currentNode.type===n.DocType)this.dtdElement.apply(this,arguments);else if(Array.isArray(A)||m(A)||h(A))for(z=this.options.noValidation,this.options.noValidation=!0,it=new p(this.options).element("TEMP_ROOT"),it.element(A),this.options.noValidation=z,Dt=it.children,tt=0,ot=Dt.length;tt<ot;tt++)U=Dt[tt],this.createChildNode(U),U.type===n.Element&&this.up();else this.node(A,E,B);return this},_.prototype.attribute=function(A,E){var B,U;if(!this.currentNode||this.currentNode.children)throw new Error("att() can only be used immediately after an ele() call in callback mode. "+this.debugInfo(A));if(A!=null&&(A=D(A)),m(A))for(B in A)!v.call(A,B)||(U=A[B],this.attribute(B,U));else h(E)&&(E=E.apply()),this.options.keepNullAttributes&&E==null?this.currentNode.attribs[A]=new t(this,A,""):E!=null&&(this.currentNode.attribs[A]=new t(this,A,E));return this},_.prototype.text=function(A){var E;return this.openCurrent(),E=new F(this,A),this.onData(this.writer.text(E,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.cdata=function(A){var E;return this.openCurrent(),E=new a(this,A),this.onData(this.writer.cdata(E,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.comment=function(A){var E;return this.openCurrent(),E=new r(this,A),this.onData(this.writer.comment(E,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.raw=function(A){var E;return this.openCurrent(),E=new M(this,A),this.onData(this.writer.raw(E,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.instruction=function(A,E){var B,U,tt,ot,z;if(this.openCurrent(),A!=null&&(A=D(A)),E!=null&&(E=D(E)),Array.isArray(A))for(B=0,ot=A.length;B<ot;B++)U=A[B],this.instruction(U);else if(m(A))for(U in A)!v.call(A,U)||(tt=A[U],this.instruction(U,tt));else h(E)&&(E=E.apply()),z=new S(this,A,E),this.onData(this.writer.processingInstruction(z,this.writerOptions,this.currentLevel+1),this.currentLevel+1);return this},_.prototype.declaration=function(A,E,B){var U;if(this.openCurrent(),this.documentStarted)throw new Error("declaration() must be the first node.");return U=new c(this,A,E,B),this.onData(this.writer.declaration(U,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.doctype=function(A,E,B){if(this.openCurrent(),A==null)throw new Error("Missing root node name.");if(this.root)throw new Error("dtd() must come before the root node.");return this.currentNode=new d(this,E,B),this.currentNode.rootNodeName=A,this.currentNode.children=!1,this.currentLevel++,this.openTags[this.currentLevel]=this.currentNode,this},_.prototype.dtdElement=function(A,E){var B;return this.openCurrent(),B=new s(this,A,E),this.onData(this.writer.dtdElement(B,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.attList=function(A,E,B,U,tt){var ot;return this.openCurrent(),ot=new i(this,A,E,B,U,tt),this.onData(this.writer.dtdAttList(ot,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.entity=function(A,E){var B;return this.openCurrent(),B=new o(this,!1,A,E),this.onData(this.writer.dtdEntity(B,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.pEntity=function(A,E){var B;return this.openCurrent(),B=new o(this,!0,A,E),this.onData(this.writer.dtdEntity(B,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.notation=function(A,E){var B;return this.openCurrent(),B=new l(this,A,E),this.onData(this.writer.dtdNotation(B,this.writerOptions,this.currentLevel+1),this.currentLevel+1),this},_.prototype.up=function(){if(this.currentLevel<0)throw new Error("The document node has no parent.");return this.currentNode?(this.currentNode.children?this.closeNode(this.currentNode):this.openNode(this.currentNode),this.currentNode=null):this.closeNode(this.openTags[this.currentLevel]),delete this.openTags[this.currentLevel],this.currentLevel--,this},_.prototype.end=function(){for(;this.currentLevel>=0;)this.up();return this.onEnd()},_.prototype.openCurrent=function(){if(this.currentNode)return this.currentNode.children=!0,this.openNode(this.currentNode)},_.prototype.openNode=function(A){var E,B,U,tt;if(!A.isOpen){if(!this.root&&this.currentLevel===0&&A.type===n.Element&&(this.root=A),B="",A.type===n.Element){this.writerOptions.state=e.OpenTag,B=this.writer.indent(A,this.writerOptions,this.currentLevel)+"<"+A.name,tt=A.attribs;for(U in tt)!v.call(tt,U)||(E=tt[U],B+=this.writer.attribute(E,this.writerOptions,this.currentLevel));B+=(A.children?">":"/>")+this.writer.endline(A,this.writerOptions,this.currentLevel),this.writerOptions.state=e.InsideTag}else this.writerOptions.state=e.OpenTag,B=this.writer.indent(A,this.writerOptions,this.currentLevel)+"<!DOCTYPE "+A.rootNodeName,A.pubID&&A.sysID?B+=' PUBLIC "'+A.pubID+'" "'+A.sysID+'"':A.sysID&&(B+=' SYSTEM "'+A.sysID+'"'),A.children?(B+=" [",this.writerOptions.state=e.InsideTag):(this.writerOptions.state=e.CloseTag,B+=">"),B+=this.writer.endline(A,this.writerOptions,this.currentLevel);return this.onData(B,this.currentLevel),A.isOpen=!0}},_.prototype.closeNode=function(A){var E;if(!A.isClosed)return E="",this.writerOptions.state=e.CloseTag,A.type===n.Element?E=this.writer.indent(A,this.writerOptions,this.currentLevel)+"</"+A.name+">"+this.writer.endline(A,this.writerOptions,this.currentLevel):E=this.writer.indent(A,this.writerOptions,this.currentLevel)+"]>"+this.writer.endline(A,this.writerOptions,this.currentLevel),this.writerOptions.state=e.None,this.onData(E,this.currentLevel),A.isClosed=!0},_.prototype.onData=function(A,E){return this.documentStarted=!0,this.onDataCallback(A,E+1)},_.prototype.onEnd=function(){return this.documentCompleted=!0,this.onEndCallback()},_.prototype.debugInfo=function(A){return A==null?"":"node: <"+A+">"},_.prototype.ele=function(){return this.element.apply(this,arguments)},_.prototype.nod=function(A,E,B){return this.node(A,E,B)},_.prototype.txt=function(A){return this.text(A)},_.prototype.dat=function(A){return this.cdata(A)},_.prototype.com=function(A){return this.comment(A)},_.prototype.ins=function(A,E){return this.instruction(A,E)},_.prototype.dec=function(A,E,B){return this.declaration(A,E,B)},_.prototype.dtd=function(A,E,B){return this.doctype(A,E,B)},_.prototype.e=function(A,E,B){return this.element(A,E,B)},_.prototype.n=function(A,E,B){return this.node(A,E,B)},_.prototype.t=function(A){return this.text(A)},_.prototype.d=function(A){return this.cdata(A)},_.prototype.c=function(A){return this.comment(A)},_.prototype.r=function(A){return this.raw(A)},_.prototype.i=function(A,E){return this.instruction(A,E)},_.prototype.att=function(){return this.currentNode&&this.currentNode.type===n.DocType?this.attList.apply(this,arguments):this.attribute.apply(this,arguments)},_.prototype.a=function(){return this.currentNode&&this.currentNode.type===n.DocType?this.attList.apply(this,arguments):this.attribute.apply(this,arguments)},_.prototype.ent=function(A,E){return this.entity(A,E)},_.prototype.pent=function(A,E){return this.pEntity(A,E)},_.prototype.not=function(A,E){return this.notation(A,E)},_}()}).call(Ns)});var Hs=Q((Vs,Us)=>{(function(){var n,e,t,a,r=function(s,o){for(var l in o)i.call(o,l)&&(s[l]=o[l]);function c(){this.constructor=s}return c.prototype=o.prototype,s.prototype=new c,s.__super__=o.prototype,s},i={}.hasOwnProperty;n=bt(),a=Oi(),e=Ra(),Us.exports=t=function(s){r(o,s);function o(l,c){this.stream=l,o.__super__.constructor.call(this,c)}return o.prototype.endline=function(l,c,d){return l.isLastRootNode&&c.state===e.CloseTag?"":o.__super__.endline.call(this,l,c,d)},o.prototype.document=function(l,c){var d,p,g,y,S,M,L,R,F;for(L=l.children,p=g=0,S=L.length;g<S;p=++g)d=L[p],d.isLastRootNode=p===l.children.length-1;for(c=this.filterOptions(c),R=l.children,F=[],y=0,M=R.length;y<M;y++)d=R[y],F.push(this.writeChildNode(d,c,0));return F},o.prototype.attribute=function(l,c,d){return this.stream.write(o.__super__.attribute.call(this,l,c,d))},o.prototype.cdata=function(l,c,d){return this.stream.write(o.__super__.cdata.call(this,l,c,d))},o.prototype.comment=function(l,c,d){return this.stream.write(o.__super__.comment.call(this,l,c,d))},o.prototype.declaration=function(l,c,d){return this.stream.write(o.__super__.declaration.call(this,l,c,d))},o.prototype.docType=function(l,c,d){var p,g,y,S;if(d||(d=0),this.openNode(l,c,d),c.state=e.OpenTag,this.stream.write(this.indent(l,c,d)),this.stream.write("<!DOCTYPE "+l.root().name),l.pubID&&l.sysID?this.stream.write(' PUBLIC "'+l.pubID+'" "'+l.sysID+'"'):l.sysID&&this.stream.write(' SYSTEM "'+l.sysID+'"'),l.children.length>0){for(this.stream.write(" ["),this.stream.write(this.endline(l,c,d)),c.state=e.InsideTag,S=l.children,g=0,y=S.length;g<y;g++)p=S[g],this.writeChildNode(p,c,d+1);c.state=e.CloseTag,this.stream.write("]")}return c.state=e.CloseTag,this.stream.write(c.spaceBeforeSlash+">"),this.stream.write(this.endline(l,c,d)),c.state=e.None,this.closeNode(l,c,d)},o.prototype.element=function(l,c,d){var p,g,y,S,M,L,R,F,D,h;d||(d=0),this.openNode(l,c,d),c.state=e.OpenTag,this.stream.write(this.indent(l,c,d)+"<"+l.name),D=l.attribs;for(R in D)!i.call(D,R)||(p=D[R],this.attribute(p,c,d));if(y=l.children.length,S=y===0?null:l.children[0],y===0||l.children.every(function(m){return(m.type===n.Text||m.type===n.Raw)&&m.value===""}))c.allowEmpty?(this.stream.write(">"),c.state=e.CloseTag,this.stream.write("</"+l.name+">")):(c.state=e.CloseTag,this.stream.write(c.spaceBeforeSlash+"/>"));else if(c.pretty&&y===1&&(S.type===n.Text||S.type===n.Raw)&&S.value!=null)this.stream.write(">"),c.state=e.InsideTag,c.suppressPrettyCount++,F=!0,this.writeChildNode(S,c,d+1),c.suppressPrettyCount--,F=!1,c.state=e.CloseTag,this.stream.write("</"+l.name+">");else{for(this.stream.write(">"+this.endline(l,c,d)),c.state=e.InsideTag,h=l.children,M=0,L=h.length;M<L;M++)g=h[M],this.writeChildNode(g,c,d+1);c.state=e.CloseTag,this.stream.write(this.indent(l,c,d)+"</"+l.name+">")}return this.stream.write(this.endline(l,c,d)),c.state=e.None,this.closeNode(l,c,d)},o.prototype.processingInstruction=function(l,c,d){return this.stream.write(o.__super__.processingInstruction.call(this,l,c,d))},o.prototype.raw=function(l,c,d){return this.stream.write(o.__super__.raw.call(this,l,c,d))},o.prototype.text=function(l,c,d){return this.stream.write(o.__super__.text.call(this,l,c,d))},o.prototype.dtdAttList=function(l,c,d){return this.stream.write(o.__super__.dtdAttList.call(this,l,c,d))},o.prototype.dtdElement=function(l,c,d){return this.stream.write(o.__super__.dtdElement.call(this,l,c,d))},o.prototype.dtdEntity=function(l,c,d){return this.stream.write(o.__super__.dtdEntity.call(this,l,c,d))},o.prototype.dtdNotation=function(l,c,d){return this.stream.write(o.__super__.dtdNotation.call(this,l,c,d))},o}(a)}).call(Vs)});var js=Q(($s,xe)=>{(function(){var n,e,t,a,r,i,s,o,l,c;c=oe(),o=c.assign,l=c.isFunction,t=Ei(),a=Li(),r=Bs(),s=gr(),i=Hs(),n=bt(),e=Ra(),xe.exports.create=function(d,p,g,y){var S,M;if(d==null)throw new Error("Root element needs a name.");return y=o({},p,g,y),S=new a(y),M=S.element(d),y.headless||(S.declaration(y),(y.pubID!=null||y.sysID!=null)&&S.dtd(y)),M},xe.exports.begin=function(d,p,g){var y;return l(d)&&(y=[d,p],p=y[0],g=y[1],d={}),p?new r(d,p,g):new a(d)},xe.exports.stringWriter=function(d){return new s(d)},xe.exports.streamWriter=function(d,p){return new i(d,p)},xe.exports.implementation=new t,xe.exports.nodeType=n,xe.exports.writerState=e}).call($s)});var Gs=Q(Fi=>{(function(){"use strict";var n,e,t,a,r,i={}.hasOwnProperty;n=js(),e=ar().defaults,a=function(s){return typeof s=="string"&&(s.indexOf("&")>=0||s.indexOf(">")>=0||s.indexOf("<")>=0)},r=function(s){return"<![CDATA["+t(s)+"]]>"},t=function(s){return s.replace("]]>","]]]]><![CDATA[>")},Fi.Builder=function(){function s(o){var l,c,d;this.options={},c=e["0.2"];for(l in c)!i.call(c,l)||(d=c[l],this.options[l]=d);for(l in o)!i.call(o,l)||(d=o[l],this.options[l]=d)}return s.prototype.buildObject=function(o){var l,c,d,p,g;return l=this.options.attrkey,c=this.options.charkey,Object.keys(o).length===1&&this.options.rootName===e["0.2"].rootName?(g=Object.keys(o)[0],o=o[g]):g=this.options.rootName,d=function(y){return function(S,M){var L,R,F,D,h,m;if(typeof M!="object")y.options.cdata&&a(M)?S.raw(r(M)):S.txt(M);else if(Array.isArray(M)){for(D in M)if(!!i.call(M,D)){R=M[D];for(h in R)F=R[h],S=d(S.ele(h),F).up()}}else for(h in M)if(!!i.call(M,h))if(R=M[h],h===l){if(typeof R=="object")for(L in R)m=R[L],S=S.att(L,m)}else if(h===c)y.options.cdata&&a(R)?S=S.raw(r(R)):S=S.txt(R);else if(Array.isArray(R))for(D in R)!i.call(R,D)||(F=R[D],typeof F=="string"?y.options.cdata&&a(F)?S=S.ele(h).raw(r(F)).up():S=S.ele(h,F).up():S=d(S.ele(h),F).up());else typeof R=="object"?S=d(S.ele(h),R).up():typeof R=="string"&&y.options.cdata&&a(R)?S=S.ele(h).raw(r(R)).up():(R==null&&(R=""),S=S.ele(h,R.toString()).up());return S}}(this),p=n.create(g,this.options.xmldec,this.options.doctype,{headless:this.options.headless,allowSurrogateChars:this.options.allowSurrogateChars}),d(p,o).end(this.options.renderOpts)},s}()}).call(Fi)});var Ws=Q((Sh,zs)=>{zs.exports=zt;function zt(n){if(n)return pl(n)}function pl(n){for(var e in zt.prototype)n[e]=zt.prototype[e];return n}zt.prototype.on=zt.prototype.addEventListener=function(n,e){return this._callbacks=this._callbacks||{},(this._callbacks[n]=this._callbacks[n]||[]).push(e),this};zt.prototype.once=function(n,e){var t=this;this._callbacks=this._callbacks||{};function a(){t.off(n,a),e.apply(this,arguments)}return a.fn=e,this.on(n,a),this};zt.prototype.off=zt.prototype.removeListener=zt.prototype.removeAllListeners=zt.prototype.removeEventListener=function(n,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks[n];if(!t)return this;if(arguments.length==1)return delete this._callbacks[n],this;for(var a,r=0;r<t.length;r++)if(a=t[r],a===e||a.fn===e){t.splice(r,1);break}return this};zt.prototype.emit=function(n){this._callbacks=this._callbacks||{};var e=[].slice.call(arguments,1),t=this._callbacks[n];if(t){t=t.slice(0);for(var a=0,r=t.length;a<r;++a)t[a].apply(this,e)}return this};zt.prototype.listeners=function(n){return this._callbacks=this._callbacks||{},this._callbacks[n]||[]};zt.prototype.hasListeners=function(n){return!!this.listeners(n).length}});var Ys=Q((vh,Ks)=>{var Xs=Ws();function xa(){Xs.call(this)}xa.prototype=new Xs;Ks.exports=xa;xa.Stream=xa;xa.prototype.pipe=function(n,e){var t=this;function a(d){n.writable&&n.write(d)===!1&&t.pause&&t.pause()}t.on("data",a);function r(){t.readable&&t.resume&&t.resume()}n.on("drain",r),!n._isStdio&&(!e||e.end!==!1)&&(t.on("end",s),t.on("close",o));var i=!1;function s(){i||(i=!0,n.end())}function o(){i||(i=!0,typeof n.destroy=="function"&&n.destroy())}function l(d){if(c(),!this.hasListeners("error"))throw d}t.on("error",l),n.on("error",l);function c(){t.off("data",a),n.off("drain",r),t.off("end",s),t.off("close",o),t.off("error",l),n.off("error",l),t.off("end",c),t.off("close",c),n.off("end",c),n.off("close",c)}return t.on("end",c),t.on("close",c),n.on("end",c),n.on("close",c),n.emit("pipe",t),n}});var Zs=Q(yr=>{"use strict";yr.byteLength=hl;yr.toByteArray=yl;yr.fromByteArray=Dl;var le=[],Xt=[],fl=typeof Uint8Array<"u"?Uint8Array:Array,Ni="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for($e=0,Qs=Ni.length;$e<Qs;++$e)le[$e]=Ni[$e],Xt[Ni.charCodeAt($e)]=$e;var $e,Qs;Xt["-".charCodeAt(0)]=62;Xt["_".charCodeAt(0)]=63;function Js(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var a=t===e?0:4-t%4;return[t,a]}function hl(n){var e=Js(n),t=e[0],a=e[1];return(t+a)*3/4-a}function gl(n,e,t){return(e+t)*3/4-t}function yl(n){var e,t=Js(n),a=t[0],r=t[1],i=new fl(gl(n,a,r)),s=0,o=r>0?a-4:a,l;for(l=0;l<o;l+=4)e=Xt[n.charCodeAt(l)]<<18|Xt[n.charCodeAt(l+1)]<<12|Xt[n.charCodeAt(l+2)]<<6|Xt[n.charCodeAt(l+3)],i[s++]=e>>16&255,i[s++]=e>>8&255,i[s++]=e&255;return r===2&&(e=Xt[n.charCodeAt(l)]<<2|Xt[n.charCodeAt(l+1)]>>4,i[s++]=e&255),r===1&&(e=Xt[n.charCodeAt(l)]<<10|Xt[n.charCodeAt(l+1)]<<4|Xt[n.charCodeAt(l+2)]>>2,i[s++]=e>>8&255,i[s++]=e&255),i}function bl(n){return le[n>>18&63]+le[n>>12&63]+le[n>>6&63]+le[n&63]}function wl(n,e,t){for(var a,r=[],i=e;i<t;i+=3)a=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),r.push(bl(a));return r.join("")}function Dl(n){for(var e,t=n.length,a=t%3,r=[],i=16383,s=0,o=t-a;s<o;s+=i)r.push(wl(n,s,s+i>o?o:s+i));return a===1?(e=n[t-1],r.push(le[e>>2]+le[e<<4&63]+"==")):a===2&&(e=(n[t-2]<<8)+n[t-1],r.push(le[e>>10]+le[e>>4&63]+le[e<<2&63]+"=")),r.join("")}});var to=Q(qi=>{qi.read=function(n,e,t,a,r){var i,s,o=r*8-a-1,l=(1<<o)-1,c=l>>1,d=-7,p=t?r-1:0,g=t?-1:1,y=n[e+p];for(p+=g,i=y&(1<<-d)-1,y>>=-d,d+=o;d>0;i=i*256+n[e+p],p+=g,d-=8);for(s=i&(1<<-d)-1,i>>=-d,d+=a;d>0;s=s*256+n[e+p],p+=g,d-=8);if(i===0)i=1-c;else{if(i===l)return s?NaN:(y?-1:1)*(1/0);s=s+Math.pow(2,a),i=i-c}return(y?-1:1)*s*Math.pow(2,i-a)};qi.write=function(n,e,t,a,r,i){var s,o,l,c=i*8-r-1,d=(1<<c)-1,p=d>>1,g=r===23?Math.pow(2,-24)-Math.pow(2,-77):0,y=a?0:i-1,S=a?1:-1,M=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(o=isNaN(e)?1:0,s=d):(s=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-s))<1&&(s--,l*=2),s+p>=1?e+=g/l:e+=g*Math.pow(2,1-p),e*l>=2&&(s++,l/=2),s+p>=d?(o=0,s=d):s+p>=1?(o=(e*l-1)*Math.pow(2,r),s=s+p):(o=e*Math.pow(2,p-1)*Math.pow(2,r),s=0));r>=8;n[t+y]=o&255,y+=S,o/=256,r-=8);for(s=s<<r|o,c+=r;c>0;n[t+y]=s&255,y+=S,s/=256,c-=8);n[t+y-S]|=M*128}});var bo=Q(ca=>{"use strict";var Bi=Zs(),oa=to(),eo=typeof Symbol=="function"&&typeof Symbol.for=="function"?Symbol.for("nodejs.util.inspect.custom"):null;ca.Buffer=C;ca.SlowBuffer=kl;ca.INSPECT_MAX_BYTES=50;var br=2147483647;ca.kMaxLength=br;C.TYPED_ARRAY_SUPPORT=Sl();!C.TYPED_ARRAY_SUPPORT&&typeof console<"u"&&typeof console.error=="function"&&console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support.");function Sl(){try{let n=new Uint8Array(1),e={foo:function(){return 42}};return Object.setPrototypeOf(e,Uint8Array.prototype),Object.setPrototypeOf(n,e),n.foo()===42}catch{return!1}}Object.defineProperty(C.prototype,"parent",{enumerable:!0,get:function(){if(!!C.isBuffer(this))return this.buffer}});Object.defineProperty(C.prototype,"offset",{enumerable:!0,get:function(){if(!!C.isBuffer(this))return this.byteOffset}});function be(n){if(n>br)throw new RangeError('The value "'+n+'" is invalid for option "size"');let e=new Uint8Array(n);return Object.setPrototypeOf(e,C.prototype),e}function C(n,e,t){if(typeof n=="number"){if(typeof e=="string")throw new TypeError('The "string" argument must be of type string. Received type number');return $i(n)}return no(n,e,t)}C.poolSize=8192;function no(n,e,t){if(typeof n=="string")return Tl(n,e);if(ArrayBuffer.isView(n))return Il(n);if(n==null)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n);if(ce(n,ArrayBuffer)||n&&ce(n.buffer,ArrayBuffer)||typeof SharedArrayBuffer<"u"&&(ce(n,SharedArrayBuffer)||n&&ce(n.buffer,SharedArrayBuffer)))return Ui(n,e,t);if(typeof n=="number")throw new TypeError('The "value" argument must not be of type number. Received type number');let a=n.valueOf&&n.valueOf();if(a!=null&&a!==n)return C.from(a,e,t);let r=Al(n);if(r)return r;if(typeof Symbol<"u"&&Symbol.toPrimitive!=null&&typeof n[Symbol.toPrimitive]=="function")return C.from(n[Symbol.toPrimitive]("string"),e,t);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof n)}C.from=function(n,e,t){return no(n,e,t)};Object.setPrototypeOf(C.prototype,Uint8Array.prototype);Object.setPrototypeOf(C,Uint8Array);function so(n){if(typeof n!="number")throw new TypeError('"size" argument must be of type number');if(n<0)throw new RangeError('The value "'+n+'" is invalid for option "size"')}function vl(n,e,t){return so(n),n<=0?be(n):e!==void 0?typeof t=="string"?be(n).fill(e,t):be(n).fill(e):be(n)}C.alloc=function(n,e,t){return vl(n,e,t)};function $i(n){return so(n),be(n<0?0:ji(n)|0)}C.allocUnsafe=function(n){return $i(n)};C.allocUnsafeSlow=function(n){return $i(n)};function Tl(n,e){if((typeof e!="string"||e==="")&&(e="utf8"),!C.isEncoding(e))throw new TypeError("Unknown encoding: "+e);let t=oo(n,e)|0,a=be(t),r=a.write(n,e);return r!==t&&(a=a.slice(0,r)),a}function Vi(n){let e=n.length<0?0:ji(n.length)|0,t=be(e);for(let a=0;a<e;a+=1)t[a]=n[a]&255;return t}function Il(n){if(ce(n,Uint8Array)){let e=new Uint8Array(n);return Ui(e.buffer,e.byteOffset,e.byteLength)}return Vi(n)}function Ui(n,e,t){if(e<0||n.byteLength<e)throw new RangeError('"offset" is outside of buffer bounds');if(n.byteLength<e+(t||0))throw new RangeError('"length" is outside of buffer bounds');let a;return e===void 0&&t===void 0?a=new Uint8Array(n):t===void 0?a=new Uint8Array(n,e):a=new Uint8Array(n,e,t),Object.setPrototypeOf(a,C.prototype),a}function Al(n){if(C.isBuffer(n)){let e=ji(n.length)|0,t=be(e);return t.length===0||n.copy(t,0,0,e),t}if(n.length!==void 0)return typeof n.length!="number"||zi(n.length)?be(0):Vi(n);if(n.type==="Buffer"&&Array.isArray(n.data))return Vi(n.data)}function ji(n){if(n>=br)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+br.toString(16)+" bytes");return n|0}function kl(n){return+n!=n&&(n=0),C.alloc(+n)}C.isBuffer=function(e){return e!=null&&e._isBuffer===!0&&e!==C.prototype};C.compare=function(e,t){if(ce(e,Uint8Array)&&(e=C.from(e,e.offset,e.byteLength)),ce(t,Uint8Array)&&(t=C.from(t,t.offset,t.byteLength)),!C.isBuffer(e)||!C.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;let a=e.length,r=t.length;for(let i=0,s=Math.min(a,r);i<s;++i)if(e[i]!==t[i]){a=e[i],r=t[i];break}return a<r?-1:r<a?1:0};C.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}};C.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(e.length===0)return C.alloc(0);let a;if(t===void 0)for(t=0,a=0;a<e.length;++a)t+=e[a].length;let r=C.allocUnsafe(t),i=0;for(a=0;a<e.length;++a){let s=e[a];if(ce(s,Uint8Array))i+s.length>r.length?(C.isBuffer(s)||(s=C.from(s)),s.copy(r,i)):Uint8Array.prototype.set.call(r,s,i);else if(C.isBuffer(s))s.copy(r,i);else throw new TypeError('"list" argument must be an Array of Buffers');i+=s.length}return r};function oo(n,e){if(C.isBuffer(n))return n.length;if(ArrayBuffer.isView(n)||ce(n,ArrayBuffer))return n.byteLength;if(typeof n!="string")throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof n);let t=n.length,a=arguments.length>2&&arguments[2]===!0;if(!a&&t===0)return 0;let r=!1;for(;;)switch(e){case"ascii":case"latin1":case"binary":return t;case"utf8":case"utf-8":return Hi(n).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return t*2;case"hex":return t>>>1;case"base64":return yo(n).length;default:if(r)return a?-1:Hi(n).length;e=(""+e).toLowerCase(),r=!0}}C.byteLength=oo;function Rl(n,e,t){let a=!1;if((e===void 0||e<0)&&(e=0),e>this.length||((t===void 0||t>this.length)&&(t=this.length),t<=0)||(t>>>=0,e>>>=0,t<=e))return"";for(n||(n="utf8");;)switch(n){case"hex":return Nl(this,e,t);case"utf8":case"utf-8":return co(this,e,t);case"ascii":return Ll(this,e,t);case"latin1":case"binary":return Fl(this,e,t);case"base64":return Pl(this,e,t);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ql(this,e,t);default:if(a)throw new TypeError("Unknown encoding: "+n);n=(n+"").toLowerCase(),a=!0}}C.prototype._isBuffer=!0;function je(n,e,t){let a=n[e];n[e]=n[t],n[t]=a}C.prototype.swap16=function(){let e=this.length;if(e%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(let t=0;t<e;t+=2)je(this,t,t+1);return this};C.prototype.swap32=function(){let e=this.length;if(e%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(let t=0;t<e;t+=4)je(this,t,t+3),je(this,t+1,t+2);return this};C.prototype.swap64=function(){let e=this.length;if(e%8!==0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(let t=0;t<e;t+=8)je(this,t,t+7),je(this,t+1,t+6),je(this,t+2,t+5),je(this,t+3,t+4);return this};C.prototype.toString=function(){let e=this.length;return e===0?"":arguments.length===0?co(this,0,e):Rl.apply(this,arguments)};C.prototype.toLocaleString=C.prototype.toString;C.prototype.equals=function(e){if(!C.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e?!0:C.compare(this,e)===0};C.prototype.inspect=function(){let e="",t=ca.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"};eo&&(C.prototype[eo]=C.prototype.inspect);C.prototype.compare=function(e,t,a,r,i){if(ce(e,Uint8Array)&&(e=C.from(e,e.offset,e.byteLength)),!C.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(t===void 0&&(t=0),a===void 0&&(a=e?e.length:0),r===void 0&&(r=0),i===void 0&&(i=this.length),t<0||a>e.length||r<0||i>this.length)throw new RangeError("out of range index");if(r>=i&&t>=a)return 0;if(r>=i)return-1;if(t>=a)return 1;if(t>>>=0,a>>>=0,r>>>=0,i>>>=0,this===e)return 0;let s=i-r,o=a-t,l=Math.min(s,o),c=this.slice(r,i),d=e.slice(t,a);for(let p=0;p<l;++p)if(c[p]!==d[p]){s=c[p],o=d[p];break}return s<o?-1:o<s?1:0};function lo(n,e,t,a,r){if(n.length===0)return-1;if(typeof t=="string"?(a=t,t=0):t>2147483647?t=2147483647:t<-2147483648&&(t=-2147483648),t=+t,zi(t)&&(t=r?0:n.length-1),t<0&&(t=n.length+t),t>=n.length){if(r)return-1;t=n.length-1}else if(t<0)if(r)t=0;else return-1;if(typeof e=="string"&&(e=C.from(e,a)),C.isBuffer(e))return e.length===0?-1:ao(n,e,t,a,r);if(typeof e=="number")return e=e&255,typeof Uint8Array.prototype.indexOf=="function"?r?Uint8Array.prototype.indexOf.call(n,e,t):Uint8Array.prototype.lastIndexOf.call(n,e,t):ao(n,[e],t,a,r);throw new TypeError("val must be string, number or Buffer")}function ao(n,e,t,a,r){let i=1,s=n.length,o=e.length;if(a!==void 0&&(a=String(a).toLowerCase(),a==="ucs2"||a==="ucs-2"||a==="utf16le"||a==="utf-16le")){if(n.length<2||e.length<2)return-1;i=2,s/=2,o/=2,t/=2}function l(d,p){return i===1?d[p]:d.readUInt16BE(p*i)}let c;if(r){let d=-1;for(c=t;c<s;c++)if(l(n,c)===l(e,d===-1?0:c-d)){if(d===-1&&(d=c),c-d+1===o)return d*i}else d!==-1&&(c-=c-d),d=-1}else for(t+o>s&&(t=s-o),c=t;c>=0;c--){let d=!0;for(let p=0;p<o;p++)if(l(n,c+p)!==l(e,p)){d=!1;break}if(d)return c}return-1}C.prototype.includes=function(e,t,a){return this.indexOf(e,t,a)!==-1};C.prototype.indexOf=function(e,t,a){return lo(this,e,t,a,!0)};C.prototype.lastIndexOf=function(e,t,a){return lo(this,e,t,a,!1)};function xl(n,e,t,a){t=Number(t)||0;let r=n.length-t;a?(a=Number(a),a>r&&(a=r)):a=r;let i=e.length;a>i/2&&(a=i/2);let s;for(s=0;s<a;++s){let o=parseInt(e.substr(s*2,2),16);if(zi(o))return s;n[t+s]=o}return s}function Ml(n,e,t,a){return wr(Hi(e,n.length-t),n,t,a)}function El(n,e,t,a){return wr(Hl(e),n,t,a)}function Cl(n,e,t,a){return wr(yo(e),n,t,a)}function _l(n,e,t,a){return wr($l(e,n.length-t),n,t,a)}C.prototype.write=function(e,t,a,r){if(t===void 0)r="utf8",a=this.length,t=0;else if(a===void 0&&typeof t=="string")r=t,a=this.length,t=0;else if(isFinite(t))t=t>>>0,isFinite(a)?(a=a>>>0,r===void 0&&(r="utf8")):(r=a,a=void 0);else throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");let i=this.length-t;if((a===void 0||a>i)&&(a=i),e.length>0&&(a<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");let s=!1;for(;;)switch(r){case"hex":return xl(this,e,t,a);case"utf8":case"utf-8":return Ml(this,e,t,a);case"ascii":case"latin1":case"binary":return El(this,e,t,a);case"base64":return Cl(this,e,t,a);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return _l(this,e,t,a);default:if(s)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),s=!0}};C.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};function Pl(n,e,t){return e===0&&t===n.length?Bi.fromByteArray(n):Bi.fromByteArray(n.slice(e,t))}function co(n,e,t){t=Math.min(n.length,t);let a=[],r=e;for(;r<t;){let i=n[r],s=null,o=i>239?4:i>223?3:i>191?2:1;if(r+o<=t){let l,c,d,p;switch(o){case 1:i<128&&(s=i);break;case 2:l=n[r+1],(l&192)===128&&(p=(i&31)<<6|l&63,p>127&&(s=p));break;case 3:l=n[r+1],c=n[r+2],(l&192)===128&&(c&192)===128&&(p=(i&15)<<12|(l&63)<<6|c&63,p>2047&&(p<55296||p>57343)&&(s=p));break;case 4:l=n[r+1],c=n[r+2],d=n[r+3],(l&192)===128&&(c&192)===128&&(d&192)===128&&(p=(i&15)<<18|(l&63)<<12|(c&63)<<6|d&63,p>65535&&p<1114112&&(s=p))}}s===null?(s=65533,o=1):s>65535&&(s-=65536,a.push(s>>>10&1023|55296),s=56320|s&1023),a.push(s),r+=o}return Ol(a)}var ro=4096;function Ol(n){let e=n.length;if(e<=ro)return String.fromCharCode.apply(String,n);let t="",a=0;for(;a<e;)t+=String.fromCharCode.apply(String,n.slice(a,a+=ro));return t}function Ll(n,e,t){let a="";t=Math.min(n.length,t);for(let r=e;r<t;++r)a+=String.fromCharCode(n[r]&127);return a}function Fl(n,e,t){let a="";t=Math.min(n.length,t);for(let r=e;r<t;++r)a+=String.fromCharCode(n[r]);return a}function Nl(n,e,t){let a=n.length;(!e||e<0)&&(e=0),(!t||t<0||t>a)&&(t=a);let r="";for(let i=e;i<t;++i)r+=jl[n[i]];return r}function ql(n,e,t){let a=n.slice(e,t),r="";for(let i=0;i<a.length-1;i+=2)r+=String.fromCharCode(a[i]+a[i+1]*256);return r}C.prototype.slice=function(e,t){let a=this.length;e=~~e,t=t===void 0?a:~~t,e<0?(e+=a,e<0&&(e=0)):e>a&&(e=a),t<0?(t+=a,t<0&&(t=0)):t>a&&(t=a),t<e&&(t=e);let r=this.subarray(e,t);return Object.setPrototypeOf(r,C.prototype),r};function At(n,e,t){if(n%1!==0||n<0)throw new RangeError("offset is not uint");if(n+e>t)throw new RangeError("Trying to access beyond buffer length")}C.prototype.readUintLE=C.prototype.readUIntLE=function(e,t,a){e=e>>>0,t=t>>>0,a||At(e,t,this.length);let r=this[e],i=1,s=0;for(;++s<t&&(i*=256);)r+=this[e+s]*i;return r};C.prototype.readUintBE=C.prototype.readUIntBE=function(e,t,a){e=e>>>0,t=t>>>0,a||At(e,t,this.length);let r=this[e+--t],i=1;for(;t>0&&(i*=256);)r+=this[e+--t]*i;return r};C.prototype.readUint8=C.prototype.readUInt8=function(e,t){return e=e>>>0,t||At(e,1,this.length),this[e]};C.prototype.readUint16LE=C.prototype.readUInt16LE=function(e,t){return e=e>>>0,t||At(e,2,this.length),this[e]|this[e+1]<<8};C.prototype.readUint16BE=C.prototype.readUInt16BE=function(e,t){return e=e>>>0,t||At(e,2,this.length),this[e]<<8|this[e+1]};C.prototype.readUint32LE=C.prototype.readUInt32LE=function(e,t){return e=e>>>0,t||At(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+this[e+3]*16777216};C.prototype.readUint32BE=C.prototype.readUInt32BE=function(e,t){return e=e>>>0,t||At(e,4,this.length),this[e]*16777216+(this[e+1]<<16|this[e+2]<<8|this[e+3])};C.prototype.readBigUInt64LE=Me(function(e){e=e>>>0,la(e,"offset");let t=this[e],a=this[e+7];(t===void 0||a===void 0)&&Ma(e,this.length-8);let r=t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24,i=this[++e]+this[++e]*2**8+this[++e]*2**16+a*2**24;return BigInt(r)+(BigInt(i)<<BigInt(32))});C.prototype.readBigUInt64BE=Me(function(e){e=e>>>0,la(e,"offset");let t=this[e],a=this[e+7];(t===void 0||a===void 0)&&Ma(e,this.length-8);let r=t*2**24+this[++e]*2**16+this[++e]*2**8+this[++e],i=this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+a;return(BigInt(r)<<BigInt(32))+BigInt(i)});C.prototype.readIntLE=function(e,t,a){e=e>>>0,t=t>>>0,a||At(e,t,this.length);let r=this[e],i=1,s=0;for(;++s<t&&(i*=256);)r+=this[e+s]*i;return i*=128,r>=i&&(r-=Math.pow(2,8*t)),r};C.prototype.readIntBE=function(e,t,a){e=e>>>0,t=t>>>0,a||At(e,t,this.length);let r=t,i=1,s=this[e+--r];for(;r>0&&(i*=256);)s+=this[e+--r]*i;return i*=128,s>=i&&(s-=Math.pow(2,8*t)),s};C.prototype.readInt8=function(e,t){return e=e>>>0,t||At(e,1,this.length),this[e]&128?(255-this[e]+1)*-1:this[e]};C.prototype.readInt16LE=function(e,t){e=e>>>0,t||At(e,2,this.length);let a=this[e]|this[e+1]<<8;return a&32768?a|4294901760:a};C.prototype.readInt16BE=function(e,t){e=e>>>0,t||At(e,2,this.length);let a=this[e+1]|this[e]<<8;return a&32768?a|4294901760:a};C.prototype.readInt32LE=function(e,t){return e=e>>>0,t||At(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24};C.prototype.readInt32BE=function(e,t){return e=e>>>0,t||At(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]};C.prototype.readBigInt64LE=Me(function(e){e=e>>>0,la(e,"offset");let t=this[e],a=this[e+7];(t===void 0||a===void 0)&&Ma(e,this.length-8);let r=this[e+4]+this[e+5]*2**8+this[e+6]*2**16+(a<<24);return(BigInt(r)<<BigInt(32))+BigInt(t+this[++e]*2**8+this[++e]*2**16+this[++e]*2**24)});C.prototype.readBigInt64BE=Me(function(e){e=e>>>0,la(e,"offset");let t=this[e],a=this[e+7];(t===void 0||a===void 0)&&Ma(e,this.length-8);let r=(t<<24)+this[++e]*2**16+this[++e]*2**8+this[++e];return(BigInt(r)<<BigInt(32))+BigInt(this[++e]*2**24+this[++e]*2**16+this[++e]*2**8+a)});C.prototype.readFloatLE=function(e,t){return e=e>>>0,t||At(e,4,this.length),oa.read(this,e,!0,23,4)};C.prototype.readFloatBE=function(e,t){return e=e>>>0,t||At(e,4,this.length),oa.read(this,e,!1,23,4)};C.prototype.readDoubleLE=function(e,t){return e=e>>>0,t||At(e,8,this.length),oa.read(this,e,!0,52,8)};C.prototype.readDoubleBE=function(e,t){return e=e>>>0,t||At(e,8,this.length),oa.read(this,e,!1,52,8)};function Vt(n,e,t,a,r,i){if(!C.isBuffer(n))throw new TypeError('"buffer" argument must be a Buffer instance');if(e>r||e<i)throw new RangeError('"value" argument is out of bounds');if(t+a>n.length)throw new RangeError("Index out of range")}C.prototype.writeUintLE=C.prototype.writeUIntLE=function(e,t,a,r){if(e=+e,t=t>>>0,a=a>>>0,!r){let o=Math.pow(2,8*a)-1;Vt(this,e,t,a,o,0)}let i=1,s=0;for(this[t]=e&255;++s<a&&(i*=256);)this[t+s]=e/i&255;return t+a};C.prototype.writeUintBE=C.prototype.writeUIntBE=function(e,t,a,r){if(e=+e,t=t>>>0,a=a>>>0,!r){let o=Math.pow(2,8*a)-1;Vt(this,e,t,a,o,0)}let i=a-1,s=1;for(this[t+i]=e&255;--i>=0&&(s*=256);)this[t+i]=e/s&255;return t+a};C.prototype.writeUint8=C.prototype.writeUInt8=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,1,255,0),this[t]=e&255,t+1};C.prototype.writeUint16LE=C.prototype.writeUInt16LE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,2,65535,0),this[t]=e&255,this[t+1]=e>>>8,t+2};C.prototype.writeUint16BE=C.prototype.writeUInt16BE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=e&255,t+2};C.prototype.writeUint32LE=C.prototype.writeUInt32LE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=e&255,t+4};C.prototype.writeUint32BE=C.prototype.writeUInt32BE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};function uo(n,e,t,a,r){go(e,a,r,n,t,7);let i=Number(e&BigInt(4294967295));n[t++]=i,i=i>>8,n[t++]=i,i=i>>8,n[t++]=i,i=i>>8,n[t++]=i;let s=Number(e>>BigInt(32)&BigInt(4294967295));return n[t++]=s,s=s>>8,n[t++]=s,s=s>>8,n[t++]=s,s=s>>8,n[t++]=s,t}function mo(n,e,t,a,r){go(e,a,r,n,t,7);let i=Number(e&BigInt(4294967295));n[t+7]=i,i=i>>8,n[t+6]=i,i=i>>8,n[t+5]=i,i=i>>8,n[t+4]=i;let s=Number(e>>BigInt(32)&BigInt(4294967295));return n[t+3]=s,s=s>>8,n[t+2]=s,s=s>>8,n[t+1]=s,s=s>>8,n[t]=s,t+8}C.prototype.writeBigUInt64LE=Me(function(e,t=0){return uo(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});C.prototype.writeBigUInt64BE=Me(function(e,t=0){return mo(this,e,t,BigInt(0),BigInt("0xffffffffffffffff"))});C.prototype.writeIntLE=function(e,t,a,r){if(e=+e,t=t>>>0,!r){let l=Math.pow(2,8*a-1);Vt(this,e,t,a,l-1,-l)}let i=0,s=1,o=0;for(this[t]=e&255;++i<a&&(s*=256);)e<0&&o===0&&this[t+i-1]!==0&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+a};C.prototype.writeIntBE=function(e,t,a,r){if(e=+e,t=t>>>0,!r){let l=Math.pow(2,8*a-1);Vt(this,e,t,a,l-1,-l)}let i=a-1,s=1,o=0;for(this[t+i]=e&255;--i>=0&&(s*=256);)e<0&&o===0&&this[t+i+1]!==0&&(o=1),this[t+i]=(e/s>>0)-o&255;return t+a};C.prototype.writeInt8=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=e&255,t+1};C.prototype.writeInt16LE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,2,32767,-32768),this[t]=e&255,this[t+1]=e>>>8,t+2};C.prototype.writeInt16BE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=e&255,t+2};C.prototype.writeInt32LE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,4,2147483647,-2147483648),this[t]=e&255,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4};C.prototype.writeInt32BE=function(e,t,a){return e=+e,t=t>>>0,a||Vt(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=e&255,t+4};C.prototype.writeBigInt64LE=Me(function(e,t=0){return uo(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});C.prototype.writeBigInt64BE=Me(function(e,t=0){return mo(this,e,t,-BigInt("0x8000000000000000"),BigInt("0x7fffffffffffffff"))});function po(n,e,t,a,r,i){if(t+a>n.length)throw new RangeError("Index out of range");if(t<0)throw new RangeError("Index out of range")}function fo(n,e,t,a,r){return e=+e,t=t>>>0,r||po(n,e,t,4,34028234663852886e22,-34028234663852886e22),oa.write(n,e,t,a,23,4),t+4}C.prototype.writeFloatLE=function(e,t,a){return fo(this,e,t,!0,a)};C.prototype.writeFloatBE=function(e,t,a){return fo(this,e,t,!1,a)};function ho(n,e,t,a,r){return e=+e,t=t>>>0,r||po(n,e,t,8,17976931348623157e292,-17976931348623157e292),oa.write(n,e,t,a,52,8),t+8}C.prototype.writeDoubleLE=function(e,t,a){return ho(this,e,t,!0,a)};C.prototype.writeDoubleBE=function(e,t,a){return ho(this,e,t,!1,a)};C.prototype.copy=function(e,t,a,r){if(!C.isBuffer(e))throw new TypeError("argument should be a Buffer");if(a||(a=0),!r&&r!==0&&(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<a&&(r=a),r===a||e.length===0||this.length===0)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(a<0||a>=this.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-a&&(r=e.length-t+a);let i=r-a;return this===e&&typeof Uint8Array.prototype.copyWithin=="function"?this.copyWithin(t,a,r):Uint8Array.prototype.set.call(e,this.subarray(a,r),t),i};C.prototype.fill=function(e,t,a,r){if(typeof e=="string"){if(typeof t=="string"?(r=t,t=0,a=this.length):typeof a=="string"&&(r=a,a=this.length),r!==void 0&&typeof r!="string")throw new TypeError("encoding must be a string");if(typeof r=="string"&&!C.isEncoding(r))throw new TypeError("Unknown encoding: "+r);if(e.length===1){let s=e.charCodeAt(0);(r==="utf8"&&s<128||r==="latin1")&&(e=s)}}else typeof e=="number"?e=e&255:typeof e=="boolean"&&(e=Number(e));if(t<0||this.length<t||this.length<a)throw new RangeError("Out of range index");if(a<=t)return this;t=t>>>0,a=a===void 0?this.length:a>>>0,e||(e=0);let i;if(typeof e=="number")for(i=t;i<a;++i)this[i]=e;else{let s=C.isBuffer(e)?e:C.from(e,r),o=s.length;if(o===0)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(i=0;i<a-t;++i)this[i+t]=s[i%o]}return this};var sa={};function Gi(n,e,t){sa[n]=class extends t{constructor(){super(),Object.defineProperty(this,"message",{value:e.apply(this,arguments),writable:!0,configurable:!0}),this.name=`${this.name} [${n}]`,this.stack,delete this.name}get code(){return n}set code(r){Object.defineProperty(this,"code",{configurable:!0,enumerable:!0,value:r,writable:!0})}toString(){return`${this.name} [${n}]: ${this.message}`}}}Gi("ERR_BUFFER_OUT_OF_BOUNDS",function(n){return n?`${n} is outside of buffer bounds`:"Attempt to access memory outside buffer bounds"},RangeError);Gi("ERR_INVALID_ARG_TYPE",function(n,e){return`The "${n}" argument must be of type number. Received type ${typeof e}`},TypeError);Gi("ERR_OUT_OF_RANGE",function(n,e,t){let a=`The value of "${n}" is out of range.`,r=t;return Number.isInteger(t)&&Math.abs(t)>2**32?r=io(String(t)):typeof t=="bigint"&&(r=String(t),(t>BigInt(2)**BigInt(32)||t<-(BigInt(2)**BigInt(32)))&&(r=io(r)),r+="n"),a+=` It must be ${e}. Received ${r}`,a},RangeError);function io(n){let e="",t=n.length,a=n[0]==="-"?1:0;for(;t>=a+4;t-=3)e=`_${n.slice(t-3,t)}${e}`;return`${n.slice(0,t)}${e}`}function Bl(n,e,t){la(e,"offset"),(n[e]===void 0||n[e+t]===void 0)&&Ma(e,n.length-(t+1))}function go(n,e,t,a,r,i){if(n>t||n<e){let s=typeof e=="bigint"?"n":"",o;throw i>3?e===0||e===BigInt(0)?o=`>= 0${s} and < 2${s} ** ${(i+1)*8}${s}`:o=`>= -(2${s} ** ${(i+1)*8-1}${s}) and < 2 ** ${(i+1)*8-1}${s}`:o=`>= ${e}${s} and <= ${t}${s}`,new sa.ERR_OUT_OF_RANGE("value",o,n)}Bl(a,r,i)}function la(n,e){if(typeof n!="number")throw new sa.ERR_INVALID_ARG_TYPE(e,"number",n)}function Ma(n,e,t){throw Math.floor(n)!==n?(la(n,t),new sa.ERR_OUT_OF_RANGE(t||"offset","an integer",n)):e<0?new sa.ERR_BUFFER_OUT_OF_BOUNDS:new sa.ERR_OUT_OF_RANGE(t||"offset",`>= ${t?1:0} and <= ${e}`,n)}var Vl=/[^+/0-9A-Za-z-_]/g;function Ul(n){if(n=n.split("=")[0],n=n.trim().replace(Vl,""),n.length<2)return"";for(;n.length%4!==0;)n=n+"=";return n}function Hi(n,e){e=e||1/0;let t,a=n.length,r=null,i=[];for(let s=0;s<a;++s){if(t=n.charCodeAt(s),t>55295&&t<57344){if(!r){if(t>56319){(e-=3)>-1&&i.push(239,191,189);continue}else if(s+1===a){(e-=3)>-1&&i.push(239,191,189);continue}r=t;continue}if(t<56320){(e-=3)>-1&&i.push(239,191,189),r=t;continue}t=(r-55296<<10|t-56320)+65536}else r&&(e-=3)>-1&&i.push(239,191,189);if(r=null,t<128){if((e-=1)<0)break;i.push(t)}else if(t<2048){if((e-=2)<0)break;i.push(t>>6|192,t&63|128)}else if(t<65536){if((e-=3)<0)break;i.push(t>>12|224,t>>6&63|128,t&63|128)}else if(t<1114112){if((e-=4)<0)break;i.push(t>>18|240,t>>12&63|128,t>>6&63|128,t&63|128)}else throw new Error("Invalid code point")}return i}function Hl(n){let e=[];for(let t=0;t<n.length;++t)e.push(n.charCodeAt(t)&255);return e}function $l(n,e){let t,a,r,i=[];for(let s=0;s<n.length&&!((e-=2)<0);++s)t=n.charCodeAt(s),a=t>>8,r=t%256,i.push(r),i.push(a);return i}function yo(n){return Bi.toByteArray(Ul(n))}function wr(n,e,t,a){let r;for(r=0;r<a&&!(r+t>=e.length||r>=n.length);++r)e[r+t]=n[r];return r}function ce(n,e){return n instanceof e||n!=null&&n.constructor!=null&&n.constructor.name!=null&&n.constructor.name===e.name}function zi(n){return n!==n}var jl=function(){let n="0123456789abcdef",e=new Array(256);for(let t=0;t<16;++t){let a=t*16;for(let r=0;r<16;++r)e[a+r]=n[t]+n[r]}return e}();function Me(n){return typeof BigInt>"u"?Gl:n}function Gl(){throw new Error("BigInt not supported")}});var So=Q((Wi,Do)=>{var Dr=bo(),ue=Dr.Buffer;function wo(n,e){for(var t in n)e[t]=n[t]}ue.from&&ue.alloc&&ue.allocUnsafe&&ue.allocUnsafeSlow?Do.exports=Dr:(wo(Dr,Wi),Wi.Buffer=Ge);function Ge(n,e,t){return ue(n,e,t)}Ge.prototype=Object.create(ue.prototype);wo(ue,Ge);Ge.from=function(n,e,t){if(typeof n=="number")throw new TypeError("Argument must not be a number");return ue(n,e,t)};Ge.alloc=function(n,e,t){if(typeof n!="number")throw new TypeError("Argument must be a number");var a=ue(n);return e!==void 0?typeof t=="string"?a.fill(e,t):a.fill(e):a.fill(0),a};Ge.allocUnsafe=function(n){if(typeof n!="number")throw new TypeError("Argument must be a number");return ue(n)};Ge.allocUnsafeSlow=function(n){if(typeof n!="number")throw new TypeError("Argument must be a number");return Dr.SlowBuffer(n)}});var Io=Q(To=>{"use strict";var Ki=So().Buffer,vo=Ki.isEncoding||function(n){switch(n=""+n,n&&n.toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":case"raw":return!0;default:return!1}};function zl(n){if(!n)return"utf8";for(var e;;)switch(n){case"utf8":case"utf-8":return"utf8";case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return"utf16le";case"latin1":case"binary":return"latin1";case"base64":case"ascii":case"hex":return n;default:if(e)return;n=(""+n).toLowerCase(),e=!0}}function Wl(n){var e=zl(n);if(typeof e!="string"&&(Ki.isEncoding===vo||!vo(n)))throw new Error("Unknown encoding: "+n);return e||n}To.StringDecoder=Ea;function Ea(n){this.encoding=Wl(n);var e;switch(this.encoding){case"utf16le":this.text=Zl,this.end=tc,e=4;break;case"utf8":this.fillLast=Yl,e=4;break;case"base64":this.text=ec,this.end=ac,e=3;break;default:this.write=rc,this.end=ic;return}this.lastNeed=0,this.lastTotal=0,this.lastChar=Ki.allocUnsafe(e)}Ea.prototype.write=function(n){if(n.length===0)return"";var e,t;if(this.lastNeed){if(e=this.fillLast(n),e===void 0)return"";t=this.lastNeed,this.lastNeed=0}else t=0;return t<n.length?e?e+this.text(n,t):this.text(n,t):e||""};Ea.prototype.end=Jl;Ea.prototype.text=Ql;Ea.prototype.fillLast=function(n){if(this.lastNeed<=n.length)return n.copy(this.lastChar,this.lastTotal-this.lastNeed,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);n.copy(this.lastChar,this.lastTotal-this.lastNeed,0,n.length),this.lastNeed-=n.length};function Xi(n){return n<=127?0:n>>5===6?2:n>>4===14?3:n>>3===30?4:n>>6===2?-1:-2}function Xl(n,e,t){var a=e.length-1;if(a<t)return 0;var r=Xi(e[a]);return r>=0?(r>0&&(n.lastNeed=r-1),r):--a<t||r===-2?0:(r=Xi(e[a]),r>=0?(r>0&&(n.lastNeed=r-2),r):--a<t||r===-2?0:(r=Xi(e[a]),r>=0?(r>0&&(r===2?r=0:n.lastNeed=r-3),r):0))}function Kl(n,e,t){if((e[0]&192)!==128)return n.lastNeed=0,"\uFFFD";if(n.lastNeed>1&&e.length>1){if((e[1]&192)!==128)return n.lastNeed=1,"\uFFFD";if(n.lastNeed>2&&e.length>2&&(e[2]&192)!==128)return n.lastNeed=2,"\uFFFD"}}function Yl(n){var e=this.lastTotal-this.lastNeed,t=Kl(this,n,e);if(t!==void 0)return t;if(this.lastNeed<=n.length)return n.copy(this.lastChar,e,0,this.lastNeed),this.lastChar.toString(this.encoding,0,this.lastTotal);n.copy(this.lastChar,e,0,n.length),this.lastNeed-=n.length}function Ql(n,e){var t=Xl(this,n,e);if(!this.lastNeed)return n.toString("utf8",e);this.lastTotal=t;var a=n.length-(t-this.lastNeed);return n.copy(this.lastChar,0,a),n.toString("utf8",e,a)}function Jl(n){var e=n&&n.length?this.write(n):"";return this.lastNeed?e+"\uFFFD":e}function Zl(n,e){if((n.length-e)%2===0){var t=n.toString("utf16le",e);if(t){var a=t.charCodeAt(t.length-1);if(a>=55296&&a<=56319)return this.lastNeed=2,this.lastTotal=4,this.lastChar[0]=n[n.length-2],this.lastChar[1]=n[n.length-1],t.slice(0,-1)}return t}return this.lastNeed=1,this.lastTotal=2,this.lastChar[0]=n[n.length-1],n.toString("utf16le",e,n.length-1)}function tc(n){var e=n&&n.length?this.write(n):"";if(this.lastNeed){var t=this.lastTotal-this.lastNeed;return e+this.lastChar.toString("utf16le",0,t)}return e}function ec(n,e){var t=(n.length-e)%3;return t===0?n.toString("base64",e):(this.lastNeed=3-t,this.lastTotal=3,t===1?this.lastChar[0]=n[n.length-1]:(this.lastChar[0]=n[n.length-2],this.lastChar[1]=n[n.length-1]),n.toString("base64",e,n.length-t))}function ac(n){var e=n&&n.length?this.write(n):"";return this.lastNeed?e+this.lastChar.toString("base64",0,3-this.lastNeed):e}function rc(n){return n.toString(this.encoding)}function ic(n){return n&&n.length?this.write(n):""}});var Ao=Q(Sr=>{(function(n){n.parser=function(b,f){return new t(b,f)},n.SAXParser=t,n.SAXStream=c,n.createStream=l,n.MAX_BUFFER_LENGTH=64*1024;var e=["comment","sgmlDecl","textNode","tagName","doctype","procInstName","procInstBody","entity","attribName","attribValue","cdata","script"];n.EVENTS=["text","processinginstruction","sgmldeclaration","doctype","comment","opentagstart","attribute","opentag","closetag","opencdata","cdata","closecdata","error","end","ready","script","opennamespace","closenamespace"];function t(b,f){if(!(this instanceof t))return new t(b,f);var N=this;r(N),N.q=N.c="",N.bufferCheckPosition=n.MAX_BUFFER_LENGTH,N.opt=f||{},N.opt.lowercase=N.opt.lowercase||N.opt.lowercasetags,N.looseCase=N.opt.lowercase?"toLowerCase":"toUpperCase",N.tags=[],N.closed=N.closedRoot=N.sawRoot=!1,N.tag=N.error=null,N.strict=!!b,N.noscript=!!(b||N.opt.noscript),N.state=v.BEGIN,N.strictEntities=N.opt.strictEntities,N.ENTITIES=N.strictEntities?Object.create(n.XML_ENTITIES):Object.create(n.ENTITIES),N.attribList=[],N.opt.xmlns&&(N.ns=Object.create(S)),N.trackPosition=N.opt.position!==!1,N.trackPosition&&(N.position=N.line=N.column=0),A(N,"onready")}Object.create||(Object.create=function(b){function f(){}f.prototype=b;var N=new f;return N}),Object.keys||(Object.keys=function(b){var f=[];for(var N in b)b.hasOwnProperty(N)&&f.push(N);return f});function a(b){for(var f=Math.max(n.MAX_BUFFER_LENGTH,10),N=0,x=0,lt=e.length;x<lt;x++){var St=b[e[x]].length;if(St>f)switch(e[x]){case"textNode":B(b);break;case"cdata":E(b,"oncdata",b.cdata),b.cdata="";break;case"script":E(b,"onscript",b.script),b.script="";break;default:tt(b,"Max buffer length exceeded: "+e[x])}N=Math.max(N,St)}var Tt=n.MAX_BUFFER_LENGTH-N;b.bufferCheckPosition=Tt+b.position}function r(b){for(var f=0,N=e.length;f<N;f++)b[e[f]]=""}function i(b){B(b),b.cdata!==""&&(E(b,"oncdata",b.cdata),b.cdata=""),b.script!==""&&(E(b,"onscript",b.script),b.script="")}t.prototype={end:function(){ot(this)},write:tl,resume:function(){return this.error=null,this},close:function(){return this.write(null)},flush:function(){i(this)}};var s;try{s=Ys().Stream}catch{s=function(){}}var o=n.EVENTS.filter(function(b){return b!=="error"&&b!=="end"});function l(b,f){return new c(b,f)}function c(b,f){if(!(this instanceof c))return new c(b,f);s.apply(this),this._parser=new t(b,f),this.writable=!0,this.readable=!0;var N=this;this._parser.onend=function(){N.emit("end")},this._parser.onerror=function(x){N.emit("error",x),N._parser.error=null},this._decoder=null,o.forEach(function(x){Object.defineProperty(N,"on"+x,{get:function(){return N._parser["on"+x]},set:function(lt){if(!lt)return N.removeAllListeners(x),N._parser["on"+x]=lt,lt;N.on(x,lt)},enumerable:!0,configurable:!1})})}c.prototype=Object.create(s.prototype,{constructor:{value:c}}),c.prototype.write=function(b){if(typeof Buffer=="function"&&typeof Buffer.isBuffer=="function"&&Buffer.isBuffer(b)){if(!this._decoder){var f=Io().StringDecoder;this._decoder=new f("utf8")}b=this._decoder.write(b)}return this._parser.write(b.toString()),this.emit("data",b),!0},c.prototype.end=function(b){return b&&b.length&&this.write(b),this._parser.end(),!0},c.prototype.on=function(b,f){var N=this;return!N._parser["on"+b]&&o.indexOf(b)!==-1&&(N._parser["on"+b]=function(){var x=arguments.length===1?[arguments[0]]:Array.apply(null,arguments);x.splice(0,0,b),N.emit.apply(N,x)}),s.prototype.on.call(N,b,f)};var d="[CDATA[",p="DOCTYPE",g="http://www.w3.org/XML/1998/namespace",y="http://www.w3.org/2000/xmlns/",S={xml:g,xmlns:y},M=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,L=/[:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/,R=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD]/,F=/[#:_A-Za-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\u00B7\u0300-\u036F\u203F-\u2040.\d-]/;function D(b){return b===" "||b===`
`||b==="\r"||b==="	"}function h(b){return b==='"'||b==="'"}function m(b){return b===">"||D(b)}function T(b,f){return b.test(f)}function k(b,f){return!T(b,f)}var v=0;n.STATE={BEGIN:v++,BEGIN_WHITESPACE:v++,TEXT:v++,TEXT_ENTITY:v++,OPEN_WAKA:v++,SGML_DECL:v++,SGML_DECL_QUOTED:v++,DOCTYPE:v++,DOCTYPE_QUOTED:v++,DOCTYPE_DTD:v++,DOCTYPE_DTD_QUOTED:v++,COMMENT_STARTING:v++,COMMENT:v++,COMMENT_ENDING:v++,COMMENT_ENDED:v++,CDATA:v++,CDATA_ENDING:v++,CDATA_ENDING_2:v++,PROC_INST:v++,PROC_INST_BODY:v++,PROC_INST_ENDING:v++,OPEN_TAG:v++,OPEN_TAG_SLASH:v++,ATTRIB:v++,ATTRIB_NAME:v++,ATTRIB_NAME_SAW_WHITE:v++,ATTRIB_VALUE:v++,ATTRIB_VALUE_QUOTED:v++,ATTRIB_VALUE_CLOSED:v++,ATTRIB_VALUE_UNQUOTED:v++,ATTRIB_VALUE_ENTITY_Q:v++,ATTRIB_VALUE_ENTITY_U:v++,CLOSE_TAG:v++,CLOSE_TAG_SAW_WHITE:v++,SCRIPT:v++,SCRIPT_ENDING:v++},n.XML_ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'"},n.ENTITIES={amp:"&",gt:">",lt:"<",quot:'"',apos:"'",AElig:198,Aacute:193,Acirc:194,Agrave:192,Aring:197,Atilde:195,Auml:196,Ccedil:199,ETH:208,Eacute:201,Ecirc:202,Egrave:200,Euml:203,Iacute:205,Icirc:206,Igrave:204,Iuml:207,Ntilde:209,Oacute:211,Ocirc:212,Ograve:210,Oslash:216,Otilde:213,Ouml:214,THORN:222,Uacute:218,Ucirc:219,Ugrave:217,Uuml:220,Yacute:221,aacute:225,acirc:226,aelig:230,agrave:224,aring:229,atilde:227,auml:228,ccedil:231,eacute:233,ecirc:234,egrave:232,eth:240,euml:235,iacute:237,icirc:238,igrave:236,iuml:239,ntilde:241,oacute:243,ocirc:244,ograve:242,oslash:248,otilde:245,ouml:246,szlig:223,thorn:254,uacute:250,ucirc:251,ugrave:249,uuml:252,yacute:253,yuml:255,copy:169,reg:174,nbsp:160,iexcl:161,cent:162,pound:163,curren:164,yen:165,brvbar:166,sect:167,uml:168,ordf:170,laquo:171,not:172,shy:173,macr:175,deg:176,plusmn:177,sup1:185,sup2:178,sup3:179,acute:180,micro:181,para:182,middot:183,cedil:184,ordm:186,raquo:187,frac14:188,frac12:189,frac34:190,iquest:191,times:215,divide:247,OElig:338,oelig:339,Scaron:352,scaron:353,Yuml:376,fnof:402,circ:710,tilde:732,Alpha:913,Beta:914,Gamma:915,Delta:916,Epsilon:917,Zeta:918,Eta:919,Theta:920,Iota:921,Kappa:922,Lambda:923,Mu:924,Nu:925,Xi:926,Omicron:927,Pi:928,Rho:929,Sigma:931,Tau:932,Upsilon:933,Phi:934,Chi:935,Psi:936,Omega:937,alpha:945,beta:946,gamma:947,delta:948,epsilon:949,zeta:950,eta:951,theta:952,iota:953,kappa:954,lambda:955,mu:956,nu:957,xi:958,omicron:959,pi:960,rho:961,sigmaf:962,sigma:963,tau:964,upsilon:965,phi:966,chi:967,psi:968,omega:969,thetasym:977,upsih:978,piv:982,ensp:8194,emsp:8195,thinsp:8201,zwnj:8204,zwj:8205,lrm:8206,rlm:8207,ndash:8211,mdash:8212,lsquo:8216,rsquo:8217,sbquo:8218,ldquo:8220,rdquo:8221,bdquo:8222,dagger:8224,Dagger:8225,bull:8226,hellip:8230,permil:8240,prime:8242,Prime:8243,lsaquo:8249,rsaquo:8250,oline:8254,frasl:8260,euro:8364,image:8465,weierp:8472,real:8476,trade:8482,alefsym:8501,larr:8592,uarr:8593,rarr:8594,darr:8595,harr:8596,crarr:8629,lArr:8656,uArr:8657,rArr:8658,dArr:8659,hArr:8660,forall:8704,part:8706,exist:8707,empty:8709,nabla:8711,isin:8712,notin:8713,ni:8715,prod:8719,sum:8721,minus:8722,lowast:8727,radic:8730,prop:8733,infin:8734,ang:8736,and:8743,or:8744,cap:8745,cup:8746,int:8747,there4:8756,sim:8764,cong:8773,asymp:8776,ne:8800,equiv:8801,le:8804,ge:8805,sub:8834,sup:8835,nsub:8836,sube:8838,supe:8839,oplus:8853,otimes:8855,perp:8869,sdot:8901,lceil:8968,rceil:8969,lfloor:8970,rfloor:8971,lang:9001,rang:9002,loz:9674,spades:9824,clubs:9827,hearts:9829,diams:9830},Object.keys(n.ENTITIES).forEach(function(b){var f=n.ENTITIES[b],N=typeof f=="number"?String.fromCharCode(f):f;n.ENTITIES[b]=N});for(var _ in n.STATE)n.STATE[n.STATE[_]]=_;v=n.STATE;function A(b,f,N){b[f]&&b[f](N)}function E(b,f,N){b.textNode&&B(b),A(b,f,N)}function B(b){b.textNode=U(b.opt,b.textNode),b.textNode&&A(b,"ontext",b.textNode),b.textNode=""}function U(b,f){return b.trim&&(f=f.trim()),b.normalize&&(f=f.replace(/\s+/g," ")),f}function tt(b,f){return B(b),b.trackPosition&&(f+=`
Line: `+b.line+`
Column: `+b.column+`
Char: `+b.c),f=new Error(f),b.error=f,A(b,"onerror",f),b}function ot(b){return b.sawRoot&&!b.closedRoot&&z(b,"Unclosed root tag"),b.state!==v.BEGIN&&b.state!==v.BEGIN_WHITESPACE&&b.state!==v.TEXT&&tt(b,"Unexpected end"),B(b),b.c="",b.closed=!0,A(b,"onend"),t.call(b,b.strict,b.opt),b}function z(b,f){if(typeof b!="object"||!(b instanceof t))throw new Error("bad call to strictFail");b.strict&&tt(b,f)}function Dt(b){b.strict||(b.tagName=b.tagName[b.looseCase]());var f=b.tags[b.tags.length-1]||b,N=b.tag={name:b.tagName,attributes:{}};b.opt.xmlns&&(N.ns=f.ns),b.attribList.length=0,E(b,"onopentagstart",N)}function it(b,f){var N=b.indexOf(":"),x=N<0?["",b]:b.split(":"),lt=x[0],St=x[1];return f&&b==="xmlns"&&(lt="xmlns",St=""),{prefix:lt,local:St}}function Fe(b){if(b.strict||(b.attribName=b.attribName[b.looseCase]()),b.attribList.indexOf(b.attribName)!==-1||b.tag.attributes.hasOwnProperty(b.attribName)){b.attribName=b.attribValue="";return}if(b.opt.xmlns){var f=it(b.attribName,!0),N=f.prefix,x=f.local;if(N==="xmlns")if(x==="xml"&&b.attribValue!==g)z(b,"xml: prefix must be bound to "+g+`
Actual: `+b.attribValue);else if(x==="xmlns"&&b.attribValue!==y)z(b,"xmlns: prefix must be bound to "+y+`
Actual: `+b.attribValue);else{var lt=b.tag,St=b.tags[b.tags.length-1]||b;lt.ns===St.ns&&(lt.ns=Object.create(St.ns)),lt.ns[x]=b.attribValue}b.attribList.push([b.attribName,b.attribValue])}else b.tag.attributes[b.attribName]=b.attribValue,E(b,"onattribute",{name:b.attribName,value:b.attribValue});b.attribName=b.attribValue=""}function Zt(b,f){if(b.opt.xmlns){var N=b.tag,x=it(b.tagName);N.prefix=x.prefix,N.local=x.local,N.uri=N.ns[x.prefix]||"",N.prefix&&!N.uri&&(z(b,"Unbound namespace prefix: "+JSON.stringify(b.tagName)),N.uri=x.prefix);var lt=b.tags[b.tags.length-1]||b;N.ns&&lt.ns!==N.ns&&Object.keys(N.ns).forEach(function(rn){E(b,"onopennamespace",{prefix:rn,uri:N.ns[rn]})});for(var St=0,Tt=b.attribList.length;St<Tt;St++){var Nt=b.attribList[St],ie=Nt[0],Qe=Nt[1],xt=it(ie,!0),he=xt.prefix,el=xt.local,an=he===""?"":N.ns[he]||"",Ti={name:ie,value:Qe,prefix:he,local:el,uri:an};he&&he!=="xmlns"&&!an&&(z(b,"Unbound namespace prefix: "+JSON.stringify(he)),Ti.uri=he),b.tag.attributes[ie]=Ti,E(b,"onattribute",Ti)}b.attribList.length=0}b.tag.isSelfClosing=!!f,b.sawRoot=!0,b.tags.push(b.tag),E(b,"onopentag",b.tag),f||(!b.noscript&&b.tagName.toLowerCase()==="script"?b.state=v.SCRIPT:b.state=v.TEXT,b.tag=null,b.tagName=""),b.attribName=b.attribValue="",b.attribList.length=0}function vi(b){if(!b.tagName){z(b,"Weird empty close tag."),b.textNode+="</>",b.state=v.TEXT;return}if(b.script){if(b.tagName!=="script"){b.script+="</"+b.tagName+">",b.tagName="",b.state=v.SCRIPT;return}E(b,"onscript",b.script),b.script=""}var f=b.tags.length,N=b.tagName;b.strict||(N=N[b.looseCase]());for(var x=N;f--;){var lt=b.tags[f];if(lt.name!==x)z(b,"Unexpected close tag");else break}if(f<0){z(b,"Unmatched closing tag: "+b.tagName),b.textNode+="</"+b.tagName+">",b.state=v.TEXT;return}b.tagName=N;for(var St=b.tags.length;St-- >f;){var Tt=b.tag=b.tags.pop();b.tagName=b.tag.name,E(b,"onclosetag",b.tagName);var Nt={};for(var ie in Tt.ns)Nt[ie]=Tt.ns[ie];var Qe=b.tags[b.tags.length-1]||b;b.opt.xmlns&&Tt.ns!==Qe.ns&&Object.keys(Tt.ns).forEach(function(xt){var he=Tt.ns[xt];E(b,"onclosenamespace",{prefix:xt,uri:he})})}f===0&&(b.closedRoot=!0),b.tagName=b.attribValue=b.attribName="",b.attribList.length=0,b.state=v.TEXT}function Zo(b){var f=b.entity,N=f.toLowerCase(),x,lt="";return b.ENTITIES[f]?b.ENTITIES[f]:b.ENTITIES[N]?b.ENTITIES[N]:(f=N,f.charAt(0)==="#"&&(f.charAt(1)==="x"?(f=f.slice(2),x=parseInt(f,16),lt=x.toString(16)):(f=f.slice(1),x=parseInt(f,10),lt=x.toString(10))),f=f.replace(/^0+/,""),isNaN(x)||lt.toLowerCase()!==f?(z(b,"Invalid character entity"),"&"+b.entity+";"):String.fromCodePoint(x))}function tn(b,f){f==="<"?(b.state=v.OPEN_WAKA,b.startTagPosition=b.position):D(f)||(z(b,"Non-whitespace before first tag."),b.textNode=f,b.state=v.TEXT)}function en(b,f){var N="";return f<b.length&&(N=b.charAt(f)),N}function tl(b){var f=this;if(this.error)throw this.error;if(f.closed)return tt(f,"Cannot write after close. Assign an onready handler.");if(b===null)return ot(f);typeof b=="object"&&(b=b.toString());for(var N=0,x="";x=en(b,N++),f.c=x,!!x;)switch(f.trackPosition&&(f.position++,x===`
`?(f.line++,f.column=0):f.column++),f.state){case v.BEGIN:if(f.state=v.BEGIN_WHITESPACE,x==="\uFEFF")continue;tn(f,x);continue;case v.BEGIN_WHITESPACE:tn(f,x);continue;case v.TEXT:if(f.sawRoot&&!f.closedRoot){for(var lt=N-1;x&&x!=="<"&&x!=="&";)x=en(b,N++),x&&f.trackPosition&&(f.position++,x===`
`?(f.line++,f.column=0):f.column++);f.textNode+=b.substring(lt,N-1)}x==="<"&&!(f.sawRoot&&f.closedRoot&&!f.strict)?(f.state=v.OPEN_WAKA,f.startTagPosition=f.position):(!D(x)&&(!f.sawRoot||f.closedRoot)&&z(f,"Text data outside of root node."),x==="&"?f.state=v.TEXT_ENTITY:f.textNode+=x);continue;case v.SCRIPT:x==="<"?f.state=v.SCRIPT_ENDING:f.script+=x;continue;case v.SCRIPT_ENDING:x==="/"?f.state=v.CLOSE_TAG:(f.script+="<"+x,f.state=v.SCRIPT);continue;case v.OPEN_WAKA:if(x==="!")f.state=v.SGML_DECL,f.sgmlDecl="";else if(!D(x))if(T(M,x))f.state=v.OPEN_TAG,f.tagName=x;else if(x==="/")f.state=v.CLOSE_TAG,f.tagName="";else if(x==="?")f.state=v.PROC_INST,f.procInstName=f.procInstBody="";else{if(z(f,"Unencoded <"),f.startTagPosition+1<f.position){var St=f.position-f.startTagPosition;x=new Array(St).join(" ")+x}f.textNode+="<"+x,f.state=v.TEXT}continue;case v.SGML_DECL:(f.sgmlDecl+x).toUpperCase()===d?(E(f,"onopencdata"),f.state=v.CDATA,f.sgmlDecl="",f.cdata=""):f.sgmlDecl+x==="--"?(f.state=v.COMMENT,f.comment="",f.sgmlDecl=""):(f.sgmlDecl+x).toUpperCase()===p?(f.state=v.DOCTYPE,(f.doctype||f.sawRoot)&&z(f,"Inappropriately located doctype declaration"),f.doctype="",f.sgmlDecl=""):x===">"?(E(f,"onsgmldeclaration",f.sgmlDecl),f.sgmlDecl="",f.state=v.TEXT):(h(x)&&(f.state=v.SGML_DECL_QUOTED),f.sgmlDecl+=x);continue;case v.SGML_DECL_QUOTED:x===f.q&&(f.state=v.SGML_DECL,f.q=""),f.sgmlDecl+=x;continue;case v.DOCTYPE:x===">"?(f.state=v.TEXT,E(f,"ondoctype",f.doctype),f.doctype=!0):(f.doctype+=x,x==="["?f.state=v.DOCTYPE_DTD:h(x)&&(f.state=v.DOCTYPE_QUOTED,f.q=x));continue;case v.DOCTYPE_QUOTED:f.doctype+=x,x===f.q&&(f.q="",f.state=v.DOCTYPE);continue;case v.DOCTYPE_DTD:f.doctype+=x,x==="]"?f.state=v.DOCTYPE:h(x)&&(f.state=v.DOCTYPE_DTD_QUOTED,f.q=x);continue;case v.DOCTYPE_DTD_QUOTED:f.doctype+=x,x===f.q&&(f.state=v.DOCTYPE_DTD,f.q="");continue;case v.COMMENT:x==="-"?f.state=v.COMMENT_ENDING:f.comment+=x;continue;case v.COMMENT_ENDING:x==="-"?(f.state=v.COMMENT_ENDED,f.comment=U(f.opt,f.comment),f.comment&&E(f,"oncomment",f.comment),f.comment=""):(f.comment+="-"+x,f.state=v.COMMENT);continue;case v.COMMENT_ENDED:x!==">"?(z(f,"Malformed comment"),f.comment+="--"+x,f.state=v.COMMENT):f.state=v.TEXT;continue;case v.CDATA:x==="]"?f.state=v.CDATA_ENDING:f.cdata+=x;continue;case v.CDATA_ENDING:x==="]"?f.state=v.CDATA_ENDING_2:(f.cdata+="]"+x,f.state=v.CDATA);continue;case v.CDATA_ENDING_2:x===">"?(f.cdata&&E(f,"oncdata",f.cdata),E(f,"onclosecdata"),f.cdata="",f.state=v.TEXT):x==="]"?f.cdata+="]":(f.cdata+="]]"+x,f.state=v.CDATA);continue;case v.PROC_INST:x==="?"?f.state=v.PROC_INST_ENDING:D(x)?f.state=v.PROC_INST_BODY:f.procInstName+=x;continue;case v.PROC_INST_BODY:if(!f.procInstBody&&D(x))continue;x==="?"?f.state=v.PROC_INST_ENDING:f.procInstBody+=x;continue;case v.PROC_INST_ENDING:x===">"?(E(f,"onprocessinginstruction",{name:f.procInstName,body:f.procInstBody}),f.procInstName=f.procInstBody="",f.state=v.TEXT):(f.procInstBody+="?"+x,f.state=v.PROC_INST_BODY);continue;case v.OPEN_TAG:T(L,x)?f.tagName+=x:(Dt(f),x===">"?Zt(f):x==="/"?f.state=v.OPEN_TAG_SLASH:(D(x)||z(f,"Invalid character in tag name"),f.state=v.ATTRIB));continue;case v.OPEN_TAG_SLASH:x===">"?(Zt(f,!0),vi(f)):(z(f,"Forward-slash in opening tag not followed by >"),f.state=v.ATTRIB);continue;case v.ATTRIB:if(D(x))continue;x===">"?Zt(f):x==="/"?f.state=v.OPEN_TAG_SLASH:T(M,x)?(f.attribName=x,f.attribValue="",f.state=v.ATTRIB_NAME):z(f,"Invalid attribute name");continue;case v.ATTRIB_NAME:x==="="?f.state=v.ATTRIB_VALUE:x===">"?(z(f,"Attribute without value"),f.attribValue=f.attribName,Fe(f),Zt(f)):D(x)?f.state=v.ATTRIB_NAME_SAW_WHITE:T(L,x)?f.attribName+=x:z(f,"Invalid attribute name");continue;case v.ATTRIB_NAME_SAW_WHITE:if(x==="=")f.state=v.ATTRIB_VALUE;else{if(D(x))continue;z(f,"Attribute without value"),f.tag.attributes[f.attribName]="",f.attribValue="",E(f,"onattribute",{name:f.attribName,value:""}),f.attribName="",x===">"?Zt(f):T(M,x)?(f.attribName=x,f.state=v.ATTRIB_NAME):(z(f,"Invalid attribute name"),f.state=v.ATTRIB)}continue;case v.ATTRIB_VALUE:if(D(x))continue;h(x)?(f.q=x,f.state=v.ATTRIB_VALUE_QUOTED):(z(f,"Unquoted attribute value"),f.state=v.ATTRIB_VALUE_UNQUOTED,f.attribValue=x);continue;case v.ATTRIB_VALUE_QUOTED:if(x!==f.q){x==="&"?f.state=v.ATTRIB_VALUE_ENTITY_Q:f.attribValue+=x;continue}Fe(f),f.q="",f.state=v.ATTRIB_VALUE_CLOSED;continue;case v.ATTRIB_VALUE_CLOSED:D(x)?f.state=v.ATTRIB:x===">"?Zt(f):x==="/"?f.state=v.OPEN_TAG_SLASH:T(M,x)?(z(f,"No whitespace between attributes"),f.attribName=x,f.attribValue="",f.state=v.ATTRIB_NAME):z(f,"Invalid attribute name");continue;case v.ATTRIB_VALUE_UNQUOTED:if(!m(x)){x==="&"?f.state=v.ATTRIB_VALUE_ENTITY_U:f.attribValue+=x;continue}Fe(f),x===">"?Zt(f):f.state=v.ATTRIB;continue;case v.CLOSE_TAG:if(f.tagName)x===">"?vi(f):T(L,x)?f.tagName+=x:f.script?(f.script+="</"+f.tagName,f.tagName="",f.state=v.SCRIPT):(D(x)||z(f,"Invalid tagname in closing tag"),f.state=v.CLOSE_TAG_SAW_WHITE);else{if(D(x))continue;k(M,x)?f.script?(f.script+="</"+x,f.state=v.SCRIPT):z(f,"Invalid tagname in closing tag."):f.tagName=x}continue;case v.CLOSE_TAG_SAW_WHITE:if(D(x))continue;x===">"?vi(f):z(f,"Invalid characters in closing tag");continue;case v.TEXT_ENTITY:case v.ATTRIB_VALUE_ENTITY_Q:case v.ATTRIB_VALUE_ENTITY_U:var Tt,Nt;switch(f.state){case v.TEXT_ENTITY:Tt=v.TEXT,Nt="textNode";break;case v.ATTRIB_VALUE_ENTITY_Q:Tt=v.ATTRIB_VALUE_QUOTED,Nt="attribValue";break;case v.ATTRIB_VALUE_ENTITY_U:Tt=v.ATTRIB_VALUE_UNQUOTED,Nt="attribValue";break}x===";"?(f[Nt]+=Zo(f),f.entity="",f.state=Tt):T(f.entity.length?F:R,x)?f.entity+=x:(z(f,"Invalid character in entity name"),f[Nt]+="&"+f.entity+x,f.entity="",f.state=Tt);continue;default:throw new Error(f,"Unknown state: "+f.state)}return f.position>=f.bufferCheckPosition&&a(f),f}String.fromCodePoint||function(){var b=String.fromCharCode,f=Math.floor,N=function(){var x=16384,lt=[],St,Tt,Nt=-1,ie=arguments.length;if(!ie)return"";for(var Qe="";++Nt<ie;){var xt=Number(arguments[Nt]);if(!isFinite(xt)||xt<0||xt>1114111||f(xt)!==xt)throw RangeError("Invalid code point: "+xt);xt<=65535?lt.push(xt):(xt-=65536,St=(xt>>10)+55296,Tt=xt%1024+56320,lt.push(St,Tt)),(Nt+1===ie||lt.length>x)&&(Qe+=b.apply(null,lt),lt.length=0)}return Qe};Object.defineProperty?Object.defineProperty(String,"fromCodePoint",{value:N,configurable:!0,writable:!0}):String.fromCodePoint=N}()})(typeof Sr>"u"?Sr.sax={}:Sr)});var Fo=Q((Mh,Yi)=>{"use strict";var ua=typeof Reflect=="object"?Reflect:null,ko=ua&&typeof ua.apply=="function"?ua.apply:function(e,t,a){return Function.prototype.apply.call(e,t,a)},vr;ua&&typeof ua.ownKeys=="function"?vr=ua.ownKeys:Object.getOwnPropertySymbols?vr=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:vr=function(e){return Object.getOwnPropertyNames(e)};function nc(n){console&&console.warn&&console.warn(n)}var xo=Number.isNaN||function(e){return e!==e};function ct(){ct.init.call(this)}Yi.exports=ct;Yi.exports.once=cc;ct.EventEmitter=ct;ct.prototype._events=void 0;ct.prototype._eventsCount=0;ct.prototype._maxListeners=void 0;var Ro=10;function Tr(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(ct,"defaultMaxListeners",{enumerable:!0,get:function(){return Ro},set:function(n){if(typeof n!="number"||n<0||xo(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");Ro=n}});ct.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};ct.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||xo(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function Mo(n){return n._maxListeners===void 0?ct.defaultMaxListeners:n._maxListeners}ct.prototype.getMaxListeners=function(){return Mo(this)};ct.prototype.emit=function(e){for(var t=[],a=1;a<arguments.length;a++)t.push(arguments[a]);var r=e==="error",i=this._events;if(i!==void 0)r=r&&i.error===void 0;else if(!r)return!1;if(r){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var o=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw o.context=s,o}var l=i[e];if(l===void 0)return!1;if(typeof l=="function")ko(l,this,t);else for(var c=l.length,d=Oo(l,c),a=0;a<c;++a)ko(d[a],this,t);return!0};function Eo(n,e,t,a){var r,i,s;if(Tr(t),i=n._events,i===void 0?(i=n._events=Object.create(null),n._eventsCount=0):(i.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),i=n._events),s=i[e]),s===void 0)s=i[e]=t,++n._eventsCount;else if(typeof s=="function"?s=i[e]=a?[t,s]:[s,t]:a?s.unshift(t):s.push(t),r=Mo(n),r>0&&s.length>r&&!s.warned){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=n,o.type=e,o.count=s.length,nc(o)}return n}ct.prototype.addListener=function(e,t){return Eo(this,e,t,!1)};ct.prototype.on=ct.prototype.addListener;ct.prototype.prependListener=function(e,t){return Eo(this,e,t,!0)};function sc(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Co(n,e,t){var a={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},r=sc.bind(a);return r.listener=t,a.wrapFn=r,r}ct.prototype.once=function(e,t){return Tr(t),this.on(e,Co(this,e,t)),this};ct.prototype.prependOnceListener=function(e,t){return Tr(t),this.prependListener(e,Co(this,e,t)),this};ct.prototype.removeListener=function(e,t){var a,r,i,s,o;if(Tr(t),r=this._events,r===void 0)return this;if(a=r[e],a===void 0)return this;if(a===t||a.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,a.listener||t));else if(typeof a!="function"){for(i=-1,s=a.length-1;s>=0;s--)if(a[s]===t||a[s].listener===t){o=a[s].listener,i=s;break}if(i<0)return this;i===0?a.shift():oc(a,i),a.length===1&&(r[e]=a[0]),r.removeListener!==void 0&&this.emit("removeListener",e,o||t)}return this};ct.prototype.off=ct.prototype.removeListener;ct.prototype.removeAllListeners=function(e){var t,a,r;if(a=this._events,a===void 0)return this;if(a.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):a[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete a[e]),this;if(arguments.length===0){var i=Object.keys(a),s;for(r=0;r<i.length;++r)s=i[r],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=a[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this};function _o(n,e,t){var a=n._events;if(a===void 0)return[];var r=a[e];return r===void 0?[]:typeof r=="function"?t?[r.listener||r]:[r]:t?lc(r):Oo(r,r.length)}ct.prototype.listeners=function(e){return _o(this,e,!0)};ct.prototype.rawListeners=function(e){return _o(this,e,!1)};ct.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):Po.call(n,e)};ct.prototype.listenerCount=Po;function Po(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}ct.prototype.eventNames=function(){return this._eventsCount>0?vr(this._events):[]};function Oo(n,e){for(var t=new Array(e),a=0;a<e;++a)t[a]=n[a];return t}function oc(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function lc(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function cc(n,e){return new Promise(function(t,a){function r(s){n.removeListener(e,i),a(s)}function i(){typeof n.removeListener=="function"&&n.removeListener("error",r),t([].slice.call(arguments))}Lo(n,e,i,{once:!0}),e!=="error"&&uc(n,r,{once:!0})})}function uc(n,e,t){typeof n.on=="function"&&Lo(n,"error",e,t)}function Lo(n,e,t,a){if(typeof n.on=="function")a.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function r(i){a.once&&n.removeEventListener(e,r),t(i)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}});var No=Q(Qi=>{(function(){"use strict";Qi.stripBOM=function(n){return n[0]==="\uFEFF"?n.substring(1):n}}).call(Qi)});var Ji=Q(ze=>{(function(){"use strict";var n;n=new RegExp(/(?!xmlns)^.*:/),ze.normalize=function(e){return e.toLowerCase()},ze.firstCharLowerCase=function(e){return e.charAt(0).toLowerCase()+e.slice(1)},ze.stripPrefix=function(e){return e.replace(n,"")},ze.parseNumbers=function(e){return isNaN(e)||(e=e%1===0?parseInt(e,10):parseFloat(e)),e},ze.parseBooleans=function(e){return/^(?:true|false)$/i.test(e)&&(e=e.toLowerCase()==="true"),e}}).call(ze)});var Bo=Q(qo=>{qo.every=function(n){return new Zi(n)};var we={millisecond:1,second:1e3,minute:6e4,hour:36e5,day:864e5};for(We in we)We==="millisecond"?we.ms=we[We]:we[We.charAt(0)]=we[We],we[We+"s"]=we[We];var We;function Zi(n){this.count=0;var e=mc(n);e&&(this.time=Number(e[0])*we[e[1]],this.type=e[1])}Zi.prototype.do=function(n){this.time&&(this.interval=setInterval(t,this.time));var e=this;function t(){e.count++,n.call(e)}return this};Zi.prototype.stop=function(){return this.interval&&(clearInterval(this.interval),delete this.interval),this};var dc=/^\s*(\d+(?:\.\d+)?)\s*([a-z]+)\s*$/;function mc(n){var e=n.match(dc);return e&&we[e[2]]?e.slice(1):null}});var Vo=Q(De=>{(function(){"use strict";var n,e,t,a,r,i,s,o,l=function(p,g){return function(){return p.apply(g,arguments)}},c=function(p,g){for(var y in g)d.call(g,y)&&(p[y]=g[y]);function S(){this.constructor=p}return S.prototype=g.prototype,p.prototype=new S,p.__super__=g.prototype,p},d={}.hasOwnProperty;s=Ao(),t=Fo(),n=No(),i=Ji(),o=Bo().setImmediate,e=ar().defaults,a=function(p){return typeof p=="object"&&p!=null&&Object.keys(p).length===0},r=function(p,g,y){var S,M,L;for(S=0,M=p.length;S<M;S++)L=p[S],g=L(g,y);return g},De.Parser=function(p){c(g,p);function g(y){this.parseStringPromise=l(this.parseStringPromise,this),this.parseString=l(this.parseString,this),this.reset=l(this.reset,this),this.assignOrPush=l(this.assignOrPush,this),this.processAsync=l(this.processAsync,this);var S,M,L;if(!(this instanceof De.Parser))return new De.Parser(y);this.options={},M=e["0.2"];for(S in M)!d.call(M,S)||(L=M[S],this.options[S]=L);for(S in y)!d.call(y,S)||(L=y[S],this.options[S]=L);this.options.xmlns&&(this.options.xmlnskey=this.options.attrkey+"ns"),this.options.normalizeTags&&(this.options.tagNameProcessors||(this.options.tagNameProcessors=[]),this.options.tagNameProcessors.unshift(i.normalize)),this.reset()}return g.prototype.processAsync=function(){var y,S;try{return this.remaining.length<=this.options.chunkSize?(y=this.remaining,this.remaining="",this.saxParser=this.saxParser.write(y),this.saxParser.close()):(y=this.remaining.substr(0,this.options.chunkSize),this.remaining=this.remaining.substr(this.options.chunkSize,this.remaining.length),this.saxParser=this.saxParser.write(y),o(this.processAsync))}catch(M){if(S=M,!this.saxParser.errThrown)return this.saxParser.errThrown=!0,this.emit(S)}},g.prototype.assignOrPush=function(y,S,M){return S in y?(y[S]instanceof Array||(y[S]=[y[S]]),y[S].push(M)):this.options.explicitArray?y[S]=[M]:y[S]=M},g.prototype.reset=function(){var y,S,M,L;return this.removeAllListeners(),this.saxParser=s.parser(this.options.strict,{trim:!1,normalize:!1,xmlns:this.options.xmlns}),this.saxParser.errThrown=!1,this.saxParser.onerror=function(R){return function(F){if(R.saxParser.resume(),!R.saxParser.errThrown)return R.saxParser.errThrown=!0,R.emit("error",F)}}(this),this.saxParser.onend=function(R){return function(){if(!R.saxParser.ended)return R.saxParser.ended=!0,R.emit("end",R.resultObject)}}(this),this.saxParser.ended=!1,this.EXPLICIT_CHARKEY=this.options.explicitCharkey,this.resultObject=null,L=[],y=this.options.attrkey,S=this.options.charkey,this.saxParser.onopentag=function(R){return function(F){var D,h,m,T,k;if(m={},m[S]="",!R.options.ignoreAttrs){k=F.attributes;for(D in k)!d.call(k,D)||(!(y in m)&&!R.options.mergeAttrs&&(m[y]={}),h=R.options.attrValueProcessors?r(R.options.attrValueProcessors,F.attributes[D],D):F.attributes[D],T=R.options.attrNameProcessors?r(R.options.attrNameProcessors,D):D,R.options.mergeAttrs?R.assignOrPush(m,T,h):m[y][T]=h)}return m["#name"]=R.options.tagNameProcessors?r(R.options.tagNameProcessors,F.name):F.name,R.options.xmlns&&(m[R.options.xmlnskey]={uri:F.uri,local:F.local}),L.push(m)}}(this),this.saxParser.onclosetag=function(R){return function(){var F,D,h,m,T,k,v,_,A,E;if(k=L.pop(),T=k["#name"],(!R.options.explicitChildren||!R.options.preserveChildrenOrder)&&delete k["#name"],k.cdata===!0&&(F=k.cdata,delete k.cdata),A=L[L.length-1],k[S].match(/^\s*$/)&&!F?(D=k[S],delete k[S]):(R.options.trim&&(k[S]=k[S].trim()),R.options.normalize&&(k[S]=k[S].replace(/\s{2,}/g," ").trim()),k[S]=R.options.valueProcessors?r(R.options.valueProcessors,k[S],T):k[S],Object.keys(k).length===1&&S in k&&!R.EXPLICIT_CHARKEY&&(k=k[S])),a(k)&&(k=R.options.emptyTag!==""?R.options.emptyTag:D),R.options.validator!=null&&(E="/"+function(){var B,U,tt;for(tt=[],B=0,U=L.length;B<U;B++)m=L[B],tt.push(m["#name"]);return tt}().concat(T).join("/"),function(){var B;try{return k=R.options.validator(E,A&&A[T],k)}catch(U){return B=U,R.emit("error",B)}}()),R.options.explicitChildren&&!R.options.mergeAttrs&&typeof k=="object"){if(!R.options.preserveChildrenOrder)m={},R.options.attrkey in k&&(m[R.options.attrkey]=k[R.options.attrkey],delete k[R.options.attrkey]),!R.options.charsAsChildren&&R.options.charkey in k&&(m[R.options.charkey]=k[R.options.charkey],delete k[R.options.charkey]),Object.getOwnPropertyNames(k).length>0&&(m[R.options.childkey]=k),k=m;else if(A){A[R.options.childkey]=A[R.options.childkey]||[],v={};for(h in k)!d.call(k,h)||(v[h]=k[h]);A[R.options.childkey].push(v),delete k["#name"],Object.keys(k).length===1&&S in k&&!R.EXPLICIT_CHARKEY&&(k=k[S])}}return L.length>0?R.assignOrPush(A,T,k):(R.options.explicitRoot&&(_=k,k={},k[T]=_),R.resultObject=k,R.saxParser.ended=!0,R.emit("end",R.resultObject))}}(this),M=function(R){return function(F){var D,h;if(h=L[L.length-1],h)return h[S]+=F,R.options.explicitChildren&&R.options.preserveChildrenOrder&&R.options.charsAsChildren&&(R.options.includeWhiteChars||F.replace(/\\n/g,"").trim()!=="")&&(h[R.options.childkey]=h[R.options.childkey]||[],D={"#name":"__text__"},D[S]=F,R.options.normalize&&(D[S]=D[S].replace(/\s{2,}/g," ").trim()),h[R.options.childkey].push(D)),h}}(this),this.saxParser.ontext=M,this.saxParser.oncdata=function(R){return function(F){var D;if(D=M(F),D)return D.cdata=!0}}(this)},g.prototype.parseString=function(y,S){var M;S!=null&&typeof S=="function"&&(this.on("end",function(L){return this.reset(),S(null,L)}),this.on("error",function(L){return this.reset(),S(L)}));try{return y=y.toString(),y.trim()===""?(this.emit("end",null),!0):(y=n.stripBOM(y),this.options.async?(this.remaining=y,o(this.processAsync),this.saxParser):this.saxParser.write(y).close())}catch(L){if(M=L,this.saxParser.errThrown||this.saxParser.ended){if(this.saxParser.ended)throw M}else return this.emit("error",M),this.saxParser.errThrown=!0}},g.prototype.parseStringPromise=function(y){return new Promise(function(S){return function(M,L){return S.parseString(y,function(R,F){return R?L(R):M(F)})}}(this))},g}(t),De.parseString=function(p,g,y){var S,M,L;return y!=null?(typeof y=="function"&&(S=y),typeof g=="object"&&(M=g)):(typeof g=="function"&&(S=g),M={}),L=new De.Parser(M),L.parseString(p,S)},De.parseStringPromise=function(p,g){var y,S;return typeof g=="object"&&(y=g),S=new De.Parser(y),S.parseStringPromise(p)}}).call(De)});var Uo=Q(Se=>{(function(){"use strict";var n,e,t,a,r=function(s,o){for(var l in o)i.call(o,l)&&(s[l]=o[l]);function c(){this.constructor=s}return c.prototype=o.prototype,s.prototype=new c,s.__super__=o.prototype,s},i={}.hasOwnProperty;e=ar(),n=Gs(),t=Vo(),a=Ji(),Se.defaults=e.defaults,Se.processors=a,Se.ValidationError=function(s){r(o,s);function o(l){this.message=l}return o}(Error),Se.Builder=n.Builder,Se.Parser=t.Parser,Se.parseString=t.parseString,Se.parseStringPromise=t.parseStringPromise}).call(Se)});var sn=()=>u(void 0,null,function*(){let n=["systems/shadowrun5e/dist/templates/actor/tabs/ActionsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/BioTab.html","systems/shadowrun5e/dist/templates/actor/tabs/MagicTab.html","systems/shadowrun5e/dist/templates/actor/tabs/MatrixTab.html","systems/shadowrun5e/dist/templates/actor/tabs/MiscTab.html","systems/shadowrun5e/dist/templates/actor/tabs/SkillsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/SocialTab.html","systems/shadowrun5e/dist/templates/actor/tabs/SpellsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/EffectsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/CritterPowersTab.html","systems/shadowrun5e/dist/templates/actor/tabs/NetworkTab.html","systems/shadowrun5e/dist/templates/actor/tabs/InventoryTab.html","systems/shadowrun5e/dist/templates/actor/tabs/spirit/SpiritSkillsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/matrix/SpriteSkillsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/matrix/SpritePowersTab.html","systems/shadowrun5e/dist/templates/actor/tabs/vehicle/VehicleSkillsTab.html","systems/shadowrun5e/dist/templates/actor/tabs/vehicle/VehicleMatrixTab.html","systems/shadowrun5e/dist/templates/actor/tabs/ic/ICActorTab.html","systems/shadowrun5e/dist/templates/actor/tabs/ic/ICMiscTab.html","systems/shadowrun5e/dist/templates/actor/parts/Initiative.html","systems/shadowrun5e/dist/templates/actor/parts/Movement.html","systems/shadowrun5e/dist/templates/actor/parts/ProfileImage.html","systems/shadowrun5e/dist/templates/actor/parts/NameInput.html","systems/shadowrun5e/dist/templates/actor/parts/ActionList.html","systems/shadowrun5e/dist/templates/actor/parts/ContactList.html","systems/shadowrun5e/dist/templates/actor/parts/SinAndLifestyleList.html","systems/shadowrun5e/dist/templates/actor/parts/magic/AdeptPowerList.html","systems/shadowrun5e/dist/templates/actor/parts/magic/SpellList.html","systems/shadowrun5e/dist/templates/actor/parts/magic/SpellAndAdeptPowerList.html","systems/shadowrun5e/dist/templates/actor/parts/magic/SpiritOptions.html","systems/shadowrun5e/dist/templates/actor/parts/matrix/ProgramList.html","systems/shadowrun5e/dist/templates/actor/parts/matrix/ComplexFormList.html","systems/shadowrun5e/dist/templates/actor/parts/matrix/MatrixAttribute.html","systems/shadowrun5e/dist/templates/actor/parts/matrix/SpritePowerList.html","systems/shadowrun5e/dist/templates/actor/parts/matrix/DeviceRating.html","systems/shadowrun5e/dist/templates/actor/parts/matrix/Marks.html","systems/shadowrun5e/dist/templates/actor/parts/attributes/Attribute.html","systems/shadowrun5e/dist/templates/actor/parts/attributes/AttributeList.html","systems/shadowrun5e/dist/templates/actor/parts/attributes/SpecialAttributeList.html","systems/shadowrun5e/dist/templates/actor/parts/attributes/Limits.html","systems/shadowrun5e/dist/templates/actor/parts/skills/ActiveSkillList.html","systems/shadowrun5e/dist/templates/actor/parts/skills/LanguageAndKnowledgeSkillList.html","systems/shadowrun5e/dist/templates/actor/parts/vehicle/VehicleStatsList.html","systems/shadowrun5e/dist/templates/actor/parts/vehicle/VehicleSecondStatsList.html","systems/shadowrun5e/dist/templates/actor/parts/vehicle/VehicleMovement.html","systems/shadowrun5e/dist/templates/actor/parts/ic/ICStats.html","systems/shadowrun5e/dist/templates/actor/parts/ic/ICConfiguration.html","systems/shadowrun5e/dist/templates/actor-limited/character.html","systems/shadowrun5e/dist/templates/actor-limited/spirit.html","systems/shadowrun5e/dist/templates/actor-limited/sprite.html","systems/shadowrun5e/dist/templates/actor-limited/vehicle.html","systems/shadowrun5e/dist/templates/actor-limited/critter.html","systems/shadowrun5e/dist/templates/actor-limited/parts/Header.html","systems/shadowrun5e/dist/templates/actor-limited/parts/MiscCharacter.html","systems/shadowrun5e/dist/templates/actor-limited/parts/MiscSpirit.html","systems/shadowrun5e/dist/templates/actor-limited/parts/MiscSprite.html","systems/shadowrun5e/dist/templates/actor-limited/parts/MiscVehicle.html","systems/shadowrun5e/dist/templates/actor-limited/parts/MiscCritter.html","systems/shadowrun5e/dist/templates/item/parts/description.html","systems/shadowrun5e/dist/templates/item/parts/technology.html","systems/shadowrun5e/dist/templates/item/parts/header.html","systems/shadowrun5e/dist/templates/item/parts/weapon-ammo-list.html","systems/shadowrun5e/dist/templates/item/parts/weapon-mods-list.html","systems/shadowrun5e/dist/templates/item/parts/action.html","systems/shadowrun5e/dist/templates/item/parts/action_results.html","systems/shadowrun5e/dist/templates/item/parts/modifier.html","systems/shadowrun5e/dist/templates/item/parts/damage.html","systems/shadowrun5e/dist/templates/item/parts/opposed.html","systems/shadowrun5e/dist/templates/item/parts/spell.html","systems/shadowrun5e/dist/templates/item/parts/complex_form.html","systems/shadowrun5e/dist/templates/item/parts/weapon.html","systems/shadowrun5e/dist/templates/item/parts/armor.html","systems/shadowrun5e/dist/templates/item/parts/matrix.html","systems/shadowrun5e/dist/templates/item/parts/sin.html","systems/shadowrun5e/dist/templates/item/parts/contact.html","systems/shadowrun5e/dist/templates/item/parts/lifestyle.html","systems/shadowrun5e/dist/templates/item/parts/ammo.html","systems/shadowrun5e/dist/templates/item/parts/modification.html","systems/shadowrun5e/dist/templates/item/parts/program.html","systems/shadowrun5e/dist/templates/item/parts/critter_power.html","systems/shadowrun5e/dist/templates/rolls/parts/parts-list.html","systems/shadowrun5e/dist/templates/rolls/parts/Damage.html","systems/shadowrun5e/dist/templates/common/TabWrapper.html","systems/shadowrun5e/dist/templates/common/ValueInput.html","systems/shadowrun5e/dist/templates/common/ValueMaxAttribute.html","systems/shadowrun5e/dist/templates/common/Attribute.html","systems/shadowrun5e/dist/templates/common/ValueModifiers.html","systems/shadowrun5e/dist/templates/common/Select.html","systems/shadowrun5e/dist/templates/common/HorizontalCellInput.html","systems/shadowrun5e/dist/templates/common/HeaderBlock.html","systems/shadowrun5e/dist/templates/common/NameLineBlock.html","systems/shadowrun5e/dist/templates/common/List/ListItem.html","systems/shadowrun5e/dist/templates/common/List/ListEntityItem.html","systems/shadowrun5e/dist/templates/common/List/ListHeader.html","systems/shadowrun5e/dist/templates/apps/dialogs/damage-application.html","systems/shadowrun5e/dist/templates/apps/dialogs/test-dialog.html","systems/shadowrun5e/dist/templates/apps/dialogs/parts/success-test-common.html","systems/shadowrun5e/dist/templates/apps/dialogs/defense-test-dialog.html","systems/shadowrun5e/dist/templates/apps/dialogs/ranged-attack-test-dialog.html","systems/shadowrun5e/dist/templates/apps/dialogs/spellcasting-test-dialog.html","systems/shadowrun5e/dist/templates/apps/dialogs/complexform-test-dialog.html","systems/shadowrun5e/dist/templates/rolls/success-test-message.html","systems/shadowrun5e/dist/templates/rolls/physical-defense-test-message.html","systems/shadowrun5e/dist/templates/rolls/parts/rolled-dice.html","systems/shadowrun5e/dist/templates/rolls/parts/test-opposed-resist.html"];return loadTemplates(n)});var O=class{get list(){return this._list.slice()}get length(){return this._list.length}get total(){let e=0;for(let t of this._list)typeof t.value=="number"&&(e+=t.value);return e}get last(){return this._list[this._list.length-1]}get isEmpty(){return this.length===0}getPartValue(e){var t;return(t=this._list.find(a=>a.name===e))==null?void 0:t.value}clear(){this._list.length=0}constructor(e){let t=[];if(e){if(Array.isArray(e))t=e;else if(typeof e=="object")for(let[a,r]of Object.entries(e))r!=null&&(!isNaN(Number(a))&&typeof r=="object"?t.push({name:r.name,value:r.value}):t.push({name:a,value:r}))}this._list=t}addPart(e,t){this._list.push({name:e,value:t})}addUniquePart(e,t,a=!0){let r=this._list.findIndex(i=>i.name===e);if(r>-1){if(!a||(this._list.splice(r,1),t==null))return;this.addUniquePart(e,t)}else t!==void 0?this.addPart(e,t):console.warn("Shadowrun 5e | PartsList cant add a none-numerical modifier.",e,t)}removePart(e){let t=this._list.findIndex(a=>a.name===e);return t>-1?(this._list.splice(t,1),!0):!1}getMessageOutput(){return this.list}static AddPart(e,t,a){let r=new O(e);return r.addPart(t,a),r._list}static AddUniquePart(e,t,a,r=!0){let i=new O(e);return i.addUniquePart(t,a,r),i._list}static RemovePart(e,t){let a=new O(e);return a.removePart(t),a._list}static Total(e){return new O(e).total}};var V="shadowrun5e",wa=`system.${V}`,j={ShowGlitchAnimation:"showGlitchAnimation",ShowTokenNameForChatOutput:"showTokenNameInsteadOfActor",WhisperOpposedTestsToTargetedPlayers:"whisperOpposedTestsToTargetedPlayers",OnlyAllowRollOnDefaultableSkills:"onlyAllowRollOnDefaultableSkills",ShowSkillsWithDetails:"showSkillsWithDetails",OnlyAutoRollNPCInCombat:"onlyAutoRollNPCInCombat",MessageCustomRoll:"customRoll",ApplyLimits:"applyLimits",LastRollPromptValue:"lastRollPromptValue",DisplayDefaultRollCard:"displayDefaultRollCard",CombatInitiativePass:"combatInitiativePass",EmbeddedItems:"embeddedItems",LastFireMode:"lastFireMode",LastSpellForce:"lastSpellForce",LastComplexFormLevel:"lastComplexFormLevel",LastFireRange:"lastFireRange",Attack:"attack",Roll:"roll",ActionTestData:"actionTestData",TargetsSceneTokenIds:"targetsSceneTokenIds",ChangelogShownForVersion:"changelogShownForVersion",Modifier:"modifier",DoInitPass:"doInitPass",DoNextRound:"doNextRound",addNetworkController:"addNetworkController",TokenHealthBars:"tokenHealthBars",Test:"TestData"},Va="core",Ua={RollMode:"rollMode"},Ai="SR5.Character.Modifiers.NPCMetatypeAttribute",ki={m:1,meter:1,meters:1,km:1e3,kilometers:1e3,kilometer:1e3},on="Roll",Ha="m",$a="",ln=16,K={combat:{environmental:{range_modifiers:{short:0,medium:-1,long:-3,extreme:-6,out_of_range:0},levels:{good:0,light:-1,moderate:-3,heavy:-6,extreme:-10}},INI_RESULT_MOD_AFTER_INI_PASS:-10,INITIAL_INI_PASS:1,INITIAL_INI_ROUND:1},die:{glitch:[1],success:[5,6]},defense:{spell:{direct:{mana:"willpower",physical:"body"}}},attributes:{ranges:{magic:{min:0},edge:{min:0},resonance:{min:0},essence:{min:0},body:{min:1},agility:{min:1},reaction:{min:1},strength:{min:1},willpower:{min:1},logic:{min:1},intuition:{min:1},charisma:{min:1},attack:{min:0},sleaze:{min:0},data_processing:{min:0},firewall:{min:0},host_rating:{min:0,max:12}},defaults:{essence:6},SHORT_NAME_LENGTH:3},skill:{DEFAULTING_MODIFIER:-1,SPECIALIZATION_MODIFIER:2},initiatives:{ic:{dice:4},ranges:{base:{min:0},dice:{min:0,max:5}}}};var It=class extends Dialog{constructor(t,a){super(t,a);let{templateData:r,templatePath:i}=t;this._templateData=r,this._templatePath=i,this._onAfterClose=t.onAfterClose||this.onAfterClose,this.selection=this._emptySelection(),this._selectionPromise=new Promise((s,o)=>{this._selectionResolve=s,this._selectionReject=o})}close(){return u(this,null,function*(){yield Y(It.prototype,this,"close").call(this),this.canceled&&setTimeout(()=>this._selectionResolve(this.selection),250)})}activateListeners(t){super.activateListeners(t),t.on("change","input,select,textarea",this._onChangeInput.bind(this))}submit(t){return u(this,null,function*(){var a;this.selectedButton=(a=t.name)!=null?a:t.label,this.applyFormData(),Y(It.prototype,this,"submit").call(this,t),yield this.afterSubmit("jQuery"in this.options?this.element:this.element[0])})}afterSubmit(t){return u(this,null,function*(){this.selection=yield this._onAfterClose(t,this.selectedButton),setTimeout(()=>this._selectionResolve(this.selection),250)})}applyFormData(){if(!this.options.applyFormChangesOnSubmit)return;if(!this.form)throw new Error("The FormApplication subclass has no registered form element");let a=new FormDataExtended(this.form,{editors:{}}).toObject();this._updateData(a)}_updateData(t){foundry.utils.mergeObject(this.data.templateData,t)}getData(){this.data.buttons=this.data.buttons||this.buttons,this._amendButtonsWithName(this.data.buttons);let t=super.getData();return mergeObject(t,ut(J({},this.data),{content:""}))}get buttons(){return{}}get templateContent(){return""}select(){return u(this,null,function*(){return yield this.render(!0),this._selectionPromise===void 0||this.selection===void 0?this._emptySelection():yield this._selectionPromise})}_emptySelection(){return{}}get selected(){return!this.canceled}get canceled(){return!this.selectedButton||this.selectedButton==="cancel"}static getButtons(){return{}}_amendButtonsWithName(t){Object.keys(t).forEach(a=>t[a].name=a)}_renderInner(t){return u(this,null,function*(){(t.templatePath||this.templateContent)&&(t.content=yield renderTemplate(t.templatePath||this.templateContent,t.templateData||t));let r=yield Y(It.prototype,this,"_renderInner").call(this,t);return this.form=r.filter((i,s)=>s instanceof HTMLFormElement)[0],this.form||(this.form=r.find("form")[0]),r})}_onChangeInput(t){return u(this,null,function*(){let a=t.target;this.options.applyFormChangesOnSubmit&&(this.applyFormData(),this.render())})}onAfterClose(t){}};var Je=class extends It{constructor(e){let t=Je.getDialogData();super(t,e)}static getDialogData(){return{title:game.i18n.localize("SR5.DeleteConfirmationApplication.Title"),buttons:{delete:{label:game.i18n.localize("SR5.DeleteConfirmationApplication.Delete")},cancel:{label:game.i18n.localize("SR5.DeleteConfirmationApplication.Cancel")}},default:"cancel",templateData:{},templatePath:"systems/shadowrun5e/dist/templates/apps/dialogs/delete-confirmation-dialog.html"}}static get defaultOptions(){let e=super.defaultOptions;return e.id="delete-confirmation-application",e.classes=["sr5","form-dialog"],e.resizable=!0,e.height="auto",e}};var P=class{static damageData(e={}){let t={type:{base:"physical",value:"physical"},element:{base:"",value:""},base:0,value:0,ap:{base:0,value:0,mod:[]},attribute:"",mod:[],base_formula_operator:"add",source:{actorId:"",itemId:"",itemType:"",itemName:""}};return mergeObject(t,e)}static actorArmorData(e={}){return mergeObject({value:0,mod:[],base:0,label:""},e)}static equipmentData(e={}){return mergeObject({description:this.descriptionData(),technology:this.technologyData()},e)}static qualityData(e={}){return mergeObject({type:"",description:this.descriptionData(),action:this.actionRollData()},e)}static technologyData(e={}){return mergeObject({rating:"",availability:"",quantity:1,cost:0,equipped:!1,conceal:{base:0,value:0,mod:[]},condition_monitor:{label:"",value:0,max:0},wireless:!0,networkController:void 0},e)}static descriptionData(e={}){return mergeObject({value:"",chat:"",source:""},e)}static matrixData(e={}){return e.category===void 0&&delete e.category,e.atts===void 0&&delete e.atts,mergeObject({category:"",atts:{att1:{value:0,att:"attack",editable:!0},att2:{value:0,att:"attack",editable:!0},att3:{value:0,att:"attack",editable:!0},att4:{value:0,att:"attack",editable:!0}},networkDevices:[]},e)}static actionRollData(e={}){return mergeObject({type:"",category:"",attribute:"",attribute2:"",skill:"",spec:!1,mod:0,mod_description:"",limit:this.limitData(),extended:!1,damage:this.damageData(),opposed:this.opposedTestData(),alt_mod:0,dice_pool_mod:[]},e)}static actionResultData(e={}){return mergeObject({success:{matrix:{placeMarks:!1}}})}static limitData(e={}){return mergeObject({value:0,base:0,attribute:"",mod:[]},e)}static opposedTestData(e={}){return mergeObject({type:"",attribute:"",attribute2:"",skill:"",mod:0,description:""},e)}static skillData(e={}){return mergeObject({name:$a,base:0,value:0,hidden:!1,canDefault:!1,label:"",bonus:[],specs:[],mod:[],attribute:""},e)}static trackData(e={}){return mergeObject({value:0,max:0,label:"",mod:[],disabled:!1,wounds:0},e)}static hostData(e={}){return mergeObject(ut(J({description:P.descriptionData(e.description)},P.matrixData({category:e.category,atts:e.atts})),{rating:0,ic:[]}),e)}static sourceEntityData(e={}){return mergeObject({id:"",name:"",pack:null,type:"Actor",data:e.data||void 0},e)}static equipmentItemData(e={}){var t,a;return mergeObject({name:"",type:"equipment",data:{description:P.descriptionData(((t=e.data)==null?void 0:t.description)||{}),technology:P.technologyData(((a=e.data)==null?void 0:a.technology)||{})}},e)}static deviceItemData(e={}){var t,a,r,i;return mergeObject({name:"",type:"device",data:J({description:P.descriptionData(((t=e.data)==null?void 0:t.description)||{}),technology:P.technologyData(((a=e.data)==null?void 0:a.technology)||{})},P.matrixData({category:(r=e.data)==null?void 0:r.category,atts:(i=e.data)==null?void 0:i.atts}))},e)}static valueData(e={}){return mergeObject({base:0,value:0,temp:0,mod:[],label:""},e)}static genericValueData(e={}){return mergeObject({base:0,value:0,temp:0,mod:[],label:""},e)}static minimalActionData(e={}){return mergeObject({attribute:"",attribute2:"",skill:"",mod:0,armor:!1},e)}static actionData(e={}){return mergeObject({test:"",type:"",category:"",attribute:"",attribute2:"",skill:"",spec:!1,mod:0,mod_description:"",damage:P.damageData(),modifiers:[],limit:{value:0,attribute:"",mod:[],base:0},threshold:{value:0,base:0},extended:!1,opposed:{type:"",test:"",attribute:"",attribute2:"",skill:"",mod:0,description:""},followed:{test:"",attribute:"",attribute2:"",skill:"",mod:0},alt_mod:0,dice_pool_mod:[]},e)}},ja={grunt:{metatype_modifiers:{elf:{attributes:{agility:1,charisma:2,edge:-1}},ork:{attributes:{body:3,strength:2,logic:-1,charisma:-1,edge:-1}},troll:{attributes:{body:4,agility:-1,strength:4,logic:-1,intuition:-1,charisma:-2,edge:-1},general:{armor:1}},dwarf:{attributes:{body:2,reaction:-1,strength:2,willpower:1,edge:-1}}}},damage:P.damageData({type:{base:"",value:""}})};var w=class{static calcTotal(e,t){e.mod===void 0&&(e.mod=[]);let a=new O(e.mod);if(!isNaN(e.temp)&&Number(e.temp)>0&&a.addUniquePart("SR5.Temporary",e.temp),e.base=e.base!==void 0?e.base:0,e.override)return e.value=w.applyValueRange(e.override.value,t),e.value;switch(getType(e.base)){case"number":e.value=w.roundTo(a.total+e.base,3),e.value=w.applyValueRange(e.value,t);break;default:e.value=a.last===void 0?e.base:a.last;break}return e.mod=a.list,e.value}static roundTo(e,t){let a=Math.pow(10,t);return Math.round(e*a)/a}static applyValueRange(e,t){return typeof(t==null?void 0:t.min)=="number"&&(e=Math.max(t.min,e)),typeof(t==null?void 0:t.max)=="number"&&(e=Math.min(t.max,e)),e}static listItemId(e){return e.currentTarget.closest(".list-item").dataset.itemId}static onSetFlag(e){if(typeof e!="object"||e==null)return e;let t={};for(let[a,r]of Object.entries(e)){let i=a.replace("SR5.","SR5_DOT_");t[i]=this.onSetFlag(r)}return t}static onGetFlag(e){if(typeof e!="object"||e==null)return e;let t={};for(let[a,r]of Object.entries(e)){let i=a.replace("SR5_DOT_","SR5.");t[i]=this.onGetFlag(r)}return t}static isMatrix(e){var a;if(!e)return!1;if(typeof e=="boolean")return e;let t=["SR5.MatrixAttrFirewall","SR5.MatrixAttrDataProcessing","SR5.MatrixAttrSleaze","SR5.MatrixAttrAttack","SR5.SkillComputer","SR5.SkillHacking","SR5.SkillCybercombat","SR5.SkillElectronicWarfare","SR5.Software"];Array.isArray(e)||(e=[e]),e=e.filter(r=>r);for(let r of e)if(typeof r=="string"){if(t.indexOf(r)>=0)return!0}else if(typeof r=="object"&&r.label!==void 0&&t.indexOf((a=r.label)!=null?a:"")>=0)return!0;return!1}static parseInputToString(e){return e===void 0?"":typeof e=="number"?e.toString():typeof e=="string"?e:Array.isArray(e)?e.join(","):""}static parseInputToNumber(e){if(typeof e=="number")return e;if(typeof e=="string"){let t=+e;return isNaN(t)?0:t}if(Array.isArray(e)){let a=+e.join("");return isNaN(a)?0:a}return 0}static setupCustomCheckbox(e,t){let a=r=>{let i=$(r).children("input[type=checkbox]"),s=$(r).children(".checkmark");$(i).prop("checked")?($(s).addClass("fa-check-circle"),$(s).removeClass("fa-circle")):($(s).addClass("fa-circle"),$(s).removeClass("fa-check-circle"))};t.find("label.checkbox").each(function(){a(this)}),t.find("label.checkbox").click(r=>a(r.currentTarget)),t.find(".submit-checkbox").change(r=>e._onSubmit(r))}static mapRoundsToDefenseMod(e){return e===1?0:e===3?-2:e===6?-5:e===10?-9:0}static mapRoundsToDefenseDesc(e){return e===1?"":e===3?"-2":e===6?"-5":e===10?"-9":e===20?"SR5.DuckOrCover":""}static label(e){let t=e.split("_");for(let a=0;a<t.length;a++)t[a]=t[a].charAt(0).toUpperCase()+t[a].slice(1);return t.forEach((a,r)=>{a==="Processing"&&(t[r]="Proc."),a==="Mechanic"&&(t[r]="Mech.")}),t.join(" ")}static orderKeys(e){let t=Object.keys(e).sort(function(s,o){return s<o?-1:s>o?1:0}),a,r={};for(a=0;a<t.length;a++)r[t[a]]=e[t[a]],delete e[t[a]];for(a=0;a<t.length;a++)e[t[a]]=r[t[a]];return e}static hasModifiers(e){return e&&(e.shiftKey||e.altKey||e.ctrlKey||e.metaKey)}static filter(e,t){let a={};return typeof e=="object"&&e!==null&&Object.entries(e).forEach(([r,i])=>{t([r,i])&&(a[r]=i)}),a}static addLabels(e,t){typeof e=="object"&&e!==null&&(!e.hasOwnProperty("label")&&e.hasOwnProperty("value")&&t!==""&&(e.label=t),Object.entries(e).filter(([,a])=>typeof a=="object").forEach(([a,r])=>w.addLabels(r,a)))}static shortenAttributeLocalization(e,t=3){let a=game.i18n.localize(e);return t<=0?a:(a.length<t&&(t=a.length),a.slice(0,t).toUpperCase())}static getToken(e){if(!(!canvas||!canvas.ready||!canvas.tokens)){for(let t of canvas.tokens.placeables)if(t.id===e)return t}}static getSceneTokenActor(e){let[t,a]=w.deconstructSceneTokenId(e),r=w.getSceneTokenDocument(t,a);return r?r.getActor():null}static deconstructSceneTokenId(e){return e.split(".")}static getSceneTokenDocument(e,t){var i;let a=(i=game.scenes)==null?void 0:i.get(e);if(!a)return;let r=a.tokens.get(t);if(!!r)return r}static getUserTargets(e){return e=e||game.user,e?Array.from(e.targets):[]}static userHasTargets(e){return e=e||game.user,e?e.targets.size>0:!1}static measureTokenDistance(e,t){if(!canvas||!canvas.ready||!canvas.scene||!canvas.grid||!e||!t)return 0;let a=new PIXI.Point(...canvas.grid.getCenter(e.data.x,e.data.y)),r=new PIXI.Point(...canvas.grid.getCenter(t.data.x,t.data.y)),i=canvas.grid.measureDistance(a,r),s=canvas.scene.data.gridUnits;return w.convertLengthUnit(i,s)}static convertLengthUnit(e,t){return t=t.toLowerCase(),ki.hasOwnProperty(t)?Math.floor(e*ki[t]):(console.error(`Distance can't be converted from ${t} to ${Ha}`),0)}static getWeaponRange(e,t){let a=Object.keys(t).find(r=>e<t[r].distance);if(a)return t[a];{let{extreme:r}=t;return w.createRangeDescription("SR5.OutOfRange",r.distance,K.combat.environmental.range_modifiers.out_of_range)}}static getControlledTokens(){return!canvas||!canvas.ready||!canvas.tokens?[]:canvas.tokens.controlled}static getTargetedTokens(){return!canvas.ready||!game.user?[]:Array.from(game.user.targets)}static getSelectedActorsOrCharacter(){if(!game.user)return[];let t=w.getControlledTokens().map(a=>a.actor);return t.length===0&&game.user.character&&t.push(game.user.character),t}static createRangeDescription(e,t,a){return e=game.i18n.localize(e),{label:e,distance:t,modifier:a}}static convertIndexedObjectToArray(e){return Object.keys(e).map(t=>(Number.isNaN(t)&&console.warn("An object with no numerical index was given, which is likely a bug.",e),e[t]))}static getChatSpeakerName(e){if(!e)return"";let t=game.settings.get(V,j.ShowTokenNameForChatOutput),a=e.getToken();return t&&a?a.data.name:e.name}static createDamageData(e,t,a=0,r="",i){let s=duplicate(ja.damage);return s.base=e,s.value=e,s.type.base=t,s.type.value=t,s.ap.base=a,s.ap.value=a,s.element.base=r,s.element.value=r,i&&i.actor&&(s.source={actorId:i.actor.id,itemType:i.type,itemId:i.id,itemName:i.name}),s}static findDamageSource(e){if(!game.actors||!e.source)return;let t=e.source.actorId,a=game.actors.get(t);if(!a)return;let r=e.source.itemId,i=a.items.get(r);if(i)return i;let s=a.getActiveTokens(),o;return s.forEach(l=>{if(!l.actor)return;let c=l.actor.items.get(r);c&&(o=c)}),o}static modifyDamageByHits(e,t,a){let r=duplicate(e);return r.mod=O.AddUniquePart(r.mod,a,t),r.value=w.calcTotal(r,{min:0}),{incoming:e,modified:r}}static reduceDamageByHits(e,t,a){return t<0&&(t=0),w.modifyDamageByHits(e,-t,a)}static confirmDeletion(){return u(this,null,function*(){let e=new Je;return yield e.select(),!e.canceled&&e.selectedButton==="delete"})}static getRandomIdSkillFieldDataEntry(e,t,a=ln){if(!e||e.length===0)return;let r=randomID(a),i={[e]:{[r]:t}};return{id:r,updateSkillData:i}}static getUpdateDataEntry(e,t){return{[e]:t}}static getDeleteKeyUpdateData(e,t){return{[e]:{[`-=${t}`]:null}}}static localizeSkill(e){return e.label?game.i18n.localize(e.label):e.name}static sortSkills(e,t=!0){let a=Object.entries(e).sort(([i,s],[o,l])=>{let c=w.localizeSkill(s)||i,d=w.localizeSkill(l)||o;return t?c.localeCompare(d)===1?1:-1:c.localeCompare(d)===1?-1:1}),r={};for(let[i,s]of a)r[i]=s;return r}static sortConfigValuesByTranslation(e,t=!0){let a=Object.entries(e).sort(([i,s],[o,l])=>{let c=game.i18n.localize(s),d=game.i18n.localize(l);return t?c.localeCompare(d)===1?1:-1:c.localeCompare(d)===1?-1:1}),r={};for(let[i,s]of a)r[i]=s;return r}static getPlayersWithPermission(e,t,a=!0){return game.users?game.users.filter(r=>!(r.isGM||!e.testUserPermission(r,t)||a&&!r.active)):[]}static getSkillLabelOrName(e){return e.label?game.i18n.localize(e.label):e.name||""}static showDiceSoNice(e,t,a=!1){return u(this,null,function*(){if(!game.dice3d)return;let r=(t==null?void 0:t.length)===0||t===null;t=(t==null?void 0:t.length)>0?t:null,yield game.dice3d.showForRoll(e,game.user,r,t,a),console.error(game.dice3d)})}static getEntityFromDropData(e){return u(this,null,function*(){if(!(!game.actors||!game.items)){if(e.pack&&e.type==="Actor")return yield w.getEntityFromCollection(e.pack,e.id);if(e.pack&&e.type==="Item")return yield w.getEntityFromCollection(e.pack,e.id);if(e.type==="Actor")return game.actors.get(e.id);if(e.type==="Item")return game.items.get(e.id)}})}static getEntityFromCollection(e,t){return u(this,null,function*(){return yield game.packs.find(r=>r.collection===e).getDocument(t)})}static isValidMarkId(e){if(!game.scenes)return!1;let[t,a,r]=w.deconstructMarkId(e),i=game.scenes.get(t);if(!i)return!1;let s=i.tokens.get(a);if(!s)return!1;let o=s.actor;return!(r&&!(o!=null&&o.items.get(r)))}static buildMarkId(e,t,a,r="/"){return[e,t,a||""].join(r)}static deconstructMarkId(e,t="/"){let a=e.split(t);return a.length!==3&&console.error("A mark id must always be of length 3"),a}static getMarkIdDocuments(e){var l,c;if(!game.scenes||!game.items)return;let[t,a,r]=w.deconstructMarkId(e),i=game.scenes.get(t);if(!i)return;let s=i.tokens.get(a)||game.items.get(a),o=(c=(l=s==null?void 0:s.actor)==null?void 0:l.items)==null?void 0:c.get(r);return{scene:i,target:s,item:o}}static objectHasKeys(e,t){for(let a of t)if(!e.hasOwnProperty(a))return!1;return!0}static getPackAction(e,t){return u(this,null,function*(){console.info(`Shadowrun 5e | Trying to fetch action ${t} from pack ${e}`);let a=game.packs.find(s=>s.metadata.system===V&&s.metadata.name===e);if(!a)return;let r=a.index.find(s=>{var o;return((o=s.name)==null?void 0:o.toLowerCase().replace(new RegExp(" ","g"),"_"))===t.toLowerCase()});if(!r)return;let i=yield a.getDocument(r._id);if(!(!i||i.type!=="action"))return console.info(`Shadowrun5e | Fetched action ${t} from pack ${e}`,i),i})}static renderEntityLinkSheet(e){return u(this,null,function*(){let a=$(e.currentTarget).data("uuid");yield w.renderDocumentSheet(a)})}static renderDocumentSheet(e,t=!0){return u(this,null,function*(){if(!e)return;let a=yield fromUuid(e);!a||(a instanceof TokenDocument&&t&&a.actor&&(a=a.actor),yield a.sheet.render(!0))})}};var cn=()=>{Handlebars.registerHelper("damageAbbreviation",function(n){return n==="physical"?"P":n==="stun"?"S":n==="matrix"?"M":""}),Handlebars.registerHelper("damageCode",function(n){let e=Handlebars.helpers.damageAbbreviation(n.type.value),t=`${n.value}${e}`;return new Handlebars.SafeString(t)}),Handlebars.registerHelper("diceIcon",function(n){if(n)switch(n){case 1:return"red";case 2:return"grey";case 3:return"grey";case 4:return"grey";case 5:return"green";case 6:return"green"}}),Handlebars.registerHelper("elementIcon",function(n){let e="";return n==="electricity"?e="fas fa-bolt":n==="radiation"?e="fas fa-radiation-alt":n==="fire"?e="fas fa-fire":n==="acid"?e="fas fa-vials":n==="cold"&&(e="fas fa-snowflake"),e}),Handlebars.registerHelper("partsTotal",function(n){return new O(n).total}),Handlebars.registerHelper("signedValue",function(n){return n>0?`+${n}`:`${n}`}),Handlebars.registerHelper("speakerName",w.getChatSpeakerName)};var Ga=class{constructor(e){this.data=e}};var ne=class extends Ga{getType(){return this.data.type}getData(){return this.data.data}isAreaOfEffect(){return this.isGrenade()||this.isSpell()&&this.getData().range==="los_a"}isArmor(){return this.data.type==="armor"}couldHaveArmor(){let e=this.getData().armor;return this.isArmor()||e!==void 0}hasArmorBase(){var e;return this.hasArmor()&&!((e=this.getData().armor)!=null&&e.mod)}hasArmorAccessory(){var e,t;return this.hasArmor()&&((t=(e=this.getData().armor)==null?void 0:e.mod)!=null?t:!1)}hasArmor(){return this.getArmorValue()>0}isGrenade(){var e,t;return this.isThrownWeapon()&&((t=(e=this.getData().thrown)==null?void 0:e.blast.radius)!=null?t:0)>0}isThrownWeapon(){return this.isWeapon()&&this.getData().category==="thrown"}isWeapon(){return this.data.type==="weapon"}isModification(){return this.data.type==="modification"}isWeaponModification(){return this.isModification()?this.data.data.type==="weapon":!1}isArmorModification(){return this.isModification()?this.data.data.type==="armor":!1}isProgram(){return this.data.type==="program"}isQuality(){return this.data.type==="quality"}isAmmo(){return this.data.type==="ammo"}isCyberware(){return this.data.type==="cyberware"}isBioware(){return this.data.type==="bioware"}isBodyware(){return this.isCyberware()||this.isBioware()}isCombatSpell(){return this.isSpell()&&this.getData().category==="combat"}isDirectCombatSpell(){var e,t;return this.isCombatSpell()?((t=(e=this.getData())==null?void 0:e.combat)==null?void 0:t.type)==="direct":!1}isIndirectCombatSpell(){var e,t;return this.isCombatSpell()?((t=(e=this.getData())==null?void 0:e.combat)==null?void 0:t.type)==="indirect":!1}isManaSpell(){return this.isSpell()?this.getData().type==="mana":!1}isPhysicalSpell(){return this.isSpell()?this.getData().type==="physical":!1}isRangedWeapon(){return this.isWeapon()&&this.getData().category==="range"}isSpell(){return this.data.type==="spell"}isSpritePower(){return this.data.type==="sprite_power"}isComplexForm(){return this.data.type==="complex_form"}isContact(){return this.data.type==="contact"}isCritterPower(){return this.data.type==="critter_power"}isMeleeWeapon(){return this.data.type==="weapon"&&this.getData().category==="melee"}isDevice(){return this.data.type==="device"}isEquipment(){return this.data.type==="equipment"}isEquipped(){var e;return((e=this.getData().technology)==null?void 0:e.equipped)||!1}isCyberdeck(){return this.isDevice()&&this.getData().category==="cyberdeck"}isCommlink(){return this.isDevice()&&this.getData().category==="commlink"}isMatrixAction(){return this.isAction()&&this.getData().result.success.matrix.placeMarks}isSin(){return this.data.type==="sin"}isLifestyle(){return this.data.type==="lifestyle"}getId(){return this.data._id}getBookSource(){var e,t;return(t=(e=this.getData().description)==null?void 0:e.source)!=null?t:""}getConditionMonitor(){var e,t;return(t=(e=this.getData().technology)==null?void 0:e.condition_monitor)!=null?t:{value:0,max:0,label:""}}getRating(){var e;return((e=this.getData().technology)==null?void 0:e.rating)||0}getArmorValue(){var e,t,a;return(a=(t=(e=this.getData())==null?void 0:e.armor)==null?void 0:t.value)!=null?a:0}getArmorElements(){let{fire:e,electricity:t,cold:a,acid:r}=this.getData().armor||{};return{fire:e!=null?e:0,electricity:t!=null?t:0,cold:a!=null?a:0,acid:r!=null?r:0}}getName(){return this.data.name}getEssenceLoss(){var e,t;return(t=(e=this.getData())==null?void 0:e.essence)!=null?t:0}getAmmo(){return this.getData().ammo}getASDF(){if(!this.isDevice())return;let e={attack:{value:0,device_att:""},sleaze:{value:0,device_att:""},data_processing:{value:this.getRating(),device_att:""},firewall:{value:this.getRating(),device_att:""}};if(this.isCyberdeck()){let t=this.getData().atts;if(t)for(let[a,r]of Object.entries(t))e[r.att].value=r.value,e[r.att].device_att=a}return e}getQuantity(){var e,t;return((t=(e=this.getData())==null?void 0:e.technology)==null?void 0:t.quantity)||1}isAction(){return this.data.type==="action"}getAction(){return this.getData().action}getActionDicePoolMod(){var e;return(e=this.getData().action)==null?void 0:e.mod}getLimitAttribute(){var e,t;return(t=(e=this.getData().action)==null?void 0:e.limit)==null?void 0:t.attribute}getActionSkill(){var e;return(e=this.getData().action)==null?void 0:e.skill}getActionAttribute(){var e;return(e=this.getData().action)==null?void 0:e.attribute}getActionAttribute2(){var e;return(e=this.getData().action)==null?void 0:e.attribute2}getActionLimit(){var e,t;return(t=(e=this.getData().action)==null?void 0:e.limit)==null?void 0:t.value}getModifierList(){var e;return((e=this.getData().action)==null?void 0:e.dice_pool_mod)||[]}getActionSpecialization(){var e;if((e=this.getData().action)!=null&&e.spec)return"SR5.Specialization"}getDrain(){return this.getData().drain||0}getFade(){return this.getData().fade||0}getRecoilCompensation(){var t,a,r;if(!this.isRangedWeapon())return 0;let e=(r=(a=(t=this.getData())==null?void 0:t.range)==null?void 0:a.rc.value)!=null?r:"0";return Number(e)}getReach(){var e,t;return this.isMeleeWeapon()&&(t=(e=this.getData().melee)==null?void 0:e.reach)!=null?t:0}getTechnology(){if("technology"in this.data.data)return this.data.data.technology}getRange(){if("range"in this.data.data){if(this.data.type==="critter_power")return this.data.data.range;if(this.data.type==="spell")return this.data.data.range;if(this.data.type==="weapon")return this.data.data.range}}hasDefenseTest(){var e,t;return((t=(e=this.getData().action)==null?void 0:e.opposed)==null?void 0:t.type)==="defense"}hasAmmo(){return!!this.getAmmo()}getActionResult(){return this.getData().result}};var q={itemTypes:{action:"SR5.ItemTypes.Action",adept_power:"SR5.ItemTypes.AdeptPower",ammo:"SR5.ItemTypes.Ammo",armor:"SR5.ItemTypes.Armor",complex_form:"SR5.ItemTypes.ComplexForm",contact:"SR5.ItemTypes.Contact",critter_power:"SR5.ItemTypes.CritterPower",cyberware:"SR5.ItemTypes.Cyberware",bioware:"SR5.ItemTypes.Bioware",device:"SR5.ItemTypes.Device",equipment:"SR5.ItemTypes.Equipment",lifestyle:"SR5.ItemTypes.Lifestyle",modification:"SR5.ItemTypes.Modification",quality:"SR5.ItemTypes.Quality",sin:"SR5.ItemTypes.Sin",spell:"SR5.ItemTypes.Spell",weapon:"SR5.ItemTypes.Weapon",host:"SR5.ItemTypes.Host"},attributes:{agility:"SR5.AttrAgility",attack:"SR5.MatrixAttrAttack",body:"SR5.AttrBody",charisma:"SR5.AttrCharisma",data_processing:"SR5.MatrixAttrDataProc",edge:"SR5.AttrEdge",essence:"SR5.AttrEssence",firewall:"SR5.MatrixAttrFirewall",intuition:"SR5.AttrIntuition",logic:"SR5.AttrLogic",magic:"SR5.AttrMagic",reaction:"SR5.AttrReaction",resonance:"SR5.AttrResonance",sleaze:"SR5.MatrixAttrSleaze",strength:"SR5.AttrStrength",willpower:"SR5.AttrWillpower"},limits:{physical:"SR5.LimitPhysical",social:"SR5.LimitSocial",mental:"SR5.LimitMental",attack:"SR5.MatrixAttrAttack",sleaze:"SR5.MatrixAttrSleaze",data_processing:"SR5.MatrixAttrDataProc",firewall:"SR5.MatrixAttrFirewall"},specialTypes:{mundane:"SR5.Mundane",magic:"SR5.Awakened",resonance:"SR5.Emerged"},damageTypes:{physical:"SR5.DmgTypePhysical",stun:"SR5.DmgTypeStun",matrix:"SR5.DmgTypeMatrix"},elementTypes:{fire:"SR5.ElementFire",cold:"SR5.ElementCold",acid:"SR5.ElementAcid",electricity:"SR5.ElementElectricity",radiation:"SR5.ElementRadiation"},spellCategories:{combat:"SR5.SpellCatCombat",detection:"SR5.SpellCatDetection",health:"SR5.SpellCatHealth",illusion:"SR5.SpellCatIllusion",manipulation:"SR5.SpellCatManipulation"},spellTypes:{physical:"SR5.SpellTypePhysical",mana:"SR5.SpellTypeMana"},spellRanges:{touch:"SR5.SpellRangeTouch",los:"SR5.SpellRangeLos",los_a:"SR5.SpellRangeLosA"},combatSpellTypes:{direct:"SR5.SpellCombatDirect",indirect:"SR5.SpellCombatIndirect"},detectionSpellTypes:{directional:"SR5.SpellDetectionDirectional",psychic:"SR5.SpellDetectionPsychic",area:"SR5.SpellDetectionArea"},illusionSpellTypes:{obvious:"SR5.SpellIllusionObvious",realistic:"SR5.SpellIllusionRealistic"},illusionSpellSenses:{"single-sense":"SR5.SpellIllusionSingleSense","multi-sense":"SR5.SpellIllusionMultiSense"},attributeRolls:{composure:"SR5.RollComposure",lift_carry:"SR5.RollLiftCarry",judge_intentions:"SR5.RollJudgeIntentions",memory:"SR5.RollMemory"},matrixTargets:{persona:"SR5.TargetPersona",device:"SR5.TargetDevice",file:"SR5.TargetFile",self:"SR5.TargetSelf",sprite:"SR5.TargetSprite",other:"SR5.TargetOther"},durations:{instant:"SR5.DurationInstant",sustained:"SR5.DurationSustained",permanent:"SR5.DurationPermanent"},weaponCategories:{range:"SR5.WeaponCatRange",melee:"SR5.WeaponCatMelee",thrown:"SR5.WeaponCatThrown"},weaponRanges:{short:"SR5.WeaponRangeShort",medium:"SR5.WeaponRangeMedium",long:"SR5.WeaponRangeLong",extreme:"SR5.WeaponRangeExtreme"},qualityTypes:{positive:"SR5.QualityTypePositive",negative:"SR5.QualityTypeNegative"},adeptPower:{types:{active:"SR5.AdeptPower.Types.Active",passive:"SR5.AdeptPower.Types.Passive"}},deviceCategories:{commlink:"SR5.DeviceCatCommlink",cyberdeck:"SR5.DeviceCatCyberdeck"},cyberwareGrades:{standard:"SR5.CyberwareGradeStandard",alpha:"SR5.CyberwareGradeAlpha",beta:"SR5.CyberwareGradeBeta",delta:"SR5.CyberwareGradeDelta",used:"SR5.CyberwareGradeUsed"},knowledgeSkillCategories:{street:"SR5.KnowledgeSkillStreet",academic:"SR5.KnowledgeSkillAcademic",professional:"SR5.KnowledgeSkillProfessional",interests:"SR5.KnowledgeSkillInterests"},activeSkills:{archery:"SR5.SkillArchery",automatics:"SR5.SkillAutomatics",blades:"SR5.SkillBlades",clubs:"SR5.SkillClubs",exotic_melee:"SR5.SkillExoticMelee",exotic_range:"SR5.SkillExoticRange",heavy_weapons:"SR5.SkillHeavyWeapons",longarms:"SR5.SkillLongarms",pistols:"SR5.SkillPistols",throwing_weapons:"SR5.SkillThrowingWeapons",unarmed_combat:"SR5.SkillUnarmedCombat",disguise:"SR5.SkillDisguise",diving:"SR5.SkillDiving",escape_artist:"SR5.SkillEscapeArtist",free_fall:"SR5.SkillFreeFall",gymnastics:"SR5.SkillGymnastics",palming:"SR5.SkillPalming",perception:"SR5.SkillPerception",running:"SR5.SkillRunning",sneaking:"SR5.SkillSneaking",survival:"SR5.SkillSurvival",swimming:"SR5.SkillSwimming",tracking:"SR5.SkillTracking",con:"SR5.SkillCon",etiquette:"SR5.SkillEtiquette",impersonation:"SR5.SkillImpersonation",instruction:"SR5.SkillInstruction",intimidation:"SR5.SkillIntimidation",leadership:"SR5.SkillLeadership",negotiation:"SR5.SkillNegotiation",performance:"SR5.SkillPerformance",alchemy:"SR5.SkillAlchemy",arcana:"SR5.SkillArcana",artificing:"SR5.SkillArtificing",assensing:"SR5.SkillAssensing",astral_combat:"SR5.SkillAstralCombat",banishing:"SR5.SkillBanishing",binding:"SR5.SkillBinding",counterspelling:"SR5.SkillCounterspelling",disenchanting:"SR5.SkillDisenchanting",ritual_spellcasting:"SR5.SkillRitualSpellcasting",spellcasting:"SR5.SkillSpellcasting",summoning:"SR5.SkillSummoning",compiling:"SR5.SkillCompiling",decompiling:"SR5.SkillDecompiling",registering:"SR5.SkillRegistering",aeronautics_mechanic:"SR5.SkillAeronauticsMechanic",automotive_mechanic:"SR5.SkillAutomotiveMechanic",industrial_mechanic:"SR5.SkillIndustrialMechanic",nautical_mechanic:"SR5.SkillNauticalMechanic",animal_handling:"SR5.SkillAnimalHandling",armorer:"SR5.SkillArmorer",artisan:"SR5.SkillArtisan",biotechnology:"SR5.SkillBiotechnology",chemistry:"SR5.SkillChemistry",computer:"SR5.SkillComputer",cybercombat:"SR5.SkillCybercombat",cybertechnology:"SR5.SkillCybertechnology",demolitions:"SR5.SkillDemolitions",electronic_warfare:"SR5.SkillElectronicWarfare",first_aid:"SR5.SkillFirstAid",forgery:"SR5.SkillForgery",hacking:"SR5.SkillHacking",hardware:"SR5.SkillHardware",locksmith:"SR5.SkillLocksmith",medicine:"SR5.SkillMedicine",navigation:"SR5.SkillNavigation",software:"SR5.SkillSoftware",gunnery:"SR5.SkillGunnery",pilot_aerospace:"SR5.SkillPilotAerospace",pilot_aircraft:"SR5.SkillPilotAircraft",pilot_walker:"SR5.SkillPilotWalker",pilot_ground_craft:"SR5.SkillPilotGroundCraft",pilot_water_craft:"SR5.SkillPilotWaterCraft",pilot_exotic_vehicle:"SR5.SkillPilotExoticVehicle"},actionTypes:{none:"SR5.ActionTypeNone",free:"SR5.ActionTypeFree",simple:"SR5.ActionTypeSimple",complex:"SR5.ActionTypeComplex",varies:"SR5.ActionTypeVaries"},actionDamageFormulaOperators:{add:"+",subtract:"-",multiply:"*",divide:"/"},matrixAttributes:{attack:"SR5.MatrixAttrAttack",sleaze:"SR5.MatrixAttrSleaze",data_processing:"SR5.MatrixAttrDataProc",firewall:"SR5.MatrixAttrFirewall"},initiativeCategories:{meatspace:"SR5.InitCatMeatspace",astral:"SR5.InitCatAstral",matrix:"SR5.InitCatMatrix"},modificationTypes:{weapon:"SR5.Weapon",armor:"SR5.Armor"},mountPoints:{barrel:"SR5.Barrel",under_barrel:"SR5.UnderBarrel",stock:"SR5.Stock",top:"SR5.Top",side:"SR5.Side",internal:"SR5.Internal"},lifestyleTypes:{street:"SR5.LifestyleStreet",squatter:"SR5.LifestyleSquatter",low:"SR5.LifestyleLow",medium:"SR5.LifestyleMiddle",high:"SR5.LifestyleHigh",luxory:"SR5.LifestyleLuxory",other:"SR5.LifestyleOther"},kbmod:{ITEM_DESCR:"ctrlKey",EDGE:"altKey",HIDE_DIALOG:"shiftKey"},actorModifiers:{soak:"SR5.RollSoak",drain:"SR5.Drain",armor:"SR5.Armor",physical_limit:"SR5.PhysicalLimit",social_limit:"SR5.SocialLimit",mental_limit:"SR5.MentalLimit",stun_track:"SR5.StunTrack",physical_track:"SR5.PhysicalTrack",meat_initiative:"SR5.MeatSpaceInit",meat_initiative_dice:"SR5.MeatSpaceDice",astral_initiative:"SR5.AstralInit",astral_initiative_dice:"SR5.AstralDice",matrix_initiative:"SR5.MatrixInit",matrix_initiative_dice:"SR5.MatrixDice",matrix_track:"SR5.MatrixTrack",composure:"SR5.RollComposure",lift_carry:"SR5.RollLiftCarry",judge_intentions:"SR5.RollJudgeIntentions",memory:"SR5.RollMemory",walk:"SR5.Walk",run:"SR5.Run",defense:"SR5.RollDefense",wound_tolerance:"SR5.WoundTolerance",essence:"SR5.AttrEssence",fade:"SR5.RollFade",global:"SR5.Global"},modifierTypes:{armor:"SR5.Armor",composure:"SR5.RollComposure",defense:"SR5.RollDefense",drain:"SR5.Drain",environmental:"SR5.ModifierTypes.Environmental",fade:"SR5.RollFade",global:"SR5.Global",judge_intentions:"SR5.RollJudgeIntentions",lift_carry:"SR5.RollLiftCarry",memory:"SR5.RollMemory",soak:"SR5.RollSoak",wounds:"SR5.ModifierTypes.Wounds"},weaponCategoryActiveTests:{range:"RangedAttackTest",melee:"MeleeAttackTest",thrown:"ThrownAttackTest"},spellOpposedTests:{combat:"CombatSpellDefenseTest"},activeTests:{spell:"SpellCastingTest",complexForm:"ComplexFormTest"},opposedTests:{spell:{combat:"CombatSpellDefenseTest"}},opposedResistTests:{spell:{combat:"PhysicalResistTest"}},packNames:{generalActions:"General Actions",matrixActions:"Matrix Actions"},programTypes:{common_program:"SR5.CommonProgram",hacking_program:"SR5.HackingProgram",agent:"SR5.Agent"},spiritTypes:{air:"SR5.Spirit.Types.Air",aircraft:"SR5.Spirit.Types.Aircraft",airwave:"SR5.Spirit.Types.Airwave",automotive:"SR5.Spirit.Types.Automotive",beasts:"SR5.Spirit.Types.Beasts",ceramic:"SR5.Spirit.Types.Ceramic",earth:"SR5.Spirit.Types.Earth",energy:"SR5.Spirit.Types.Energy",fire:"SR5.Spirit.Types.Fire",guardian:"SR5.Spirit.Types.Guardian",guidance:"SR5.Spirit.Types.Guidance",man:"SR5.Spirit.Types.Man",metal:"SR5.Spirit.Types.Metal",plant:"SR5.Spirit.Types.Plant",ship:"SR5.Spirit.Types.Ship",task:"SR5.Spirit.Types.Task",train:"SR5.Spirit.Types.Train",water:"SR5.Spirit.Types.Water",toxic_air:"SR5.Spirit.Types.ToxicAir",toxic_beasts:"SR5.Spirit.Types.ToxicBeasts",toxic_earth:"SR5.Spirit.Types.ToxicEarth",toxic_fire:"SR5.Spirit.Types.ToxicFire",toxic_man:"SR5.Spirit.Types.ToxicMan",toxic_water:"SR5.Spirit.Types.ToxicWater",blood:"SR5.Spirit.Types.Blood",muse:"SR5.Spirit.Types.Muse",nightmare:"SR5.Spirit.Types.Nightmare",shade:"SR5.Spirit.Types.Shade",succubus:"SR5.Spirit.Types.Succubus",wraith:"SR5.Spirit.Types.Wraith",shedim:"SR5.Spirit.Types.Shedim",master_shedim:"SR5.Spirit.Types.MasterShedim",caretaker:"SR5.Spirit.Types.Caretaker",nymph:"SR5.Spirit.Types.Nymph",scout:"SR5.Spirit.Types.Scout",soldier:"SR5.Spirit.Types.Soldier",worker:"SR5.Spirit.Types.Worker",queen:"SR5.Spirit.Types.Queen"},critterPower:{categories:{mundane:"SR5.CritterPower.Categories.Mundane",paranormal:"SR5.CritterPower.Categories.Paranormal",free_spirit:"SR5.CritterPower.Categories.FreeSpirit",emergent:"SR5.CritterPower.Categories.Emergent",shapeshifter:"SR5.CritterPower.Categories.Shapeshifter",drake:"SR5.CritterPower.Categories.Drake",echoes:"SR5.CritterPower.Categories.Echoes",weakness:"SR5.CritterPower.Categories.Weakness",paranormal_infected:"SR5.CritterPower.Categories.ParanormalInfected"},types:{mana:"SR5.CritterPower.Types.Mana",physical:"SR5.CritterPower.Types.Physical"},ranges:{los:"SR5.CritterPower.Ranges.LineOfSight",self:"SR5.CritterPower.Ranges.Self",touch:"SR5.CritterPower.Ranges.Touch",los_a:"SR5.CritterPower.Ranges.LineOfSightArea",special:"SR5.CritterPower.Ranges.Special"},durations:{always:"SR5.CritterPower.Durations.Always",instant:"SR5.CritterPower.Durations.Instant",sustained:"SR5.CritterPower.Durations.Sustained",permanent:"SR5.CritterPower.Durations.Permanent",special:"SR5.CritterPower.Durations.Special"}},spriteTypes:{courier:"SR5.Sprite.Types.Courier",crack:"SR5.Sprite.Types.Crack",data:"SR5.Sprite.Types.Data",fault:"SR5.Sprite.Types.Fault",machine:"SR5.Sprite.Types.Machine"},vehicle:{types:{air:"SR5.Vehicle.Types.Air",aerospace:"SR5.Vehicle.Types.Aerospace",ground:"SR5.Vehicle.Types.Ground",water:"SR5.Vehicle.Types.Water",walker:"SR5.Vehicle.Types.Walker",exotic:"SR5.Vehicle.Types.Exotic"},stats:{handling:"SR5.Vehicle.Stats.Handling",off_road_handling:"SR5.Vehicle.Stats.OffRoadHandling",speed:"SR5.Vehicle.Stats.Speed",off_road_speed:"SR5.Vehicle.Stats.OffRoadSpeed",acceleration:"SR5.Vehicle.Stats.Acceleration",pilot:"SR5.Vehicle.Stats.Pilot",sensor:"SR5.Vehicle.Stats.Sensor"},control_modes:{manual:"SR5.Vehicle.ControlModes.Manual",remote:"SR5.Vehicle.ControlModes.Remote",rigger:"SR5.Vehicle.ControlModes.Rigger",autopilot:"SR5.Vehicle.ControlModes.Autopilot"},environments:{speed:"SR5.Vehicle.Environments.Speed",handling:"SR5.Vehicle.Environments.Handling"}},ic:{types:{acid:"SR5.IC.Types.Acid",binder:"SR5.IC.Types.Binder",black_ic:"SR5.IC.Types.BlackIC",blaster:"SR5.IC.Types.Blaster",crash:"SR5.IC.Types.Crash",jammer:"SR5.IC.Types.Jammer",killer:"SR5.IC.Types.Killer",marker:"SR5.IC.Types.Marker",patrol:"SR5.IC.Types.Patrol",probe:"SR5.IC.Types.Probe",scramble:"SR5.IC.Types.Scramble",sparky:"SR5.IC.Types.Sparky",tar_baby:"SR5.IC.Types.TarBaby",track:"SR5.IC.Types.Track"}},character:{types:{human:"SR5.Character.Types.Human",elf:"SR5.Character.Types.Elf",ork:"SR5.Character.Types.Ork",dwarf:"SR5.Character.Types.Dwarf",troll:"SR5.Character.Types.Troll"}}};var un=()=>{Handlebars.registerHelper("ItemHeaderIcons",function(n){let e="fas fa-plus",t=game.i18n.localize("SR5.Add"),a={icon:e,text:t,title:game.i18n.localize("SR5.CreateItem"),cssClass:"item-create",data:{}};switch(n){case"lifestyle":return a.title=game.i18n.localize("SR5.CreateItemLifestyle"),[a];case"contact":return a.title=game.i18n.localize("SR5.CreateItemContact"),[a];case"sin":return a.title=game.i18n.localize("SR5.CreateItemSIN"),[a];case"license":return a.title=game.i18n.localize("SR5.CreateItemLicense"),[a];case"quality":return a.title=game.i18n.localize("SR5.CreateItemQuality"),[a];case"adept_power":return a.title=game.i18n.localize("SR5.CreateItemAdeptPower"),[a];case"action":return a.title=game.i18n.localize("SR5.CreateItemAction"),[a];case"spell":return a.title=game.i18n.localize("SR5.CreateItemSpell"),[a];case"gear":return a.title=game.i18n.localize("SR5.CreateItemGear"),[a];case"complex_form":return a.title=game.i18n.localize("SR5.CreateItemComplexForm"),[a];case"program":return a.title=game.i18n.localize("SR5.CreateItemProgram"),[a];case"weapon":return a.title=game.i18n.localize("SR5.CreateItemWeapon"),[a];case"armor":return a.title=game.i18n.localize("SR5.CreateItemArmor"),[a];case"ammo":return a.title=game.i18n.localize("SR5.CreateItemAmmo"),[a];case"modification":return a.title=game.i18n.localize("SR5.CreateItemModification"),[a];case"device":return a.title=game.i18n.localize("SR5.CreateItemDevice"),[a];case"equipment":return a.title=game.i18n.localize("SR5.CreateItemEquipment"),[a];case"cyberware":return a.title=game.i18n.localize("SR5.CreateItemCyberware"),[a];case"bioware":return a.title=game.i18n.localize("SR5.CreateItemBioware"),[a];case"critter_power":return a.title=game.i18n.localize("SR5.CreateItemCritterPower"),[a];case"sprite_power":return a.title=game.i18n.localize("SR5.CreateItemSpritePower"),[a];case"effect":return a.title=game.i18n.localize("SR5.CreateEffect"),a.cssClass="effect-control",a.data={action:"create"},[a];default:return[]}}),Handlebars.registerHelper("InventoryIcons",function(n){return[{icon:"fas fa-plus",text:game.i18n.localize("SR5.Add"),title:game.i18n.localize("SR5.CreateItem"),cssClass:"inventory-item-create",data:{inventory:n}}]}),Handlebars.registerHelper("ItemHeaderRightSide",function(n){switch(n){case"action":return[{text:{text:game.i18n.localize("SR5.Skill"),cssClass:"six"}},{text:{text:game.i18n.localize("SR5.Attribute"),cssClass:"six"}},{text:{text:game.i18n.localize("SR5.Attribute"),cssClass:"six"}},{text:{text:game.i18n.localize("SR5.Limit"),cssClass:"six"}},{text:{text:game.i18n.localize("SR5.Modifier"),cssClass:"six"}}];case"weapon":case"armor":case"device":case"equipment":case"cyberware":case"bioware":case"modification":case"ammo":return[{text:{text:game.i18n.localize("SR5.Qty")}}];case"complex_form":return[{text:{text:game.i18n.localize("SR5.Target")}},{text:{text:game.i18n.localize("SR5.Duration")}},{text:{text:game.i18n.localize("SR5.Fade")}}];case"adept_power":return[{text:{text:game.i18n.localize("SR5.PowerType")}}];case"spell":return[{text:{text:game.i18n.localize("SR5.SpellType")}},{text:{text:game.i18n.localize("SR5.SpellRange")}},{text:{text:game.i18n.localize("SR5.Duration")}},{text:{text:game.i18n.localize("SR5.Drain")}}];case"critter_power":return[{text:{text:game.i18n.localize("SR5.CritterPower.Type")}},{text:{text:game.i18n.localize("SR5.CritterPower.Range")}},{text:{text:game.i18n.localize("SR5.CritterPower.Duration")}}];case"quality":return[{text:{text:game.i18n.localize("SR5.QualityType")}}];default:return[]}}),Handlebars.registerHelper("ItemRightSide",function(n){var a,r,i,s,o,l,c,d,p,g,y,S,M,L,R,F,D,h;let e=new ne(n),t={input:{type:"number",value:e.getQuantity(),cssClass:"item-qty"}};switch(n.type){case"action":return[{text:{text:game.i18n.localize(q.activeSkills[(a=e.getActionSkill())!=null?a:""]),cssClass:"six"}},{text:{text:game.i18n.localize(q.attributes[(r=e.getActionAttribute())!=null?r:""]),cssClass:"six"}},{text:{text:game.i18n.localize(q.attributes[(i=e.getActionAttribute2())!=null?i:""]),cssClass:"six"}},{text:{text:e.getLimitAttribute()?game.i18n.localize(q.attributes[(s=e.getLimitAttribute())!=null?s:""]):e.getActionLimit(),cssClass:"six"}},{text:{text:e.getActionDicePoolMod(),cssClass:"six"}}];case"armor":case"ammo":case"modification":case"device":case"equipment":case"cyberware":case"bioware":return[t];case"weapon":if(e.isRangedWeapon()){let m=(l=(o=e.getAmmo())==null?void 0:o.current.value)!=null?l:0,T=(d=(c=e.getAmmo())==null?void 0:c.current.max)!=null?d:0,k=m<T?`${game.i18n.localize("SR5.WeaponReload")} (${m}/${T})`:game.i18n.localize("SR5.AmmoFull"),v="no-break"+(m<T?" reload-ammo roll":"faded");return[{text:{title:`${game.i18n.localize("SR5.WeaponAmmoCount")}: ${m}`,text:k,cssClass:v}},{text:{text:""}},t]}else return[t];case"quality":return[{text:{text:game.i18n.localize(q.qualityTypes[(p=n.data.type)!=null?p:""])}}];case"adept_power":return[{text:{text:game.i18n.localize(q.adeptPower.types[(g=n.data.type)!=null?g:""])}}];case"spell":return[{text:{text:game.i18n.localize(q.spellTypes[(y=n.data.type)!=null?y:""])}},{text:{text:game.i18n.localize(q.spellRanges[(S=n.data.range)!=null?S:""])}},{text:{text:game.i18n.localize(q.durations[(M=n.data.duration)!=null?M:""])}},{text:{text:e.getDrain()}}];case"critter_power":return[{text:{text:game.i18n.localize(q.critterPower.types[(L=n.data.powerType)!=null?L:""])}},{text:{text:game.i18n.localize(q.critterPower.ranges[(R=n.data.range)!=null?R:""])}},{text:{text:game.i18n.localize(q.critterPower.durations[(F=n.data.duration)!=null?F:""])}}];case"complex_form":return[{text:{text:game.i18n.localize(q.matrixTargets[(D=n.data.target)!=null?D:""])}},{text:{text:game.i18n.localize(q.durations[(h=n.data.duration)!=null?h:""])}},{text:{text:String(n.data.fade)}}];case"program":return[{button:{cssClass:`item-equip-toggle ${e.isEquipped()?"light":""}`,short:!0,text:e.isEquipped()?game.i18n.localize("SR5.Loaded"):game.i18n.localize("SR5.Load")+" >>"}}];default:return[]}}),Handlebars.registerHelper("ItemIcons",function(n){let e=new ne(n),t={icon:"fas fa-edit item-edit",title:game.i18n.localize("SR5.EditItem")},a={icon:"fas fa-trash item-delete",title:game.i18n.localize("SR5.DeleteItem")},r={icon:`${e.isEquipped()?"fas fa-check-circle":"far fa-circle"} item-equip-toggle`,title:game.i18n.localize("SR5.ToggleEquip")},i={icon:"fas fa-file open-source-pdf",title:game.i18n.localize("SR5.OpenSourcePdf")},s=[t,a];switch(ui.PDFoundry&&s.unshift(i),e.getType()){case"program":case"armor":case"device":case"equipment":case"cyberware":case"bioware":case"weapon":s.unshift(r)}return s}),Handlebars.registerHelper("InventoryItemIcons",function(n){let e=new ne(n),t={icon:"fas fa-exchange-alt inventory-item-move",title:game.i18n.localize("SR5.MoveItemInventory")},a={icon:"fas fa-edit item-edit",title:game.i18n.localize("SR5.EditItem")},r={icon:"fas fa-trash item-delete",title:game.i18n.localize("SR5.DeleteItem")},i={icon:`${e.isEquipped()?"fas fa-check-circle":"far fa-circle"} item-equip-toggle`,title:game.i18n.localize("SR5.ToggleEquip")},s={icon:"fas fa-file open-source-pdf",title:game.i18n.localize("SR5.OpenSourcePdf")},o=[t,a,r];switch(ui.PDFoundry&&o.unshift(s),e.getType()){case"program":case"armor":case"device":case"equipment":case"cyberware":case"bioware":case"weapon":o.unshift(i)}return o}),Handlebars.registerHelper("EffectIcons",function(n){let e={icon:"fas fa-edit effect-control",title:game.i18n.localize("SR5.EditItem"),data:{action:"edit"}},t={icon:"fas fa-trash effect-control",title:game.i18n.localize("SR5.DeleteItem"),data:{action:"delete"}},a={icon:`${n.data.disabled?"far fa-circle":"fas fa-check-circle"} effect-control`,title:game.i18n.localize("SR5.ToggleActive"),data:{action:"toggle"}},r={icon:"fas fa-file effect-control",title:game.i18n.localize("SR5.OpenOrigin"),data:{action:"open-origin"}},i=[a,e,t];return n.isOriginOwned&&(i=[r,...i]),i}),Handlebars.registerHelper("EffectData",function(n){return{"effect-type":n}}),Handlebars.registerHelper("MarksRightSide",n=>[{input:{type:"number",value:n.marks,cssClass:"marks-qty"}}]),Handlebars.registerHelper("MarksIcons",n=>{let e={icon:"fas fa-plus marks-add-one",title:game.i18n.localize("SR5.Labels.Sheet.AddOne"),data:{action:"add-one"}},t={icon:"fas fa-minus marks-remove-one",title:game.i18n.localize("SR5.Labels.Sheet.SubtractOne"),data:{action:"remove-one"}};return[e,t]}),Handlebars.registerHelper("MarkListHeaderRightSide",()=>[{text:{text:game.i18n.localize("SR5.FOUNDRY.Scene")}},{text:{text:game.i18n.localize("SR5.FOUNDRY.Item")}},{text:{text:game.i18n.localize("SR5.Qty")}}]),Handlebars.registerHelper("MarkListHeaderIcons",()=>[{icon:"fas fa-trash",title:game.i18n.localize("SR5.ClearMarks"),text:game.i18n.localize("SR5.Del"),cssClass:"marks-clear-all"}]),Handlebars.registerHelper("NetworkDevicesListRightSide",()=>[{text:{text:game.i18n.localize("SR5.FOUNDRY.Actor")}},{text:{text:game.i18n.localize("SR5.FOUNDRY.Item")}}]),Handlebars.registerHelper("NetworkDevicesListHeaderIcons",()=>[{icon:"fas fa-trash",title:game.i18n.localize("SR5.Labels.Sheet.ClearNetwork"),text:game.i18n.localize("SR5.Del"),cssClass:"network-clear"}])};var mt=class{static mustDefaultToRoll(e){return e.base===0}static allowDefaultingRoll(e){return e.canDefault}static allowRoll(e){return!mt.mustDefaultToRoll(e)||mt.allowDefaultingRoll(e)}static addDefaultingPart(e){e.addUniquePart("SR5.Defaulting",mt.defaultingModifier)}static level(e,t={specialization:!1}){if(this.mustDefaultToRoll(e)&&this.allowDefaultingRoll(e))return mt.defaultingModifier;let a=typeof e.value=="number"?e.value:0,r=t.specialization?K.skill.SPECIALIZATION_MODIFIER:0;return a+r}static get defaultingModifier(){return K.skill.DEFAULTING_MODIFIER}static get SpecializationModifier(){return K.skill.SPECIALIZATION_MODIFIER}};var dn=()=>{Handlebars.registerHelper("SkillHeaderIcons",function(n){let e={icon:"fas fa-plus",title:game.i18n.localize("SR5.AddSkill"),text:game.i18n.localize("SR5.Add"),cssClass:""};switch(n){case"active":return e.cssClass="add-active",[e];case"language":return e.cssClass="add-language",[e];case"knowledge":return e.cssClass="add-knowledge",[e];default:return[]}}),Handlebars.registerHelper("SkillHeaderRightSide",function(n,e){let t={text:{text:game.i18n.localize("SR5.Specialization"),cssClass:"skill-spec-item"}},a={text:{text:!e||e.showUntrainedSkills?game.i18n.localize("SR5.Rtg"):game.i18n.localize("SR5.RtgAboveZero"),cssClass:"rtg"}};switch(n){case"active":case"knowledge":case"language":return[t,a];default:return[]}}),Handlebars.registerHelper("SkillRightSide",function(n,e){return[{html:{text:(Array.isArray(e.specs)?e.specs:[e.specs]).map(a=>`<span class="roll skill-spec-roll">${a}</span>`).join(", "),cssClass:"skill-spec-item"}},{text:{text:w.calcTotal(e),cssClass:"rtg"}}]}),Handlebars.registerHelper("SkillAdditionCssClass",function(n){let e=[];return game.settings.get(V,j.ShowSkillsWithDetails)&&!mt.allowDefaultingRoll(n)&&e.push("skill-roll-not-defaultable"),e}),Handlebars.registerHelper("SkillIcons",function(n,e){let t={icon:"fas fa-edit",title:game.i18n.localize("SR5.EditSkill"),cssClass:""},a={icon:"fas fa-trash",title:game.i18n.localize("SR5.DeleteSkill"),cssClass:""};switch(n){case"active":return t.cssClass="skill-edit",a.cssClass="remove-active",[t,a];case"language":return t.cssClass="language-skill-edit",a.cssClass="remove-language",[t,a];case"knowledge":return t.cssClass="knowledge-skill-edit",a.cssClass="remove-knowledge",[t,a];default:return[t]}})};var mn=()=>{Handlebars.registerHelper("IsEnvModifierActive",(n,e,t)=>n[e]===t)};var te=class extends Roll{get sides(){return this.terms?this.terms[0].results.map(t=>t.result):this.parts[0].rolls.map(t=>t.roll)}get limit(){return this.data.limit}get threshold(){return this.data.threshold}get parts(){return this.data.parts}get explodeSixes(){return this.data.explodeSixes}count(t){return this.sides.reduce((a,r)=>r===t?a+1:a,0)}get hits(){return this.sides.reduce((t,a)=>K.die.success.includes(a)?t+1:t,0)}get glitches(){return this.sides.reduce((t,a)=>K.die.glitch.includes(a)?t+1:t,0)}get pool(){return this.terms?this.dice[0].number:this.parts[0].rolls.length}get glitched(){return this.glitches>Math.floor(this.pool/2)}get total(){return this.hits}};var Mt=class{static handleDefaulting(e,t){var a;if(!!mt.mustDefaultToRoll(e)){if(!Mt.allowDefaultingRoll(e)){(a=ui.notifications)==null||a.warn(game.i18n.localize("SR5.Warnings.SkillCantBeDefault"));return}mt.addDefaultingPart(t)}}static allowDefaultingRoll(e){return game.settings.get(V,j.OnlyAllowRollOnDefaultableSkills)===!1?!0:mt.allowDefaultingRoll(e)}static allowRoll(e){return mt.mustDefaultToRoll(e)&&Mt.allowDefaultingRoll(e)?!0:mt.allowRoll(e)}static isCustomSkill(e){return e.name!==void 0&&e.name!==""}static isLegacySkill(e){return!Mt.isCustomSkill(e)}};var W={fromPool:function(n={pool:0,limit:0,threshold:0},e){let t=W._minimalTestData();t.pool.base=n.pool,t.threshold.base=n.threshold||0,t.limit.base=n.limit||0;let a=W._getTestClass("SuccessTest");return new a(t,void 0,e)},fromItem:function(n,e,t){return u(this,null,function*(){if(e||(e=n.parent),!(e instanceof st)){console.error("Shadowrun 5e | A SuccessTest can only be created with an explicit Actor or Item with an actor parent.");return}let a=n.getAction();if(!a)return;if(a.test||(a.test="SuccessTest",console.warn("Shadowrun 5e | An action without a defined test handler defaulted to SuccessTest")),!game.shadowrun5e.tests.hasOwnProperty(a.test)){console.error(`Shadowrun 5e | Test registration for test ${a.test} is missing`);return}let r=W._getTestClass(a.test),i=yield W._getTestDataFromItemAction(r,n,e),s={item:n,actor:e};return new r(i,s,t)})},fromAction:function(n,e,t){return u(this,null,function*(){if(n.test||(n.test="SuccessTest",console.warn("Shadowrun 5e | An action without a defined test handler defaulted to SuccessTest")),!game.shadowrun5e.tests.hasOwnProperty(n.test)){console.error(`Shadowrun 5e | Test registration for test ${n.test} is missing`);return}let a=W._getTestClass(n.test),r=yield W._prepareTestDataWithAction(n,e,W._minimalTestData()),i={actor:e};return new a(r,i,t)})},fromMessage:function(n){return u(this,null,function*(){var i;let e=(i=game.messages)==null?void 0:i.get(n);if(!e){console.error(`Shadowrun 5e | Couldn't find a message for id ${n} to create a message action`);return}let t=foundry.utils.duplicate(e.getFlag(V,j.Test));if(!t){console.error(`Shadowrun 5e | Message with id ${n} doesn't have test data in it's flags.`);return}let r={rolls:t.rolls.map(s=>te.fromData(s))};return W.fromTestData(t.data,r,t.data.options)})},fromMessageAction:function(n,e,t){return u(this,null,function*(){var o,l;let a=(o=game.messages)==null?void 0:o.get(n);if(!a){console.error(`Shadowrun 5e | Couldn't find a message for id ${n} to create a message action`);return}let r=foundry.utils.duplicate(a.getFlag(V,j.Test));if(!r||!r.data||!r.rolls){console.error(`Shadowrun 5e | Message with id ${n} doesn't have valid test data in it's flags.`);return}let i=W._getTestClass(e);if(!i){console.error(`Shadowrun 5e | Couldn't find a registered test implementation for ${e}`);return}let s=w.getSelectedActorsOrCharacter();s.length===0&&((l=ui.notifications)==null||l.warn(game.i18n.localize("SR5.Warnings.TokenSelectionNeeded")));for(let c of s){let d=yield i._getOpposedActionTestData(r.data,c,n);if(!d)return;let p={actor:c};yield new i(d,p,t).execute()}})},fromTestData:function(n,e,t){let a=n.type||"SuccessTest",r=W._getTestClass(a);return new r(n,e,t)},fromOpposedTestResistTest:function(n,e){return u(this,null,function*(){var s,o,l;let t=foundry.utils.duplicate(n.data);if(!((l=(o=(s=t==null?void 0:t.against)==null?void 0:s.opposed)==null?void 0:o.resist)!=null&&l.test))return console.error("Shadowrun 5e | Given test doesn't define an opposed resist test",n);if(!n.actor)return console.error(`Shadowrun 5e | A ${n.title} can't operate without a populated actor given`);let a=W._getTestClass(t.against.opposed.resist.test),r=yield W._getOpposedResistTestData(a,t,n.actor,n.data.messageUuid),i={actor:n.actor};return new a(r,i,e)})},fromFollowupTest:function(n,e){return u(this,null,function*(){var o,l,c;if(!((c=(l=(o=n==null?void 0:n.data)==null?void 0:o.action)==null?void 0:l.followed)!=null&&c.test))return;if(!n.item)return console.error("Shadowrun 5e | Test doesn't have a populated item document");if(!n.actor)return console.error("Shadowrun 5e | Test doesn't have a populated actor document");let t=W._getTestClass(n.data.action.followed.test);if(!t)return console.error(`Shadowrun 5e | A ${n.constructor.name} has a unregistered follow up test configured`,this);let a=W._minimalTestData();a.title=t.title,a.previousMessageId=n.data.messageUuid,a.against=n.data;let r=W._mergeMinimalActionDataInOrder(P.actionData({test:t.name}),yield t._getDocumentTestAction(n.item,n.actor),t._getDefaultTestAction()),i=yield t._prepareActionTestData(r,n.actor,a);i.following=n.data;let s={item:n.item,actor:n.actor};return new t(i,s,e)})},_getTestClass:function(n){if(!game.shadowrun5e.tests.hasOwnProperty(n)){console.error(`Shadowrun 5e | Tried getting a Test Class ${n}, which isn't registered in: `,game.shadowrun5e.tests);return}return game.shadowrun5e.tests[n]},_getTestDataFromItemAction:function(n,e,t){return u(this,null,function*(){let a=W._minimalTestData(),r=e.getAction();return!r||!t?a:(r=W._mergeMinimalActionDataInOrder(r,yield n._getDocumentTestAction(e,t),n._getDefaultTestAction()),yield W._prepareTestDataWithAction(r,t,a))})},_prepareTestDataWithAction:function(n,e,t){return u(this,null,function*(){var r;t.action=n;let a=new O(t.pool.mod);if(n.skill){let i=e.getSkill(n.skill);i&&!Mt.allowRoll(i)&&((r=ui.notifications)==null||r.warn("SR5.Warnings.SkillCantBeDefault",{localize:!0})),i&&a.addUniquePart(i.label||i.name,mt.level(i)),n.spec&&a.addUniquePart("SR5.Specialization",mt.SpecializationModifier)}if(n.attribute){let i=e.getAttribute(n.attribute);i&&a.addPart(i.label,i.value),i&&e._isMatrixAttribute(n.attribute)&&e._addMatrixParts(a,!0)}if(!n.skill&&n.attribute2){let i=e.getAttribute(n.attribute2);i&&a.addPart(i.label,i.value),i&&e._isMatrixAttribute(n.attribute2)&&e._addMatrixParts(a,!0)}if(n.mod&&(t.pool.base=Number(n.mod)),n.armor){let i=e.getArmor();t.pool.mod=O.AddUniquePart(t.pool.mod,"SR5.Armor",i.value)}if(n.limit.attribute){let i=e.getLimit(n.limit.attribute);i&&(t.limit.mod=O.AddUniquePart(t.limit.mod,i.label,i.value)),i&&e._isMatrixAttribute(n.limit.attribute)&&e._addMatrixParts(a,!0)}if((n.limit.base||n.limit.value)&&(t.limit.base=Number(n.limit.value)),n.threshold.base&&(t.threshold.base=Number(n.threshold.base)),n.damage.base&&(t.damage=n.damage),n.damage.attribute){let i=e.getAttribute(n.damage.attribute);t.damage.mod=O.AddUniquePart(t.damage.mod,i.label,i.value)}n.opposed.test&&(t.opposed=n.opposed);for(let i of t.action.modifiers){let s=q.modifierTypes[i],o=yield e.modifiers.totalFor(i);t.modifiers.mod=O.AddUniquePart(t.modifiers.mod,s,o)}return t.extended=n.extended,t})},_getOpposedResistTestData:function(n,e,t,a){return u(this,null,function*(){if(!e.against.opposed.resist.test){console.error("Shadowrun 5e | Supplied test action doesn't contain an resist test in it's opposed test configuration",e,this);return}t||console.error("Shadowrun 5e | Can't resolve opposed test values due to missing actor",n);let r=W._minimalTestData();r.previousMessageId=a,r.following=e;let i=W._mergeMinimalActionDataInOrder(P.actionData({test:n.name}),e.against.opposed.resist,n._getDefaultTestAction());return yield W._prepareTestDataWithAction(i,t,r)})},_minimalTestData:function(){return{pool:P.valueData({label:"SR5.DicePool"}),limit:P.valueData({label:"SR5.Limit"}),threshold:P.valueData({label:"SR5.Threshold"}),damage:P.damageData(),modifiers:P.valueData({label:"SR5.Labels.Action.Modifiers"}),values:{},action:P.actionData(),opposed:{}}},_mergeMinimalActionDataInOrder:function(n,...e){n=duplicate(n);for(let t of e)for(let a of Object.keys(P.minimalActionData()))!t.hasOwnProperty(a)||(n[a]=t[a]);return n},shouldHideDialog(n){return n?n[q.kbmod.HIDE_DIALOG]===!0:!1},shouldPostItemDescription(n){return n?n[q.kbmod.ITEM_DESCR]===!0:!1}};var pn=class extends Roll{toJSON(){let t=super.toJSON();return t.class="Roll",t}get sides(){return this.terms?this.terms[0].results.map(t=>t.result):this.parts[0].rolls.map(t=>t.roll)}get limit(){return this.data.limit}get threshold(){return this.data.threshold}get parts(){return this.data.parts}get explodeSixes(){return this.data.explodeSixes}count(t){return this.sides.reduce((r,i)=>i===t?r+1:r,0)}get hits(){return this.total||0}get pool(){return this.terms?this.dice[0].number:this.parts[0].rolls.length}get glitched(){let t=0;return K.die.glitch.forEach(a=>t+=this.count(a)),t>Math.floor(this.pool/2)}toMessage(t,a){return console.error("message",t,a),super.toMessage(t,a)}},ee=class{static shadowrunFormula({parts:e,limit:t,explode:a}){var o;let i=new O(e).total;if(i<=0)return(o=ui.notifications)==null||o.warn(game.i18n.localize("SR5.RollOneDie")),"0d6cs>=5";let s=`${i}d6`;return a&&(s+="x6"),t!=null&&t.value&&(s+=`kh${t.value}`),s+="cs>=5",s}static promptSuccessTest(){return u(this,null,function*(){var a,r;let e=Number((a=game.user)==null?void 0:a.getFlag(V,j.LastRollPromptValue))||0,t=yield W.fromPool({pool:e});yield t.execute(),t.evaluated&&(yield(r=game.user)==null?void 0:r.setFlag(V,j.LastRollPromptValue,t.pool.value))})}static advancedRoll(e,t){return u(this,null,function*(){})}};var $t={action:(n,e,t)=>{if(n.action){let a=[];if(n.action.skill?(a.push(w.label(n.action.skill)),a.push(w.label(n.action.attribute))):n.action.attribute2?(a.push(w.label(n.action.attribute)),a.push(w.label(n.action.attribute2))):n.action.attribute&&a.push(w.label(n.action.attribute)),n.action.mod&&a.push(`${game.i18n.localize("SR5.ItemMod")} (${n.action.mod})`),a.length&&(e.roll=a.join(" + ")),n.action.opposed.type){let{opposed:r}=n.action;r.type!=="custom"?e.opposedRoll=`vs. ${w.label(r.type)}`:r.skill?e.opposedRoll=`vs. ${w.label(r.skill)}+${w.label(r.attribute)}`:r.attribute2?e.opposedRoll=`vs. ${w.label(r.attribute)}+${w.label(r.attribute2)}`:r.attribute&&(e.opposedRoll=`vs. ${w.label(r.attribute)}`)}if(n.action.type!==""&&n.action.type!=="varies"&&n.action.type!=="none"&&t.push(`${w.label(n.action.type)} Action`),n.action.limit){let{limit:r}=n.action,i=r.attribute?`${game.i18n.localize(q.limits[r.attribute])}`:"",s=r.value?r.value:"",o="";i&&(o+=i),s&&(i&&(o+=" + "),o+=s),o&&t.push(`Limit ${o}`)}if(n.action.damage.type.value){let{damage:r}=n.action,i="",s="",o=r.attribute?`${game.i18n.localize(q.attributes[r.attribute])} + `:"";if(r.value||o){let l=r.type.value?r.type.value.toUpperCase().charAt(0):"";i=`DV ${o}${r.value}${l}`}r.element.value&&(r.value?r.element.value==="electricity"?i+=" (e)":s=w.label(r.element.value):s=w.label(r.element.value)),i&&t.push(i),s&&t.push(s),r.ap&&r.ap.value&&t.push(`AP ${r.ap.value}`)}}},sin:(n,e,t)=>{t.push(`Rating ${n.technology.rating}`),n.licenses.forEach(a=>{t.push(`${a.name} R${a.rtg}`)})},contact:(n,e,t)=>{t.push(n.type),t.push(`${game.i18n.localize("SR5.Connection")} ${n.connection}`),t.push(`${game.i18n.localize("SR5.Loyalty")} ${n.loyalty}`),n.blackmail&&t.push(`${game.i18n.localize("SR5.Blackmail")}`),n.family&&t.push(game.i18n.localize("SR5.Family"))},lifestyle:(n,e,t)=>{t.push(w.label(n.type)),n.cost&&t.push(`\xA5${n.cost}`),n.comforts&&t.push(`Comforts ${n.comforts}`),n.security&&t.push(`Security ${n.security}`),n.neighborhood&&t.push(`Neighborhood ${n.neighborhood}`),n.guests&&t.push(`Guests ${n.guests}`)},adept_power:(n,e,t)=>{$t.action(n,e,t),t.push(`PP ${n.pp}`),t.push(w.label(n.type))},armor:(n,e,t)=>{n.armor&&(n.armor.value&&t.push(`Armor ${n.armor.mod?"+":""}${n.armor.value}`),n.armor.acid&&t.push(`Acid ${n.armor.acid}`),n.armor.cold&&t.push(`Cold ${n.armor.cold}`),n.armor.fire&&t.push(`Fire ${n.armor.fire}`),n.armor.electricity&&t.push(`Electricity ${n.armor.electricity}`),n.armor.radiation&&t.push(`Radiation ${n.armor.radiation}`))},ammo:(n,e,t)=>{n.damageType&&t.push(`${game.i18n.localize("SR5.DamageType")} ${n.damageType}`),n.damage&&t.push(`${game.i18n.localize("SR5.DamageValue")} ${n.damage}`),n.element&&t.push(`${game.i18n.localize("SR5.Element")} ${n.element}`),n.ap&&t.push(`${game.i18n.localize("SR5.AP")} ${n.ap}`),n.blast.radius&&t.push(`${game.i18n.localize("SR5.BlastRadius")} ${n.blast.radius}m`),n.blast.dropoff&&t.push(`${game.i18n.localize("SR5.Dropoff")} ${n.blast.dropoff}/m`)},program:(n,e,t)=>{t.push(game.i18n.localize(q.programTypes[n.type]))},complex_form:(n,e,t)=>{$t.action(n,e,t),t.push(w.label(n.target),w.label(n.duration));let{fade:a}=n;a>0?t.push(`Fade L+${a}`):a<0?t.push(`Fade L${a}`):t.push("Fade L")},cyberware:(n,e,t)=>{$t.action(n,e,t),$t.armor(n,e,t),n.essence&&t.push(`Ess ${n.essence}`)},bioware:(n,e,t)=>{$t.action(n,e,t),$t.armor(n,e,t),n.essence&&t.push(`Ess ${n.essence}`)},device:(n,e,t)=>{if(n.technology&&n.technology.rating&&t.push(`Rating ${n.technology.rating}`),n.category==="cyberdeck")for(let a of Object.values(n.atts))t.push(`${w.label(a.att)} ${a.value}`)},equipment:(n,e,t)=>{n.technology&&n.technology.rating&&t.push(`Rating ${n.technology.rating}`)},quality:(n,e,t)=>{$t.action(n,e,t),t.push(w.label(n.type))},sprite_power:(n,e,t)=>{$t.action(n,e,t)},critter_power:(n,e,t)=>{t.push(game.i18n.localize(q.critterPower.types[n.powerType])),t.push(game.i18n.localize(q.critterPower.durations[n.duration])),t.push(game.i18n.localize(q.critterPower.ranges[n.range])),$t.action(n,e,t)},spell:(n,e,t)=>{t.push(w.label(n.category),w.label(n.type)),n.category==="combat"?t.push(w.label(n.combat.type)):n.category==="health"||(n.category==="illusion"?(t.push(n.illusion.type),t.push(n.illusion.sense)):n.category==="manipulation"?(n.manipulation.damaging&&t.push("Damaging"),n.manipulation.mental&&t.push("Mental"),n.manipulation.environmental&&t.push("Environmental"),n.manipulation.physical&&t.push("Physical")):n.category==="detection"&&(t.push(n.illusion.type),t.push(n.illusion.passive?"Passive":"Active"),n.illusion.extended&&t.push("Extended"))),t.push(w.label(n.range)),$t.action(n,e,t),t.push(w.label(n.duration));let{drain:a}=n;a>0?t.push(`Drain F+${a}`):a<0?t.push(`Drain F${a}`):t.push("Drain F"),e.roll="Cast"},weapon:(n,e,t,a)=>{var s,o,l;$t.action(n,e,t);for(let c=0;c<t.length;c++){let d=t[c];d.includes("Limit")&&(t[c]=d.replace("Limit","Accuracy"))}let r=a.getEquippedAmmo();if(r&&n.ammo&&((s=n.ammo.current)==null?void 0:s.max)&&r){let c=r.data.data,{current:d,spare_clips:p}=n.ammo;r.name&&t.push(`${r.name} (${d.value}/${d.max})`),c.blast.radius&&t.push(`${game.i18n.localize("SR5.BlastRadius")} ${c.blast.radius}m`),c.blast.dropoff&&t.push(`${game.i18n.localize("SR5.Dropoff")} $ammoData.blast.dropoff}/m`),p&&p.max&&t.push(`${game.i18n.localize("SR5.SpareClips")} (${p.value}/${p.max})`)}if((l=(o=n.technology)==null?void 0:o.conceal)!=null&&l.value&&t.push(`${game.i18n.localize("SR5.Conceal")} ${n.technology.conceal.value}`),n.category==="range"){if(n.range.rc){let c=`${game.i18n.localize("SR5.RecoilCompensation")} ${n.range.rc.value}`;a!=null&&a.actor&&(c+=` (${game.i18n.localize("SR5.Total")} ${a.actor.getRecoilCompensation()})`),t.push(c)}if(n.range.modes){let c=[],{modes:d}=n.range;d.single_shot&&c.push("SR5.WeaponModeSingleShotShort"),d.semi_auto&&c.push("SR5.WeaponModeSemiAutoShort"),d.burst_fire&&c.push("SR5.WeaponModeBurstFireShort"),d.full_auto&&c.push("SR5.WeaponModeFullAutoShort"),t.push(c.map(p=>game.i18n.localize(p)).join("/"))}n.range.ranges&&t.push(Array.from(Object.values(n.range.ranges)).join("/"))}else if(n.category==="melee"){if(n.melee.reach){let c=`${game.i18n.localize("SR5.Reach")} ${n.melee.reach}`,d=t.findIndex(p=>p.includes("Accuracy"));d>-1?t.splice(d+1,0,c):t.push(c)}}else if(n.category==="thrown"){let{blast:c}=n.thrown;if(c!=null&&c.radius&&t.push(`${game.i18n.localize("SR5.BlastRadius")} ${c.radius}m`),c!=null&&c.dropoff&&t.push(`${game.i18n.localize("SR5.Dropoff")} ${c.dropoff}/m`),n.thrown.ranges){let d=n.thrown.ranges.attribute&&(a==null?void 0:a.actor)?a.actor.data.data.attributes[n.thrown.ranges.attribute].value:1,p=[n.thrown.ranges.short,n.thrown.ranges.medium,n.thrown.ranges.long,n.thrown.ranges.extreme];t.push(p.map(g=>g*d).join("/"))}}let i=a.getEquippedMods();i&&i.forEach(c=>{t.push(`${c.name}`)})}};var Ze=class extends It{constructor(e,t,a){let r=Ze.getDialogData(e,t);super(r,a)}static get defaultOptions(){let e=super.defaultOptions;return e.id="damage-application",e.classes=["sr5","form-dialog"],e.resizable=!0,e.height="auto",e}static getDialogData(e,t){let a=game.i18n.localize("SR5.DamageApplication.Title"),r="systems/shadowrun5e/dist/templates/apps/dialogs/damage-application.html",i=e.map(c=>({actor:c})),s={damage:t,actorDamage:i},o={damage:{label:game.i18n.localize("SR5.DamageApplication.ApplyDamage")}};return{title:a,templatePath:r,templateData:s,onAfterClose:()=>i,buttons:o,default:"damage"}}};var za=class{runApplyDamage(e,t){return u(this,null,function*(){let a=yield new Ze(e,t);yield a.select(),!a.canceled&&e.forEach(r=>{this.applyDamageToActor(r,t)})})}applyDamageToActor(e,t){return u(this,null,function*(){t.value<=0||(t=this.changeStunToPhysicalForGrunts(e,t),t.type.value==="matrix"&&(t=yield e.addMatrixDamage(t)),t.type.value==="stun"&&(t=yield e.addStunDamage(t)),t.type.value==="physical"&&(yield e.addPhysicalDamage(t)))})}changeStunToPhysicalForGrunts(e,t){let a=duplicate(t);return e.isGrunt()&&t.type.value==="stun"&&(a.type.value="physical"),a}};var X=class{static getConditionMonitor(e){return e=Math.max(e,K.attributes.ranges.host_rating.min),Math.ceil(8+e/2)}static getICDeviceRating(e){return Math.max(e,K.attributes.ranges.host_rating.min)}static getICInitiativeBase(e){return Math.max(e*2,K.attributes.ranges.host_rating.min)}static getICInitiativeDice(){return Math.max(K.initiatives.ic.dice,K.initiatives.ranges.dice.min)}static getICMeatAttributeBase(e){return Math.max(e,K.attributes.ranges.host_rating.min)}static isValidMarksCount(e){return e>=X.minMarksCount()&&e<=X.maxMarksCount()&&e%1===0}static maxMarksCount(){return 3}static minMarksCount(){return 0}static getValidMarksCount(e){return e=Math.min(e,X.maxMarksCount()),Math.max(e,X.minMarksCount())}static hostMatrixAttributeRatings(e){return[1,2,3,4].map(t=>t+e)}};var Da=class{static executeResult(e,t){return u(this,null,function*(){var a;switch(e){case"placeMarks":{(a=ui.notifications)==null||a.error("Placing marks currently isnt suported. Sorry!");break}}})}static placeMatrixMarks(e,t,a){return u(this,null,function*(){var r;if(!X.isValidMarksCount(a))return(r=ui.notifications)==null?void 0:r.warn(game.i18n.localize("SR5.Warnings.InvalidMarksCount"));for(let i of t)yield e.setMarks(i,a)})}};function cl(n,e){return u(this,null,function*(){let t=yield ul(n,e),a=yield ChatMessage.create(t);return a?(game.dice3d&&e.roll&&w.showDiceSoNice(e.roll,t.whisper,t.blind),n.roll&&(yield a.setFlag(V,j.Roll,n.roll)),n.attack&&(yield a.setFlag(V,j.Attack,n.attack)),n.targets&&(yield a.setFlag(V,j.TargetsSceneTokenIds,n.targets.map(r=>hn(r.document)))),n.actionTestData&&(yield a.setFlag(V,j.ActionTestData,n.actionTestData)),a):null})}var ul=(n,e)=>u(void 0,null,function*(){var c,d,p;let t="systems/shadowrun5e/dist/templates/rolls/roll-card.html",a=n.actor,r=a==null?void 0:a.getToken(),i=ut(J({},n),{speaker:{actor:a,token:r},showGlitchAnimation:game.settings.get(V,j.ShowGlitchAnimation)}),s=yield renderTemplate(t,i),o={user:(c=game.user)==null?void 0:c.id,sound:e!=null&&e.roll?CONFIG.sounds.dice:void 0,content:s,roll:e!=null&&e.roll?JSON.stringify(e==null?void 0:e.roll):void 0,speaker:{actor:a==null?void 0:a.id,token:r==null?void 0:r.id,alias:(d=game.user)==null?void 0:d.name},flags:{shadowrun5e:{customRoll:!0}}},l=(p=n.rollMode)!=null?p:game.settings.get(Va,Ua.RollMode);return ChatMessage.applyRollMode(o,l),o.rollMode=l,e!=null&&e.whisperTo&&(o.whisper=ChatMessage.getWhisperRecipients(e.whisperTo.name)),o});function fn(n){return u(this,null,function*(){let e=dl(n);return yield cl(e)})}function dl(n){let{actor:e,item:t,description:a,tests:r}=n,i=e==null?void 0:e.getToken(),s=hn(i);return{title:game.i18n.localize("SR5.Description"),actor:e,tokenId:s,item:t,description:a,tests:r}}function hn(n){let e=n==null?void 0:n.parent;if(!(!n||!e))return`${e.id}.${n.id}`}var gn=(n,e,t)=>{e.on("click",".apply-damage",a=>ml(e,a))},ml=(n,e)=>u(void 0,null,function*(){var c,d;e.stopPropagation(),e.preventDefault();let t=$(e.currentTarget),a=Number(t.data("damageValue")),r=String(t.data("damageType")),i=Number(t.data("damageAp")),s=String(t.data("damageElement")),o=w.createDamageData(a,r,i,s),l=w.getSelectedActorsOrCharacter();if(l.length===0){let p=n.data("messageId"),g=(c=game.messages)==null?void 0:c.get(p);if(!g)return;let y=g.getFlag(V,j.TargetsSceneTokenIds);if(y)y.forEach(S=>{let M=w.getSceneTokenActor(S);!M||l.push(M)});else{let S=n.find(".chat-card").data("tokenId"),M=w.getSceneTokenActor(S);M&&l.push(M)}if(l.length===0){(d=ui.notifications)==null||d.warn(game.i18n.localize("SR5.Warnings.TokenSelectionNeeded"));return}}yield new za().runApplyDamage(l,o)});function yn(n){Wa.setDeviceCategory(n),Wa.prepareMatrixAttributes(n)}var Wa=class{static setDeviceCategory(e){e.category="host"}static prepareMatrixAttributes(e){let t=X.hostMatrixAttributeRatings(e.rating);Object.values(e.atts).forEach(a=>{a.value=t.pop(),a.editable=!1})}};var se=class{static _createMessage(e,t,a){return{type:e,data:t,userId:a}}static emit(e,t){return u(this,null,function*(){if(!game.socket)return;let a=se._createMessage(e,t);console.trace("Shadowrun 5e | Emiting Shadowrun5e system socket message",a),yield game.socket.emit(wa,a)})}static emitForGM(e,t){return u(this,null,function*(){if(!game.socket||!game.user||!game.users)return;if(game.user.isGM)return console.error("Active user is GM! Aborting socket message...");let a=game.users.find(i=>i.isGM);if(!a)return console.error("No active GM user! One GM must be active for this action to work.");let r=se._createMessage(e,t,a.id);console.trace("Shadowrun 5e | Emiting Shadowrun5e system socket message",r),yield game.socket.emit(wa,r)})}};var H=class{static buildLink(e){return e.uuid}static resolveLink(e){if(!e)return;let t=e.split("."),a;if(t[0]==="Compendium"){t.shift();let[r,i,s]=t.slice(0,3);t=t.slice(3);let o=game.packs.get(`${r}.${i}`);if(!o)return;a=o.getDocument(s)}else{let[r,i]=t.slice(0,2);t=t.slice(2),a=CONFIG[r].collection.instance.get(i)}for(;a&&t.length>1;){let[r,i]=t.slice(0,2);a=a.getEmbeddedDocument(r,i),t=t.slice(2)}return a||null}static emitAddNetworkControllerSocketMessage(e,t){return u(this,null,function*(){let a=H.buildLink(e),r=H.buildLink(t);yield se.emitForGM(j.addNetworkController,{controllerLink:a,networkDeviceLink:r})})}static _handleAddNetworkControllerSocketMessage(e){return u(this,null,function*(){var r;if(console.log("Shadowrun 5e | Handle add network controller socket message",e),!((r=game.user)!=null&&r.isGM))return console.error("Shadowrun 5e | Abort handling of message. Current user isn't a GM",game.user);let t=H.resolveLink(e.data.controllerLink),a=H.resolveLink(e.data.networkDeviceLink);if(!t||!a)return console.error("Shadowrun 5e | Either the networks controller or device did not resolve.");yield H._handleAddDeviceToNetwork(t,a)})}static addDeviceToNetwork(e,t){return u(this,null,function*(){var r;if(console.log(`Shadowrun5e | Adding an the item ${t.name} to the controller ${e.name}`,e,t),e.id===t.id)return console.warn("Shadowrun 5e | A device cant be its own network controller");if(!t.getTechnologyData())return(r=ui.notifications)==null?void 0:r.error(game.i18n.localize("SR5.Errors.CanOnlyAddTechnologyItemsToANetwork"));!e.canBeNetworkController||(H._currentUserCanModifyDevice(e)&&H._currentUserCanModifyDevice(t)?yield H._handleAddDeviceToNetwork(e,t):yield H.emitAddNetworkControllerSocketMessage(e,t))})}static _handleAddDeviceToNetwork(e,t){return u(this,null,function*(){if(!H._currentUserCanModifyDevice(e)&&!H._currentUserCanModifyDevice(t))return console.error("User isn't owner or GM of this device",e);let a=e.asDeviceData()||e.asHostData();if(!a)return console.error("Device isn't capable of accepting network devices",e);let r=t.getTechnologyData();if(!r)return console.error("'Device can't be added to a network");r.networkController&&(yield H._removeDeviceFromController(t));let i=H.buildLink(e);yield H._setControllerFromLink(t,i);let s=H.buildLink(t),o=a.data.networkDevices;if(!o.includes(s))return H._setDevicesOnController(e,[...o,s])})}static removeDeviceFromController(e){return u(this,null,function*(){!e||(console.log(`Shadowrun 5e | Removing device ${e.name} from it's controller`),yield H._removeDeviceFromController(e),yield H._removeControllerFromDevice(e))})}static removeDeviceLinkFromNetwork(e,t){return u(this,null,function*(){console.log(`Shadowrun 5e | Removing device with uuid ${t} from network`);let a=e.asControllerData(),r=H.resolveLink(t);if(r&&r.getTechnologyData()&&(yield H._removeControllerFromDevice(r)),!a)return;let i=a.data.networkDevices.filter(s=>s!==t);yield H._setDevicesOnController(e,i)})}static removeAllDevicesFromNetwork(e){return u(this,null,function*(){console.log(`Shadowrun 5e | Removing all devices from network ${e.name}`),yield H._removeControllerFromAllDevices(e),yield H._removeAllDevicesFromController(e)})}static _setControllerFromLink(e,t){return u(this,null,function*(){if(!e.canBeNetworkDevice)return console.error("Shadowrun 5e | Given device cant be part of a network",e);yield e.update({"data.technology.networkController":t})})}static _removeControllerFromDevice(e){return u(this,null,function*(){if(!e.canBeNetworkDevice)return console.error("Shadowrun 5e | Given device cant be part of a network",e);!H._currentUserCanModifyDevice(e)||(yield e.update({"data.technology.networkController":""}))})}static _setDevicesOnController(e,t){return u(this,null,function*(){if(!e.canBeNetworkController)return console.error("Shadowrun 5e | Given device cant control a network",e);yield e.update({"data.networkDevices":t})})}static _removeAllDevicesFromController(e){return u(this,null,function*(){if(!e.canBeNetworkController)return console.error("Shadowrun 5e | Given device cant control a network",e);yield e.update({"data.networkDevices":[]})})}static _removeDeviceFromController(e){return u(this,null,function*(){if(!e.canBeNetworkDevice)return console.error("Shadowrun 5e | Given device cant be part of a network",e);let t=e.getTechnologyData();if(!t)return;let a=H.resolveLink(t.networkController);if(!a||!H._currentUserCanModifyDevice(a))return;let r=a.asControllerData();if(!r)return;let i=H.buildLink(e),s=r.data.networkDevices.filter(o=>o!==i);yield H._setDevicesOnController(a,s)})}static _removeControllerFromAllDevices(e){return u(this,null,function*(){if(!e.canBeNetworkController)return console.error("Shadowrun 5e | Given device cant control a network",e);let t=e.asControllerData();if(!t)return;let a=t.data.networkDevices;if(a){let r=a.map(i=>H.resolveLink(i));for(let i of r)!i||(yield H._removeControllerFromDevice(i))}})}static getNetworkDevices(e){let t=[],a=e.asControllerData();return a&&a.data.networkDevices.forEach(r=>{let i=H.resolveLink(r);if(!i)return console.warn(`Shadowrun5e | Controller ${e.name} has a network device ${r} that doesn't exist anymore`);t.push(i)}),t}static handleOnDeleteItem(e,t,a){return u(this,null,function*(){if(console.log(`Shadowrun 5e | Checking for network on deleted item ${e.name}`,e),e.canBeNetworkController)return yield H._removeControllerFromAllDevices(e);if(e.canBeNetworkDevice)return yield H._removeDeviceFromController(e)})}static _currentUserCanModifyDevice(e){var t;return((t=game.user)==null?void 0:t.isGM)||e.isOwner}};var nt=class extends Item{constructor(){super(...arguments);this.labels={}}get actor(){return super.actor}get actorOwner(){if(!!this.actor)return this.actor instanceof st?this.actor:this.actor.actorOwner}get wrapper(){return new ne(this.data)}getLastFireMode(){return this.getFlag(V,j.LastFireMode)||{value:0}}setLastFireMode(t){return u(this,null,function*(){return this.setFlag(V,j.LastFireMode,t)})}getLastSpellForce(){return this.getFlag(V,j.LastSpellForce)||{value:0}}setLastSpellForce(t){return u(this,null,function*(){return this.setFlag(V,j.LastSpellForce,t)})}getLastComplexFormLevel(){return this.getFlag(V,j.LastComplexFormLevel)||{value:0}}setLastComplexFormLevel(t){return u(this,null,function*(){return this.setFlag(V,j.LastComplexFormLevel,t)})}getLastFireRangeMod(){return this.getFlag(V,j.LastFireRange)||{value:0}}setLastFireRangeMod(t){return u(this,null,function*(){return this.setFlag(V,j.LastFireRange,t)})}getNestedItems(){let t=this.getFlag(V,j.EmbeddedItems);return t=t||[],t&&!Array.isArray(t)&&(t=w.convertIndexedObjectToArray(t)),t=t.map(a=>(a.effects&&!Array.isArray(a.effects)&&(a.effects=w.convertIndexedObjectToArray(a.effects)),a)),t}setNestedItems(t){return u(this,null,function*(){yield this.setFlag(V,j.EmbeddedItems,t)})}clearNestedItems(){return u(this,null,function*(){yield this.unsetFlag(V,j.EmbeddedItems)})}get hasOpposedRoll(){let t=this.getAction();return t?!!t.opposed.test:!1}get hasRoll(){let t=this.getAction();return!!(t&&t.type!==""&&(t.skill||t.attribute||t.attribute2||t.dice_pool_mod))}get hasTemplate(){return this.isAreaOfEffect()}prepareData(){var l;super.prepareData(),this.prepareNestedItems(),this.labels={},this.data.type==="sin"&&typeof this.data.data.licenses=="object"&&(this.data.data.licenses=Object.values(this.data.data.licenses));let t=this.getEquippedMods(),a=this.getEquippedAmmo(),r=this.getTechnologyData();if(r){r.condition_monitor===void 0&&(r.condition_monitor={value:0,max:0,label:""});let c=typeof r.rating=="string"?0:r.rating;r.condition_monitor.max=8+Math.ceil(c/2),r.conceal||(r.conceal={base:0,value:0,mod:[]});let d=new O;t.forEach(p=>{let g=p.getTechnologyData();g&&g.conceal.value&&d.addUniquePart(p.name,g.conceal.value)}),r.conceal.mod=d.list,r.conceal.value=w.calcTotal(r.conceal)}let i=this.getAction();if(i){i.alt_mod=0,i.limit.mod=[],i.damage.mod=[],i.damage.ap.mod=[],i.dice_pool_mod=[],i.damage.base_formula_operator==="+"&&(i.damage.base_formula_operator="add"),(l=this.actor)!=null&&l.data&&(i.damage.source={actorId:this.actor.id,itemId:this.id,itemName:this.name,itemType:this.data.type});let c=new O(i.limit.mod),d=new O(i.dice_pool_mod);if(t.forEach(p=>{let g=p.asModificationData();!g||(g.data.accuracy&&c.addUniquePart(p.name,g.data.accuracy),g.data.dice_pool&&d.addUniquePart(p.name,g.data.dice_pool))}),a){let p=a.data.data;i.damage.mod=O.AddUniquePart(i.damage.mod,a.name,p.damage),i.damage.ap.mod=O.AddUniquePart(i.damage.ap.mod,a.name,p.ap),p.element?i.damage.element.value=p.element:i.damage.element.value=i.damage.element.base,p.damageType?i.damage.type.value=p.damageType:i.damage.type.value=i.damage.type.base}else i.damage.element.value=i.damage.element.base,i.damage.type.value=i.damage.type.base;i.damage.value=w.calcTotal(i.damage),i.damage.ap.value=w.calcTotal(i.damage.ap),i.limit.value=w.calcTotal(i.limit)}let s=this.getWeaponRange();if(s&&s.rc){let c=new O;t.forEach(d=>{d.data.data.rc&&c.addUniquePart(d.name,d.data.data.rc)}),s.rc.mod=c.list,s.rc&&(s.rc.value=w.calcTotal(s.rc))}let o=this.asAdeptPowerData();switch(o&&(o.data.type=o.data.action.type?"active":"passive"),this.data.type){case"host":yn(this.data.data)}}postItemCard(){return u(this,null,function*(){let t=this.getActionTests(),a={actor:this.actor,description:this.getChatData(),item:this,previewTemplate:this.hasTemplate,tests:t};return yield fn(a)})}castAction(t){return u(this,null,function*(){if(W.shouldPostItemDescription(t)||!this.hasRoll)return yield this.postItemCard();if(!this.actor)return;let r=!W.shouldHideDialog(t),i=yield W.fromItem(this,this.actor,{showDialog:r});!i||(yield i.execute())})}getChatData(t){let a=duplicate(this.data.data),{labels:r}=this;a.description||(a.description={}),a.description.value||(a.description.value=""),a.description.value=TextEditor.enrichHTML(a.description.value,t);let i=[],s=$t[this.data.type];return s&&s(duplicate(a),r,i,this),a.properties=i.filter(o=>!!o),a}getActionTestName(){let t=this.getRollName();return t||game.i18n.localize("SR5.Action")}getOpposedTestMod(){let t=new O;return this.hasOpposedTest()&&this.isAreaOfEffect()&&t.addUniquePart("SR5.Aoe",-2),t}getBlastData(t){if(this.isSpell()&&this.isAreaOfEffect()){let a=this.data.data,r=this.getLastSpellForce().value;return t!=null&&t.spell&&(r=t.spell.force),a.extended&&(r*=10),{radius:r,dropoff:0}}else if(this.isGrenade()){let a=this.data.data,r=a.thrown.blast.radius,i=a.thrown.blast.dropoff;return{radius:r,dropoff:i}}else if(this.hasExplosiveAmmo()){let r=this.getEquippedAmmo().asAmmoData();if(!r)return{radius:0,dropoff:0};let i=r.data.blast.radius,s=r.data.blast.dropoff;return{radius:i,dropoff:s}}}getEquippedAmmo(){return(this.items||[]).filter(a=>a.isAmmo()&&a.isEquipped())[0]}getEquippedMods(){return(this.items||[]).filter(t=>t.isWeaponModification()&&t.isEquipped())}hasExplosiveAmmo(){let t=this.getEquippedAmmo();return t?t.data.data.blast.radius>0:!1}equipWeaponMod(t){return u(this,null,function*(){let a=this.getOwnedItem(t);if(a){let r=duplicate(a.data),i=r.data;i.technology.equipped=!i.technology.equipped,yield this.updateOwnedItem(r)}})}hasAmmo(){return this.wrapper.hasAmmo()}useAmmo(t){return u(this,null,function*(){let a=duplicate(this.asWeaponData());if(a){let{ammo:r}=a.data;return r.current.value=Math.max(0,r.current.value-t),yield this.update(a)}})}reloadAmmo(){return u(this,null,function*(){let t=duplicate(this.asWeaponData());if(!t)return;let{ammo:a}=t.data,r=a.current.max-a.current.value;a.current.value=a.current.max,a.spare_clips&&(a.spare_clips.value=Math.max(0,a.spare_clips.value-1)),yield this.update(t);let i=(this.items||[]).filter(s=>s.data.type==="ammo").reduce((s,o)=>{let l=o.asAmmoData();if(l&&l.data.technology.equipped){let{technology:c}=l.data,d=typeof c.quantity=="string"?0:c.quantity;c.quantity=Math.max(0,d-r),s.push(o.data)}return s},[]);i&&i.length&&(yield this.updateOwnedItem(i))})}equipAmmo(t){return u(this,null,function*(){let a=this.items.filter(r=>r.type==="ammo").map(r=>{let i=this.getOwnedItem(r.id),s=i==null?void 0:i.asAmmoData();if(i&&s)return s.data.technology.equipped=t===r.id,i.data});yield this.updateOwnedItem(a)})}addNewLicense(){return u(this,null,function*(){let t=duplicate(this.asSinData());!t||(typeof t.data.licenses=="object"&&(t.data.licenses=Object.values(t.data.licenses)),t.data.licenses.push({name:"",rtg:"",description:""}),yield this.update(t))})}getRollPartsList(){if(!this.getAction()||!this.actor)return[];let a=new O(duplicate(this.getModifierList())),r=this.actor.findActiveSkill(this.getActionSkill()),i=this.actor.findAttribute(this.getActionAttribute()),s=this.actor.findAttribute(this.getActionAttribute2());i&&i.label&&a.addPart(i.label,i.value),r?(a.addUniquePart(r.label||r.name,r.value),Mt.handleDefaulting(r,a)):s&&s.label&&a.addPart(s.label,s.value);let o=this.getActionSpecialization();o&&a.addUniquePart(o,2);let l=parseInt(this.data.data.action.mod||0);l&&a.addUniquePart("SR5.ItemMod",l);let c=[];return i!==void 0&&c.push(i),s!==void 0&&c.push(s),r!==void 0&&c.push(r),this.actor._addGlobalParts(a),this.actor._addMatrixParts(a,c),this._addWeaponParts(a),a.list}calculateRecoil(){var a;let t=this.getLastFireMode();return!t||t.value===20?0:Math.min(this.getRecoilCompensation(!0)-(((a=this.getLastFireMode())==null?void 0:a.value)||0),0)}_addWeaponParts(t){if(this.isRangedWeapon()){let a=this.calculateRecoil();a&&t.addUniquePart("SR5.Recoil",a)}}isSin(){return this.wrapper.isSin()}asSinData(){if(this.isSin())return this.data}isLifestyle(){return this.wrapper.isLifestyle()}asLifestyleData(){if(this.isLifestyle())return this.data}isAmmo(){return this.wrapper.isAmmo()}asAmmoData(){if(this.isAmmo())return this.data}isModification(){return this.wrapper.isModification()}asModificationData(){if(this.isModification())return this.data}isWeaponModification(){return this.wrapper.isWeaponModification()}isArmorModification(){return this.wrapper.isArmorModification()}isProgram(){return this.wrapper.isProgram()}asProgramData(){if(this.isProgram())return this.data}isQuality(){return this.wrapper.isQuality()}asQualityData(){if(this.isQuality())return this.data}isAdeptPower(){return this.data.type==="adept_power"}asAdeptPowerData(){if(this.isAdeptPower())return this.data}isHost(){return this.data.type==="host"}asHostData(){if(this.isHost())return this.data}removeLicense(t){return u(this,null,function*(){let a=duplicate(this.asSinData());a&&(a.data.licenses.splice(t,1),yield this.update(a))})}isAction(){return this.wrapper.isAction()}asActionData(){if(this.isAction())return this.data}rollOpposedTest(t,a,r){return u(this,null,function*(){console.error(`Shadowrun5e | ${this.constructor.name}.rollOpposedTest is not supported anymore`)})}rollTestType(t,a,r,i){return u(this,null,function*(){t==="opposed"&&(yield this.rollOpposedTest(i,a,r)),t==="action"&&(yield this.castAction(r))})}static getItemFromMessage(t){var o;if(!game||!game.scenes||!game.ready||!canvas||!canvas.ready||!canvas.scene)return;let a=t.find(".chat-card"),r,i=a.data("tokenId");if(i?r=w.getSceneTokenActor(i):r=(o=game.actors)==null?void 0:o.get(a.data("actorId")),!r)return;let s=a.data("itemId");return r.items.get(s)}static getTargets(){if(!game.ready||!game.user)return;let{character:t}=game.user,{controlled:a}=canvas.tokens,r=a.reduce((i,s)=>s.actor?i.concat([s.actor]):i,[]);if(t&&a.length===0&&r.push(t),!r.length)throw new Error("You must designate a specific Token as the roll target");return r}getActionTests(){return this.hasRoll?[{label:this.getActionTestName(),type:"action"}]:[]}getActionResult(){if(!!this.isAction())return this.wrapper.getActionResult()}createOwnedItem(r){return u(this,arguments,function*(t,a={}){if(Array.isArray(t)||(t=[t]),this.type==="weapon"){let i=duplicate(this.getNestedItems());t.forEach(s=>{var l,c;let o=duplicate(s);o._id=randomID(16),(o.type==="ammo"||o.type==="modification")&&((c=(l=o==null?void 0:o.data)==null?void 0:l.technology)!=null&&c.equipped&&(o.data.technology.equipped=!1),i.push(o))}),yield this.setNestedItems(i)}return yield this.prepareNestedItems(),yield this.prepareData(),yield this.render(!1),!0})}prepareNestedItems(){let t=this.getNestedItems();if(t){let a=(this.items||[]).reduce((r,i)=>(r[i.id]=i,r),{});this.items=t.map(r=>{let i=game.user?{permission:{[game.user.id]:CONST.DOCUMENT_PERMISSION_LEVELS.OWNER}}:{};if(r._id in a){let s=a[r._id];return s.data.update(J(J({},r),i)),s.prepareData(),s}else return new nt(J(J({},r),i),{parent:this})})}}getOwnedItem(t){let a=this.items;if(!!a)return a.find(r=>r.id===t)}updateOwnedItem(t){return u(this,null,function*(){let a=duplicate(this.getNestedItems());if(!!a&&(t=Array.isArray(t)?t:[t],!(!t||t.length===0)))return t.forEach(r=>{let i=a.findIndex(o=>o._id===r._id);if(i===-1)return;let s=a[i];delete r._id,s&&(r=expandObject(r),mergeObject(s,r),a[i]=s)}),yield this.setNestedItems(a),yield this.prepareNestedItems(),yield this.prepareData(),yield this.render(!1),!0})}updateEmbeddedEntity(t,a,r){return u(this,null,function*(){return yield this.updateOwnedItem(a),this})}deleteOwnedItem(t){return u(this,null,function*(){let a=duplicate(this.getNestedItems());if(!a)return;let r=a.findIndex(i=>i._id===t||Number(i._id)===t);if(r===-1)throw new Error(`Shadowrun5e | Couldn't find owned item ${t}`);return a.splice(r,1),yield this.clearNestedItems(),yield this.setNestedItems(a),yield this.prepareNestedItems(),yield this.prepareData(),yield this.render(!1),!0})}openPdfSource(){return u(this,null,function*(){var i,s;if(!ui.PDFoundry){(i=ui.notifications)==null||i.warn(game.i18n.localize("SR5.DIALOG.MissingModuleContent"));return}let t=this.getBookSource();t===""&&((s=ui.notifications)==null||s.error(game.i18n.localize("SR5.SourceFieldEmptyError")));let[a,r]=t.split(" ");ui.PDFoundry.openPDFByCode(a,{page:parseInt(r)})})}_canDealDamage(){let t=this.getAction();return t?!!t.damage.type.base:!1}getAction(){return this.wrapper.getAction()}getExtended(){let t=this.getAction();return t?t.extended:!1}getTechnologyData(){return this.wrapper.getTechnology()}getRange(){return this.wrapper.getRange()}getWeaponRange(){if(this.isRangedWeapon())return this.getRange()}getRollName(){return this.isRangedWeapon()?game.i18n.localize("SR5.RangeWeaponAttack"):this.isMeleeWeapon()?game.i18n.localize("SR5.MeleeWeaponAttack"):this.isCombatSpell()?game.i18n.localize("SR5.SpellAttack"):this.isSpell()?game.i18n.localize("SR5.SpellCast"):this.hasRoll?this.name:on}setFlag(t,a,r){let i=w.onSetFlag(r);return super.setFlag(t,a,i)}getFlag(t,a){let r=super.getFlag(t,a);return w.onGetFlag(r)}isAreaOfEffect(){return this.wrapper.isAreaOfEffect()}isArmor(){return this.wrapper.isArmor()}asArmorData(){if(this.isArmor())return this.data}hasArmorBase(){return this.wrapper.hasArmorBase()}hasArmorAccessory(){return this.wrapper.hasArmorAccessory()}hasArmor(){return this.wrapper.hasArmor()}isGrenade(){return this.wrapper.isGrenade()}isWeapon(){return this.wrapper.isWeapon()}asWeaponData(){if(this.wrapper.isWeapon())return this.data}isCyberware(){return this.wrapper.isCyberware()}asCyberwareData(){if(this.isCyberware())return this.data}isCombatSpell(){return this.wrapper.isCombatSpell()}isDirectCombatSpell(){return this.wrapper.isDirectCombatSpell()}isIndirectCombatSpell(){return this.wrapper.isIndirectCombatSpell()}isManaSpell(){return this.wrapper.isManaSpell()}isPhysicalSpell(){return this.wrapper.isPhysicalSpell()}isRangedWeapon(){return this.wrapper.isRangedWeapon()}isSpell(){return this.wrapper.isSpell()}asSpellData(){if(this.isSpell())return this.data}isSpritePower(){return this.wrapper.isSpritePower()}asSpritePowerData(){if(this.isSpritePower())return this.data}isBioware(){return this.wrapper.isBioware()}isComplexForm(){return this.wrapper.isComplexForm()}asComplexFormData(){if(this.isComplexForm())return this.data}isContact(){return this.wrapper.isContact()}asContactData(){if(this.isContact())return this.data}isCritterPower(){return this.wrapper.isCritterPower()}asCritterPowerData(){if(this.isCritterPower())return this.data}isMeleeWeapon(){return this.wrapper.isMeleeWeapon()}isDevice(){return this.wrapper.isDevice()}asDeviceData(){if(this.isDevice())return this.data}asControllerData(){return this.asHostData()||this.asDeviceData()||void 0}isEquipment(){return this.wrapper.isEquipment()}asEquipmentData(){if(this.isEquipment())return this.data}isEquipped(){return this.wrapper.isEquipped()}isCyberdeck(){return this.wrapper.isCyberdeck()}isCommlink(){return this.wrapper.isCommlink()}isMatrixAction(){return this.wrapper.isMatrixAction()}getBookSource(){return this.wrapper.getBookSource()}getConditionMonitor(){return this.wrapper.getConditionMonitor()}getRating(){return this.wrapper.getRating()}getArmorValue(){return this.wrapper.getArmorValue()}getArmorElements(){return this.wrapper.getArmorElements()}getEssenceLoss(){return this.wrapper.getEssenceLoss()}getASDF(){return this.wrapper.getASDF()}getActionSkill(){return this.wrapper.getActionSkill()}getActionAttribute(){return this.wrapper.getActionAttribute()}getActionAttribute2(){return this.wrapper.getActionAttribute2()}getModifierList(){return this.wrapper.getModifierList()}getActionSpecialization(){return this.wrapper.getActionSpecialization()}getDrain(){return this.wrapper.getDrain()}getFade(){return this.wrapper.getFade()}getRecoilCompensation(t=!0){let a=this.wrapper.getRecoilCompensation();return t&&this.actor&&(a+=this.actor.getRecoilCompensation()),a}getReach(){var t;return this.isMeleeWeapon()&&(t=this.data.data.melee.reach)!=null?t:0}getCondition(){let t=this.getTechnologyData();if(t&&"condition_monitor"in t)return t.condition_monitor}hasOpposedTest(){if(!this.hasOpposedRoll)return!1;let t=this.getAction();return t?t.opposed.test!=="":!1}addIC(t,a=null){return u(this,null,function*(){var l;let r=this.asHostData();if(!r||!t)return;let i=a?yield w.getEntityFromCollection(a,t):(l=game.actors)==null?void 0:l.get(t);if(!i||!i.isIC()){console.error(`Provided actor id ${t} doesn't exist (with pack collection '${a}') or isn't an IC type`);return}let s=i.asICData();if(!s)return;let o=P.sourceEntityData({id:i.id,name:i.name,type:"Actor",pack:a,data:{icType:s.data.icType}});r.data.ic.push(o),yield this.update({"data.ic":r.data.ic})})}removeIC(t){return u(this,null,function*(){if(isNaN(t)||t<0)return;let a=this.asHostData();!a||a.data.ic.length<=t||(a.data.ic.splice(t,1),yield this.update({"data.ic":a.data.ic}))})}get _isEmbeddedItem(){return this.hasOwnProperty("parent")&&this.parent instanceof nt}updateEmbeddedItem(t){return u(this,null,function*(){var a;return!this.parent||this.parent instanceof st?this:(t._id=this.id,yield this.parent.updateOwnedItem(t),yield(a=this.sheet)==null?void 0:a.render(!1),this)})}update(t,a){return u(this,null,function*(){return this._isEmbeddedItem?this.updateEmbeddedItem(t):yield Y(nt.prototype,this,"update").call(this,t,a)})}setMarks(t,a,r){return u(this,null,function*(){if(!canvas.ready)return;if(!this.isHost()){console.error("Only Host item types can place matrix marks!");return}let i=(r==null?void 0:r.scene)||canvas.scene,s=r==null?void 0:r.item,o=w.buildMarkId(i.id,t.id,s==null?void 0:s.id),l=this.asHostData();if(!l)return;let c=r!=null&&r.overwrite?0:this.getMarksById(o);l.data.marks[o]=X.getValidMarksCount(c+a),yield this.update({"data.marks":l.data.marks})})}getMarksById(t){let a=this.asHostData();return a?a.data.marks[t]:0}getAllMarks(){let t=this.asHostData();if(!!t)return t.data.marks}getMarks(t,a,r){if(!canvas.ready||!this.isHost())return 0;let i=(r==null?void 0:r.scene)||canvas.scene;a=a||t.getMatrixDevice();let s=w.buildMarkId(i.id,t.id,a==null?void 0:a.id),o=this.asHostData();return o&&o.data.marks[s]||0}clearMarks(){return u(this,null,function*(){if(!this.isHost())return;let t=this.asHostData();if(!t)return;let a={};for(let r of Object.keys(t.data.marks))a[`-=${r}`]=null;yield this.update({"data.marks":a})})}clearMark(t){return u(this,null,function*(){if(!this.isHost())return;let a={};a[`-=${t}`]=null,yield this.update({"data.marks":a})})}addNetworkDevice(t){return u(this,null,function*(){yield H.addDeviceToNetwork(this,t)})}addNetworkController(t){return u(this,null,function*(){yield this.addNetworkDevice(t)})}removeNetworkDevice(t){return u(this,null,function*(){let a=this.asControllerData();if(!a||a.data.networkDevices[t]===void 0)return;let r=a.data.networkDevices[t],i=this;return yield H.removeDeviceLinkFromNetwork(i,r)})}removeAllNetworkDevices(){return u(this,null,function*(){if(!!this.asControllerData())return yield H.removeAllDevicesFromNetwork(this)})}getAllMarkedDocuments(){if(!this.isHost())return[];let t=this.getAllMarks();return t?Object.entries(t).filter(([a,r])=>w.isValidMarkId(a)).map(([a,r])=>ut(J({},w.getMarkIdDocuments(a)),{marks:r,markId:a})):[]}get networkController(){let t=this.getTechnologyData();if(!!t&&!!t.networkController)return H.resolveLink(t.networkController)}get networkDevices(){return this.asDeviceData()||this.asHostData()?H.getNetworkDevices(this):[]}get canBeNetworkController(){return this.isDevice()||this.isHost()}get canBeNetworkDevice(){return!!this.getTechnologyData()}disconnectFromNetwork(){return u(this,null,function*(){this.canBeNetworkController&&(yield H.removeAllDevicesFromNetwork(this)),this.canBeNetworkDevice&&(yield H.removeDeviceFromController(this))})}_preUpdate(t,a,r){var o;if(this.isWeapon()&&((o=t==null?void 0:t.data)==null?void 0:o.category)&&t.data.category!==""){let l=q.weaponCategoryActiveTests[t.data.category];l||console.error(`Shadowrun 5 | There is no active test configured for the weapon category ${t.data.category}.`,this),foundry.utils.mergeObject(t,{data:{action:{test:l}}})}let i=this.asSpellData();if(i){let l=foundry.utils.mergeObject(i,t);switch(l.data.category){case"":{foundry.utils.mergeObject(t,{data:{action:{test:"",opposed:{test:"",resist:{test:""}}}}});break}default:{let c=q.activeTests[this.data.type],d=q.opposedTests[this.data.type][l.data.category]||"OpposedTest",p=q.opposedResistTests[this.data.type][l.data.category]||"";foundry.utils.mergeObject(t,{data:{action:{test:c,opposed:{test:d,resist:{test:p}}}}});break}}}let s=this.asComplexFormData();if(s){let l=foundry.utils.mergeObject(s,t),c=q.activeTests[this.data.type];foundry.utils.mergeObject(t,{data:{action:{test:c}}})}return super._preUpdate(t,a,r)}};var ht=class{static prepareCurrentInitiative(e){let{initiative:t}=e;t.perception==="matrix"?t.current=t.matrix:t.perception==="astral"?t.current=t.astral:(t.current=t.meatspace,t.perception="meatspace"),t.current.dice.value=w.calcTotal(t.current.dice,{min:0,max:5}),t.edge&&(t.current.dice.value=5),t.current.dice.value=Math.min(5,t.current.dice.value),t.current.dice.text=`${t.current.dice.value}d6`,t.current.base.value=w.calcTotal(t.current.base)}static prepareMeatspaceInit(e){let{initiative:t,attributes:a,modifiers:r}=e;t.meatspace.base.base=a.intuition.value+a.reaction.value,t.meatspace.base.mod=O.AddUniquePart(t.meatspace.base.mod,"SR5.Bonus",Number(r.meat_initiative)),t.meatspace.dice.base=1,t.meatspace.dice.mod=O.AddUniquePart(t.meatspace.dice.mod,"SR5.Bonus",Number(r.meat_initiative_dice))}static prepareAstralInit(e){let{initiative:t,attributes:a,modifiers:r}=e;t.astral.base.base=a.intuition.value*2,t.astral.base.mod=O.AddUniquePart(t.astral.base.mod,"SR5.Bonus",Number(r.astral_initiative)),t.astral.dice.base=2,t.astral.dice.mod=O.AddUniquePart(t.astral.dice.mod,"SR5.Bonus",Number(r.astral_initiative_dice))}static prepareMatrixInit(e){let{initiative:t,attributes:a,modifiers:r,matrix:i}=e;i&&(t.matrix.base.base=a.intuition.value+e.matrix.data_processing.value,t.matrix.base.mod=O.AddUniquePart(t.matrix.base.mod,"SR5.Bonus",Number(r.matrix_initiative)),t.matrix.dice.base=i.hot_sim?4:3,t.matrix.dice.mod=O.AddUniquePart(t.matrix.dice.mod,"SR5.Bonus",Number(r.matrix_initiative_dice)))}};var et=class{static prepareModifiers(e){let t=et.commonModifiers;t=t.concat(et.matrixModifiers),t=t.concat(et.characterModifiers),et.setupModifiers(e,t)}static get commonModifiers(){return["soak","defense"]}static get characterModifiers(){return["drain","armor","physical_limit","social_limit","mental_limit","stun_track","physical_track","meat_initiative","meat_initiative_dice","astral_initiative","astral_initiative_dice","composure","lift_carry","judge_intentions","memory","walk","run","wound_tolerance","essence","fade"]}static get matrixModifiers(){return["matrix_initiative","matrix_initiative_dice","matrix_track"]}static setupModifiers(e,t){e.modifiers||(e.modifiers={}),t.sort(),t.unshift("global");let a={};for(let r of t)a[r]=Number(e.modifiers[r])||0;e.modifiers=a}static clearAttributeMods(e){let{attributes:t}=e;for(let[a,r]of Object.entries(t)){if(!q.attributes.hasOwnProperty(a)||!r)return;r.mod=[]}}static clearArmorMods(e){let{armor:t}=e;t.mod=[]}static clearLimitMods(e){let{limits:t}=e;for(let[a,r]of Object.entries(t)){if(!q.limits.hasOwnProperty(a)||!r)return;r.mod=[]}}};var pt=class{static prepareAttributes(e){let{attributes:t}=e;t.magic.hidden=!0,t.resonance.hidden=!0,t.edge.hidden=!0,t.essence.hidden=!0;for(let[a,r]of Object.entries(t)){if(a==="edge"&&r.uses===void 0)return;pt.prepareAttribute(a,r)}}static prepareAttribute(e,t){!q.attributes.hasOwnProperty(e)||!t||(pt.calculateAttribute(e,t),t.label=q.attributes[e])}static calculateAttribute(e,t){if(!q.attributes.hasOwnProperty(e)||!t)return;let a=K.attributes.ranges[e];w.calcTotal(t,a)}};var Pt=class{static prepareMatrix(e,t){let{matrix:a,attributes:r}=e;["firewall","sleaze","data_processing","attack"].forEach(o=>{let l=new O(a[o].mod);l.addUniquePart("SR5.Temporary",a[o].temp),l.removePart("Temporary"),a[o].mod=l.list,a[o].value=l.total}),a.condition_monitor.max=0,a.rating=0,a.name="",a.device="",a.condition_monitor.label="SR5.ConditionMonitor";let s=t.find(o=>o.isEquipped()&&o.isDevice());if(s){let o=s.getConditionMonitor();a.device=s.getId(),a.condition_monitor.max=o.max,a.condition_monitor.value=o.value,a.rating=s.getRating(),a.is_cyberdeck=s.isCyberdeck(),a.name=s.getName(),a.item=s.getData();let l=s.getASDF();if(l)for(let[c,d]of Object.entries(l))d&&a[c]&&(a[c].base=d.value,a[c].device_att=d.device_att)}else e.special==="resonance"&&(a.firewall.base=w.calcTotal(r.willpower),a.data_processing.base=w.calcTotal(r.logic),a.rating=w.calcTotal(r.resonance),a.attack.base=w.calcTotal(r.charisma),a.sleaze.base=w.calcTotal(r.intuition),a.name=game.i18n.localize("SR5.LivingPersona"));a.condition_monitor.value>a.condition_monitor.max&&(a.condition_monitor.value=a.condition_monitor.max)}static prepareMatrixToLimitsAndAttributes(e){let{matrix:t,attributes:a,limits:r}=e;Object.keys(q.matrixAttributes).forEach(i=>{if(!t.hasOwnProperty(i))return console.error("SR5Actor matrix preparation failed due to missing matrix attributes");let s=t[i];pt.prepareAttribute(i,s);let{value:o,base:l,mod:c,label:d}=s,p=!0;r[i]={value:o,base:l,mod:c,label:d,hidden:p},a[i]={value:o,base:l,mod:c,label:d,hidden:p}})}static prepareAttributesForDevice(e){let{matrix:t,attributes:a}=e,r=t.rating||0;["intuition","logic","charisma","willpower"].forEach(o=>{a[o]!==void 0&&(a[o].base=r,w.calcTotal(a[o]))});let s=["firewall","data_processing"];s.forEach(o=>{t[o].base=r}),[...s,"sleaze","attack"].forEach(o=>{w.calcTotal(t[o])})}};var Ie=class{static prepareArmor(e,t){let{armor:a}=e;a.base=0,a.value=0;for(let s of Object.keys(q.elementTypes))a[s]=0;let r=new O(a.mod),i=t.filter(s=>s.couldHaveArmor()&&s.isEquipped());i==null||i.forEach(s=>{s.hasArmor()&&(s.hasArmorAccessory()?r.addUniquePart(s.getName(),s.getArmorValue()):s.getArmorValue()>a.base&&(a.base=s.getArmorValue(),a.label=s.getName()));for(let o of Object.keys(q.elementTypes))a[o]+=s.getArmorElements()[o]}),e.modifiers.armor&&r.addUniquePart(game.i18n.localize("SR5.Bonus"),e.modifiers.armor),a.value=w.calcTotal(a)}static prepareBodyware(e,t){let{attributes:a}=e,r=new O;t.filter(s=>s.isBodyware()&&s.isEquipped()).forEach(s=>{s.getEssenceLoss()&&r.addUniquePart(s.getName(),-Number(s.getEssenceLoss()))});let i=e.modifiers.essence;i&&!Number.isNaN(i)&&r.addUniquePart("SR5.Bonus",Number(i)),a.essence.base=K.attributes.defaults.essence,a.essence.mod=r.list,a.essence.value=w.calcTotal(a.essence)}};var qt=class{static prepareSkills(e){let{language:t,active:a,knowledge:r}=e.skills;t&&(t.value||(t.value={}),Array.isArray(t.value)&&t.value.length==0&&(t.value={}),t.attribute="intuition");let i=o=>{var l;if(o.base||(o.base=0),(l=o.bonus)!=null&&l.length)for(let c of o.bonus)o.mod=O.AddUniquePart(o.mod,c.key,Number(c.value));o.value=w.calcTotal(o),Ri(o)};for(let o of Object.values(a))o.hidden||i(o);Object.entries(e.skills.language.value).forEach(([o,l])=>l._delete&&delete e.skills.language.value[o]);for(let o of Object.values(t.value))i(o),o.attribute="intuition";for(let[,o]of Object.entries(r)){let l=Object.entries(o.value);o.value=l.filter(([,c])=>!c._delete).reduce((c,[d,p])=>(i(p),p.attribute=o.attribute,c[d]=p,c),{})}for(let[o,l]of Object.entries(a))l.label=q.activeSkills[o]}},Ri=n=>{let e={name:"",base:"",value:0,attribute:"",mod:[],specs:[],hidden:!1};mergeObject(n,e,{overwrite:!1})};var Ot=class{static prepareLimits(e){let{limits:t,modifiers:a}=e;t.physical.mod=O.AddUniquePart(t.physical.mod,"SR5.Bonus",Number(a.physical_limit)),t.mental.mod=O.AddUniquePart(t.mental.mod,"SR5.Bonus",Number(a.mental_limit)),t.social.mod=O.AddUniquePart(t.social.mod,"SR5.Bonus",Number(a.social_limit));for(let[r,i]of Object.entries(t))w.calcTotal(i),i.label=q.limits[r]}static prepareLimitBaseFromAttributes(e){let{limits:t,attributes:a}=e;t.physical.base=Math.ceil((2*a.strength.value+a.body.value+a.reaction.value)/3),t.mental.base=Math.ceil((2*a.logic.value+a.intuition.value+a.willpower.value)/3),t.social.base=Math.ceil((2*a.charisma.value+a.willpower.value+a.essence.value)/3)}};var Bt=class{static prepareStun(e){let{track:t,attributes:a,modifiers:r}=e;t.stun.base=8+Math.ceil(a.willpower.value/2),t.stun.max=t.stun.base+Number(r.stun_track),t.stun.label=q.damageTypes.stun,t.stun.disabled=!1}static preparePhysical(e){let{track:t,attributes:a,modifiers:r}=e;t.physical.base=8+Math.ceil(a.body.value/2),t.physical.max=t.physical.base+Number(r.physical_track),t.physical.overflow.max=a.body.value,t.physical.label=q.damageTypes.physical,t.physical.disabled=!1}static prepareGrunt(e){Bt.prepareStun(e);let{track:t,attributes:a,modifiers:r}=e;t.stun.value=0,t.stun.disabled=!0;let i=a.willpower.value>a.body.value?a.willpower:a.body;t.physical.base=8+Math.ceil(i.value/2),t.physical.max=t.physical.base+Number(r.physical_track),t.physical.overflow.max=a.body.value,t.physical.label="SR5.ConditionMonitor",t.physical.disabled=!1}};var Ae=class{static prepareMovement(e){let{attributes:t,modifiers:a}=e,r=e.movement;r.walk.value=t.agility.value*(2+Number(a.walk))+new O(r.walk.mod).total,r.run.value=t.agility.value*(4+Number(a.run))+new O(r.run.mod).total}};var ke=class{static prepareWounds(e){let{modifiers:t,track:a}=e,r=3+Number(t.wound_tolerance),i=a.stun.disabled?0:Math.floor(a.stun.value/r),s=a.physical.disabled?0:Math.floor(a.physical.value/r);a.stun.wounds=i,a.physical.wounds=s,e.wounds={value:i+s}}};var ta=class{static prepareNPCData(e){ta.applyMetatypeModifiers(e)}static applyMetatypeModifiers(e){var i;let{attributes:t,metatype:a}=e,r=ja.grunt.metatype_modifiers[a]||{};for(let[s,o]of Object.entries(t))if(!Array.isArray(o.mod))console.error("Actor data contains wrong data type for attribute.mod",o,!Array.isArray(o.mod));else{let l=new O(o.mod);l.removePart(Ai);let c=(i=r.attributes)==null?void 0:i[s];e.is_npc&&c&&l.addPart(Ai,c),o.mod=l.list,pt.calculateAttribute(s,o)}}};var Sa=class{static prepareBaseData(e){et.prepareModifiers(e),et.clearAttributeMods(e),et.clearArmorMods(e),et.clearLimitMods(e)}static prepareDerivedData(e,t){pt.prepareAttributes(e),ta.prepareNPCData(e),qt.prepareSkills(e),Ie.prepareArmor(e,t),Ie.prepareBodyware(e,t),Pt.prepareMatrix(e,t),Pt.prepareMatrixToLimitsAndAttributes(e),Ot.prepareLimitBaseFromAttributes(e),Ot.prepareLimits(e),e.is_npc&&e.npc.is_grunt?Bt.prepareGrunt(e):(Bt.preparePhysical(e),Bt.prepareStun(e)),Ae.prepareMovement(e),ke.prepareWounds(e),ht.prepareMeatspaceInit(e),ht.prepareAstralInit(e),ht.prepareMatrixInit(e),ht.prepareCurrentInitiative(e)}};var va=class{static prepareBaseData(e){et.prepareModifiers(e),et.clearAttributeMods(e),et.clearArmorMods(e),et.clearLimitMods(e)}static prepareDerivedData(e,t){pt.prepareAttributes(e),qt.prepareSkills(e),Ie.prepareArmor(e,t),Ie.prepareBodyware(e,t),Pt.prepareMatrix(e,t),Pt.prepareMatrixToLimitsAndAttributes(e),Ot.prepareLimitBaseFromAttributes(e),Ot.prepareLimits(e),Bt.preparePhysical(e),Bt.prepareStun(e),Ae.prepareMovement(e),ke.prepareWounds(e),ht.prepareMeatspaceInit(e),ht.prepareAstralInit(e),ht.prepareMatrixInit(e),ht.prepareCurrentInitiative(e)}};var ye=class{static prepareBaseData(e){ye.prepareSpiritSpecial(e),et.prepareModifiers(e),et.clearAttributeMods(e),et.clearArmorMods(e),et.clearLimitMods(e)}static prepareDerivedData(e,t){ye.prepareSpiritBaseData(e),pt.prepareAttributes(e),qt.prepareSkills(e),Ot.prepareLimitBaseFromAttributes(e),Ot.prepareLimits(e),ye.prepareSpiritArmor(e),Bt.prepareStun(e),Bt.preparePhysical(e),Ae.prepareMovement(e),ke.prepareWounds(e),ht.prepareCurrentInitiative(e)}static prepareSpiritSpecial(e){e.special="magic"}static prepareSpiritBaseData(e){let t=this.getSpiritStatModifiers(e.spiritType);if(t){let{attributes:a,skills:r,initiative:i,force:s,modifiers:o}=e;for(let[l,c]of Object.entries(t.attributes))a[l]!==void 0&&(a[l].base=c+s);for(let[l,c]of Object.entries(r.active))Mt.isCustomSkill(c)||(c.base=t.skills.find(d=>d===l)?s:0);i.meatspace.base.base=s*2+t.init+Number(o.astral_initiative),i.meatspace.base.mod=O.AddUniquePart(i.meatspace.base.mod,"SR5.Bonus",Number(o.meat_initiative)),i.meatspace.dice.base=2,i.meatspace.dice.mod=O.AddUniquePart(i.meatspace.dice.mod,"SR5.Bonus",Number(o.meat_initiative_dice)),i.astral.base.base=s*2+t.astral_init+Number(o.astral_initiative_dice),i.astral.base.mod=O.AddUniquePart(i.astral.base.mod,"SR5.Bonus",Number(o.astral_initiative)),i.astral.dice.base=3,i.astral.dice.mod=O.AddUniquePart(i.astral.dice.mod,"SR5.Bonus",Number(o.astral_initiative_dice))}}static prepareSpiritArmor(e){var r;let{armor:t,attributes:a}=e;t.base=((r=a.essence.value)!=null?r:0)*2,t.value=w.calcTotal(t)}static getSpiritStatModifiers(e){let t={attributes:{body:0,agility:0,reaction:0,strength:0,willpower:0,logic:0,intuition:0,charisma:0,magic:0,essence:0},init:0,astral_init:0,skills:[]};switch(e){case"air":t.attributes.body=-2,t.attributes.agility=3,t.attributes.reaction=4,t.attributes.strength=-3,t.init=4,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"aircraft":t.attributes.body=2,t.attributes.agility=1,t.attributes.strength=1,t.attributes.logic=-2,t.skills.push("free_fall","navigation","perception","pilot_aircraft","unarmed_combat");break;case"airwave":t.attributes.body=2,t.attributes.agility=3,t.attributes.reaction=4,t.attributes.strength=-3,t.init=4,t.skills.push("assensing","astral_combat","exotic_range","impersonation","perception","running","unarmed_combat");break;case"automotive":t.attributes.body=1,t.attributes.agility=2,t.attributes.reaction=1,t.attributes.logic=-2,t.init=1,t.skills.push("navigation","perception","pilot_ground_craft","running","unarmed_combat");break;case"beasts":t.attributes.body=2,t.attributes.agility=1,t.attributes.strength=2,t.skills.push("assensing","astral_combat","perception","unarmed_combat");break;case"ceramic":t.attributes.agility=1,t.attributes.reaction=2,t.init=2,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"earth":t.attributes.body=4,t.attributes.agility=-2,t.attributes.reaction=-1,t.attributes.strength=4,t.attributes.logic=-1,t.init=-1,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"energy":t.attributes.body=1,t.attributes.agility=2,t.attributes.reaction=3,t.attributes.strength=-2,t.attributes.intuition=1,t.init=3,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"fire":t.attributes.body=1,t.attributes.agility=2,t.attributes.reaction=3,t.attributes.strength=-2,t.attributes.intuition=1,t.init=3,t.skills.push("assensing","astral_combat","exotic_range","flight","perception","unarmed_combat");break;case"guardian":t.attributes.body=1,t.attributes.agility=2,t.attributes.reaction=3,t.attributes.strength=2,t.init=1,t.skills.push("assensing","astral_combat","blades","clubs","counter_spelling","exotic_range","perception","unarmed_combat");break;case"guidance":t.attributes.body=3,t.attributes.agility=-1,t.attributes.reaction=2,t.attributes.strength=1,t.skills.push("arcana","assensing","astral_combat","counter_spelling","perception","unarmed_combat");break;case"man":t.attributes.body=1,t.attributes.reaction=2,t.attributes.strength=-2,t.attributes.intuition=1,t.init=2,t.skills.push("assensing","astral_combat","perception","spellcasting","unarmed_combat");break;case"metal":t.attributes.body=4,t.attributes.agility=-2,t.attributes.reaction=-1,t.attributes.strength=4,t.attributes.logic=-1,t.init=-1,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"plant":t.attributes.body=2,t.attributes.agility=-1,t.attributes.strength=1,t.attributes.logic=-1,t.skills.push("assensing","astral_combat","perception","exotic_range","unarmed_combat");break;case"ship":t.attributes.body=4,t.attributes.agility=-1,t.attributes.reaction=-1,t.attributes.strength=2,t.attributes.logic=-2,t.init=-1,t.skills.push("navigation","perception","pilot_water_craft","survival","swimming","unarmed_combat");break;case"task":t.attributes.reaction=2,t.attributes.strength=2,t.init=2,t.skills.push("artisan","assensing","astral_combat","perception","unarmed_combat");break;case"train":t.attributes.body=3,t.attributes.agility=-1,t.attributes.reaction=-1,t.attributes.strength=2,t.attributes.willpower=1,t.attributes.logic=-2,t.init=-1,t.skills.push("intimidation","navigation","perception","pilot_ground_craft","unarmed_combat");break;case"water":t.attributes.agility=1,t.attributes.reaction=2,t.init=2,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"toxic_air":t.attributes.body=-2,t.attributes.agility=3,t.attributes.reaction=4,t.attributes.strength=-3,t.init=4,t.skills.push("assensing","astral_combat","exotic_range","perception","running","unarmed_combat");break;case"toxic_beasts":t.attributes.body=2,t.attributes.agility=1,t.attributes.strength=2,t.skills.push("assensing","astral_combat","exotic_range","gymnastics","perception","running","unarmed_combat");break;case"toxic_earth":t.attributes.body=4,t.attributes.agility=-2,t.attributes.reaction=-1,t.attributes.strength=4,t.attributes.logic=-1,t.init=-1,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"toxic_fire":t.attributes.body=1,t.attributes.agility=2,t.attributes.reaction=3,t.attributes.strength=-2,t.attributes.intuition=1,t.init=3,t.skills.push("assensing","astral_combat","exotic_range","perception","flight","unarmed_combat");break;case"toxic_man":t.attributes.reaction=2,t.attributes.strength=-2,t.attributes.intuition=1,t.init=2,t.skills.push("assensing","astral_combat","perception","spell_casting","unarmed_combat");break;case"toxic_water":t.attributes.body=1,t.attributes.agility=1,t.attributes.reaction=2,t.init=2,t.skills.push("assensing","astral_combat","exotic_range","perception","unarmed_combat");break;case"blood":t.attributes.body=2,t.attributes.agility=2,t.attributes.strength=2,t.attributes.logic=-1,t.skills.push("assensing","astral_combat","perception","running","unarmed_combat");break;case"muse":t.attributes.agility=3,t.attributes.reaction=2,t.attributes.willpower=1,t.init=3,t.skills.push("assensing","astral_combat","con","gymnastics","intimidation","perception","unarmed_combat");break;case"nightmare":t.attributes.agility=3,t.attributes.reaction=2,t.attributes.willpower=1,t.attributes.intuition=1,t.attributes.charisma=2,t.init=3,t.skills.push("assensing","astral_combat","con","gymnastics","intimidation","perception","unarmed_combat");break;case"shade":t.attributes.agility=3,t.attributes.reaction=2,t.attributes.willpower=1,t.attributes.intuition=1,t.attributes.charisma=2,t.init=3,t.skills.push("assensing","astral_combat","con","gymnastics","intimidation","perception","unarmed_combat");break;case"succubus":t.attributes.agility=3,t.attributes.reaction=2,t.attributes.willpower=1,t.attributes.intuition=1,t.attributes.charisma=2,t.init=3,t.skills.push("assensing","astral_combat","con","gymnastics","intimidation","perception","unarmed_combat");break;case"wraith":t.attributes.agility=3,t.attributes.reaction=2,t.attributes.willpower=1,t.attributes.intuition=1,t.attributes.charisma=2,t.init=3,t.skills.push("assensing","astral_combat","con","gymnastics","intimidation","perception","unarmed_combat");break;case"shedim":t.attributes.reaction=2,t.attributes.strength=1,t.init=2,t.skills.push("assensing","astral_combat","perception","unarmed_combat");break;case"master_shedim":t.attributes.reaction=2,t.attributes.strength=1,t.attributes.logic=1,t.attributes.intuition=1,t.init=3,t.skills.push("assensing","astral_combat","counterspelling","perception","spellcasting","unarmed_combat");break;case"caretaker":t.attributes.agility=1,t.attributes.reaction=1,t.init=1,t.skills.push("assensing","astral_combat","leadership","perception","unarmed_combat");break;case"nymph":t.attributes.body=1,t.attributes.reaction=3,t.attributes.strength=1,t.init=3,t.skills.push("assensing","astral_combat","perception","gymnastics","spellcasting","unarmed_combat");break;case"scout":t.attributes.agility=2,t.attributes.reaction=2,t.init=2,t.skills.push("assensing","astral_combat","perception","gymnastics","sneaking","unarmed_combat");break;case"soldier":t.attributes.body=3,t.attributes.agility=1,t.attributes.reaction=1,t.attributes.strength=3,t.init=1,t.skills.push("assensing","astral_combat","counterspelling","exotic_range","gymnastics","perception","unarmed_combat");break;case"worker":t.attributes.strength=1,t.skills.push("assensing","astral_combat","perception","unarmed_combat");break;case"queen":t.attributes.body=5,t.attributes.agility=3,t.attributes.reaction=4,t.attributes.strength=5,t.attributes.willpower=1,t.attributes.logic=1,t.attributes.intuition=1,t.init=5,t.skills.push("assensing","astral_combat","con","counterspelling","gymnastics","leadership","negotiation","perception","spellcasting","unarmed_combat");break}return t}};var Wt=class{static prepareBaseData(e){Wt.prepareSpriteSpecial(e),et.prepareModifiers(e),et.clearAttributeMods(e),et.clearLimitMods(e)}static prepareDerivedData(e,t){Wt.prepareSpriteMatrixAttributes(e),Wt.prepareSpriteAttributes(e),Wt.prepareSpriteSkills(e),pt.prepareAttributes(e),qt.prepareSkills(e),Ot.prepareLimits(e),Pt.prepareMatrixToLimitsAndAttributes(e),Wt.prepareSpriteConditionMonitor(e),Wt.prepareSpriteInitiative(e),ht.prepareCurrentInitiative(e)}static prepareSpriteSpecial(e){e.special="resonance"}static prepareSpriteAttributes(e){let{attributes:t,level:a,spriteType:r}=e,i=this.getSpriteStatModifiers(r);t.resonance.base=a+i.resonance,w.calcTotal(t.resonance)}static prepareSpriteMatrixAttributes(e){let{level:t,matrix:a,spriteType:r}=e,i=["attack","sleaze","data_processing","firewall"],s=this.getSpriteStatModifiers(r);i.forEach(o=>{a[o]!==void 0&&(a[o].base=t+s[o],a[o].value=w.calcTotal(a[o]))}),a.rating=t}static prepareSpriteSkills(e){let{skills:t,level:a,spriteType:r}=e,i=this.getSpriteStatModifiers(r);for(let[s,o]of Object.entries(t.active))o.base=i.skills.find(l=>l===s)?a:0}static prepareSpriteConditionMonitor(e){let{matrix:t,level:a}=e;t.condition_monitor.max=8+Math.ceil(a/2)}static prepareSpriteInitiative(e){let{initiative:t,level:a,spriteType:r,modifiers:i}=e;t.perception="matrix";let s=this.getSpriteStatModifiers(r);t.matrix.base.base=a*2+s.init,O.AddUniquePart(t.matrix.base.mod,"SR5.Bonus",i.matrix_initiative),w.calcTotal(t.matrix.base,{min:0}),t.matrix.dice.base=4,O.AddUniquePart(t.matrix.dice.mod,"SR5.Bonus",i.matrix_initiative_dice),w.calcTotal(t.matrix.dice,{min:0})}static getSpriteStatModifiers(e){let t={attack:0,sleaze:0,data_processing:0,firewall:0,resonance:0,init:0,skills:["computer"]};switch(e){case"courier":t.sleaze=3,t.data_processing=1,t.firewall=2,t.init=1,t.skills.push("hacking");break;case"crack":t.sleaze=3,t.data_processing=2,t.firewall=1,t.init=2,t.skills.push("hacking","electronic_warfare");break;case"data":t.attack=-1,t.data_processing=4,t.firewall=1,t.init=4,t.skills.push("electronic_warfare");break;case"fault":t.attack=3,t.data_processing=1,t.firewall=2,t.init=1,t.skills.push("cybercombat","hacking");break;case"machine":t.attack=1,t.data_processing=3,t.firewall=2,t.init=3,t.skills.push("electronic_warfare","hardware");break}return t}};var jt=class{static prepareBaseData(e){et.prepareModifiers(e),et.clearAttributeMods(e),et.clearArmorMods(e),et.clearLimitMods(e)}static prepareDerivedData(e,t){jt.prepareVehicleStats(e),jt.prepareAttributes(e),jt.prepareLimits(e),pt.prepareAttributes(e),qt.prepareSkills(e),Ot.prepareLimits(e),jt.prepareConditionMonitor(e),Pt.prepareMatrixToLimitsAndAttributes(e),Pt.prepareAttributesForDevice(e),jt.prepareMovement(e),jt.prepareMeatspaceInit(e),ht.prepareMatrixInit(e),ht.prepareCurrentInitiative(e),jt.prepareArmor(e)}static prepareVehicleStats(e){var r;let{vehicle_stats:t,isOffRoad:a}=e;for(let[i,s]of Object.entries(t)){typeof s.mod=="object"&&(s.mod=new O(s.mod).list);let o=new O(s.mod);o.addUniquePart("SR5.Temporary",(r=s.temp)!=null?r:0),s.mod=o.list,w.calcTotal(s),s.label=q.vehicle.stats[i]}a?(t.off_road_speed.hidden=!1,t.off_road_handling.hidden=!1,t.speed.hidden=!0,t.handling.hidden=!0):(t.off_road_speed.hidden=!0,t.off_road_handling.hidden=!0,t.speed.hidden=!1,t.handling.hidden=!1)}static prepareAttributes(e){let{attributes:t,vehicle_stats:a}=e,r=["agility","reaction","strength","willpower","logic","intuition","charisma"],i=w.calcTotal(a.pilot);r.forEach(s=>{t[s]!==void 0&&(t[s].base=i)})}static prepareLimits(e){let{limits:t,vehicle_stats:a,isOffRoad:r}=e;t.mental.base=w.calcTotal(a.sensor),t.sensor=ut(J({},a.sensor),{hidden:!0}),t.handling=ut(J({},r?a.off_road_handling:a.handling),{hidden:!0}),t.speed=ut(J({},r?a.off_road_speed:a.speed),{hidden:!0})}static prepareConditionMonitor(e){let{track:t,attributes:a,matrix:r,isDrone:i,modifiers:s}=e,o=Math.ceil(w.calcTotal(a.body)/2);i?(t.physical.base=6+o,t.physical.max=t.physical.base+(Number(s.physical_track)||0)):(t.physical.base=12+o,t.physical.max=t.physical.base+(Number(s.physical_track)||0)),t.physical.label=q.damageTypes.physical;let l=r.rating||0;r.condition_monitor.max=8+Math.ceil(l/2)}static prepareMovement(e){let{vehicle_stats:t,movement:a,isOffRoad:r}=e,i=w.calcTotal(r?t.off_road_speed:t.speed);a.walk.base=5*Math.pow(2,i-1),a.walk.value=a.walk.base,a.run.base=10*Math.pow(2,i-1),a.run.value=a.run.base}static prepareMeatspaceInit(e){let{vehicle_stats:t,initiative:a,modifiers:r}=e,i=w.calcTotal(t.pilot);a.meatspace.base.base=i*2,a.meatspace.base.mod=O.AddUniquePart(a.meatspace.base.mod,"SR5.Bonus",Number(r.meat_initiative)),a.meatspace.dice.base=4,a.meatspace.dice.mod=O.AddUniquePart(a.meatspace.dice.mod,"SR5.Bonus",Number(r.meat_initiative_dice)),w.calcTotal(a.meatspace.base),w.calcTotal(a.meatspace.dice)}static prepareArmor(e){let{armor:t,modifiers:a}=e;t.mod=O.AddUniquePart(t.mod,"SR5.Temporary",Number(t.temp)),t.mod=O.AddUniquePart(t.mod,"SR5.Bonus",Number(a.armor)),w.calcTotal(t)}};var Z=class{constructor(e){(!e||typeof e!="object"||!("environmental"in e))&&(e=Z.getDefaultModifiers()),this.data=duplicate(e)}get hasActiveEnvironmental(){return Object.keys(this.environmental.active).length>0}get modifiers(){return this.data}set modifiers(e){this.data=e}getTotalForType(e){return(this.modifiers[e]||{total:0}).total}get environmental(){return this.data.environmental}set environmental(e){this.data.environmental=e}_matchingActiveEnvironmental(e,t){return this.environmental.active[e]===t}_setEnvironmentalCategoryActive(e,t){this.environmental.active[e]=t}_setEnvironmentalCategoryInactive(e){delete this.environmental.active[e]}_disableEnvironmentalOverwrite(){this._setEnvironmentalCategoryInactive("value")}activateEnvironmentalCategory(e,t){this._environmentalCategoryIsOverwrite(e)||this._disableEnvironmentalOverwrite(),this._setEnvironmentalCategoryActive(e,t),this.calcEnvironmentalTotal()}toggleEnvironmentalCategory(e,t){this._matchingActiveEnvironmental(e,t)?this._setEnvironmentalCategoryInactive(e):this._environmentalCategoryIsOverwrite(e)?this._setEnvironmentalOverwriteActive(t):this._setEnvironmentalCategoryActive(e,t),this._environmentalCategoryIsOverwrite(e)||this._setEnvironmentalOverwriteInactive(),this.calcEnvironmentalTotal()}calcEnvironmentalTotal(){if(this.hasActiveEnvironmentalOverwrite){let e=this._activeEnvironmentalOverwrite;if(e===void 0){console.error("An active overwrite modifier was returned as undefined");return}this._resetEnvironmental(),this._setEnvironmentalOverwriteActive(e),this._setEnvironmentalTotal(e)}else{let t=Object.entries(this.environmental.active).filter(([i,s])=>i!=="value").map(([i,s])=>s||0),a=this._countActiveModifierLevels(t),r=Z.getEnvironmentalModifierLevels();a.extreme>0||a.heavy>=2?this._setEnvironmentalTotal(r.extreme):a.heavy===1||a.moderate>=2?this._setEnvironmentalTotal(r.heavy):a.moderate===1||a.light>=2?this._setEnvironmentalTotal(r.moderate):a.light===1?this._setEnvironmentalTotal(r.light):this._setEnvironmentalTotal(r.good)}}static clearOnEntity(e){return u(this,null,function*(){return yield e.unsetFlag(V,j.Modifier),new Z(Z.getDefaultModifiers())})}static clearEnvironmentalOnEntity(e){return u(this,null,function*(){let t=yield Z.getModifiersFromEntity(e);return t.data.environmental=Z.getDefaultEnvironmentalModifiers(),yield Z.setModifiersOnEntity(e,t.data),t})}_environmentalCategoryIsOverwrite(e){return e==="value"}_resetEnvironmental(){Object.keys(this.environmental.active).forEach(e=>delete this.environmental.active[e])}_setEnvironmentalOverwriteActive(e){this._resetEnvironmental(),this._setEnvironmentalCategoryActive("value",e)}_setEnvironmentalOverwriteInactive(){this._setEnvironmentalCategoryInactive("value")}_setEnvironmentalTotal(e){this.environmental.total=e}get _activeEnvironmentalOverwrite(){return this.modifiers.environmental.active.value}get hasActiveEnvironmentalOverwrite(){return this.environmental.active.value!==void 0}_countActiveModifierLevels(e){let t=Z.getEnvironmentalModifierLevels();return{light:e.reduce((a,r)=>r===t.light?a+1:a,0),moderate:e.reduce((a,r)=>r===t.moderate?a+1:a,0),heavy:e.reduce((a,r)=>r===t.heavy?a+1:a,0),extreme:e.reduce((a,r)=>r===t.extreme?a+1:a,0)}}static getDefaultEnvironmentalModifiers(){return{total:0,active:{}}}static getDefaultModifier(){return{total:0}}static getDefaultModifiers(){return{environmental:Z.getDefaultEnvironmentalModifiers()}}static getEnvironmentalModifierLevels(){return K.combat.environmental.levels}static getModifiersFromEntity(e){let t=e.getFlag(V,j.Modifier);return new Z(t)}static setModifiersOnEntity(e,t){return u(this,null,function*(){yield e.unsetFlag(V,j.Modifier),yield e.setFlag(V,j.Modifier,t)})}};var Lt=class{static prepareBaseData(e){et.clearAttributeMods(e),et.clearLimitMods(e),Lt.addMissingTracks(e),Lt.prepareModifiers(e),Lt.hideMeatAttributes(e)}static prepareDerivedData(e,t){Lt.prepareMatrixAttributes(e),qt.prepareSkills(e),Lt.prepareHostAttributes(e),Lt.prepareMeatAttributes(e),Pt.prepareMatrixToLimitsAndAttributes(e),Lt.prepareMatrix(e),Lt.prepareMatrixTrack(e),Lt.prepareMatrixInit(e),ht.prepareCurrentInitiative(e)}static addMissingTracks(e){let t=e.track||{};t.matrix||(t.matrix=P.trackData()),e.track=t}static prepareModifiers(e){let t=et.commonModifiers;t=t.concat(et.matrixModifiers),et.setupModifiers(e,t)}static prepareMatrix(e){e.matrix.rating=X.getICDeviceRating(e.host.rating)}static prepareMatrixTrack(e){let{modifiers:t,track:a,matrix:r}=e;r.condition_monitor.max=Number(t.matrix_track)+X.getConditionMonitor(r.rating),a.matrix.base=X.getConditionMonitor(r.rating),a.matrix.mod=O.AddUniquePart(a.matrix.mod,"SR5.Bonus",Number(t.matrix_track)),a.matrix.max=r.condition_monitor.max,a.matrix.label=q.damageTypes.matrix}static prepareMatrixInit(e){let{initiative:t,modifiers:a,host:r}=e;t.perception="matrix",t.matrix.base.base=X.getICInitiativeBase(r.rating),t.matrix.base.mod=O.AddUniquePart(t.matrix.base.mod,"SR5.Bonus",Number(a.matrix_initiative)),t.matrix.dice.base=X.getICInitiativeDice(),t.matrix.dice.mod=O.AddUniquePart(t.matrix.dice.mod,"SR5.Bonus",Number(a.matrix_initiative_dice))}static prepareHostAttributes(e){!e.host.id||!e.host.atts||Object.keys(e.host.atts).forEach(t=>{let a=e.host.atts[t];e.matrix[a.att].base=a.value,e.matrix[a.att].device_att=t})}static hideMeatAttributes(e){let{attributes:t}=e;for(let a of Object.values(t))a.hidden=!0}static prepareMeatAttributes(e){let{attributes:t,host:a}=e;for(let r of Object.keys(q.attributes)){if(!t.hasOwnProperty(r)||["magic","edge","essence","resonance"].includes(r))continue;let i=t[r];i.base=0;let s=new O(i.mod);s.addPart("SR5.Host.Rating",X.getICMeatAttributeBase(a.rating)),i.mod=s.list,pt.prepareAttribute(r,i)}}static prepareMatrixAttributes(e){let{matrix:t}=e;for(let a of Object.keys(q.matrixAttributes)){if(!t.hasOwnProperty(a))continue;let r=t[a];pt.prepareAttribute(a,r)}}};var Xa=class{constructor(e){e.data.data.inventories===void 0&&console.error("Shawdorun 5e | Actor given does not have a inventory data structure. You will experience bugs."),this.document=e}create(e){return u(this,null,function*(){var a;if(console.log(`Shadowrun 5e | Creating inventory ${e}`),this.exists(e))return(a=ui.notifications)==null?void 0:a.warn(game.i18n.localize("SR5.Errors.InventoryAlreadyExists"));if(this.document.defaultInventory.name===e)return;let t={"data.inventories":{[e]:{name:e,label:e,itemIds:[]}}};return console.log("Shadowrun 5e | Executing update to create inventory",t),yield this.document.update(t)})}remove(a){return u(this,arguments,function*(e,t=this.document.defaultInventory.name){var i;if(console.log(`Shadowrun 5e | Removing inventory ${e}. Moving items over to ${t}`),this.document.defaultInventory.name===e)return(i=ui.notifications)==null?void 0:i.error(game.i18n.localize("SR5.Errors.DefaultInventoryCantBeRemoved"));if(!this.exists(e))return console.error(`Shadowrun 5e | Can't remove inventory ${e} or move its items over to inventory ${t}`);this.exists(t)||(t=this.document.defaultInventory.name);let r=w.getDeleteKeyUpdateData("data.inventories",e);this.document.defaultInventory.name!==t&&(r[`data.inventories.${t}.itemIds`]=[...this.document.data.data.inventories[e].itemIds,...this.document.data.data.inventories[t].itemIds]),console.log("Shadowrun 5e | Executing update to remove inventory",r),yield this.document.update(r)})}exists(e){return e===Object.keys(this.document.data.data.inventories).find(t=>t.toLowerCase()===e.toLowerCase())}getOne(e){return this.document.data.data.inventories[e]}getAll(){return this.document.data.data.inventories}rename(e,t){return u(this,null,function*(){if(console.log(`Shadowrun 5e | Renaming the inventory ${e} to ${t}`),this.document.defaultInventory.name===e||e===t)return;let a=this.getOne(e);if(!a)return;a.name=t,a.label=t;let r={"data.inventories":{[`-=${e}`]:null,[t]:a}};console.log("Shadowrun 5e | Executing update to rename inventory",r),yield this.document.update(r)})}addItems(e,t,a=!0){return u(this,null,function*(){if(console.log(`Shadowrun 5e | Adding items to to inventory ${e}`,t),this.document.defaultInventory.name!==e&&!this.exists(e)||(t instanceof nt&&(t=[t]),t.length===0))return;if(a)for(let i of t)yield this.removeItem(i);if(this.document.defaultInventory.name===e)return;for(let i of t)i.id&&this.document.data.data.inventories[e].itemIds.push(i.id);let r={[`data.inventories.${e}.itemIds`]:this.document.data.data.inventories[e].itemIds};console.log("Shadowrun 5e | Executing adding items to inventory",r),yield this.document.update(r)})}removeItem(e,t){return u(this,null,function*(){if(console.log(`Shadowrun 5e | Removing item from inventory (${t||this.document.defaultInventory.name})`,e),this.document.defaultInventory.name===t)return;let a=t?[this.document.data.data.inventories[t]]:Object.values(this.document.data.data.inventories).filter(({itemIds:i})=>i.includes(e.id));if(a.length===0)return;let r={};for(let i of a){let s=i.itemIds.filter(o=>o!==e.id);r[`data.inventories.${i.name}.itemIds`]=s}console.log("Shadowrun 5e | Executing update to remove item",r),r&&(yield this.document.update(r))})}};var Ka=class{constructor(e){this.document=e}totalFor(e){return u(this,null,function*(){if(this[e]!==void 0)return this[e];let t=yield this.document.getModifiers();return t.modifiers.hasOwnProperty(e)?t.getTotalForType(e):this.document.getModifier(e)||0})}get wounds(){return this.document.getWoundModifier()}};var Ya=class extends It{constructor(t,a={}){a.applyFormChangesOnSubmit=!0;super(t,a)}static get defaultOptions(){let t=super.defaultOptions;return t.id="test-dialog",t.classes=["sr5","form-dialog"],t.resizable=!0,t.height="auto",t.width="auto",t}activateListeners(t){super.activateListeners(t),t.find(".entity-link").on("click",w.renderEntityLinkSheet)}get templateContent(){return"systems/shadowrun5e/dist/templates/apps/dialogs/test-dialog.html"}getData(){var a;let t=super.getData();return t.rollMode=(a=t.test.data.options)==null?void 0:a.rollMode,t.rollModes=CONFIG.Dice.rollModes,t.default="roll",t.config=q,t}get title(){let t=this.data;return game.i18n.localize(t.test.title)}get buttons(){return{roll:{label:game.i18n.localize("SR5.Roll"),icon:'<i class="fas fa-dice-six"></i>'},cancel:{label:game.i18n.localize("SR5.Dialogs.Common.Cancel")}}}onAfterClose(t){return this.data.test.data}_updateData(t){Object.entries(t).forEach(([a,r])=>{let i=foundry.utils.getProperty(this.data,a);foundry.utils.getType(i)!=="Object"||!i.hasOwnProperty("mod")||(delete t[a],i.value!==r&&(r===null||r===""?delete i.override:i.override={name:"SR5.ManualOverride",value:r}))}),foundry.utils.mergeObject(this.data,t),this.data.test.prepareBaseValues(),this.data.test.calculateBaseValues()}};var Ne=class{static calcDamage(e,t,a){if(e=duplicate(e),!t)return e;a&&(e.source=Ne._damageSource(t,a));let r=t.findAttribute(e.attribute);return r&&(e.base=Ne._applyFormulaOperatorToValues(e.base,r.value,e.base_formula_operator),e.base=w.applyValueRange(Math.floor(e.base),{min:0}),e.value=e.base),e}static _applyFormulaOperatorToValues(e,t,a){switch(a){case"add":return e+t;case"subtract":return e-t;case"multiply":return e*t;case"divide":return e/t;default:return console.error(`Unsupported base damage formula operator: '${a}' used. Falling back to 'add'.`),e+t}}static _damageSource(e,t){return{actorId:e.id||"",itemId:t.id||"",itemName:t.name||"",itemType:t.type}}};var qe=class extends MeasuredTemplate{static fromItem(t,a){var c,d;let i={t:"circle",user:(c=game.user)==null?void 0:c.id,direction:0,x:0,y:0,fillColor:(d=game.user)==null?void 0:d.color},s=t.getBlastData();i.distance=s==null?void 0:s.radius,i.dropoff=s==null?void 0:s.dropoff;let o=new MeasuredTemplateDocument(i,{parent:canvas.scene}),l=new qe(o);return l.item=t,l.onComplete=a,l}drawPreview(){return u(this,null,function*(){if(!canvas.ready||!this.layer.preview)return;let t=canvas.activeLayer;!t||(yield this.draw(),this.layer.activate(),this.layer.preview.addChild(this),this.activatePreviewListeners(t))})}activatePreviewListeners(t){if(!canvas.ready||!canvas.stage||!canvas.app)return;let a={},r=0;a.mm=i=>{if(i.stopPropagation(),!canvas.grid)return;let s=Date.now();if(s-r<=20)return;let o=i.data.getLocalPosition(this.layer),l=canvas.grid.getSnappedPosition(o.x,o.y,2);this.data.x=l.x,this.data.y=l.y,this.refresh(),r=s},a.rc=()=>{!canvas.ready||!this.layer.preview||!canvas.stage||!canvas.app||(this.layer.preview.removeChildren(),canvas.stage.off("mousemove",a.mm),canvas.stage.off("mousedown",a.lc),canvas.app.view.oncontextmenu=null,canvas.app.view.onwheel=null,t.activate(),this.onComplete&&this.onComplete())},a.lc=i=>{var o;if(a.rc(i),!canvas.grid)return;let s=canvas.grid.getSnappedPosition(this.x,this.y,2);this.data.update({x:s.x,y:s.y}),(o=canvas.scene)==null||o.createEmbeddedDocuments("MeasuredTemplate",[this.data])},a.mw=i=>{if(i.ctrlKey&&i.preventDefault(),i.stopPropagation(),!canvas.grid)return;let s=canvas.grid.type>CONST.GRID_TYPES.SQUARE?30:15,o=i.shiftKey?s:5;this.data.direction+=o*Math.sign(i.deltaY),this.refresh()},canvas.stage.on("mousemove",a.mm),canvas.stage.on("mousedown",a.lc),canvas.app.view.oncontextmenu=a.rc,canvas.app.view.onwheel=a.mw}};var Be={extendedModifierValue:-1,calcNextExtendedModifier:(n=0)=>n+Be.extendedModifierValue,canExtendTest:(n,e,t)=>t<e&&n>0,success:(n,e)=>(n=Math.max(n,0),e=Math.max(e,0),e>0?n>=e:n>=0),glitched:(n,e)=>(n=Math.max(n,0),e=Math.max(e,1),n>Math.floor(e/2)),criticalGlitched:(n,e)=>!n&&e};var at=class{constructor(e,t,a){this.actor=t==null?void 0:t.actor,this.item=t==null?void 0:t.item,this.rolls=(t==null?void 0:t.rolls)||[],this.targets=[],this.evaluated=!1,a=a||{},this.data=this._prepareData(e,a),this.calculateBaseValues(),console.info(`Shadowrun 5e | Created ${this.constructor.name} Test`,this)}_prepareData(e,t){var a,r;return e.type=e.type||this.type,e.targetActorsUuid=e.targetActorsUuid||w.getUserTargets().map(i=>{var s;return(s=i.actor)==null?void 0:s.uuid}).filter(i=>!!i),e.sourceActorUuid=e.sourceActorUuid||((a=this.actor)==null?void 0:a.uuid),e.sourceItemUuid=e.sourceItemUuid||((r=this.item)==null?void 0:r.uuid),e.title=e.title||this.constructor.label,t.rollMode=t.rollMode!==void 0?t.rollMode:game.settings.get(Va,Ua.RollMode),t.showDialog=t.showDialog!==void 0?t.showDialog:!0,t.showMessage=t.showMessage!==void 0?t.showMessage:!0,e.options=t,e.pushTheLimit=e.pushTheLimit!==void 0?e.pushTheLimit:!1,e.secondChance=e.secondChance!==void 0?e.secondChance:!1,e.pool=e.pool||P.valueData({label:"SR5.DicePool"}),e.threshold=e.threshold||P.valueData({label:"SR5.Threshold"}),e.limit=e.limit||P.valueData({label:"SR5.Limit"}),e.values=e.values||{},e.values.hits=e.values.hits||P.valueData({label:"SR5.Hits"}),e.values.extendedHits=e.values.extendedHits||P.valueData({label:"SR5.ExtendedHits"}),e.values.netHits=e.values.netHits||P.valueData({label:"SR5.NetHits"}),e.values.glitches=e.values.glitches||P.valueData({label:"SR5.Glitches"}),e.opposed=e.opposed||void 0,e.modifiers=this._prepareModifiers(e.modifiers),e}_prepareModifiers(e){return e||P.valueData({label:"SR5.Labels.Action.Modifiers"})}get type(){return this.constructor.name}toJSON(){return{data:this.data,rolls:this.rolls}}static get lowestSuccessSide(){return Math.min(...K.die.success)}static get lowestGlitchSide(){return Math.min(...K.die.glitch)}static _getDefaultTestAction(){return{}}static _getDocumentTestAction(e,t){return u(this,null,function*(){return{}})}static _prepareActionTestData(e,t,a){return u(this,null,function*(){return W._prepareTestDataWithAction(e,t,a)})}static _getOpposedActionTestData(e,t,a){return u(this,null,function*(){console.error(`Shadowrun 5e | Testing Class ${this.name} doesn't support opposed message actions`)})}static get label(){return`SR5.Tests.${this.name}`}get hasModifiers(){return this.data.modifiers.mod.length>0}get formula(){let e=w.calcTotal(this.data.pool,{min:0}),t=this.hasPushTheLimit?"x6":"";return`(${e})d6cs>=${at.lowestSuccessSide}${t}`}get code(){let e=this.pool.mod.filter(i=>i.value!==0).map(i=>`${game.i18n.localize(i.name)} (${i.value})`),t=this.threshold.mod.map(i=>game.i18n.localize(i.name)),a=this.limit.mod.map(i=>game.i18n.localize(i.name));this.pool.base>0&&e.push(String(this.pool.base)),this.threshold.base>0&&t.push(String(this.threshold.base)),this.limit.base>0&&a.push(String(this.limit.base));let r=e.join(" + ").trim()||`${this.pool.value}`;return t.length>0&&this.threshold.value>0&&(r=`${r} (${t.join(" + ").trim()})`),a.length>0&&this.limit.value>0&&(r=`${r} [${a.join(" + ").trim()}]`),r}get hasCode(){return this.pool.mod.length>0||this.threshold.mod.length>0||this.limit.mod.length>0}get title(){return`${game.i18n.localize(this.constructor.label)}`}createRoll(){let e=new te(this.formula);return this.rolls.push(e),e}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/test-dialog.html"}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/success-test-message.html"}_createTestDialog(){return new Ya({test:this,templatePath:this._dialogTemplate})}showDialog(){return u(this,null,function*(){var a;if(!((a=this.data.options)!=null&&a.showDialog))return!0;let e=this._createTestDialog(),t=yield e.select();return e.canceled?!1:(this.data=t,yield this._alterTestDataFromDialogData(),!0)})}_alterTestDataFromDialogData(){return u(this,null,function*(){})}prepareBaseValues(){this.applyPushTheLimit(),this.applyPoolModifiers()}applyPoolModifiers(){let e=new O(this.pool.mod);if(e.removePart("SR5.Labels.Action.Modifiers"),this.data.modifiers.override){for(let t of this.data.modifiers.mod)e.removePart(t.name);e.addUniquePart("SR5.Labels.Action.Modifiers",this.data.modifiers.override.value);return}for(let t of this.data.modifiers.mod)e.addUniquePart(t.name,t.value)}calculateBaseValues(){this.data.modifiers.value=w.calcTotal(this.data.modifiers),this.data.pool.value=w.calcTotal(this.data.pool,{min:0}),this.data.threshold.value=w.calcTotal(this.data.threshold,{min:0}),this.data.limit.value=w.calcTotal(this.data.limit,{min:0});let e=this.data.action?this.data.action.damage:P.damageData();this.data.damage=Ne.calcDamage(e,this.actor),console.log(`Shadowrun 5e | Calculated base values for ${this.constructor.name}`,this.data)}evaluate(){return u(this,null,function*(){for(let e of this.rolls)e._evaluated||(yield e.evaluate({async:!0}));return this.evaluated=!0,this.calculateDerivedValues(),this})}populateTests(){return u(this,null,function*(){})}populateDocuments(){return u(this,null,function*(){if(!this.actor&&this.data.sourceActorUuid){let e=(yield fromUuid(this.data.sourceActorUuid))||void 0;this.actor=e instanceof TokenDocument?e.actor:e}if(!this.item&&this.data.sourceItemUuid&&(this.item=(yield fromUuid(this.data.sourceItemUuid))||void 0),this.targets.length===0&&this.data.targetActorsUuid){this.targets=[];for(let e of this.data.targetActorsUuid){let t=yield fromUuid(e);if(!t)continue;let a=t instanceof st?t.getToken():t;a instanceof TokenDocument&&this.targets.push(a)}}})}prepareDocumentData(){return u(this,null,function*(){})}get testModifiers(){return["global","wounds"]}prepareDocumentModifiers(){return u(this,null,function*(){yield this.prepareActorModifiers(),yield this.prepareItemModifiers()})}prepareActorModifiers(){return u(this,null,function*(){if(!!this.actor)for(let e of this.testModifiers){let t=yield this.actor.modifiers.totalFor(e),a=q.modifierTypes[e];O.AddUniquePart(this.data.modifiers.mod,a,t,!0)}})}prepareItemModifiers(){return u(this,null,function*(){})}calculateDerivedValues(){this.data.values.hits=this.calculateHits(),this.data.values.extendedHits=this.calculateExtendedHits(),this.data.values.netHits=this.calculateNetHits(),this.data.values.glitches=this.calculateGlitches(),console.log(`Shadowrun 5e | Calculated derived values for ${this.constructor.name}`,this.data)}get pool(){return this.data.pool}get limit(){return this.data.limit}get hasLimit(){return game.settings.get(V,j.ApplyLimits)&&!this.hasPushTheLimit&&this.limit.value>0}get hasReducedHits(){return this.hits.value>this.limit.value}get threshold(){return this.data.threshold}get hasThreshold(){return this.threshold.value>0}calculateNetHits(){let e=this.extended?this.extendedHits:this.hits,t=this.hasThreshold?Math.max(e.value-this.threshold.value,0):e.value,a=P.valueData({label:"SR5.NetHits",base:t});return a.value=w.calcTotal(a,{min:0}),a}get netHits(){return this.data.values.netHits}calculateHits(){let e=this.rolls.reduce((a,r)=>a+r.hits,0),t=P.valueData({label:"SR5.Hits",base:this.hasLimit?Math.min(this.limit.value,e):e});return t.value=w.calcTotal(t,{min:0}),t}get hits(){return this.data.values.hits}get extendedHits(){return this.data.values.extendedHits||P.valueData({label:"SR5.ExtendedHits"})}calculateGlitches(){let e=this.rolls.reduce((a,r)=>a+r.glitches,0),t=P.valueData({label:"SR5.Glitches",base:e});return t.value=w.calcTotal(t,{min:0}),t}calculateExtendedHits(){if(!this.extended)return P.valueData({label:"SR5.ExtendedHits"});let e=this.extendedHits;return e.mod=O.AddPart(e.mod,"SR5.Hits",this.hits.value),w.calcTotal(e,{min:0}),e}get extended(){return this.canBeExtended&&this.data.extended}get canBeExtended(){return!0}get glitches(){return this.data.values.glitches}get glitched(){return Be.glitched(this.glitches.value,this.pool.value)}get criticalGlitched(){return Be.criticalGlitched(this.success,this.glitched)}get success(){let e=this.extended?this.extendedHits:this.hits;return Be.success(e.value,this.threshold.value)}get failure(){return!this.success}get canSucceed(){return!0}get canFail(){return!0}get successLabel(){return"SR5.Success"}get failureLabel(){return"SR5.Failure"}get opposed(){return!!this.data.opposed&&this.data.opposed.test!==""}get opposing(){return!1}get hasResults(){if(!this.item)return!1;let e=this.item.getActionResult();return e?!foundry.utils.isObjectEmpty(e):!1}get results(){if(!!this.item)return this.item.getActionResult()}get hasTargets(){return this.targets.length>0}get description(){let e=this.pool.value,t=this.hasThreshold?`(${this.threshold.value})`:"",a=this.hasLimit?`[${this.limit.value}]`:"";return`${e} ${t} ${a}`}get hasPushTheLimit(){return this.data.pushTheLimit}get hasSecondChance(){return this.data.secondChance}applyPushTheLimit(){if(!this.actor)return;let e=new O(this.pool.mod);if(this.hasPushTheLimit){let t=this.actor.getEdge().value;e.addUniquePart("SR5.PushTheLimit",t,!0)}else e.removePart("SR5.PushTheLimit")}executeSecondChance(){return u(this,null,function*(){if(console.log(`Shadowrun 5e | ${this.constructor.name} will apply second chance rules`),!this.data.sourceActorUuid)return;let e=this.rolls[this.rolls.length-1],t=e.pool-e.hits;if(t<=0)return;new O(this.pool.mod).addPart("SR5.SecondChange",t),yield this.populateDocuments(),this.calculateBaseValues();let r=`${t}d6`,i=new te(r);this.rolls.push(i),yield this.evaluate(),yield this.processResults(),yield this.toMessage(),yield this.afterTestComplete()})}consumeActorResources(){return u(this,null,function*(){var e;if(!this.actor)return!0;if(this.hasPushTheLimit){if(this.actor.getEdge().uses<=0)return(e=ui.notifications)==null||e.error(game.i18n.localize("SR5.MissingResource.Edge")),!1;yield this.actor.useEdge()}return!0})}execute(){return u(this,null,function*(){return yield this.populateTests(),yield this.populateDocuments(),yield this.prepareDocumentModifiers(),yield this.prepareDocumentData(),this.prepareBaseValues(),this.calculateBaseValues(),(yield this.showDialog())?(yield this.consumeActorResources())?(this.prepareBaseValues(),this.calculateBaseValues(),this.createRoll(),yield this.evaluate(),yield this.processResults(),yield this.toMessage(),yield this.afterTestComplete(),this):this:this})}processResults(){return u(this,null,function*(){this.success?yield this.processSuccess():yield this.processFailure()})}processSuccess(){return u(this,null,function*(){})}processFailure(){return u(this,null,function*(){})}afterTestComplete(){return u(this,null,function*(){console.log(`Shadowrun5e | Test ${this.constructor.name} completed.`,this),this.success?yield this.afterSuccess():yield this.afterFailure(),yield this.executeFollowUp(),this.extended&&(yield this.extendCurrentTest())})}afterSuccess(){return u(this,null,function*(){})}afterFailure(){return u(this,null,function*(){})}executeFollowUp(){return u(this,null,function*(){let e=yield W.fromFollowupTest(this,this.data.options);!e||(yield e.execute())})}extendCurrentTest(){return u(this,null,function*(){let e=foundry.utils.duplicate(this.data);if(!e.type)return;let t=new O(e.pool.mod),a=t.getPartValue("SR5.ExtendedTest")||0,r=Be.calcNextExtendedModifier(a);if(t.addUniquePart("SR5.ExtendedTest",r),w.calcTotal(e.pool,{min:0}),Be.canExtendTest(e.pool.value,this.threshold.value,this.extendedHits.value)){let i=W._getTestClass(e.type);if(!i)return;yield new i(e,{actor:this.actor,item:this.item},this.data.options).execute()}})}toMessage(){return u(this,null,function*(){var i;if(!((i=this.data.options)!=null&&i.showMessage))return;let e=this._prepareMessageTemplateData(),t=yield renderTemplate(this._chatMessageTemplate,e),a=this._prepareMessageData(t),r=yield ChatMessage.create(a);if(!!r)return this.data.messageUuid=r.uuid,r})}_prepareMessageTemplateData(){var a,r,i;let e=((a=this.actor)==null?void 0:a.getActiveTokens(!0))||[],t=e.length===1?e[0].id:void 0;return{title:this.data.title,test:this,speaker:{actor:this.actor,token:t},item:this.item,opposedActions:this._prepareOpposedActionsTemplateData(),resultActions:this._prepareResultActionsTemplateData(),previewTemplate:this._canPlaceBlastTemplate,showDescription:this._canShowDescription,description:((r=this.item)==null?void 0:r.getChatData())||"",applyGmOnlyContent:(i=game.user)==null?void 0:i.isGM}}get _canShowDescription(){return!0}get _canPlaceBlastTemplate(){var e;return((e=this.item)==null?void 0:e.hasTemplate)||!1}_prepareOpposedActionsTemplateData(){if(!this.data.opposed||!this.data.opposed.test)return[];let e=game.shadowrun5e.tests[this.data.opposed.test];if(!e)return console.error("Shadowrun 5e | Opposed Action has no test class registered.");let t={test:this.data.opposed.test,label:e.label};return this.data.opposed.mod&&(t.label+=` ${this.data.opposed.mod}`),[t]}_prepareResultActionsTemplateData(){let e=[],t=this.results;return t&&t.success.matrix.placeMarks&&e.push({action:"placeMarks",label:"SR5.PlaceMarks"}),e}_prepareMessageData(e){var l,c,d,p,g,y;let t=((l=this.actor)==null?void 0:l.getActiveTokens(!0))||[],a=t.length===1?t[0].id:void 0,r=(c=this.actor)==null?void 0:c.id,i=(d=game.user)==null?void 0:d.name,s=this.rolls[this.rolls.length-1],o={user:(p=game.user)==null?void 0:p.id,speaker:{actor:r,alias:i,token:a},type:CONST.CHAT_MESSAGE_TYPES.ROLL,roll:s,content:e,rollMode:(g=this.data.options)==null?void 0:g.rollMode,flags:{[V]:{[j.Test]:this.toJSON()}}};return ChatMessage.applyRollMode(o,(y=this.data.options)==null?void 0:y.rollMode),o}static chatMessageListeners(e,t,a){return u(this,null,function*(){t.find(".show-roll").on("click",this._chatToggleCardRolls),t.find(".show-description").on("click",this._chatToggleCardDescription),t.find(".chat-document-link").on("click",w.renderEntityLinkSheet),t.find(".place-template").on("click",this._placeItemBlastZoneTemplate),t.find(".result-action").on("click",this._castResultAction),yield this._showGmOnlyContent(e,t,a)})}static _showGmOnlyContent(e,t,a){return u(this,null,function*(){var i;let r=yield W.fromMessage(e.id);!r||(yield r.populateDocuments(),!(!r.actor||!game.user)&&(game.user.isGM||game.user.isTrusted||((i=r.actor)==null?void 0:i.isOwner))&&t.find(".gm-only-content").removeClass("gm-only-content"))})}static chatLogListeners(e,t,a){return u(this,null,function*(){t.find(".chat-message").each((r,i)=>u(this,null,function*(){var l;i=$(i);let s=i.data("messageId"),o=(l=game.messages)==null?void 0:l.get(s);!o||(yield this.chatMessageListeners(o,i,o.toObject()))}))})}static _placeItemBlastZoneTemplate(e){return u(this,null,function*(){e.preventDefault(),e.stopPropagation();let r=$(e.currentTarget).closest(".chat-message").data("messageId"),i=yield W.fromMessage(r);if(!i||(yield i.populateDocuments(),!i.item))return;let s=qe.fromItem(i.item);!s||(yield s.drawPreview())})}static chatMessageContextOptions(e,t){let a=i=>u(this,null,function*(){let s=i.data().messageId,o=yield W.fromMessage(s);if(!o)return console.error("Shadowrun 5e | Could not restore test from message");yield o.executeSecondChance()}),r=t.pop();return t.push({name:game.i18n.localize("SR5.SecondChange"),callback:a,condition:!0,icon:'<i class="fas fa-meteor"></i>'}),t.push(r),t}static _chatToggleCardRolls(e){return u(this,null,function*(){e.preventDefault(),e.stopPropagation();let a=$(e.currentTarget).closest(".chat-card").find(".dice-rolls");a.is(":visible")?a.slideUp(200):a.slideDown(200)})}static _chatToggleCardDescription(e){return u(this,null,function*(){e.preventDefault(),e.stopPropagation();let a=$(e.currentTarget).closest(".chat-card").find(".card-description");a.is(":visible")?a.slideUp(200):a.slideDown(200)})}static _castResultAction(e){return u(this,null,function*(){e.preventDefault(),e.stopPropagation();let t=$(e.currentTarget),a=t.data("action"),r=t.closest(".chat-message").data("messageId"),i=yield W.fromMessage(r);if(!i)return console.error(`Shadowrun5e | Couldn't find both a result action ('${a}') and extract test from message ('${r}')`);yield Da.executeResult(a,i)})}};var ea=class extends at{get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/attribute-only-test-dialog.html"}_prepareData(t,a){return t=super._prepareData(t,a),t.attribute1=t.action.attribute,t.attribute2=t.action.attribute2,t}prepareBaseValues(){this.prepareAttributeSelection(),super.prepareBaseValues()}prepareAttributeSelection(){if(!this.actor)return;this.data.pool.mod=[];let t=new O(this.pool.mod),a=this.actor.getAttribute(this.data.attribute1),r=this.actor.getAttribute(this.data.attribute2);a&&t.addPart(a.label,a.value),r&&t.addPart(r.label,r.value),a&&this.actor._isMatrixAttribute(this.data.attribute1)&&this.actor._addMatrixParts(t,!0),r&&this.actor._isMatrixAttribute(this.data.attribute2)&&this.actor._addMatrixParts(t,!0)}};var bn={canHealPhysicalDamage:n=>n===0};var st=class extends Actor{constructor(t,a){super(t,a);this.defaultInventory={name:"Carried",label:"SR5.Labels.Inventory.Carried",itemIds:[]};this.inventory=new Xa(this),this.modifiers=new Ka(this)}getOverwatchScore(){let t=this.getFlag(V,"overwatchScore");return t!==void 0?t:0}setOverwatchScore(t){return u(this,null,function*(){let a=parseInt(t);if(!isNaN(a))return this.setFlag(V,"overwatchScore",a)})}prepareData(){super.prepareData()}prepareBaseData(){switch(super.prepareBaseData(),this.data.type){case"character":Sa.prepareBaseData(this.data.data);break;case"critter":va.prepareBaseData(this.data.data);break;case"spirit":ye.prepareBaseData(this.data.data);break;case"sprite":Wt.prepareBaseData(this.data.data);break;case"vehicle":jt.prepareBaseData(this.data.data);break;case"ic":Lt.prepareBaseData(this.data.data);break}}prepareEmbeddedEntities(){super.prepareEmbeddedEntities()}applyActiveEffects(){super.applyActiveEffects()}prepareDerivedData(){super.prepareDerivedData();let t=this.items.map(a=>new ne(a.data));switch(this.data.type){case"character":Sa.prepareDerivedData(this.data.data,t);break;case"critter":va.prepareDerivedData(this.data.data,t);break;case"spirit":ye.prepareDerivedData(this.data.data,t);break;case"sprite":Wt.prepareDerivedData(this.data.data,t);break;case"vehicle":jt.prepareDerivedData(this.data.data,t);break;case"ic":Lt.prepareDerivedData(this.data.data,t);break}}applyOverrideActiveEffects(){let t=this.effects.reduce((a,r)=>r.data.disabled?a:a.concat(r.data.changes.filter(i=>i.mode===CONST.ACTIVE_EFFECT_MODES.OVERRIDE).map(i=>{var s;return i=foundry.utils.duplicate(i),i.effect=r,i.priority=(s=i.priority)!=null?s:i.mode*10,i})),[]);t.sort((a,r)=>a.priority-r.priority);for(let a of t)a.effect.apply(this,a)}_applySomeActiveEffects(t){let a=this._reduceEffectChangesByKeys(t);this._applyActiveEffectChanges(a)}_applyActiveEffectChanges(t){let a={};for(let r of t){let i=r.effect.apply(this,r);i!==null&&(a[r.key]=i)}this.overrides=J(J({},this.overrides),foundry.utils.expandObject(a))}_reduceEffectChangesByKeys(t){let a=this.effects.reduce((r,i)=>i.data.disabled?r:r.concat(i.data.changes.filter(s=>t.some(o=>s.key.includes(o))).map(s=>{var o;return s=foundry.utils.duplicate(s),s.effect=i,s.priority=(o=s.priority)!=null?o:s.mode*10,s})),[]);return a.sort((r,i)=>r.priority-i.priority),a}getModifier(t){return this.data.data.modifiers[t]}findActiveSkill(t){if(!t)return;let a=this.getActiveSkills(),r=a[t];return r||Object.values(a).find(i=>i.name===t)}findAttribute(t){if(t===void 0)return;let a=this.getAttributes();if(!!a)return a[t]}findVehicleStat(t){if(t===void 0)return;let a=this.getVehicleStats();if(a)return a[t]}findLimitFromAttribute(t){if(t===void 0)return;let a=this.findAttribute(t);if(!!(a!=null&&a.limit))return this.findLimit(a.limit)}findLimit(t){if(!!t)return this.data.data.limits[t]}getWoundModifier(){return"wounds"in this.data.data&&-1*this.data.data.wounds.value||0}useEdge(t=-1){return u(this,null,function*(){let a=this.getEdge();if(a&&a.value===0)return;let r=a.uses>0?a.uses:0,i=Math.min(a.value,r+t);yield this.update({"data.attributes.edge.uses":i})})}getEdge(){return this.data.data.attributes.edge}hasArmor(){return"armor"in this.data.data}getArmor(){return"armor"in this.data.data?this.data.data.armor:P.actorArmorData()}getMatrixDevice(){if(!("matrix"in this.data.data))return;let t=this.data.data.matrix;if(t.device)return this.items.get(t.device)}getFullDefenseAttribute(){if(this.isVehicle())return this.findVehicleStat("pilot");if(this.isCharacter()){let t=this.asCharacterData();if(t){let a=t.data.full_defense_attribute;return a||(a="willpower"),this.findAttribute(a)}}}getEquippedWeapons(){return this.items.filter(t=>t.isEquipped()&&t.isWeapon())}getRecoilCompensation(){let t=1,a=this.findAttribute("strength");return a&&(t+=Math.ceil(a.value/3)),t}getDeviceRating(){return"matrix"in this.data.data?parseInt(this.data.data.matrix.rating):0}getAttributes(){return this.data.data.attributes}getAttribute(t){return this.getAttributes()[t]}getLimits(){return this.data.data.limits}getLimit(t){return this.getLimits()[t]}getType(){return this.data.type}isCharacter(){return this.getType()==="character"}isSpirit(){return this.getType()==="spirit"}isSprite(){return this.getType()==="sprite"}isVehicle(){return this.getType()==="vehicle"}isGrunt(){return!("is_npc"in this.data.data)||!("npc"in this.data.data)?!1:this.data.data.is_npc&&this.data.data.npc.is_grunt}isCritter(){return this.getType()==="critter"}isIC(){return this.getType()==="ic"}get hasNaturalRecovery(){return this.isCharacter()||this.isCritter()}getVehicleTypeSkillName(){if("vehicleType"in this.data.data)switch(this.data.data.vehicleType){case"air":return"pilot_aircraft";case"ground":return"pilot_ground_craft";case"water":return"pilot_water_craft";case"aerospace":return"pilot_aerospace";case"walker":return"pilot_walker";case"exotic":return"pilot_exotic_vehicle";default:return}}getVehicleTypeSkill(){if(this.isVehicle())return;let t=this.getVehicleTypeSkillName();return this.findActiveSkill(t)}get hasSkills(){return this.getSkills()!==void 0}getSkills(){return this.data.data.skills}getActiveSkills(){return this.data.data.skills.active}get hasSpecial(){return["character","sprite","spirit","critter"].includes(this.data.type)}get hasFullDefense(){return["character","vehicle","sprite","spirit","critter"].includes(this.data.type)}get isAwakened(){return this.data.data.special==="magic"}getPool(t,a={specialization:!1,byLabel:!1}){let r=a.byLabel?this.getSkillByLabel(t):this.getSkill(t);if(!r||!r.attribute||!Mt.allowRoll(r))return 0;let i=this.getAttribute(r.attribute),s=typeof i.value=="number"?i.value:0,o=typeof r.value=="number"?r.value:0;if(mt.mustDefaultToRoll(r)&&mt.allowDefaultingRoll(r))return mt.defaultingModifier+s;let l=a.specialization?K.skill.SPECIALIZATION_MODIFIER:0;return o+s+l}getSkill(t,a={byLabel:!1}){if(a.byLabel)return this.getSkillByLabel(t);let{skills:r}=this.data.data;if(r.active.hasOwnProperty(t))return r.active[t];if(r.language.value.hasOwnProperty(t))return r.language.value[t];for(let i in r.knowledge)if(r.knowledge.hasOwnProperty(i)){let s=r.knowledge[i];if(s.value.hasOwnProperty(t))return s.value[t]}}getSkillByLabel(t){if(!t)return;let a=i=>i.label?game.i18n.localize(i.label):i.name,r=this.getSkills();for(let i of Object.values(r.active))if(t===a(i))return i;for(let i of Object.values(r.language.value))if(t===a(i))return i;for(let i in r.knowledge){if(!r.knowledge.hasOwnProperty(i))continue;let s=r.knowledge[i].value;for(let o of Object.values(s))if(t===a(o))return o}}getSkillLabel(t){let a=this.getSkill(t);return a?a.label?a.label:a.name?a.name:"":""}addKnowledgeSkill(t,a){return u(this,null,function*(){a=J(J({},{name:"",specs:[],base:0,value:0,mod:0}),a);let i=randomID(16),s={};s[i]=a;let o=`data.skills.knowledge.${t}.value`,l={};return l[o]=s,yield this.update(l),i})}addActiveSkill(){return u(this,arguments,function*(t={name:$a}){let a=P.skillData(t),r="data.skills.active",i=w.getRandomIdSkillFieldDataEntry(r,a);if(!i)return;let{updateSkillData:s,id:o}=i;return yield this.update(s),o})}removeLanguageSkill(t){return u(this,null,function*(){let a=w.getDeleteKeyUpdateData("data.skills.language.value",t);yield this.update(a)})}addLanguageSkill(t){return u(this,null,function*(){t=J(J({},{name:"",specs:[],base:0,value:0,mod:0}),t);let r=randomID(16),i={};i[r]=t;let s="data.skills.language.value",o={};return o[s]=i,yield this.update(o),r})}removeKnowledgeSkill(t,a){return u(this,null,function*(){let r=w.getDeleteKeyUpdateData(`data.skills.knowledge.${a}.value`,t);yield this.update(r)})}removeActiveSkill(t){return u(this,null,function*(){var s;if(!this.getActiveSkills().hasOwnProperty(t))return;let r=this.getSkill(t);if(!r)return;if(r.name===""&&r.label!==void 0&&r.label!==""){yield this.hideSkill(t),this.data.token.actorLink||(yield(s=this.sheet)==null?void 0:s.render());return}let i=w.getDeleteKeyUpdateData("data.skills.active",t);yield this.update(i)})}hideSkill(t){return u(this,null,function*(){if(!t)return;let a=this.getSkill(t);if(!a)return;a.hidden=!0;let r=w.getUpdateDataEntry(`data.skills.active.${t}`,a);yield this.update(r)})}showSkill(t){return u(this,null,function*(){if(!t)return;let a=this.getSkill(t);if(!a)return;a.hidden=!1;let r=w.getUpdateDataEntry(`data.skills.active.${t}`,a);yield this.update(r)})}showHiddenSkills(){return u(this,null,function*(){var r;let t={},a=this.getActiveSkills();for(let[i,s]of Object.entries(a))s.hidden===!0&&(s.hidden=!1,t[`data.skills.active.${i}`]=s);!t||(yield this.update(t),this.data.token.actorLink||(yield(r=this.sheet)==null?void 0:r.render()))})}promptRoll(){return u(this,null,function*(){yield ee.promptSuccessTest()})}rollDeviceRating(t){return u(this,null,function*(){let a=this.getDeviceRating(),r=!W.shouldHideDialog(t==null?void 0:t.event),i=W._getTestClass("SuccessTest"),s=new i({},{actor:this},{showDialog:r}),o=new O(s.pool.mod);o.addPart("SR5.Labels.ActorSheet.DeviceRating",a),o.addPart("SR5.Labels.ActorSheet.DeviceRating",a);let l=new O;this._addGlobalParts(l),s.data.modifiers.mod=l.list,yield s.execute()})}rollGeneralAction(t,a){return u(this,null,function*(){let r=yield w.getPackAction(q.packNames.generalActions,t);if(!r)return;let i=!W.shouldHideDialog(a==null?void 0:a.event),s=yield W.fromItem(r,this,{showDialog:i});s.data.title=game.i18n.localize(q.modifierTypes[t]),s&&(yield s.execute())})}rollSkill(t,a){return u(this,null,function*(){var l;console.info(`Shadowrun5e | Rolling skill test for ${t}`);let r=this.getSkill(t);if(!r)return console.error(`Shadowrun 5e | Skill ${t} is not registered of actor ${this.id}`);if(!Mt.allowRoll(r)){(l=ui.notifications)==null||l.warn(game.i18n.localize("SR5.Warnings.SkillCantBeDefault"));return}let i=P.actionData({skill:t,spec:(a==null?void 0:a.specialization)||!1,attribute:r.attribute,limit:{base:0,value:0,mod:[],attribute:r.attribute},test:at.name}),s=!W.shouldHideDialog(a==null?void 0:a.event),o=yield W.fromAction(i,this,{showDialog:s});!o||(yield o.execute())})}rollDronePerception(t){return u(this,null,function*(){if(!this.isVehicle())return;let a=duplicate(this.data.data);if(a.controlMode==="autopilot"){let r=new O,i=w.calcTotal(a.vehicle_stats.pilot),s=this.findActiveSkill("perception"),o=this.findLimit("sensor");if(s&&o)return r.addPart("SR5.Vehicle.Clearsight",w.calcTotal(s)),r.addPart("SR5.Vehicle.Stats.Pilot",i),this._addGlobalParts(r),ee.advancedRoll({event:t==null?void 0:t.event,actor:this,parts:r.list,limit:o,title:game.i18n.localize("SR5.Labels.ActorSheet.RollDronePerception")})}else yield this.rollSkill("perception",t)})}rollPilotVehicle(t){return u(this,null,function*(){if(!this.isVehicle())return;let a=duplicate(this.data.data);if(a.controlMode==="autopilot"){let r=new O,i=w.calcTotal(a.vehicle_stats.pilot),s=this.getVehicleTypeSkill(),o=a.environment,l=this.findLimit(o);if(s&&l)return r.addPart("SR5.Vehicle.Stats.Pilot",i),r.addPart("SR5.Vehicle.Maneuvering",w.calcTotal(s)),this._addGlobalParts(r),yield ee.advancedRoll({event:t==null?void 0:t.event,actor:this,parts:r.list,limit:l,title:game.i18n.localize("SR5.Labels.ActorSheet.RollPilotVehicleTest")})}else{let r=this.getVehicleTypeSkillName();return r?yield this.rollSkill(r,t):void 0}})}rollDroneInfiltration(t){return u(this,null,function*(){if(!this.isVehicle())return;let a=duplicate(this.data.data);if(a.controlMode==="autopilot"){let r=new O,i=w.calcTotal(a.vehicle_stats.pilot),s=this.findActiveSkill("sneaking"),o=this.findLimit("sensor");if(s&&o)return r.addPart("SR5.Vehicle.Stealth",w.calcTotal(s)),r.addPart("SR5.Vehicle.Stats.Pilot",i),this._addGlobalParts(r),ee.advancedRoll({event:t==null?void 0:t.event,actor:this,parts:r.list,limit:o,title:game.i18n.localize("SR5.Labels.ActorSheet.RollDroneInfiltration")})}else yield this.rollSkill("sneaking",t)})}rollAttribute(t,a){return u(this,null,function*(){console.info(`Shadowrun5e | Rolling attribute ${t} test from ${this.constructor.name}`);let r=P.actionData({attribute:t,test:ea.name}),i=yield W.fromAction(r,this);!i||(yield i.execute())})}_isMatrixAttribute(t){return q.matrixAttributes.hasOwnProperty(t)}_addMatrixParts(t,a){if(w.isMatrix(a)){if(!("matrix"in this.data.data))return;let r=this.data.data.matrix;r.hot_sim&&t.addUniquePart("SR5.HotSim",2),r.running_silent&&t.addUniquePart("SR5.RunningSilent",-2)}}_addGlobalParts(t){this.data.data.modifiers.global&&t.addUniquePart("SR5.Global",this.data.data.modifiers.global)}_addDefenseParts(t){if(this.isVehicle()){let r=this.findVehicleStat("pilot");r&&t.addUniquePart(r.label,w.calcTotal(r));let i=this.getVehicleTypeSkill();i&&t.addUniquePart("SR5.Vehicle.Maneuvering",w.calcTotal(i))}else{let r=this.findAttribute("reaction"),i=this.findAttribute("intuition");r&&t.addUniquePart(r.label||"SR5.Reaction",r.value),i&&t.addUniquePart(i.label||"SR5.Intuition",i.value)}let a=this.getModifier("defense");a&&t.addUniquePart("SR5.Bonus",a)}_addArmorParts(t){let a=this.getArmor();if(a){t.addUniquePart(a.label||"SR5.Armor",a.base);for(let r of a.mod)t.addUniquePart(r.name,r.value)}}setFlag(t,a,r){let i=w.onSetFlag(r);return super.setFlag(t,a,i)}getFlag(t,a){let r=super.getFlag(t,a);return w.onGetFlag(r)}getToken(){return this._isLinkedToToken()&&this.hasToken()?this.getActiveTokens(!0)[0].document:this.token}_isLinkedToToken(){return this.data.token.actorLink&&!this.token}hasToken(){return this.getActiveTokens().length>0}hasActivePlayerOwner(){return this.getActivePlayerOwners().length>0}getActivePlayer(){var t;if(!game.users||!this.hasPlayerOwner)return null;for(let a of game.users.contents)if(!(!a.active||a.isGM)&&this.id===((t=a.character)==null?void 0:t.id))return a;return null}getActivePlayerOwners(){return w.getPlayersWithPermission(this,"OWNER",!0)}__addDamageToTrackValue(t,a){return t.value===0||a.value===a.max||(a=duplicate(a),a.value+=t.value,a.value>a.max&&(console.error("Damage did overflow the track, which shouldn't happen at this stage. Damage has been set to max. Please use applyDamage."),a.value=a.max)),a}_addDamageToDeviceTrack(t,a){return u(this,null,function*(){if(!a)return;let r=a.getCondition();if(!r)return t;if(t.value===0||r.value===r.max)return;r=this.__addDamageToTrackValue(t,r);let i={["data.technology.condition_monitor"]:r};yield a.update(i)})}_addDamageToTrack(t,a){return u(this,null,function*(){if(t.value===0||a.value===a.max)return;a=this.__addDamageToTrackValue(t,a);let r={[`data.track.${t.type.value}`]:a};yield this.update(r)})}_addDamageToOverflow(t,a){return u(this,null,function*(){if(t.value===0||a.overflow.value===a.overflow.max)return;let r=duplicate(a.overflow);r.value+=t.value,r.value=Math.min(r.value,r.max);let i={[`data.track.${t.type.value}.overflow`]:r};yield this.update(i)})}healDamage(t,a){return u(this,null,function*(){var i;if(console.log(`Shadowrun5e | Healing ${t} damage of ${a} for actor`,this),!((i=this.data.data)!=null&&i.track.hasOwnProperty(t)))return;let r=Math.max(this.data.data.track[t].value-a,0);yield this.update({[`data.track.${t}.value`]:r})})}healStunDamage(t){return u(this,null,function*(){yield this.healDamage("stun",t)})}healPhysicalDamage(t){return u(this,null,function*(){yield this.healDamage("physical",t)})}get canRecoverPhysicalDamage(){let t=this.getStunTrack();return t?bn.canHealPhysicalDamage(t.value):!1}addStunDamage(t){return u(this,null,function*(){if(t.type.value!=="stun")return t;let a=this.getStunTrack();if(!a)return t;let{overflow:r,rest:i}=this._calcDamageOverflow(t,a);return r.value>0&&(r.value=Math.floor(r.value/2),r.type.value="physical"),yield this._addDamageToTrack(i,a),r})}addPhysicalDamage(t){return u(this,null,function*(){if(t.type.value!=="physical")return t;let a=this.getPhysicalTrack();if(!a)return t;let{overflow:r,rest:i}=this._calcDamageOverflow(t,a);yield this._addDamageToTrack(i,a),yield this._addDamageToOverflow(r,a)})}addMatrixDamage(t){return u(this,null,function*(){if(t.type.value!=="matrix")return t;let a=this.getMatrixDevice(),r=this.getMatrixTrack();if(!r)return t;let{overflow:i,rest:s}=this._calcDamageOverflow(t,r);return a&&(yield this._addDamageToDeviceTrack(s,a)),this.isIC()&&(yield this._addDamageToTrack(s,r)),i})}_calcDamageOverflow(t,a){let r=a.max-a.value,i=t.value>r?t.value-r:0,s=t.value-i,o=duplicate(t),l=duplicate(t);return o.value=i,l.value=s,{overflow:o,rest:l}}getStunTrack(){if("track"in this.data.data&&"stun"in this.data.data.track)return this.data.data.track.stun}getPhysicalTrack(){if("track"in this.data.data&&"physical"in this.data.data.track)return this.data.data.track.physical}getMatrixTrack(){if("track"in this.data.data&&"matrix"in this.data.data.track)return this.data.data.track.matrix;let t=this.getMatrixDevice();if(!!t)return t.getCondition()}getModifiedArmor(t){var r;if(!((r=t.ap)!=null&&r.value))return this.getArmor();let a=duplicate(this.getArmor());return a&&(a.mod=O.AddUniquePart(a.mod,"SR5.DV",t.ap.value),a.value=w.calcTotal(a,{min:0})),a}changeCombatInitiative(t){return u(this,null,function*(){if(t===0)return;let a=game.combat,r=a.getActorCombatant(this);!r||(yield a.adjustInitiative(r,t))})}hasDamageTracks(){return"track"in this.data.data}asVehicleData(){if(this.isVehicle())return this.data}asCharacterData(){if(this.isCharacter())return this.data}asSpiritData(){if(this.isSpirit())return this.data}asSpriteData(){if(this.isSprite())return this.data}asCritterData(){if(this.isCritter())return this.data}asICData(){if(this.isIC())return this.data}getVehicleStats(){if(this.isVehicle()&&"vehicle_stats"in this.data.data)return this.data.data.vehicle_stats}addVehicleDriver(t){return u(this,null,function*(){var r;if(!this.isVehicle())return;let a=(r=game.actors)==null?void 0:r.get(t);!a||(yield this.update({"data.driver":a.id}))})}removeVehicleDriver(){return u(this,null,function*(){!this.hasDriver()||(yield this.update({"data.driver":""}))})}hasDriver(){let t=this.asVehicleData();return t?t.data.driver.length>0:!1}getVehicleDriver(){var r;if(!this.hasDriver())return;let t=this.asVehicleData();if(!t)return;let a=(r=game.actors)==null?void 0:r.get(t.data.driver);if(!!a)return a}addICHost(t){return u(this,null,function*(){var i;if(!this.isIC())return;let a=(i=game.items)==null?void 0:i.get(t);if(!a||!a.isHost())return;let r=a.asHostData();!r||(yield this._updateICHostData(r))})}_updateICHostData(t){return u(this,null,function*(){var r;let a={id:t._id,rating:t.data.rating,atts:duplicate(t.data.atts)};yield this.update({"data.host":a},{render:!1}),yield(r=this.sheet)==null?void 0:r.render()})}removeICHost(){return u(this,null,function*(){if(!this.isIC())return;let t={id:null,rating:0,atts:null};yield this.update({"data.host":t})})}hasHost(){let t=this.asICData();return t?t&&!!t.data.host.id:!1}getICHost(){var a,r;let t=this.asICData();if(!!t)return(r=game.items)==null?void 0:r.get((a=t==null?void 0:t.data)==null?void 0:a.host.id)}matchesActorTypes(t){return t.includes(this.data.type)}getModifiers(){return u(this,arguments,function*(t=!1,a=canvas.scene){let r=Z.getModifiersFromEntity(this);return r.hasActiveEnvironmental?r:t||a===null?new Z(Z.getDefaultModifiers()):Z.getModifiersFromEntity(a)})}setModifiers(t){return u(this,null,function*(){yield Z.setModifiersOnEntity(this,t.modifiers)})}get isMatrixActor(){return"matrix"in this.data.data}get matrixData(){if(!!this.isMatrixActor)return this.data.data.matrix}setMarks(t,a,r){return u(this,null,function*(){var d,p,g;if(!canvas.ready)return;if(this.isIC()&&this.hasHost())return yield(d=this.getICHost())==null?void 0:d.setMarks(t,a,r);if(!this.isMatrixActor)return(p=ui.notifications)==null||p.error(game.i18n.localize("SR5.Errors.MarksCantBePlacedBy")),console.error(`The actor type ${this.data.type} can't receive matrix marks!`);if(t.actor&&!t.actor.isMatrixActor)return(g=ui.notifications)==null||g.error(game.i18n.localize("SR5.Errors.MarksCantBePlacedOn")),console.error(`The actor type ${t.actor.type} can't receive matrix marks!`);if(!t.actor)return console.error(`The token ${t.name} is missing it's actor`);if(this.id===t.actor.id)return;let i=(r==null?void 0:r.scene)||canvas.scene,s=r==null?void 0:r.item,o=w.buildMarkId(i.id,t.id,s==null?void 0:s.id),l=this.matrixData;if(!l)return;let c=r!=null&&r.overwrite?0:this.getMarksById(o);l.marks[o]=X.getValidMarksCount(c+a),yield this.update({"data.matrix.marks":l.marks})})}clearMarks(){return u(this,null,function*(){let t=this.matrixData;if(!t)return;let a={};for(let r of Object.keys(t.marks))a[`-=${r}`]=null;yield this.update({"data.matrix.marks":a})})}clearMark(t){return u(this,null,function*(){if(!this.isMatrixActor)return;let a={};a[`-=${t}`]=null,yield this.update({"data.matrix.marks":a})})}getAllMarks(){let t=this.matrixData;if(!!t)return t.marks}getMarks(t,a,r){if(!canvas.ready)return 0;if(t instanceof nt)return console.error("Not yet supported"),0;if(!t.actor||!t.actor.isMatrixActor)return 0;let i=(r==null?void 0:r.scene)||canvas.scene;a=a||t instanceof st?t.actor.getMatrixDevice():void 0;let s=w.buildMarkId(i.id,t.id,a==null?void 0:a.id);return this.getMarksById(s)}getMarksById(t){var a;return((a=this.matrixData)==null?void 0:a.marks[t])||0}get matrixController(){return this.isIC()&&this.hasHost()?this.getICHost()||this:this}getAllMarkedDocuments(){let t=this.matrixController.getAllMarks();return t?Object.entries(t).filter(([a,r])=>w.isValidMarkId(a)).map(([a,r])=>ut(J({},w.getMarkIdDocuments(a)),{marks:r,markId:a})):[]}};var wn=()=>{Handlebars.registerHelper("localizeOb",function(n,e){return e&&(n=e[n]),game.i18n.localize(n)}),Handlebars.registerHelper("localizeDocumentType",function(n){if(n.type.length<1)return"";let e=n instanceof st?"ACTOR":"ITEM",t=n.type[0].toUpperCase()+n.type.slice(1),a=`${e}.Type${t}`;return game.i18n.localize(a)}),Handlebars.registerHelper("localizeSkill",function(n){return n.label?game.i18n.localize(n.label):n.name}),Handlebars.registerHelper("toHeaderCase",function(n){return n?w.label(n):""}),Handlebars.registerHelper("concatStrings",function(...n){return n.filter(e=>typeof e=="string").join("")}),Handlebars.registerHelper("concat",function(n,e=","){return Array.isArray(n)?n.join(e):n}),Handlebars.registerHelper("for",function(n,e,t){let a="";for(let r=n;r<e;r+=1)a+=t.fn(r);return a}),Handlebars.registerHelper("modulo",function(n,e){return n%e}),Handlebars.registerHelper("divide",function(n,e){return e===0?0:n/e}),Handlebars.registerHelper("hasprop",function(n,e,t){return n.hasOwnProperty(e)?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("ifin",function(n,e,t){return e.includes(n)?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("ifgt",function(n,e,t){return n>e?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("iflt",function(n,e,t){return n<e?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("iflte",function(n,e,t){return n<=e?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("ifne",function(n,e,t){return n!==e?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("ife",function(n,e,t){return n===e?t.fn(this):t.inverse(this)}),Handlebars.registerHelper("empty",function(n){if(foundry.utils.getType(n)==="Array")return n.length===0;if(foundry.utils.getType(n)==="Object")return Object.keys(n).length===0;if(foundry.utils.getType(n)==="String")return n.length===0}),Handlebars.registerHelper("not",function(n){return!n}),Handlebars.registerHelper("sum",function(n,e){return n+e}),Handlebars.registerHelper("isDefined",function(n){return n!=null}),Handlebars.registerHelper("fallbackValue",function(n,e){return new Handlebars.SafeString(n!=null?n:e)}),Handlebars.registerHelper("log",function(n){console.log(n)}),Handlebars.registerHelper("buildName",function(n){let e=w.orderKeys(n.hash),t=Object.values(e).reduce((a,r,i)=>(i>0&&(a+="."),a+r),"");return new Handlebars.SafeString(t)}),Handlebars.registerHelper("disabledHelper",function(n){let e=Boolean(n);return e||void 0}),Handlebars.registerHelper("localizeShortened",function(n,e,t){return new Handlebars.SafeString(w.shortenAttributeLocalization(n,e))})};var aa=class{static loadTemplates(){return u(this,null,function*(){yield sn()})}static registerHelpers(){wn(),cn(),un(),dn(),mn()}};var Qa=class{constructor(){this.m_Abort=!1}get SourceVersionFriendlyName(){return`v${this.SourceVersion}`}get TargetVersionFriendlyName(){return`v${this.TargetVersion}`}abort(e){var t;this.m_Abort=!0,this.m_AbortReason=e,(t=ui.notifications)==null||t.error(`Data migration has been aborted: ${e}`,{permanent:!0})}Migrate(e){return u(this,null,function*(){var a,r,i;(a=ui.notifications)==null||a.info(`${e.i18n.localize("SR5.MIGRATION.BeginNotification")} ${this.SourceVersionFriendlyName} -> ${this.TargetVersionFriendlyName}.`),(r=ui.notifications)==null||r.warn(e.i18n.localize("SR5.MIGRATION.DoNotCloseNotification"),{permanent:!0});let t=new Map;if(yield this.PreMigrateItemData(e,t),this.m_Abort)return Promise.reject(this.m_AbortReason);if(yield this.IterateItems(e,t),yield this.PostMigrateItemData(e,t),this.m_Abort)return Promise.reject(this.m_AbortReason);if(yield this.PreMigrateActorData(e,t),this.m_Abort)return Promise.reject(this.m_AbortReason);if(yield this.IterateActors(e,t),yield this.PostMigrateActorData(e,t),this.m_Abort)return Promise.reject(this.m_AbortReason);if(yield this.PreMigrateSceneData(e,t),this.m_Abort)return Promise.reject(this.m_AbortReason);if(yield this.IterateScenes(e,t),yield this.PostMigrateSceneData(e,t),this.m_Abort)return Promise.reject(this.m_AbortReason);yield this.Apply(t),yield e.settings.set(Qa.MODULE_NAME,Qa.KEY_DATA_VERSION,this.TargetVersion),(i=ui.notifications)==null||i.info(`${e.i18n.localize("SR5.MIGRATION.SuccessNotification")} ${this.TargetVersion}.`,{permanent:!0})})}Apply(e){return u(this,null,function*(){for(let[t,{updateData:a,embeddedItems:r}]of e)r!==null&&(yield t.updateEmbeddedDocuments("Item",r)),yield t.update(a,{enforceTypes:!1})})}IterateScenes(e,t){return u(this,null,function*(){for(let a of e.scenes.contents)try{if(!(yield this.ShouldMigrateSceneData(a)))continue;a.id==="MAwSFhlXRipixOWw"&&(console.log("Scene Pre-Update"),console.log(a)),console.log(`Migrating Scene entity ${a.name}`);let r=yield this.MigrateSceneData(duplicate(a.data)),i=!1;if(r.tokens=yield Promise.all(a.data.tokens.map(s=>u(this,null,function*(){if(!s.actor||isObjectEmpty(s.actor.data))return s;let o=yield this.MigrateActorData(s.actor.data);if(isObjectEmpty(o))return s;{i=!0,o._id=s.id;let l=duplicate(s);return l.actorData=yield mergeObject(s.actor.data,o,{enforceTypes:!1,inplace:!1}),console.log(l),l}}))),a.id==="MAwSFhlXRipixOWw"&&(console.log("Scene Pre-Update"),console.log(a)),isObjectEmpty(r))continue;expandObject(r),t.set(a,{updateData:r,embeddedItems:null})}catch(r){return console.error(r),Promise.reject(r)}})}IterateItems(e,t){return u(this,null,function*(){for(let a of e.items.contents)try{if(!(yield this.ShouldMigrateItemData(a.data)))continue;console.log(`Migrating Item: ${a.name}`);let r=yield this.MigrateItemData(a.data);if(isObjectEmpty(r))continue;expandObject(r),t.set(a,{updateData:r,embeddedItems:null})}catch(r){return console.error(r),Promise.reject(r)}})}IterateActors(e,t){return u(this,null,function*(){for(let a of e.actors.contents)try{if(!(yield this.ShouldMigrateActorData(a.data)))continue;console.log(`Migrating Actor ${a.name}`),console.log(a);let r=yield this.MigrateActorData(duplicate(a.data));console.log(r);let i=[];r.items&&(i=r.items,delete r.items),expandObject(r),t.set(a,{updateData:r,embeddedItems:i})}catch(r){return console.error(r),Promise.reject(r)}})}IterateActorItems(e,t){return u(this,null,function*(){let a=!1;if(e.items!==void 0){let r=yield Promise.all(e.items.map(i=>u(this,null,function*(){if(!(yield this.ShouldMigrateItemData(i)))return i;let s=yield this.MigrateItemData(i);return a=!0,s._id=i._id,mergeObject(i,s.data,{enforceTypes:!1,inplace:!1})})));a&&(t.items=r)}return t})}ShouldMigrateSceneData(e){return u(this,null,function*(){return!1})}MigrateSceneData(e){return u(this,null,function*(){return{}})}PreMigrateSceneData(e,t){return u(this,null,function*(){})}PostMigrateSceneData(e,t){return u(this,null,function*(){})}ShouldMigrateItemData(e){return u(this,null,function*(){return!1})}MigrateItemData(e){return u(this,null,function*(){return{}})}PreMigrateItemData(e,t){return u(this,null,function*(){})}PostMigrateItemData(e,t){return u(this,null,function*(){})}ShouldMigrateActorData(e){return u(this,null,function*(){return!1})}MigrateActorData(e){return u(this,null,function*(){return{}})}PreMigrateActorData(e,t){return u(this,null,function*(){})}PostMigrateActorData(e,t){return u(this,null,function*(){})}MigrateCompendiumPack(e){return u(this,null,function*(){if(!["Actor","Item","Scene"].includes(e.metadata.type))return;yield e.migrate({});let t=yield e.getDocuments();for(let a of t)try{let r=null;if(e.metadata.type==="Item"){if(r=yield this.MigrateItemData(foundry.utils.duplicate(a.data)),isObjectEmpty(r))continue;r.data&&(expandObject(r.data),a.update(r.data))}else if(e.metadata.type==="Actor"){if(r=yield this.MigrateActorData(foundry.utils.duplicate(a.data)),isObjectEmpty(r))continue;r.items&&(yield a.updateEmbeddedDocuments("Item",r.items)),r.effects&&(yield a.updateEmbeddedDocuments("Effect",r.effects)),r.data&&(expandObject(r.data),yield a.update(r.data))}else if(e.metadata.type==="Scene"){if(r=yield this.MigrateSceneData(foundry.utils.duplicate(a.data)),isObjectEmpty(r))continue;r.data&&(expandObject(r.data),yield a.update(r.data))}}catch(r){console.error(r)}console.log(`Migrated all ${e.metadata.type} entities from Compendium ${e.collection}`)})}},gt=Qa;gt.MODULE_NAME="shadowrun5e",gt.KEY_DATA_VERSION="systemMigrationVersion",gt.NO_VERSION="0";var Ft=class extends gt{get SourceVersion(){return"0"}get TargetVersion(){return Ft.TargetVersion}static get TargetVersion(){return"0.6.4"}MigrateActorData(e){return u(this,null,function*(){let t={};return Ft.migrateActorOverflow(e,t),Ft.migrateActorSkills(e,t),t=yield this.IterateActorItems(e,t),t})}MigrateItemData(e){return u(this,null,function*(){let t={};return Ft.migrateDamageTypeAndElement(e,t),Ft.migrateItemsAddActions(e,t),Ft.migrateActorOverflow(e,t),Ft.migrateItemsAddCapacity(e,t),Ft.migrateItemsAmmo(e,t),Ft.migrateItemsConceal(e,t),t})}MigrateSceneData(e){return u(this,null,function*(){return{}})}ShouldMigrateActorData(e){return u(this,null,function*(){return!0})}ShouldMigrateItemData(e){return u(this,null,function*(){return!0})}ShouldMigrateSceneData(e){return u(this,null,function*(){var t;return((t=e.data.tokens)==null?void 0:t.length)>0})}static migrateActorOverflow(e,t){getProperty(e.data,"track.physical.overflow")===0&&(t["data.track.physical.overflow.value"]=0,t["data.track.physical.overflow.max"]=0)}static migrateActorSkills(e,t){var i,s,o,l,c,d,p,g,y,S,M,L,R,F,D,h;if(!((s=(i=e.data)==null?void 0:i.skills)!=null&&s.active))return;let a=/[,\/|.]+/,r=(m,[T,k])=>(!Array.isArray(k.specs)&&k.specs&&(m[T]={specs:k.specs.split(a).filter(v=>v!=="")}),m);e.data.skills&&(t["data.skills.active"]=Object.entries(e.data.skills.active).reduce(r,{}),e.data.skills.knowledge&&(t["data.skills.knowledge.street.value"]=Object.entries((c=(l=(o=e.data.skills)==null?void 0:o.knowledge)==null?void 0:l.street)==null?void 0:c.value).reduce(r,{}),t["data.skills.knowledge.professional.value"]=Object.entries((g=(p=(d=e.data.skills)==null?void 0:d.knowledge)==null?void 0:p.professional)==null?void 0:g.value).reduce(r,{}),t["data.skills.knowledge.academic.value"]=Object.entries((M=(S=(y=e.data.skills)==null?void 0:y.knowledge)==null?void 0:S.academic)==null?void 0:M.value).reduce(r,{}),t["data.skills.knowledge.interests.value"]=Object.entries((F=(R=(L=e.data.skills)==null?void 0:L.knowledge)==null?void 0:R.interests)==null?void 0:F.value).reduce(r,{})),e.data.skills.language&&(t["data.skills.language.value"]=Object.entries((h=(D=e.data.skills)==null?void 0:D.language)==null?void 0:h.value).reduce(r,{})))}static migrateDamageTypeAndElement(e,t){if(e.data.action){let a=e.data.action;typeof a.damage.type=="string"&&(t["data.action.damage.type.base"]=e.data.action.damage.type),typeof a.damage.element=="string"&&(t["data.action.damage.element.base"]=e.data.action.damage.element)}}static migrateItemsAmmo(e,t){if(e.type==="weapon"&&e.data.ammo===void 0){let a={value:0,max:0};if(e.data.category==="range"&&e.data.range&&e.data.range.ammo){let r=e.data.range.ammo;a.value=r.value,a.max=r.max}t["data.ammo"]={spare_clips:{value:0,max:0},current:{value:a.value,max:a.max}}}}static migrateItemsConceal(e,t){var a;((a=e.data.technology)==null?void 0:a.concealability)!==void 0&&(t["data.technology.conceal"]={base:e.data.technology.concealability})}static migrateItemsAddCapacity(e,t){["cyberware"].includes(e.type)&&e.data.capacity===void 0&&(t.data.capacity=0)}static migrateItemsAddActions(e,t){if(["quality","cyberware"].includes(e.type)&&e.data.action===void 0){let a={type:"",category:"",attribute:"",attribute2:"",skill:"",spec:!1,mod:0,limit:{value:0,attribute:""},extended:!1,damage:{type:"",element:"",value:0,ap:{value:0},attribute:""},opposed:{type:"",attribute:"",attribute2:"",skill:"",mod:0,description:""}};t.data||(t.data={}),t.data.action=a}}};var Ve=class extends gt{get SourceVersion(){return"0.6.4"}get TargetVersion(){return Ve.TargetVersion}static get TargetVersion(){return"0.6.5"}MigrateActorData(e){return u(this,null,function*(){let t={};return t.data===void 0&&(t.data={}),t.data.full_defense_attribute="willpower",t})}ShouldMigrateActorData(e){return u(this,null,function*(){return e.data.full_defense_attribute===void 0})}ShouldMigrateSceneData(e){return u(this,null,function*(){var t;return((t=e.data.tokens)==null?void 0:t.length)>0})}};var Ue=class extends gt{get SourceVersion(){return"0.6.9"}get TargetVersion(){return Ue.TargetVersion}static get TargetVersion(){return"0.6.10"}MigrateActorData(e){return u(this,null,function*(){var t,a;return((a=(t=e.data)==null?void 0:t.attributes)==null?void 0:a.edge)===void 0?{}:{data:{attributes:{edge:{base:e.data.attributes.edge.max,value:e.data.attributes.edge.max,uses:e.data.attributes.edge.value}}}}})}ShouldMigrateActorData(e){return u(this,null,function*(){var t;return((t=e.data.attributes.edge)==null?void 0:t.uses)===void 0})}ShouldMigrateSceneData(e){return u(this,null,function*(){var t;return((t=e.data.tokens)==null?void 0:t.length)>0})}};var ae=class extends gt{get SourceVersion(){return"0.7.1"}get TargetVersion(){return ae.TargetVersion}static get TargetVersion(){return"0.7.2"}static NoNPCDataForCharacter(e){return e.type==="character"&&(!("is_npc"in(e==null?void 0:e.data))||!("npc"in(e==null?void 0:e.data)))}static UnsupportedMetatype(e){var a,r;let t=(r=(a=e.data.metatype)==null?void 0:a.toLowerCase())!=null?r:"";return e.type==="character"&&q.character.types.hasOwnProperty(t)}MigrateActorData(e){return u(this,null,function*(){var a,r;let t={};if(ae.UnsupportedMetatype(e)){let i=(r=(a=e.data.metatype)==null?void 0:a.toLowerCase())!=null?r:"",s={metatype:q.character.types.hasOwnProperty(i)?i:"human"};t.data=J(J({},t.data),s)}if(ae.NoNPCDataForCharacter(e)){t.data=t.data?t.data:{};let i={is_npc:!1,npc:{is_grunt:!1,professional_rating:0}};t.data=J(J({},t.data),i)}return t})}ShouldMigrateActorData(e){return u(this,null,function*(){return ae.UnsupportedMetatype(e)||ae.NoNPCDataForCharacter(e)})}};var He=class extends gt{get SourceVersion(){return"0.7.6"}get TargetVersion(){return He.TargetVersion}static get TargetVersion(){return"0.8.0"}ShouldMigrateItemData(e){return u(this,null,function*(){return this._ShouldMigrateItemData(e)})}_ShouldMigrateItemData(e){return["weapon","spell"].includes(e.type)}MigrateItemData(e){return u(this,null,function*(){let t={};switch(e.type){case"weapon":{if(e.data.category){let a=q.weaponCategoryActiveTests[e.data.category];t.data={action:{test:a}}}break}case"spell":switch(e.data.category){case"":{t.data={data:{action:{test:"",opposed:{test:"",resist:{test:""}}}}};break}default:{let a=q.activeTests[e.type],r=q.opposedTests[e.type][e.data.category]||"OpposedTest",i=q.opposedResistTests[e.type][e.data.category]||"";t.data={data:{action:{test:a,opposed:{test:r,resist:{test:i}}}}};break}}}return t})}ShouldMigrateActorData(e){return u(this,null,function*(){return e.items.contents.filter(t=>this._ShouldMigrateItemData(t.data)).length>0})}MigrateActorData(e){return u(this,null,function*(){let t={items:[]};return t=yield this.IterateActorItems(e,t),t})}};var xi=class{static BeginMigration(){return u(this,null,function*(){let e=game.settings.get(gt.MODULE_NAME,gt.KEY_DATA_VERSION);e==null&&(e=gt.NO_VERSION);let t=xi.s_Versions.filter(({versionNumber:d})=>this.compareVersion(d,e)===1);if(t.length===0)return;let a=game.i18n.localize("SR5.MIGRATION.WarningTitle"),r=game.i18n.localize("SR5.MIGRATION.WarningHeader"),i=game.i18n.localize("SR5.MIGRATION.WarningRequired"),s=game.i18n.localize("SR5.MIGRATION.WarningDescription"),o=game.i18n.localize("SR5.MIGRATION.WarningBackup"),l=game.i18n.localize("SR5.MIGRATION.BeginMigration");new Dialog({title:a,content:`<h2 style="color: red; text-align: center">${r}</h2><p style="text-align: center"><i>${i}</i></p><p>${s}</p><h3 style="color: red">${o}</h3>`,buttons:{ok:{label:l,callback:()=>this.migrate(t)}},default:"ok"}).render(!0)})}static migrate(e){return u(this,null,function*(){e.sort((l,c)=>this.compareVersion(l.versionNumber,c.versionNumber)),yield this.migrateWorld(game,e),yield this.migrateCompendium(game,e);let t=game.i18n.localize("SR5.MIGRATION.SuccessTitle"),a=game.i18n.localize("SR5.MIGRATION.SuccessHeader"),r=game.i18n.localize("SR5.MIGRATION.SuccessDescription"),i=game.i18n.localize("SR5.MIGRATION.SuccessPacksInfo"),s=game.i18n.localize("SR5.MIGRATION.SuccessConfirm");new Dialog({title:t,content:`<h2 style="text-align: center; color: green">${a}</h2><p>${r}</p><p style="text-align: center"><i>${i}</i></p>`,buttons:{ok:{icon:'<i class="fas fa-check"></i>',label:s}},default:"ok"}).render(!0)})}static migrateWorld(e,t){return u(this,null,function*(){for(let{migration:a}of t)yield a.Migrate(e)})}static migrateCompendium(e,t){return u(this,null,function*(){var r;let a=(r=e.packs)==null?void 0:r.filter(i=>i.metadata.package==="world"&&["Actor","Item","Scene"].includes(i.metadata.type));if(!!a)for(let i of a)for(let{migration:s}of t)yield s.MigrateCompendiumPack(i)})}static compareVersion(e,t){let a=e.split(".").map(s=>parseInt(s,10)),r=t.split(".").map(s=>parseInt(s,10)),i=Math.min(e.length,t.length);for(let s=0;s<i;++s){if(a[s]>r[s])return 1;if(a[s]<r[s])return-1}return e.length===t.length?0:e.length<t.length?-1:1}},Ta=xi;Ta.s_Versions=[{versionNumber:Ft.TargetVersion,migration:new Ft},{versionNumber:Ve.TargetVersion,migration:new Ve},{versionNumber:Ue.TargetVersion,migration:new Ue},{versionNumber:ae.TargetVersion,migration:new ae},{versionNumber:He.TargetVersion,migration:new He}];var Dn=()=>{game.settings.register(V,"diagonalMovement",{name:"SETTINGS.DiagonalMovementName",hint:"SETTINGS.DiagonalMovementDescription",scope:"world",config:!0,type:String,default:"1-2-1",choices:{"1-1-1":"SETTINGS.IgnoreDiagonal","1-2-1":"SETTINGS.EstimateDiagonal",EUCL:"SETTINGS.Euclidean"},onChange:n=>{canvas.ready&&(canvas.grid.diagonalRule=n)}}),game.settings.register(V,"applyLimits",{name:"SETTINGS.ApplyLimitsName",hint:"SETTINGS.ApplyLimitsDescription",scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(V,gt.KEY_DATA_VERSION,{name:"System Data Version.",scope:"world",config:!1,type:String,default:"0"}),game.settings.register(V,j.ShowGlitchAnimation,{name:"SETTINGS.ShowGlitchAnimationName",hint:"SETTINGS.ShowGlitchAnimationDescription",scope:"user",config:!0,type:Boolean,default:!0}),game.settings.register(V,j.ShowTokenNameForChatOutput,{name:"SETTINGS.ShowTokenNameForChatOutputName",hint:"SETTINGS.ShowTokenNameForChatOutputDescription",scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(V,j.OnlyAllowRollOnDefaultableSkills,{name:"SETTINGS.OnlyAllowRollOnDefaultableSkills",hint:"SETTINGS.OnlyAllowRollOnDefaultableSkillsDescription",scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(V,j.ShowSkillsWithDetails,{name:"SETTINGS.ShowSkillsWithDetails",hint:"SETTINGS.ShowSkillsWithDetailsDescription",scope:"user",config:!0,type:Boolean,default:!0}),game.settings.register(V,j.OnlyAutoRollNPCInCombat,{name:"SETTINGS.OnlyAutoRollNPCInCombat",hint:"SETTINGS.OnlyAutoRollNPCInCombatDescription",scope:"world",config:!0,type:Boolean,default:!0}),game.settings.register(V,j.TokenHealthBars,{name:"SETTINGS.TokenHealthBars",hint:"SETTINGS.TokenHealthBarsDescription",scope:"world",config:!0,type:Boolean,default:!1})};function Ja(n,e){return u(this,null,function*(){if(e.isOwned)return ui.notifications.warn("Managing Active Effects within an Owned Item is not currently supported and will be added in a subsequent update.");n.preventDefault();let t=n.currentTarget,a=n.currentTarget.closest(".list-item"),r=a.dataset.itemId?e.effects.get(a.dataset.itemId):null;switch(t.dataset.action){case"create":return e.createEmbeddedDocuments("ActiveEffect",[{label:game.i18n.localize("SR5.ActiveEffect.New"),origin:e.uuid,"duration.rounds":a.dataset.effectType==="temporary"?1:void 0,disabled:a.dataset.effectType==="inactive"}]);case"edit":return r.sheet.render(!0);case"delete":return(yield w.confirmDeletion())?r.delete():void 0;case"toggle":return r.toggleDisabled();case"open-origin":return r.renderSourceSheet();default:console.error(`An active effect with the id '${r}' couldn't be managed as no action has been defined within the template.`);return}})}function Za(n){let e={temporary:{type:"temporary",label:game.i18n.localize("SR5.ActiveEffect.Types.Temporary"),effects:[]},passive:{type:"passive",label:game.i18n.localize("SR5.ActiveEffect.Types.Passive"),effects:[]},inactive:{type:"inactive",label:game.i18n.localize("SR5.ActiveEffect.Types.Inactive"),effects:[]}};for(let t of n)t._getSourceName(),t.data.disabled?e.inactive.effects.push(t):t.isTemporary?e.temporary.effects.push(t):e.passive.effects.push(t);return e}var ra=class extends ItemSheet{constructor(){super(...arguments);this._shownDesc=[]}getEmbeddedItems(){return this.item.items||[]}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["sr5","sheet","item"],width:650,height:450,tabs:[{navSelector:".tabs",contentSelector:".sheetbody"}]})}get template(){return`systems/shadowrun5e/dist/templates/item/${this.item.data.type}.html`}getData(){let t=super.getData();t.type=t.data.type,t.data=t.data.data;let a=t.data;if(a.action)try{let{action:l}=a;l.mod===0&&delete l.mod,l.limit===0&&delete l.limit,l.damage&&(l.damage.mod===0&&delete l.damage.mod,l.damage.ap.mod===0&&delete l.damage.ap.mod),l.limit&&l.limit.mod===0&&delete l.limit.mod}catch(l){console.error(l)}if(a.technology)try{let l=a.technology;l.rating===0&&delete l.rating,l.quantity===0&&delete l.quantity,l.cost===0&&delete l.cost}catch(l){console.log(l)}t.config=q;let r=this.getEmbeddedItems(),[i,s,o]=r.reduce((l,c)=>(c.type==="ammo"&&l[0].push(c.data),c.type==="modification"&&"type"in c.data.data&&c.data.data.type==="weapon"&&l[1].push(c.data),c.type==="modification"&&"type"in c.data.data&&c.data.data.type==="armor"&&l[2].push(c.data),l),[[],[],[]]);return t.ammunition=i,t.weaponMods=s,t.armorMods=o,t.activeSkills=this._getSortedActiveSkillsForSelect(),t.attributes=this._getSortedAttributesForSelect(),t.limits=this._getSortedLimitsForSelect(),t.effects=Za(this.document.effects),this.object.isHost()&&(t.markedDocuments=this.object.getAllMarkedDocuments()),this.item.canBeNetworkController&&(t.networkDevices=this.item.networkDevices),this.item.canBeNetworkDevice&&(t.networkController=this.item.networkController),t.tests=game.shadowrun5e.tests,t.opposedTests=game.shadowrun5e.opposedTests,t.activeTests=game.shadowrun5e.activeTests,t.resistTests=game.shadowrun5e.resistTests,t}_getSortedLimitsForSelect(){return w.sortConfigValuesByTranslation(q.limits)}_getSortedAttributesForSelect(){return w.sortConfigValuesByTranslation(q.attributes)}_getSortedActiveSkillsForSelect(){let t=this.item.actorOwner;if(!t||t.isIC())return w.sortConfigValuesByTranslation(q.activeSkills);let a=w.sortSkills(t.getActiveSkills()),r={};for(let[i,s]of Object.entries(a)){let o=s.name||i,l=s.label||s.name;r[o]=l}return r}_getNetworkDevices(){return[]}activateListeners(t){super.activateListeners(t),w.setupCustomCheckbox(this,t),this.form.ondragover=a=>this._onDragOver(a),this.form.ondrop=a=>this._onDrop(a),t.find(".effect-control").click(a=>Ja(a,this.document)),t.find(".edit-item").click(this._onEditItem.bind(this)),t.find(".open-source-pdf").on("click",this._onOpenSourcePdf.bind(this)),t.find(".has-desc").click(a=>{a.preventDefault();let r=$(a.currentTarget).parents(".list-item"),i=$(r).data().item,s=r.next();s.toggle(),i&&(s.is(":visible")?this._shownDesc.push(i):this._shownDesc=this._shownDesc.filter(o=>o!==i))}),t.find(".hidden").hide(),t.find(".entity-remove").on("click",this._onEntityRemove.bind(this)),t.find(".add-new-ammo").click(this._onAddNewAmmo.bind(this)),t.find(".ammo-equip").click(this._onAmmoEquip.bind(this)),t.find(".ammo-delete").click(this._onAmmoRemove.bind(this)),t.find(".ammo-reload").click(this._onAmmoReload.bind(this)),t.find(".add-new-mod").click(this._onAddWeaponMod.bind(this)),t.find(".mod-equip").click(this._onWeaponModEquip.bind(this)),t.find(".mod-delete").click(this._onWeaponModRemove.bind(this)),t.find(".add-new-license").click(this._onAddLicense.bind(this)),t.find(".license-delete").on("click",this._onRemoveLicense.bind(this)),t.find(".network-clear").on("click",this._onRemoveAllNetworkDevices.bind(this)),t.find(".network-device-remove").on("click",this._onRemoveNetworkDevice.bind(this)),t.find(".marks-qty").on("change",this._onMarksQuantityChange.bind(this)),t.find(".marks-add-one").on("click",a=>u(this,null,function*(){return this._onMarksQuantityChangeBy(a,1)})),t.find(".marks-remove-one").on("click",a=>u(this,null,function*(){return this._onMarksQuantityChangeBy(a,-1)})),t.find(".marks-delete").on("click",this._onMarksDelete.bind(this)),t.find(".marks-clear-all").on("click",this._onMarksClearAll.bind(this)),t.find(".origin-link").on("click",this._onOpenOriginLink.bind(this)),t.find(".controller-remove").on("click",this._onControllerRemove.bind(this))}_onDrop(t){return u(this,null,function*(){var r;if(!game.items||!game.actors||!game.scenes)return;t.preventDefault(),t.stopPropagation();let a;try{a=JSON.parse(t.dataTransfer.getData("text/plain"))}catch(i){return console.log("Shadowrun 5e | drop error")}if(!!a){if(this.item.isWeapon()&&a.type==="Item"){let i;if(a.data){if(this.item.isOwned&&a.actorId===((r=this.item.actor)==null?void 0:r.id)&&a.data._id===this.item.id)return console.warn("Shadowrun 5e | Cant drop items onto themself");i=a}else a.pack?i=yield w.getEntityFromCollection(a.pack,a.id):i=game.items.get(a.id);return yield this.item.createOwnedItem(i.data)}if(this.item.isHost()&&a.type==="Actor")return yield this.item.addIC(a.id,a.pack);if(this.item.canBeNetworkController&&a.type==="Item"){if(a.actorId&&!a.sceneId&&!a.tokenId){console.log("Shadowrun 5e | Dropped an item from a collection actor");let i=game.actors.get(a.actorId);if(!i)return;let s=i.items.get(a.data._id);return s?yield this.item.addNetworkDevice(s):void 0}if(a.actorId&&a.sceneId&&a.tokenId){console.log("Shadowrun 5e | Dropped in an item from a scene token actor");let i=game.scenes.get(a.sceneId);if(!i)return;let s=i.tokens.get(a.tokenId);if(!s)return;let o=s.actor;if(!o)return;let l=o.items.get(a.data._id);return l?yield this.item.addNetworkDevice(l):void 0}return}}})}_eventId(t){return t.preventDefault(),t.currentTarget.closest(".list-item").dataset.itemId}_onOpenSourcePdf(t){return u(this,null,function*(){t.preventDefault(),yield this.item.openPdfSource()})}_onEditItem(t){return u(this,null,function*(){var r;let a=this.item.getOwnedItem(this._eventId(t));a&&((r=a.sheet)==null||r.render(!0))})}_onEntityRemove(t){return u(this,null,function*(){t.preventDefault();let a=$(t.currentTarget).closest(".entity-remove"),r=a.data("list"),i=a.data("position");if(!!r)switch(r){case"ic":yield this.item.removeIC(i);break}})}_onAddLicense(t){return u(this,null,function*(){t.preventDefault(),yield this.item.addNewLicense()})}_onRemoveLicense(t){return u(this,null,function*(){t.preventDefault();let a=t.currentTarget.dataset.index;a>=0&&(yield this.item.removeLicense(a))})}_onWeaponModRemove(t){return u(this,null,function*(){yield this._onOwnedItemRemove(t)})}_onWeaponModEquip(t){return u(this,null,function*(){yield this.item.equipWeaponMod(this._eventId(t))})}_onAddWeaponMod(t){return u(this,null,function*(){t.preventDefault();let a="modification",r={name:`New ${w.label(a)}`,type:a,data:{type:"weapon"}},i=new nt(r,{parent:this.item});yield this.item.createOwnedItem(i.data)})}_onAmmoReload(t){return u(this,null,function*(){t.preventDefault(),yield this.item.reloadAmmo()})}_onAmmoRemove(t){return u(this,null,function*(){yield this._onOwnedItemRemove(t)})}_onAmmoEquip(t){return u(this,null,function*(){yield this.item.equipAmmo(this._eventId(t))})}_onAddNewAmmo(t){return u(this,null,function*(){t.preventDefault();let a="ammo",r={name:`New ${w.label(a)}`,type:a},i=new nt(r,{parent:this.item});yield this.item.createOwnedItem(i.data)})}_onOwnedItemRemove(t){return u(this,null,function*(){t.preventDefault(),(yield w.confirmDeletion())&&(yield this.item.deleteOwnedItem(this._eventId(t)))})}_onRemoveAllNetworkDevices(t){return u(this,null,function*(){t.preventDefault(),(yield w.confirmDeletion())&&(yield this.item.removeAllNetworkDevices())})}_onRemoveNetworkDevice(t){return u(this,null,function*(){if(t.preventDefault(),!(yield w.confirmDeletion()))return;let r=w.parseInputToNumber(t.currentTarget.closest(".list-item").dataset.listItemIndex);yield this.item.removeNetworkDevice(r)})}_findActiveList(){return $(this.element).find(".tab.active .scroll-area")}fixStaleRenderedState(){this._state===Application.RENDER_STATES.RENDERED&&ui.windows[this.appId]===void 0&&(console.warn(`SR5ItemSheet app for ${this.document.name} is set as RENDERED but has no window registered. Fixing app internal render state. This is a known bug.`),this._state=Application.RENDER_STATES.CLOSED)}_render(){return u(this,arguments,function*(t=!1,a={}){this._saveScrollPositions(),yield Y(ra.prototype,this,"_render").call(this,t,a),this._restoreScrollPositions()})}_restoreScrollPositions(){let t=this._findActiveList();t.length&&this._scroll!=null&&t.prop("scrollTop",this._scroll)}_saveScrollPositions(){let t=this._findActiveList();t.length&&(this._scroll=t.prop("scrollTop"))}_onMarksQuantityChange(t){return u(this,null,function*(){if(t.stopPropagation(),!this.object.isHost())return;let a=t.currentTarget.dataset.markId;if(!a)return;let r=w.getMarkIdDocuments(a);if(!r)return;let{scene:i,target:s,item:o}=r;if(!i||!s)return;let l=parseInt(t.currentTarget.value);yield this.object.setMarks(s,l,{scene:i,item:o,overwrite:!0})})}_onMarksQuantityChangeBy(t,a){return u(this,null,function*(){if(t.stopPropagation(),!this.object.isHost())return;let r=t.currentTarget.dataset.markId;if(!r)return;let i=w.getMarkIdDocuments(r);if(!i)return;let{scene:s,target:o,item:l}=i;!s||!o||(yield this.object.setMarks(o,a,{scene:s,item:l}))})}_onMarksDelete(t){return u(this,null,function*(){if(t.stopPropagation(),!this.object.isHost())return;let a=t.currentTarget.dataset.markId;!a||!(yield w.confirmDeletion())||(yield this.object.clearMark(a))})}_onMarksClearAll(t){return u(this,null,function*(){t.stopPropagation(),!(!this.object.isHost()||!(yield w.confirmDeletion()))&&(yield this.object.clearMarks())})}_onOpenOriginLink(t){return u(this,null,function*(){t.preventDefault(),console.log("Shadowrun 5e | Opening PAN/WAN network controller");let a=t.currentTarget.dataset.originLink,r=yield fromUuid(a);!r||r.sheet.render(!0)})}_onControllerRemove(t){return u(this,null,function*(){t.preventDefault(),yield this.item.disconnectFromNetwork()})}};var tr=class extends Token{_drawBar(e,t,a){if(game.settings.get(V,j.TokenHealthBars)&&a&&a.attribute.startsWith("track")){let i=a;i.value=i.max-i.value}super._drawBar(e,t,a)}};var Sn=function(n,e={}){if(!game||!game.ready||!canvas||!canvas.ready)return 0;if(!e.gridSpaces)return BaseGrid.prototype.measureDistances.call(this,n,e);let t=0,a=this.parent.diagonalRule,r=canvas.dimensions;return n.map(i=>{let s=i.ray,o=Math.abs(Math.ceil(s.dx/r.size)),l=Math.abs(Math.ceil(s.dy/r.size)),c=Math.min(o,l),d=Math.abs(l-o);if(t+=c,a==="1-2-1"){let p=Math.floor(t/2)-Math.floor((t-c)/2);return(p*2+(c-p)+d)*canvas.dimensions.distance}else return a==="EUCL"?Math.round(Math.hypot(o,l)*canvas.scene.data.gridDistance):(d+c)*canvas.scene.data.gridDistance})};function vn(n,e){return u(this,null,function*(){var r;if(!game||!game.macros)return;let t=`game.shadowrun5e.rollItemMacro("${n.name}");`,a=game.macros.contents.find(i=>i.name===n.name);a||(a=yield Macro.create({name:n.name,type:"script",img:n.img,command:t,flags:{"shadowrun5e.itemMacro":!0}},{renderSheet:!1})),a&&((r=game.user)==null||r.assignHotbarMacro(a,e))})}function Tn(n){var r;if(!game||!game.actors)return;let e=ChatMessage.getSpeaker(),t;if(e.token&&(t=game.actors.tokens[e.token]),!e.actor)return;t||(t=game.actors.get(e.actor));let a=t?t.items.find(i=>i.name===n):null;return a?a.castAction():(r=ui.notifications)==null?void 0:r.warn(`Your controlled Actor does not have an item named ${n}`)}function In(n,e){return u(this,null,function*(){if(!game.macros||!game.user)return;let{skillId:t,skill:a}=n,r=w.getSkillLabelOrName(a);if(game.macros.contents.find(l=>l.name===r))return;let s=`game.shadowrun5e.rollSkillMacro("${r}");`,o=yield Macro.create({name:r,type:"script",command:s});o&&(yield game.user.assignHotbarMacro(o,e))})}function An(n){return u(this,null,function*(){if(!game||!game.actors||!n)return;let e=ChatMessage.getSpeaker();!e||(game.actors.tokens[e.token]||game.actors.get(e.actor))})}var Ia=class extends Application{static get defaultOptions(){let e=super.defaultOptions;return e.id="overwatch-score-tracker",e.classes=["sr5"],e.title=game.i18n.localize("SR5.OverwatchScoreTrackerTitle"),e.template="systems/shadowrun5e/dist/templates/apps/gmtools/overwatch-score-tracker.html",e.width=450,e.height="auto",e.resizable=!0,e}getData(e){let t=this._prepareCharacterActorsData();return Ia.addedActors.forEach(a=>{let r=game.actors.get(a);r&&t.push(r.toObject())}),this.actors=t,{actors:t}}_prepareCharacterActorsData(){return game.users.reduce((e,t)=>(!t.isGM&&t.character&&e.push(t.character.toObject()),e),[])}activateListeners(e){e.find(".overwatch-score-reset").on("click",this._resetOverwatchScore.bind(this)),e.find(".overwatch-score-add").on("click",this._addOverwatchScore.bind(this)),e.find(".overwatch-score-input").on("change",this._setOverwatchScore.bind(this)),e.find(".overwatch-score-roll-15-minutes").on("click",this._rollFor15Minutes.bind(this)),e.find(".overwatch-score-add-actor").on("click",this._onAddActor.bind(this))}_getActorFromEvent(e){let t=$(e.currentTarget).closest(".list-item").data("actorId");if(t)return game.actors.get(t)}_onAddActor(e){var r;e.preventDefault();let t=w.getControlledTokens();if(t.length===0)return(r=ui.notifications)==null?void 0:r.warn(game.i18n.localize("SR5.OverwatchScoreTracker.NotifyNoSelectedTokens"));t.find(i=>!i.data.actorLink)!==void 0&&ui.notifications.warn(game.i18n.localize("SR5.OverwatchScoreTracker.OnlyLinkedActorsSupported")),t.filter(i=>i.data.actorLink).forEach(i=>{let s=game.actors.get(i.data.actorId);!s||this._isActorOnTracker(s)||Ia.addedActors.push(s.id)}),this.render()}_isActorOnTracker(e){return this.actors.find(t=>t._id===e.id)!==void 0}_setOverwatchScore(e){let t=this._getActorFromEvent(e),a=e.currentTarget.value;a&&t&&t.setOverwatchScore(a).then(()=>this.render())}_addOverwatchScore(e){let t=this._getActorFromEvent(e),a=parseInt(e.currentTarget.dataset.amount);if(a&&t){let r=t.getOverwatchScore();t.setOverwatchScore(r+a).then(()=>this.render())}}_resetOverwatchScore(e){e.preventDefault();let t=this._getActorFromEvent(e);t&&t.setOverwatchScore(0).then(()=>this.render())}_rollFor15Minutes(e){e.preventDefault();let t=this._getActorFromEvent(e);if(t){let a=new Roll(Ia.MatrixOverwatchDiceCount);if(a.evaluate({async:!1}),a.total){let r=t.getOverwatchScore();t.setOverwatchScore(r+a.total).then(()=>this.render())}}}},ia=Ia;ge(ia,"MatrixOverwatchDiceCount","2d6"),ge(ia,"addedActors",[]);var yt=class{static applyAllSoakParts(e,t,a){a.type.base!=="matrix"?yt.applyPhysicalAndStunSoakParts(e,t,a):yt.applyMatrixSoakParts(e,t)}static applyPhysicalAndStunSoakParts(e,t,a){let r=w.findDamageSource(a);if(r&&r.isDirectCombatSpell())return yt.applyDirectCombatSpellParts(r.data,e,t);yt.applyBodyAndArmorParts(e,t);let i=t.getArmor();yt.applyArmorPenetration(e,i,a),yt.applyElementalArmor(e,i,a.element.base)}static applyDirectCombatSpellParts(e,t,a){e.data.type==="mana"?yt.addUniquePart(t,a.getAttribute("willpower"),q.attributes.willpower):yt.addUniquePart(t,a.getAttribute("body"),q.attributes.body)}static applyBodyAndArmorParts(e,t){let a=t.findAttribute("body");a&&e.addUniquePart(a.label||"SR5.Body",a.value);let r=t.getModifier("soak");r&&e.addUniquePart("SR5.Bonus",r),t._addArmorParts(e)}static applyArmorPenetration(e,t,a){var o;let r=(o=t[a.element.value])!=null?o:0,i=t.value+r,s=w.calcTotal(a.ap);e.addUniquePart("SR5.AP",Math.max(s,-i))}static applyElementalArmor(e,t,a){var i;let r=(i=t[a])!=null?i:0;r&&e.addUniquePart(q.elementTypes[a],r)}static applyMatrixSoakParts(e,t){let a=t.data.data;a.initiative.perception==="matrix"?t.isVehicle()?yt.applyRatingAndFirewallParts(a,e):yt.applyBiofeedbackParts(e,t,a):yt.applyRatingAndFirewallParts(a,e)}static applyBiofeedbackParts(e,t,a){yt.addUniquePart(e,t.getAttribute("willpower"),q.attributes.willpower),a.matrix&&yt.addUniquePart(e,a.matrix.firewall,q.matrixAttributes.firewall)}static applyRatingAndFirewallParts(e,t){if(!e.matrix)return;let a=e.matrix.rating;a&&t.addUniquePart("SR5.Labels.ActorSheet.DeviceRating",a),this.addUniquePart(t,e.matrix.firewall,q.matrixAttributes.firewall)}static addUniquePart(e,t,a){let r=w.calcTotal(t);e.addUniquePart(a,r)}static reduceDamage(e,t,a){return t.type.value==="stun"&&e.isVehicle()?w.reduceDamageByHits(t,t.value,"SR5.VehicleStunImmunity"):w.reduceDamageByHits(t,a,"SR5.SoakTest")}static modifyDamageType(e,t){let a=duplicate(e);t.isVehicle()&&a.element.value==="electricity"&&a.type.value==="stun"&&(a.type.value="physical");let r=w.findDamageSource(e);return r&&r.isDirectCombatSpell()?a:(a=yt.modifyPhysicalDamageForArmor(a,t),yt.modifyMatrixDamageForBiofeedback(a,t))}static modifyPhysicalDamageForArmor(e,t){let a=duplicate(e);if(e.type.value==="physical"){if(!t.isCharacter()&&!t.isSpirit()&&!t.isCritter()&&!t.isVehicle())return a;let r=t.getModifiedArmor(e);r&&r.value>e.value&&(a.type.value="stun")}return a}static modifyMatrixDamageForBiofeedback(e,t){let a=duplicate(e);if(e.type.value==="matrix"){let r=t.data.data;if(!t.isCharacter())return a;r.initiative.perception==="matrix"&&(r.matrix.hot_sim?a.type.value="physical":a.type.value="stun")}return a}};var wt=class{static iniOrderCanDoAnotherPass(e){for(let t of e)if(wt.iniScoreCanDoAnotherPass(t))return!0;return!1}static iniScoreCanDoAnotherPass(e){return wt.reduceIniResultAfterPass(e)>0}static reduceIniResultAfterPass(e){return Math.max(e+K.combat.INI_RESULT_MOD_AFTER_INI_PASS,0)}static reduceIniOnLateSpawn(e,t){t=Math.max(t-1,0),e=Math.max(e,0);let a=e+t*K.combat.INI_RESULT_MOD_AFTER_INI_PASS;return Math.max(a,0)}static attackHits(e,t){return e>t}static attackGrazes(e,t){return e===t}static attackMisses(e,t){return!wt.attackHits(e,t)}static modifyDamageAfterHit(e,t,a){let r=foundry.utils.duplicate(a);return e<0&&(e=0),t<0&&(t=0),O.AddUniquePart(r.mod,"SR5.Attacker",e),O.AddUniquePart(r.mod,"SR5.Defender",-t),r.value=w.calcTotal(r,{min:0}),r}static modifyDamageAfterMiss(e){let t=foundry.utils.duplicate(e);return t.override={name:"SR5.Success",value:0},w.calcTotal(t,{min:0}),t}static modifyDamageAfterResist(e,t,a){a<0&&(a=0);let{modified:r}=yt.reduceDamage(e,t,a);return r=yt.modifyDamageType(r,e),w.calcTotal(r,{min:0}),r}static modifyArmorAfterHit(e,t){let a=foundry.utils.duplicate(e);return t.ap.value<=0||(console.error("Check if ap is a negative value or positive value during weapon item configuration"),O.AddUniquePart(a.mod,"SR5.AP",t.ap.value),a.value=w.calcTotal(a,{min:0})),a}};var ft=class extends Combat{get settings(){return super.settings}get initiativePass(){return this.getFlag(V,j.CombatInitiativePass)||K.combat.INITIAL_INI_PASS}static setInitiativePass(e,t){return u(this,null,function*(){yield e.unsetFlag(V,j.CombatInitiativePass),yield e.setFlag(V,j.CombatInitiativePass,t)})}getActorCombatant(e){let t=e.getToken();if(!!t)return this.getCombatantByToken(t.id)}static addCombatTrackerContextOptions(e,t){return t.push({name:game.i18n.localize("SR5.COMBAT.ReduceInitByOne"),icon:'<i class="fas fa-caret-down"></i>',callback:a=>u(this,null,function*(){var i;let r=yield(i=game.combat)==null?void 0:i.combatants.get(a.data("combatant-id"));r&&(yield game.combat.adjustInitiative(r,-1))})},{name:game.i18n.localize("SR5.COMBAT.ReduceInitByFive"),icon:'<i class="fas fa-angle-down"></i>',callback:a=>u(this,null,function*(){var i;let r=yield(i=game.combat)==null?void 0:i.combatants.get(a.data("combatant-id"));r&&(yield game.combat.adjustInitiative(r,-5))})},{name:game.i18n.localize("SR5.COMBAT.ReduceInitByTen"),icon:'<i class="fas fa-angle-double-down"></i>',callback:a=>u(this,null,function*(){var i;let r=yield(i=game.combat)==null?void 0:i.combatants.get(a.data("combatant-id"));r&&(yield game.combat.adjustInitiative(r,-10))})}),t}adjustInitiative(e,t){return u(this,null,function*(){if(e=typeof e=="string"?this.combatants.find(a=>a.id===e):e,!e||typeof e=="string"){console.error("Could not find combatant with id ",e);return}yield e.update({initiative:Number(e.initiative)+t})})}static handleIniPass(e){return u(this,null,function*(){var i;let t=(i=game.combats)==null?void 0:i.get(e);if(!t)return;let a=t.initiativePass+1,r=0;for(let s of t.combatants){let o=wt.reduceIniResultAfterPass(Number(s.initiative));yield s.update({initiative:o})}yield ft.setInitiativePass(t,a),yield t.update({turn:r})})}static handleNextRound(e){return u(this,null,function*(){var r;let t=(r=game.combats)==null?void 0:r.get(e);if(!t)return;yield t.resetAll(),yield ft.setInitiativePass(t,K.combat.INITIAL_INI_PASS),game.settings.get(V,j.OnlyAutoRollNPCInCombat)?yield t.rollNPC():yield t.rollAll();let a=0;yield t.update({turn:a})})}setupTurns(){return super.setupTurns().sort(ft.sortByRERIC)}static sortByRERIC(e,t){let a=Number(e.initiative),r=Number(t.initiative);if(isNaN(a))return 1;if(isNaN(r)||a>r)return-1;if(a<r)return 1;let i=l=>{var c,d;return l?[Number(l.getEdge().value),Number((c=l.findAttribute("reaction"))==null?void 0:c.value),Number((d=l.findAttribute("intuition"))==null?void 0:d.value),new Roll("1d2").evaluate({async:!1}).total]:[0,0,0,0]},s=i(e.actor),o=i(t.actor);for(let l=0;l<s.length;l++){let c=o[l]-s[l];if(c!==0)return c}return 0}get nextUndefeatedTurnPosition(){for(let[e,t]of this.turns.entries())if(!(this.turn!==null&&e<=this.turn)&&!t.defeated&&t.initiative>0)return e;return this.turns.length}get nextViableTurnPosition(){for(let[e,t]of this.turns.entries())if(!(this.turn!==null&&e<=this.turn)&&t.initiative>0)return e;return this.turns.length}doIniPass(e){if(e<this.turns.length)return!1;let t=this.combatants.map(a=>Number(a.initiative));return wt.iniOrderCanDoAnotherPass(t)}nextTurn(){return u(this,null,function*(){var r,i,s;let e=this.round,t=this.initiativePass,a=(r=this.settings)!=null&&r.skipDefeated?this.nextUndefeatedTurnPosition:this.nextViableTurnPosition;if(e===0&&t===0){yield this.startCombat();return}if(a<this.turns.length){yield this.update({turn:a});return}if(!((i=game.user)!=null&&i.isGM)&&this.doIniPass(a)){yield this._createDoIniPassSocketMessage();return}if(((s=game.user)==null?void 0:s.isGM)&&this.doIniPass(a)){yield ft.handleIniPass(this.id);return}return this.nextRound()})}startCombat(){return u(this,null,function*(){let e=K.combat.INITIAL_INI_ROUND,t=K.combat.INITIAL_INI_PASS,a=0;return yield ft.setInitiativePass(this,t),yield this.update({round:e,turn:a}),game.settings.get(V,j.OnlyAutoRollNPCInCombat)?yield this.rollNPC():yield this.rollAll(),this})}nextRound(){return u(this,null,function*(){var e;yield Y(ft.prototype,this,"nextRound").call(this),(e=game.user)!=null&&e.isGM?yield ft.handleNextRound(this.id):yield this._createDoNextRoundSocketMessage()})}rollAll(e){return u(this,null,function*(){let t=yield Y(ft.prototype,this,"rollAll").call(this);return t.turn!==0&&(yield t.update({turn:0})),t})}rollInitiative(e,t){return u(this,null,function*(){let a=yield Y(ft.prototype,this,"rollInitiative").call(this,e,t);return this.initiativePass===K.combat.INITIAL_INI_PASS&&(yield a.update({turn:0})),a})}_getInitiativeFormula(e){return this.initiativePass===K.combat.INITIAL_INI_PASS?super._getInitiativeFormula(e):ft._getSystemInitiativeFormula(this.initiativePass)}static _getSystemInitiativeBaseFormula(){return String(CONFIG.Combat.initiative.formula||game.system.data.initiative)}static _getSystemInitiativeFormula(e){e=e>1?e:1;let t=ft._getSystemInitiativeBaseFormula(),a=(e-1)*-K.combat.INI_RESULT_MOD_AFTER_INI_PASS;return`max(${t} - ${a}[Pass], 0)`}static _handleDoNextRoundSocketMessage(e){return u(this,null,function*(){if(!e.data.hasOwnProperty("id")&&typeof e.data.id!="string"){console.error(`SR5Combat Socket Message ${j.DoNextRound} data.id must be a string (combat id) but is ${typeof e.data} (${e.data})!`);return}return yield ft.handleNextRound(e.data.id)})}static _handleDoInitPassSocketMessage(e){return u(this,null,function*(){if(!e.data.hasOwnProperty("id")&&typeof e.data.id!="string"){console.error(`SR5Combat Socket Message ${j.DoInitPass} data.id must be a string (combat id) but is ${typeof e.data} (${e.data})!`);return}return yield ft.handleIniPass(e.data.id)})}_createDoNextRoundSocketMessage(){return u(this,null,function*(){yield se.emitForGM(j.DoNextRound,{id:this.id})})}_createDoIniPassSocketMessage(){return u(this,null,function*(){yield se.emitForGM(j.DoInitPass,{id:this.id})})}};function kn(){let n=this.parent;return ft._getSystemInitiativeFormula(n.initiativePass)}var rt=class{};rt.MAP_CATEGORY_TO_SKILL={"Assault Cannons":"heavy_weapons","Assault Rifles":"automatics",Blades:"blades",Bows:"archery",Carbines:"automatics",Clubs:"clubs",Crossbows:"archery","Exotic Melee Weapons":"exotic_melee","Exotic Ranged Weapons":"exotic_ranged",Flamethrowers:"exotic_ranged","Grenade Launchers":"heavy_weapons","Heavy Machine Guns":"heavy_weapons","Heavy Pistols":"pistols",Holdouts:"pistols","Laser Weapons":"exotic_ranged","Light Machine Guns":"heavy_weapons","Light Pistols":"pistols","Machine Pistols":"automatics","Medium Machine Guns":"automatics","Missile Launchers":"heavy_weapons",Shotguns:"longarms","Sniper Rifles":"longarms","Sporting Rifles":"longarms","Submachine Guns":"automatics",Tasers:"pistols",Unarmed:"unarmed_combat"},rt.WEAPON_RANGES={Tasers:{short:5,medium:10,long:15,extreme:20},Holdouts:{short:5,medium:15,long:30,extreme:50},"Light Pistols":{short:5,medium:15,long:30,extreme:50},"Heavy Pistols":{short:5,medium:20,long:40,extreme:60},"Machine Pistols":{short:5,medium:15,long:30,extreme:50},"Submachine Guns":{short:10,medium:40,long:80,extreme:150},"Assault Rifles":{short:25,medium:150,long:350,extreme:550},Shotguns:{short:10,medium:40,long:80,extreme:150},"Shotguns (slug)":{short:10,medium:40,long:80,extreme:150},"Shotguns (flechette)":{short:15,medium:30,long:45,extreme:60},"Sniper Rifles":{short:50,medium:350,long:800,extreme:1500},"Sporting Rifles":{short:50,medium:250,long:500,extreme:750},"Light Machine Guns":{short:25,medium:200,long:400,extreme:800},"Medium/Heavy Machinegun":{short:40,medium:250,long:750,extreme:1200},"Assault Cannons":{short:50,medium:300,long:750,extreme:1500},"Grenade Launchers":{min:5,short:50,medium:100,long:150,extreme:500},"Missile Launchers":{min:20,short:70,medium:150,long:450,extreme:1500},Bows:{short:1,medium:10,long:30,extreme:60,attribute:"strength"},"Light Crossbows":{short:6,medium:24,long:60,extreme:120},"Medium Crossbows":{short:9,medium:36,long:90,extreme:150},"Heavy Crossbows":{short:15,medium:45,long:120,extreme:180},"Thrown Knife":{short:1,medium:2,long:3,extreme:5,attribute:"strength"},Net:{short:.5,medium:1,long:1.5,extreme:2.5,attribute:"strength"},Shuriken:{short:1,medium:2,long:5,extreme:7,attribute:"strength"},"Standard Grenade":{short:2,medium:4,long:6,extreme:10,attribute:"strength"},"Aerodynamic Grenade":{min:0,short:2,medium:4,long:8,extreme:15,attribute:"strength"},"Harpoon Gun":{short:5,medium:20,long:40,extreme:60},"Harpoon Gun (Underwater)":{short:6,medium:24,long:60,extreme:120},Flamethrowers:{short:15,medium:20,long:-1,extreme:-1}},rt.ROOT_IMPORT_FOLDER_NAME="SR5e";var na=class{};var Aa=class extends na{intValue(e,t,a=void 0){try{return parseInt(e[t][I.CHAR_KEY])}catch(r){if(a!==void 0)return a;throw r}}stringValue(e,t,a=void 0){try{return e[t][I.CHAR_KEY]}catch(r){if(a!==void 0)return a;throw r}}objectValue(e,t,a=void 0){try{return e[t]}catch(r){if(a!==void 0)return a;throw r}}};var er=class extends na{intValue(e,t,a=void 0){throw new Error("Unimplemented")}stringValue(e,t,a=void 0){throw new Error("Unimplemented")}objectValue(e,t,a=void 0){throw new Error("Unimplemented")}};var Et=class{static SetMode(e){switch(e){case 1:Et.s_Strategy=new Aa;break;case 2:Et.s_Strategy=new er;break}}constructor(){}static NewFolder(e,t=null){return u(this,null,function*(){return yield Folder.create({type:"Item",parent:t===null?null:t.id,name:e})})}static GetFolderAtPath(e,t=!1){return u(this,null,function*(){var s;let a,r,i=e.split("/");for(let o of i){if(a=(s=game.folders)==null?void 0:s.find(l=>l.parentFolder===r&&l.name===o),!a&&!t)return Promise.reject(`Unable to find folder: ${e}`);a||(a=yield Et.NewFolder(o,r)),r=a}return Promise.resolve(a)})}static IntValue(e,t,a=void 0){return Et.s_Strategy.intValue(e,t,a)}static StringValue(e,t,a=void 0){return Et.s_Strategy.stringValue(e,t,a)}static ObjectValue(e,t,a=void 0){return Et.s_Strategy.objectValue(e,t,a)}static findItem(e){var a,r;let t;return typeof e=="string"?t=(a=game.items)==null?void 0:a.find(i=>i.name==e):t=(r=game.items)==null?void 0:r.find(e),t}static TranslateCategory(e,t){return t&&t.hasOwnProperty(e)?t[e]:e}static MakeCategoryFolders(e,t,a){return u(this,null,function*(){let r={},i=e.categories.category;for(let s=0;s<i.length;s++){let o=i[s][Et.CHAR_KEY],l=o;o=Et.TranslateCategory(o,a),r[l.toLowerCase()]=yield Et.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/${t}/${o}`,!0)}return r})}static ExtractDataFileTranslation(e,t){for(let a=0;a<e.length;a++){let r=e[a];if(r.$.file===t)return r}return{}}static ExtractCategoriesTranslation(e){let t={};return e&&e.hasOwnProperty("categories")&&e.categories.category.forEach(a=>{let r=a[Et.CHAR_KEY],i=a.$.translate;t[r]=i}),t}static ExtractItemTranslation(e,t,a){let r={};return e&&e[t]&&e[t][a]&&e[t][a].length>0&&e[t][a].forEach(i=>{let s=i.name[Et.CHAR_KEY],o=i.translate[Et.CHAR_KEY],l=i.altpage[Et.CHAR_KEY];r[s]={translate:o,altpage:l}}),r}static MapNameToTranslationKey(e,t,a,r=""){return e&&e.hasOwnProperty(t)&&e[t].hasOwnProperty(a)?e[t][a]:r}static MapNameToTranslation(e,t){return Et.MapNameToTranslationKey(e,t,"translate",t)}static MapNameToPageSource(e,t,a="?"){return Et.MapNameToTranslationKey(e,t,"altpage",a)}},I=Et;I.CHAR_KEY="_TEXT",I.s_Strategy=new Aa;var pc=Uo(),Ca=class{static CanParseI18n(e){return e.hasOwnProperty("chummer")&&e.chummer.length>0&&e.chummer[0].$.hasOwnProperty("file")}static ParseTranslation(e){e&&e.hasOwnProperty("chummer")&&(Ca.jsoni18n=e.chummer)}static xml2json(e){return u(this,null,function*(){return(yield pc.Parser({explicitArray:!1,explicitCharkey:!0,charkey:I.CHAR_KEY}).parseStringPromise(e)).chummer})}static unsupportedBookSource(e){if(!e.hasOwnProperty("source"))return!1;let t=I.StringValue(e,"source","");return Ca.unsupportedBooks.includes(t)}static unsupportedEntry(e){return!!Ca.unsupportedBookSource(e)}},G=Ca;G.unsupportedBooks=["2050"];var da=class{};var Kt=class extends da{Parse(e,t,a){if(t.name=I.StringValue(e,"name"),t.data.description.source=`${I.StringValue(e,"source")} ${I.StringValue(e,"page")}`,a){let r=I.StringValue(e,"name");t.name=I.MapNameToTranslation(a,r),t.data.description.source=`${I.StringValue(e,"source")} ${I.MapNameToPageSource(a,r)}`}return t}};var de=class extends Kt{Parse(e,t,a){return t=super.Parse(e,t,a),t.data.technology.availability=I.StringValue(e,"avail","0"),t.data.technology.cost=I.IntValue(e,"cost",0),t.data.technology.rating=I.IntValue(e,"rating",0),t}};var Yt=class extends de{GetSkill(e){if(e.hasOwnProperty("useskill")){let t=I.StringValue(e,"useskill");return rt.MAP_CATEGORY_TO_SKILL.hasOwnProperty(t)?rt.MAP_CATEGORY_TO_SKILL[t]:t.replace(/[\s\-]/g,"_").toLowerCase()}else{let t=I.StringValue(e,"category");return rt.MAP_CATEGORY_TO_SKILL.hasOwnProperty(t)?rt.MAP_CATEGORY_TO_SKILL[t]:I.StringValue(e,"type").toLowerCase()==="ranged"?"exotic_range":"exotic_melee"}}static GetWeaponType(e){return I.StringValue(e,"type")==="Melee"?"melee":e.hasOwnProperty("useskill")&&I.StringValue(e,"useskill")==="Throwing Weapons"||I.StringValue(e,"category")==="Throwing Weapons"?"thrown":"range"}Parse(e,t,a){t=super.Parse(e,t,a);let r=I.StringValue(e,"category");return r==="Hold-outs"&&(r="Holdouts"),t.data.category=Yt.GetWeaponType(e),t.data.subcategory=r.toLowerCase(),t.data.action.skill=this.GetSkill(e),t.data.action.damage=this.GetDamage(e),t.data.action.limit.value=I.IntValue(e,"accuracy"),t.data.action.limit.base=I.IntValue(e,"accuracy"),t.data.technology.conceal.base=I.IntValue(e,"conceal"),t}};var Ir=class extends Yt{GetDamage(e){var l;let a=(l=I.StringValue(e,"damage").match(/[0-9]+[PS]/g))==null?void 0:l[0];if(a==null)return P.damageData();let r=a.includes("P")?"physical":"stun",i=parseInt(a.replace(r[0].toUpperCase(),"")),s=I.IntValue(e,"ap",0),o={type:{base:r,value:r},base:i,value:i,ap:{base:s,value:s,mod:[]}};return P.damageData(o)}GetAmmo(e){var r;let a=(r=I.StringValue(e,"ammo").match(/([0-9]+)/g))==null?void 0:r[0];return a!==void 0?parseInt(a):0}Parse(e,t,a){return t=super.Parse(e,t,a),t.data.range.rc.base=I.IntValue(e,"rc"),t.data.range.rc.value=I.IntValue(e,"rc"),e.hasOwnProperty("range")?t.data.range.ranges=rt.WEAPON_RANGES[I.StringValue(e,"range")]:t.data.range.ranges=rt.WEAPON_RANGES[I.StringValue(e,"category")],t.data.ammo.current.value=this.GetAmmo(e),t.data.ammo.current.max=this.GetAmmo(e),t.data.range.modes.single_shot=I.StringValue(e,"mode").includes("SS"),t.data.range.modes.semi_auto=I.StringValue(e,"mode").includes("SA"),t.data.range.modes.burst_fire=I.StringValue(e,"mode").includes("BF"),t.data.range.modes.full_auto=I.StringValue(e,"mode").includes("FA"),t}};var Ar=class extends Yt{GetDamage(e){var p;let a=(p=I.StringValue(e,"damage").match(/(STR)([+-]?)([1-9]*)\)([PS])/g))==null?void 0:p[0];if(a==null)return P.damageData();let r=0,i=I.IntValue(e,"ap",0),s=a.split(")"),o=s[1].includes("P")?"physical":"stun",l=a.includes("+")?s[0].split("+"):s[0].split("-");(s[0].includes("+")||s[0].includes("-"))&&(r=parseInt(l[1],0));let c=a.includes("STR")?"strength":"",d={type:{base:o,value:o},base:r,value:r,ap:{base:i,value:i,mod:[]},attribute:c};return P.damageData(d)}Parse(e,t,a){return t=super.Parse(e,t,a),t.data.melee.reach=I.IntValue(e,"reach"),t}};var kr=class extends Yt{GetDamage(e){var l,c,d,p;let t=I.StringValue(e,"damage"),a=0,r="physical",i="";if(t.includes("STR")){i="strength";let g=(l=t.match(/((STR)([+-])[0-9]\)[PS])/g))==null?void 0:l[0];if(g!==void 0){let y=(c=g.match(/-?[0-9]+/g))==null?void 0:c[0];a=y!==void 0?parseInt(y):0}}else{let g=(d=t.match(/([0-9]+[PS])/g))==null?void 0:d[0];if(g!==void 0){let y=(p=g.match(/[0-9]+/g))==null?void 0:p[0];y!==void 0&&(a=parseInt(y))}else{let y={type:{base:"physical",value:"physical"}};return P.damageData(y)}}r=t.includes("P")?"physical":"stun";let s=I.IntValue(e,"ap",0),o={type:{base:r,value:r},base:a,value:a,ap:{base:s,value:s,mod:[]},attribute:i};return P.damageData(o)}GetBlast(e,t){var o,l,c,d;let a={radius:0,dropoff:0},r=I.StringValue(e,"damage"),i=(o=r.match(/([0-9]+m)/))==null?void 0:o[0];i!==void 0&&(i=(l=i.match(/[0-9]+/))==null?void 0:l[0],i!==void 0&&(a.radius=parseInt(i)));let s=(c=r.match(/(-[0-9]+\/m)/))==null?void 0:c[0];return s!==void 0&&(s=(d=s.match(/-[0-9]+/))==null?void 0:d[0],s!==void 0&&(a.dropoff=parseInt(s))),a.dropoff&&!a.radius&&(a.radius=-(t.data.action.damage.base/a.dropoff)),a}Parse(e,t,a){return t=super.Parse(e,t,a),e.hasOwnProperty("range")?t.data.thrown.ranges=rt.WEAPON_RANGES[I.StringValue(e,"range")]:t.data.thrown.ranges=rt.WEAPON_RANGES[I.StringValue(e,"category")],t.data.thrown.blast=this.GetBlast(e,t),t}};var ma=class extends da{constructor(t,a){super();this.m_BranchKey=t,this.m_Map=new Map;for(let{key:r,value:i}of a)this.m_Map.set(r,i)}Parse(t,a,r){let i;typeof this.m_BranchKey=="function"?i=this.m_BranchKey(t):(i=this.m_BranchKey,i=I.StringValue(t,i));let s=this.m_Map.get(i);return s===void 0?(console.warn(`Could not find mapped parser for category ${i}.`),a):s.Parse(t,a,r)}};var Rr=class extends G{constructor(){super(...arguments);this.files=["weapons.xml"]}CanParse(t){return t.hasOwnProperty("weapons")&&t.weapons.hasOwnProperty("weapon")}GetDefaultData(){return{name:"Unnamed Item",type:"weapon",data:{description:{value:"",chat:"",source:""},action:P.actionData({type:"varies",attribute:"agility"}),technology:P.technologyData({rating:1}),ammo:{spare_clips:{value:0,max:0},current:{value:0,max:0}},range:{category:"",ranges:{short:0,medium:0,long:0,extreme:0},rc:{value:0,base:0,mod:[]},modes:{single_shot:!1,semi_auto:!1,burst_fire:!1,full_auto:!1}},melee:{reach:0},thrown:{ranges:{short:0,medium:0,long:0,extreme:0,attribute:""},blast:{radius:0,dropoff:0}},category:"range",subcategory:""}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(t),this.itemTranslations=I.ExtractItemTranslation(t,"weapons","weapon")}Parse(t){return u(this,null,function*(){let a=yield I.MakeCategoryFolders(t,"Weapons",this.categoryTranslations);a.gear=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/Weapons/Gear`,!0),a.quality=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/Weapons/Quality`,!0);let r=new ma(Yt.GetWeaponType,[{key:"range",value:new Ir},{key:"melee",value:new Ar},{key:"thrown",value:new kr}]),i=[],s=t.weapons.weapon;for(let o=0;o<s.length;o++){let l=s[o];if(G.unsupportedEntry(l))continue;let c=r.Parse(l,this.GetDefaultData(),this.itemTranslations);c.folder=a[c.data.subcategory].id,i.push(c)}return yield Item.create(i)})}};var xr=class extends de{Parse(e,t){return t=super.Parse(e,t),t.data.armor.value=I.IntValue(e,"armor",0),t.data.armor.mod=I.StringValue(e,"armor").includes("+"),t}};var Mr=class extends G{constructor(){super(...arguments);this.files=["armor.xml"]}CanParse(t){return t.hasOwnProperty("armors")&&t.armors.hasOwnProperty("armor")}GetDefaultData(){return{name:"Unnamed Armor",type:"armor",data:{description:{value:"",chat:"",source:""},technology:P.technologyData({rating:1,equipped:!0,wireless:!1}),armor:{value:0,mod:!1,acid:0,cold:0,fire:0,electricity:0,radiation:0}}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(t),this.armorTranslations=I.ExtractItemTranslation(t,"armors","armor")}Parse(t){return u(this,null,function*(){let a=yield I.MakeCategoryFolders(t,"Armor",this.categoryTranslations),r=new xr,i=[],s=t.armors.armor;for(let o=0;o<s.length;o++){let l=s[o];if(G.unsupportedEntry(l))continue;let c=r.Parse(l,this.GetDefaultData()),d=I.StringValue(l,"category").toLowerCase();c.name=I.MapNameToTranslation(this.armorTranslations,c.name),c.folder=a[d].id,i.push(c)}return yield Item.create(i)})}};var Er=class extends G{constructor(){super(...arguments);this.files=["gear.xml"]}CanParse(t){return t.hasOwnProperty("gears")&&t.gears.hasOwnProperty("gear")}GetDefaultData(){return{name:"",type:"ammo",data:{description:{value:"",chat:"",source:""},technology:P.technologyData({rating:1,equipped:!0,wireless:!1}),element:"",ap:0,damage:0,damageType:"physical",blast:{radius:0,dropoff:0}}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(t),this.entryTranslations=I.ExtractItemTranslation(t,"gears","gear")}Parse(t){return u(this,null,function*(){let a=[],r=t.gears.gear;for(let i=0;i<r.length;i++){let s=r[i];if(G.unsupportedEntry(s)||I.StringValue(s,"category","")!=="Ammunition")continue;let o=this.GetDefaultData();o.name=I.StringValue(s,"name"),o.name=I.MapNameToTranslation(this.entryTranslations,o.name),o.data.description.source=`${I.StringValue(s,"source")} ${I.StringValue(s,"page")}`,o.data.technology.rating=2,o.data.technology.availability=I.StringValue(s,"avail"),o.data.technology.cost=I.IntValue(s,"cost",0);let l=I.ObjectValue(s,"weaponbonus",null);if(l!=null){o.data.ap=I.IntValue(l,"ap",0),o.data.damage=I.IntValue(l,"damage",0);let p=I.StringValue(l,"damagetype","");p.length>0&&(p.includes("P")?o.data.damageType="physical":p.includes("S")?o.data.damageType="stun":p.includes("M")&&(o.data.damageType="matrix"))}let c=!1,d=o.name.toLowerCase();if(["grenade","rocket","missile"].forEach(p=>{c=c||d.includes(p)}),c){let p=I.findItem(g=>!g||!g.name?!1:g.type==="weapon"&&g.name.toLowerCase()===d);if(p!=null&&"action"in p.data.data){let g=p.data.data;o.data.damage=g.action.damage.value,o.data.ap=g.action.damage.ap.value}}o.data.technology.conceal.base=0,a.push(o)}for(let i=0;i<a.length;i++){let s="Misc",o=a[i],l=o.name.split(":");l.length>1&&(s=l[0].trim());let c=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/Ammo/${s}`,!0);o.folder=c.id}return yield Item.create(a)})}};var Cr=class extends de{Parse(e,t){return t=super.Parse(e,t),t.data.type="weapon",t.data.mount_point=I.StringValue(e,"mount"),t.data.rc=I.IntValue(e,"rc",0),t.data.accuracy=I.IntValue(e,"accuracy",0),t.data.technology.conceal.base=I.IntValue(e,"conceal",0),t}};var _r=class extends G{constructor(){super(...arguments);this.files=["weapons.xml"]}CanParse(t){return t.hasOwnProperty("accessories")&&t.accessories.hasOwnProperty("accessory")}GetDefaultData(){return{name:"",type:"modification",data:{description:{value:"",chat:"",source:""},technology:P.technologyData({rating:1,equipped:!0}),type:"",mount_point:"",dice_pool:0,accuracy:0,rc:0}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.accessoryTranslations=I.ExtractItemTranslation(t,"accessories","accessory")}Parse(t){return u(this,null,function*(){let a=new Cr,r=[],i=t.accessories.accessory;for(let s=0;s<i.length;s++){let o=i[s];if(G.unsupportedEntry(o))continue;let l=a.Parse(o,this.GetDefaultData());l.name=I.MapNameToTranslation(this.accessoryTranslations,l.name);let c=l.data.mount_point!==void 0?l.data.mount_point:"Other";c.includes("/")&&(c=c.split("/")[0]);let d=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/Mods/${c}`,!0);l.folder=d.id,r.push(l)}return yield Item.create(r)})}};var Ut=class extends Kt{Parse(e,t,a){t.name=I.StringValue(e,"name"),t.data.description.source=`${I.StringValue(e,"source")} ${I.StringValue(e,"page")}`,t.data.category=I.StringValue(e,"category").toLowerCase();let r=I.StringValue(e,"damage");r==="P"?(t.data.action.damage.type.base="physical",t.data.action.damage.type.value="physical"):r==="S"&&(t.data.action.damage.type.base="stun",t.data.action.damage.type.value="stun");let i=I.StringValue(e,"duration");i==="I"?t.data.duration="instant":i==="S"?t.data.duration="sustained":i==="P"&&(t.data.duration="permanent");let s=I.StringValue(e,"dv");(s.includes("+")||s.includes("-"))&&(t.data.drain=parseInt(s.substring(1,s.length)));let o=I.StringValue(e,"range");o==="T"?t.data.range="touch":o==="LOS"?t.data.range="los":o==="LOS (A)"&&(t.data.range="los_a");let l=I.StringValue(e,"type");if(l==="P"?t.data.type="physical":l==="M"&&(t.data.type="mana"),a){let c=I.StringValue(e,"name");t.name=I.MapNameToTranslation(a,c),t.data.description.source=`${I.StringValue(e,"source")} ${I.MapNameToPageSource(a,c)}`}return t}};var Pr=class extends Ut{Parse(e,t,a){t=super.Parse(e,t,a);let r=I.StringValue(e,"descriptor");return r===void 0&&(r=""),t.data.combat.type=r.includes("Indirect")?"indirect":"direct",t.data.action.opposed.type="defense",t}};var Or=class extends Ut{Parse(e,t,a){t=super.Parse(e,t,a);let r=I.StringValue(e,"descriptor");return r===void 0&&(r=""),t.data.manipulation.environmental=r.includes("Environmental"),t.data.manipulation.mental=r.includes("Mental"),t.data.manipulation.mental&&(t.data.action.opposed.type="custom",t.data.action.opposed.attribute="logic",t.data.action.opposed.attribute2="willpower"),t.data.manipulation.physical=r.includes("Physical"),t.data.manipulation.physical&&(t.data.action.opposed.type="custom",t.data.action.opposed.attribute="body",t.data.action.opposed.attribute2="strength"),t.data.manipulation.damaging=r.includes("Damaging"),t.data.manipulation.damaging&&(t.data.action.opposed.type="soak"),t}};var Lr=class extends Ut{Parse(e,t,a){t=super.Parse(e,t,a);let r=I.StringValue(e,"descriptor");return r===void 0&&(r=""),t.data.type==="mana"?(t.data.action.opposed.type="custom",t.data.action.opposed.attribute="logic",t.data.action.opposed.attribute2="willpower"):t.data.type==="physical"&&(t.data.action.opposed.type="custom",t.data.action.opposed.attribute="intuition",t.data.action.opposed.attribute2="logic"),t}};var Fr=class extends Ut{Parse(e,t,a){t=super.Parse(e,t,a);let r=I.StringValue(e,"descriptor");return r===void 0&&(r=""),t.data.detection.passive=r.includes("Passive"),t.data.detection.passive||(t.data.action.opposed.type="custom",t.data.action.opposed.attribute="willpower",t.data.action.opposed.attribute2="logic"),t.data.detection.extended=r.includes("Extended"),r.includes("Psychic")?t.data.detection.type="psychic":r.includes("Directional")?t.data.detection.type="directional":r.includes("Area")&&(t.data.detection.type="area"),t}};var Nr=class extends G{constructor(){super(...arguments);this.files=["spells.xml"]}CanParse(t){return t.hasOwnProperty("spells")&&t.spells.hasOwnProperty("spell")}GetDefaultData(){return{name:"Unnamed Item",type:"spell",data:{description:{value:"",chat:"",source:""},action:P.actionData({type:"varies",attribute:"magic",skill:"spellcasting",damage:P.damageData({type:{base:"",value:""}})}),drain:0,category:"",type:"",range:"",duration:"",extended:!1,combat:{type:""},detection:{passive:!1,type:"",extended:!1},illusion:{type:"",sense:""},manipulation:{damaging:!1,mental:!1,environmental:!1,physical:!1}}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(t),this.itemTranslations=I.ExtractItemTranslation(t,"spells","spell")}Parse(t){return u(this,null,function*(){let a=yield I.MakeCategoryFolders(t,"Spells",this.categoryTranslations),r=new ma("category",[{key:"Combat",value:new Pr},{key:"Manipulation",value:new Or},{key:"Illusion",value:new Lr},{key:"Detection",value:new Fr},{key:"Health",value:new Ut},{key:"Enchantments",value:new Ut},{key:"Rituals",value:new Ut}]),i=[],s=t.spells.spell;for(let o=0;o<s.length;o++){let l=s[o];if(G.unsupportedEntry(l))continue;let c=r.Parse(l,this.GetDefaultData(),this.itemTranslations);c.folder=a[c.data.category].id,i.push(c)}return yield Item.create(i)})}};var qr=class extends Kt{Parse(e,t,a){if(t.name=I.StringValue(e,"name"),t.data.description.source=`${I.StringValue(e,"source")} ${I.StringValue(e,"page")}`,t.data.type=I.StringValue(e,"category")==="Positive"?"positive":"negative",a){let r=I.StringValue(e,"name");t.name=I.MapNameToTranslation(a,r),t.data.description.source=`${I.StringValue(e,"source")} ${I.MapNameToPageSource(a,r)}`}return t}};var Br=class extends G{constructor(){super(...arguments);this.files=["qualities.xml"]}CanParse(t){return t.hasOwnProperty("qualities")&&t.qualities.hasOwnProperty("quality")}GetDefaultData(){return{name:"Unnamed Quality",type:"quality",data:{description:{value:"",chat:"",source:""},action:P.actionData({damage:P.damageData({type:{base:"",value:""}})}),type:""}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(t),this.itemTranslations=I.ExtractItemTranslation(t,"qualities","quality")}Parse(t){return u(this,null,function*(){let a={},r=yield I.MakeCategoryFolders(t,"Qualities",this.categoryTranslations),i=new qr,s=[],o=t.qualities.quality;for(let l=0;l<o.length;l++){let c=o[l];if(G.unsupportedEntry(c))continue;let d=i.Parse(c,this.GetDefaultData(),this.itemTranslations),p=I.StringValue(c,"category");d.folder=r[p.toLowerCase()].id,d.name=I.MapNameToTranslation(this.itemTranslations,d.name),s.push(d)}return yield Item.create(s)})}};var Vr=class extends Kt{Parse(e,t,a){t.name=I.StringValue(e,"name"),t.data.description.source=`${I.StringValue(e,"source")} ${I.StringValue(e,"page")}`;let r=I.StringValue(e,"fv");(r.includes("+")||r.includes("-"))&&(t.data.fade=parseInt(r.substring(1,r.length)));let i=I.StringValue(e,"duration");i==="I"?t.data.duration="instant":i==="S"?t.data.duration="sustained":i==="P"&&(t.data.duration="permanent");let s=I.StringValue(e,"target");switch(s){case"Device":case"File":case"Host":case"Persona":case"Self":case"Sprite":t.data.target=s.toLowerCase();break;default:t.data.target="other";break}if(a){let o=I.StringValue(e,"name");t.name=I.MapNameToTranslation(a,o),t.data.description.source=`${I.StringValue(e,"source")} ${I.MapNameToPageSource(a,o)}`}return t}};var Ur=class extends G{constructor(){super(...arguments);this.files=["complexforms.xml"]}CanParse(t){return t.hasOwnProperty("complexforms")&&t.complexforms.hasOwnProperty("complexform")}GetDefaultData(){return{name:"Unnamed Form",type:"complex_form",data:{description:{value:"",chat:"",source:""},action:P.actionData({type:"complex",attribute:"resonance",skill:"compiling"}),target:"",duration:"",fade:0}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.nameTranslations=I.ExtractItemTranslation(t,"complexforms","complexform")}Parse(t){return u(this,null,function*(){let a=new Vr,r=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/Complex Forms`,!0),i=[],s=t.complexforms.complexform;for(let o=0;o<s.length;o++){let l=s[o];if(G.unsupportedEntry(l))continue;let c=a.Parse(l,this.GetDefaultData(),this.nameTranslations);c.folder=r.id,c.name=I.MapNameToTranslation(this.nameTranslations,c.name),i.push(c)}return yield Item.create(i)})}};var Hr=class extends de{Parse(e,t,a){t=super.Parse(e,t,a);let r=I.StringValue(e,"ess","0").match(/[0-9]\.?[0-9]*/g);r!==null&&(t.data.essence=parseFloat(r[0]));let i=I.StringValue(e,"capacity","0").match(/[0-9]+/g);return i!==null&&(t.data.capacity=parseInt(i[0])),t}};var $r=class extends G{constructor(){super(...arguments);this.files=["cyberware.xml","bioware.xml"]}CanParse(t){return t.hasOwnProperty("cyberwares")&&t.cyberwares.hasOwnProperty("cyberware")||t.hasOwnProperty("biowares")&&t.biowares.hasOwnProperty("bioware")}GetDefaultCyberwareData(){return ut(J({},this.GetDefaultData()),{type:"cyberware"})}GetDefaultBiowareData(){return ut(J({},this.GetDefaultData()),{type:"bioware"})}GetDefaultData(){return{name:"Unnamed Form",type:"cyberware",data:{description:{value:"",chat:"",source:""},technology:P.technologyData({rating:1}),armor:{value:0,mod:!1,acid:0,cold:0,fire:0,electricity:0,radiation:0},action:P.actionData(),grade:"standard",essence:0,capacity:0}}}ExtractTranslation(t){if(!G.jsoni18n)return;let a=I.ExtractDataFileTranslation(G.jsoni18n,t);this.files.length!==2&&console.error("Lazily hacked code will fail for more or less than two files."),this.categoryTranslations=I.ExtractCategoriesTranslation(a);let{typeKey:r,listKey:i}=t==="cyberware.xml"?{typeKey:"cyberwares",listKey:"cyberware"}:{typeKey:"biowares",listKey:"bioware"};this.itemTranslations=I.ExtractItemTranslation(a,r,i)}Parse(t){return u(this,null,function*(){let a=new Hr,r=t.hasOwnProperty("cyberwares")?"Cyberware":"Bioware",i=yield I.MakeCategoryFolders(t,r);r=r.toLowerCase();let s=[],o=t[r+"s"][r];for(let l=0;l<o.length;l++){let c=o[l];if(G.unsupportedEntry(c))continue;let d=r==="cyberware"?this.GetDefaultCyberwareData():this.GetDefaultBiowareData(),p=a.Parse(c,d,this.itemTranslations),g=I.StringValue(c,"category");p.folder=i[g.toLowerCase()].id,s.push(p)}return yield Item.create(s)})}};var jr=class extends Kt{Parse(e,t,a){t.name=I.StringValue(e,"name"),t.data.description.source=`${I.StringValue(e,"source")} ${I.StringValue(e,"page")}`,t.data.category=I.StringValue(e,"category").toLowerCase();let r=I.StringValue(e,"duration");r==="Always"?t.data.duration="always":r==="Instant"?t.data.duration="instant":r==="Sustained"?t.data.duration="sustained":r==="Permanent"?t.data.duration="permanent":t.data.duration="special";let i=I.StringValue(e,"range");i==="T"?t.data.range="touch":i==="LOS"?t.data.range="los":i==="LOS (A)"?t.data.range="los_a":i==="Self"?t.data.range="self":t.data.range="special";let s=I.StringValue(e,"type");if(s==="P"?t.data.powerType="physical":s==="M"&&(t.data.powerType="mana"),a){let o=I.StringValue(e,"name");t.name=I.MapNameToTranslation(a,o),t.data.description.source=`${I.StringValue(e,"source")} ${I.MapNameToPageSource(a,o)}`}return t}};var Gr=class extends G{constructor(){super(...arguments);this.files=["critterpowers.xml"]}CanParse(t){return t.hasOwnProperty("powers")&&t.powers.hasOwnProperty("power")}GetDefaultData(){return{name:"Unnamed Item",type:"critter_power",data:{description:{value:"",chat:"",source:""},action:P.actionData({damage:P.damageData({type:{base:"",value:""}})}),armor:{value:0,mod:!1,acid:0,cold:0,fire:0,electricity:0,radiation:0},category:"",powerType:"",range:"",duration:"",karma:0}}}ExtractTranslation(){if(!G.jsoni18n)return;let t=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(t),this.itemTranslations=I.ExtractItemTranslation(t,"powers","power")}Parse(t){return u(this,null,function*(){let a=new jr,r=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/Critter Powers`,!0),i=[],s=t.powers.power;for(let o=0;o<s.length;o++){let l=s[o],c=a.Parse(l,this.GetDefaultData(),this.itemTranslations);c.folder=r.id,c.name=I.MapNameToTranslation(this.itemTranslations,c.name),i.push(c)}return yield Item.create(i)})}};var zr=class extends G{constructor(){super(...arguments);this.files=["gear.xml"]}CanParse(t){return t.hasOwnProperty("gears")&&t.gears.hasOwnProperty("gear")}GetDefaultData(){return P.deviceItemData()}ExtractTranslation(t){if(!G.jsoni18n)return;let a=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(a),this.entryTranslations=I.ExtractItemTranslation(a,"gears","gear")}ParseCommlinkDevices(t,a){let r=[];for(let i of t){if(G.unsupportedEntry(i))continue;let s=this.GetDefaultData();s.name=I.StringValue(i,"name"),s.name=I.MapNameToTranslation(this.entryTranslations,s.name),s.data.description.source=`${I.StringValue(i,"source")} ${I.MapNameToPageSource(this.entryTranslations,I.StringValue(i,"name"),I.StringValue(i,"page"))}`,s.data.technology.rating=I.IntValue(i,"devicerating",0),s.data.technology.availability=I.StringValue(i,"avail"),s.data.technology.cost=I.IntValue(i,"cost",0),s.data.atts.att3.value=I.IntValue(i,"dataprocessing",0),s.data.atts.att4.value=I.IntValue(i,"firewall",0),s.folder=a.id,r.push(s)}return r}ParseCyberdeckDevices(t,a){let r=[];for(let i of t){if(G.unsupportedEntry(i))continue;let s=this.GetDefaultData();if(s.data.category="cyberdeck",s.name=I.StringValue(i,"name"),s.name=I.MapNameToTranslation(this.entryTranslations,s.name),s.data.description.source=`${I.StringValue(i,"source")} ${I.MapNameToPageSource(this.entryTranslations,I.StringValue(i,"name"),I.StringValue(i,"page"))}`,s.data.technology.rating=I.IntValue(i,"devicerating",0),s.data.technology.availability=I.StringValue(i,"avail"),s.data.technology.cost=I.IntValue(i,"cost",0),i.hasOwnProperty("attributearray")){let o=I.StringValue(i,"attributearray").split(","),l=Number(o[0]),c=Number(o[1]),d=Number(o[2]),p=Number(o[3]);s.data.atts.att1.value=l,s.data.atts.att2.value=c,s.data.atts.att3.value=d,s.data.atts.att4.value=p}else i.hasOwnProperty("attack")&&(s.data.atts.att1.value=I.IntValue(i,"attack",0),s.data.atts.att2.value=I.IntValue(i,"sleaze",0),s.data.atts.att3.value=I.IntValue(i,"dataprocessing",0),s.data.atts.att4.value=I.IntValue(i,"firewall",0));s.folder=a.id,r.push(s)}return r}Parse(t){return u(this,null,function*(){let a=[],r=t.gears.gear.filter(l=>I.StringValue(l,"category","")==="Commlinks"),i=t.gears.gear.filter(l=>I.StringValue(l,"category","")==="Cyberdecks"),s=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/${game.i18n.localize("SR5.DeviceCatCommlink")}`,!0),o=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/${game.i18n.localize("SR5.DeviceCatCyberdeck")}`,!0);return a=a.concat(this.ParseCommlinkDevices(r,s)),a=a.concat(this.ParseCyberdeckDevices(i,o)),yield Item.create(a)})}static unsupportedEntry(t){return G.unsupportedEntry(t)?!0:["d63eb841-7b15-4539-9026-b90a4924aeeb"].includes(I.StringValue(t,"id"))}};var Wr=class extends G{constructor(){super(...arguments);this.files=["gear.xml"]}CanParse(t){return t.hasOwnProperty("gears")&&t.gears.hasOwnProperty("gear")}GetDefaultData(){return P.equipmentItemData()}ExtractTranslation(t){if(!G.jsoni18n)return;let a=I.ExtractDataFileTranslation(G.jsoni18n,this.files[0]);this.categoryTranslations=I.ExtractCategoriesTranslation(a),this.entryTranslations=I.ExtractItemTranslation(a,"gears","gear")}ParseEquipments(t){return u(this,null,function*(){let a=[];for(let r of t){if(G.unsupportedEntry(r))continue;let i=I.TranslateCategory(I.StringValue(r,"category"),this.categoryTranslations).replace("/"," "),s=yield I.GetFolderAtPath(`${rt.ROOT_IMPORT_FOLDER_NAME}/${game.i18n.localize("SR5.Gear")}/${i}`,!0),o=this.GetDefaultData();o.name=I.StringValue(r,"name"),o.name=I.MapNameToTranslation(this.entryTranslations,o.name),o.data.description.source=`${I.StringValue(r,"source")} ${I.MapNameToPageSource(this.entryTranslations,I.StringValue(r,"name"),I.StringValue(r,"page"))}`,o.data.technology.rating=I.IntValue(r,"rating",0),o.data.technology.availability=I.StringValue(r,"avail"),o.data.technology.cost=I.IntValue(r,"cost",0),o.folder=s.id,a.push(o)}return a})}FilterJsonObjects(t){let a=["Ammunition","Commlinks","Cyberdecks","Hacking Programs","Rigger Command Consoles","Custom"];return t.gears.gear.filter(r=>!a.includes(I.StringValue(r,"category","")))}Parse(t){return u(this,null,function*(){let a=this.FilterJsonObjects(t),r=yield this.ParseEquipments(a);return yield Item.create(r)})}};var Xr=class extends Application{constructor(){super();this.supportedDataFiles=[];this.dataFiles=[];this.parsedFiles=[];this.disableImportButton=!0;this.isDataFile=t=>this.supportedDataFiles.some(a=>a===t.name);this.isLangDataFile=t=>{let a=/[a-zA-Z]{2}-[a-zA-Z]{2}_data\.xml/;return t.name.match(a)!==null};this.collectDataImporterFileSupport()}static get defaultOptions(){let t=super.defaultOptions;return t.id="chummer-data-import",t.classes=["app","window-app","filepicker"],t.title="Chummer/Data Import",t.template="systems/shadowrun5e/dist/templates/apps/compendium-import.html",t.width=600,t.height="auto",t}getData(t){let a=super.getData(t);return a.dataFiles={},this.supportedDataFiles.forEach(r=>{let i=!this.dataFiles.some(l=>r===l.name),s=this.parsedFiles.some(l=>r===l),o=r===this.currentParsedFile;a.dataFiles[r]={name:r,missing:i,parsed:s,parsing:o}}),a.langDataFile=this.langDataFile?this.langDataFile.name:"",a.finishedOverallParsing=this.supportedDataFiles.length===this.parsedFiles.length,a.disableImportButton=this.disableImportButton,J({},a)}collectDataImporterFileSupport(){this.supportedDataFiles=[],Xr.Importers.forEach(t=>{this.supportedDataFiles.some(a=>t.files.includes(a))||(this.supportedDataFiles=this.supportedDataFiles.concat(t.files))})}clearParsingStatus(){this.parsedFiles=[]}parseXML(t,a){return u(this,null,function*(){let r=yield G.xml2json(t);I.SetMode(1);for(let i of Xr.Importers)i.CanParse(r)&&(i.ExtractTranslation(a),yield i.Parse(r))})}parseXmli18n(t){return u(this,null,function*(){if(!t)return;let a=yield G.xml2json(t);G.CanParseI18n(a)&&G.ParseTranslation(a)})}activateListeners(t){t.find("button[type='submit']").on("click",a=>u(this,null,function*(){if(a.preventDefault(),this.clearParsingStatus(),this.disableImportButton=!0,yield this.render(),this.langDataFile){let r=yield this.langDataFile.text();yield this.parseXmli18n(r)}for(let r of this.supportedDataFiles){let i=this.dataFiles.find(s=>s.name===r);if(i){let s=yield i.text();this.currentParsedFile=i.name,yield this.render(),yield this.parseXML(s,i.name),this.parsedFiles.some(o=>o===i.name)||this.parsedFiles.push(i.name),yield this.render()}}this.disableImportButton=!1,yield this.render()})),t.find("input[type='file'].langDataFileDrop").on("change",a=>u(this,null,function*(){return Array.from(a.target.files).forEach(r=>{this.isLangDataFile(r)&&(this.langDataFile=r,this.render())}),!0})),t.find("input[type='file'].filedatadrop").on("change",a=>u(this,null,function*(){Array.from(a.target.files).forEach(r=>{if(this.isDataFile(r)){let i=this.dataFiles.findIndex(s=>s.name===r.name);i===-1?this.dataFiles.push(r):this.dataFiles[i]=r}}),this.dataFiles.length>0&&(this.disableImportButton=!1),this.render()}))}},_a=Xr;_a.Importers=[new _r,new Rr,new Mr,new Er,new Nr,new Ur,new Br,new $r,new Gr,new zr,new Wr];var Xe=class extends Application{get template(){return"systems/shadowrun5e/dist/templates/apps/changelog.html"}static get defaultOptions(){let e=super.defaultOptions;return e.classes=["shadowrun5e"],e.title=game.i18n.localize("SR5.ChangelogApplication.Title"),e.width=500,e.height="auto",e}render(e,t){return Xe.setRenderForCurrentVersion(),super.render(e,t)}static setRenderForCurrentVersion(){var e;(e=game.user)==null||e.setFlag(V,j.ChangelogShownForVersion,game.system.data.version)}static get showApplication(){var t,a,r;return!((t=game.user)!=null&&t.isGM)||!((a=game.user)!=null&&a.isTrusted)?!1:((r=game.user)==null?void 0:r.getFlag(V,j.ChangelogShownForVersion))!==game.system.data.version}};var re=class extends Application{constructor(t){super();this.target=t}get template(){return"systems/shadowrun5e/dist/templates/apps/env-modifiers.html"}static get defaultOptions(){let t=super.defaultOptions;return t.classes=["sr5","form-dialog"],t.id="env-modifiers-application",t.title=game.i18n.localize("SR5.EnvModifiersApplication.Title"),t.width="auto",t.height="auto",t.resizable=!0,t}getData(t){return u(this,null,function*(){let a=Y(re.prototype,this,"getData").call(this,t);return this.modifiers=yield this._getModifiers(),a.active=this.modifiers.environmental.active,a.total=this.modifiers.environmental.total,a.levels=Z.getEnvironmentalModifierLevels(),a.targetType=this._getTargetTypeLabel(),a.targetName=this.target.name,a.disableForm=this._disableInputsForUser(),a})}activateListeners(t){$(t).find("button.env-modifier").on("click",this._handleModifierChange.bind(this)),$(t).find("button.remove-modifiers-from-target").on("click",this._handleRemoveModifiersFromTarget.bind(this))}_handleModifierChange(t){return u(this,null,function*(){t.preventDefault();let a=t.currentTarget;if(!a.dataset.category||!a.dataset.value)return;let r=a.dataset.category,i=Number(a.dataset.value);this._toggleActiveModifierCategory(r,i),yield this._clearModifiersOnTargetForNoSelection(),yield this._storeModifiersOnTarget(),this._updateTokenHUDTotalDisplay(),yield this.render()})}_updateTokenHUDTotalDisplay(){this.target instanceof st&&$(".modifier-value-environmental").each((t,a)=>{$(a).html(this.modifiers.environmental.total.toString())})}_handleRemoveModifiersFromTarget(t){return u(this,null,function*(){t.preventDefault(),yield this.clearModifiersOnTarget(),this._updateTokenHUDTotalDisplay(),yield this.render()})}_toggleActiveModifierCategory(t,a){this.modifiers.toggleEnvironmentalCategory(t,a)}_getModifiers(){return u(this,null,function*(){return this.target instanceof st?yield this.target.getModifiers():Z.getModifiersFromEntity(this.target)})}_storeModifiersOnTarget(){return u(this,null,function*(){yield Z.setModifiersOnEntity(this.target,this.modifiers.data)})}_clearModifiersOnTargetForNoSelection(){return u(this,null,function*(){this.modifiers.hasActiveEnvironmental||(this.modifiers=yield Z.clearEnvironmentalOnEntity(this.target))})}_targetHasEnvironmentalModifiers(){return u(this,null,function*(){return!!Z.getModifiersFromEntity(this.target).environmental})}clearModifiersOnTarget(){return u(this,null,function*(){yield Z.clearEnvironmentalOnEntity(this.target),this.modifiers=yield this._getModifiers()})}_getTargetTypeLabel(){return this.target instanceof Scene?game.i18n.localize("DOCUMENT.Scene"):this.target instanceof st?game.i18n.localize("DOCUMENT.Actor"):""}_disableInputsForUser(){var t;return game.user?!(((t=game.user)==null?void 0:t.isGM)||this.target.testUserPermission(game.user,"OWNER")):!1}static openForCurrentScene(){return u(this,null,function*(){!canvas||!canvas.ready||!canvas.scene||(yield new re(canvas.scene).render(!0))})}static openForTokenHUD(t){let a=w.getToken(t);return r=>u(this,null,function*(){r.preventDefault(),!(!a||!a.actor)&&(yield new re(a.actor).render(!0))})}static getControl(){return{name:"environmental-modifiers-application",title:"CONTROLS.SR5.EnvironmentalModifiers",icon:"fas fa-list",onClick:re.openForCurrentScene,button:!0}}static addTokenHUDFields(t,a,r){return u(this,null,function*(){if(!r._id)return;console.log(`${V} | Environmental Modifier HUD on renderTokenHUD`);let i=w.getToken(r._id);if(!i)return;let o=yield i.actor.getModifiers(),l=$('<div class="col far-right sr-modifier-container"></div>'),c=$('<div class="col modifier-column"></div>'),d=$('<div class="modifier-row"></div>'),p=$(`<div class="modifier-value modifier-value-environmental">${o.environmental.total}</div>`),g=$(`<div class="modifier-description open-environmental-modifier">${game.i18n.localize("SR5.EnvironmentModifier")}</div>`);g.on("click",re.openForTokenHUD(r._id)),l.append(c),c.append(d),d.append(p),d.append(g),a.find(".col.right").after(l)})}};var Ho=n=>{let{describe:e,it:t,assert:a}=n,r={environmental:{active:{},total:0}},i={environmental:{active:{wind:-1,light:-1},total:-3}};e("SR5 Modifiers",()=>{t("should create default modifier values",()=>{let s=Z.getDefaultModifiers();a.deepEqual(s,r)}),t("should use default modifiers for faulty constructor params",()=>{a.deepEqual(new Z({}).data,r),a.deepEqual(new Z(void 0).data,r),a.deepEqual(new Z(null).data,r),a.deepEqual(new Z(0).data,r),a.deepEqual(new Z(1).data,r),a.deepEqual(new Z().data,r)}),t("should set an environmental modifier active",()=>{new Z(r)._setEnvironmentalCategoryActive("wind",-1)}),t("should set an environmental modifier inactive",()=>{let s=new Z({environmental:{active:{wind:-1,light:-3},total:0}});s._setEnvironmentalCategoryInactive("wind"),a.deepEqual(s.environmental.active,{light:-3})}),t("should understand active environmental modifiers",()=>{let s=new Z({environmental:{active:{wind:-1,light:-3},total:0}});a.equal(s.hasActiveEnvironmental,!0);let o=new Z({environmental:{active:{},total:0}});a.equal(o.hasActiveEnvironmental,!1)}),t("should calculate the total according to sr5 rules",()=>{let s=new Z(r);a.equal(s.environmental.total,0),s.environmental.active.wind=-1,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-1),s.environmental.active.light=-1,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-3),s.environmental.active.range=-1,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-3),delete s.environmental.active.light,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-3),s.environmental.active.light=0,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-3),s.environmental.active.wind=-3,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-3),s.environmental.active.light=-3,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-6),s.environmental.active.range=-3,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-6),delete s.environmental.active.light,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-6),s.environmental.active.light=0,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-6),s.environmental.active.wind=-6,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-6),s.environmental.active.light=-6,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-10),s.environmental.active.range=-6,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-10),delete s.environmental.active.light,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-10),s.environmental.active.light=0,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-10),s.environmental.active.value=0,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,0),s.environmental.active.value=-1,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-1),s.environmental.active.value=-3,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-3),s.environmental.active.value=-6,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-6),s.environmental.active.value=-10,s.calcEnvironmentalTotal(),a.equal(s.environmental.total,-10)}),t("should reset active environmental modifiers",()=>{let s=new Z(i);s._resetEnvironmental(),a.deepEqual(s.environmental.active,{})}),t("should calculate total for faulty active",()=>{let s=new Z({environmental:{total:-1,active:{light:null,wind:void 0,range:"",visibility:"string"}}});s.calcEnvironmentalTotal(),a.equal(s.environmental.total,0)})})};var dt=class{constructor(e){this.documents={};this.documentClass=e}create(e){return u(this,null,function*(){let t=yield this.documentClass.create(ut(J({name:"#QUENCH_TEST_DOCUMENT_SHOULD_HAVE_BEEN_DELETED"},e),{folder:this.folder}));return this.documents[t.id]=t,t})}delete(e){return u(this,null,function*(){let t=this.documents[e];!t||(yield this.documentClass.deleteDocuments([t.data._id]),delete this.documents[t.id])})}teardown(){return u(this,null,function*(){yield this.documentClass.deleteDocuments(Object.values(this.documents).map(e=>e.id))})}};var $o=n=>{let{describe:e,it:t,assert:a,before:r,after:i}=n,s;r(()=>u(void 0,null,function*(){s=new dt(nt)})),i(()=>u(void 0,null,function*(){yield s.teardown()})),e("SR5Items",()=>{t("create a naked item of any type",()=>u(void 0,null,function*(){var c;let o=yield s.create({type:"action"});a.notStrictEqual(o.id,""),a.notStrictEqual(o.id,void 0),a.notStrictEqual(o.id,null);let l=(c=game.items)==null?void 0:c.get(o.id);a.notStrictEqual(l,null),a.strictEqual(o.id,l==null?void 0:l.id)})),t("update an item of any type",()=>u(void 0,null,function*(){let o=yield s.create({type:"action"});a.notProperty(o.data.data,"test"),yield o.update({"data.test":!0}),a.property(o.data.data,"test"),a.propertyVal(o.data.data,"test",!0)})),t("embedd a ammo into a weapon and not the global item collection",()=>u(void 0,null,function*(){var g;let o=yield s.create({type:"weapon"}),l=yield s.create({type:"ammo"});yield o.createOwnedItem(l.data);let c=o.getNestedItems();a.isNotEmpty(c),a.lengthOf(c,1);let d=c[0];a.strictEqual(d.type,l.data.type);let p=(g=game.items)==null?void 0:g.get(d._id);a.strictEqual(p,void 0)})),t("update an embedded ammo",()=>u(void 0,null,function*(){let o=yield s.create({type:"weapon"}),l=yield s.create({type:"ammo"});yield o.createOwnedItem(l.data);let c=o.getNestedItems();a.lengthOf(c,1);let d=c[0],p=o.getOwnedItem(d._id);a.notStrictEqual(p,void 0),a.instanceOf(p,nt),p&&(a.notProperty(p.data.data,"test"),yield p.update({"data.test":!0}),a.property(p.data.data,"test"),a.propertyVal(p.data.data,"test",!0))}))})};var jo=n=>{let{describe:e,it:t,assert:a,before:r,after:i}=n;e("Matrix Rules",()=>{t("calculate IC device rating",()=>{let s=5;a.strictEqual(X.getICDeviceRating(s),s),s=-1,a.strictEqual(X.getICDeviceRating(s),0)}),t("calculate IC condition monitor",()=>{a.strictEqual(X.getConditionMonitor(0),8),a.strictEqual(X.getConditionMonitor(1),9),a.strictEqual(X.getConditionMonitor(4),10),a.strictEqual(X.getConditionMonitor(-1),8)}),t("calculate IC matrix initiative base",()=>{a.strictEqual(X.getICInitiativeBase(0),0),a.strictEqual(X.getICInitiativeBase(-3),0),a.strictEqual(X.getICInitiativeBase(1),2),a.strictEqual(X.getICInitiativeBase(2),4),a.strictEqual(X.getICInitiativeBase(3),6),a.strictEqual(X.getICInitiativeBase(12),24)}),t("calculate IC matrix initiative dice",()=>{a.strictEqual(X.getICInitiativeDice(),4)}),t("calculate meat attribute base with the host rating",()=>{a.strictEqual(X.getICMeatAttributeBase(0),0),a.strictEqual(X.getICMeatAttributeBase(-3),0),a.strictEqual(X.getICMeatAttributeBase(3),3),a.strictEqual(X.getICMeatAttributeBase(27),27)}),t("disallow invalid marks counters",()=>{a.isTrue(X.isValidMarksCount(0)),a.isTrue(X.isValidMarksCount(1)),a.isTrue(X.isValidMarksCount(2)),a.isTrue(X.isValidMarksCount(3)),a.isFalse(X.isValidMarksCount(-1)),a.isFalse(X.isValidMarksCount(4)),a.isFalse(X.isValidMarksCount(1.5))}),t("return valid marks counts",()=>{a.strictEqual(X.getValidMarksCount(-1),X.minMarksCount()),a.strictEqual(X.getValidMarksCount(0),0),a.strictEqual(X.getValidMarksCount(1),1),a.strictEqual(X.getValidMarksCount(2),2),a.strictEqual(X.getValidMarksCount(3),3),a.strictEqual(X.getValidMarksCount(4),X.maxMarksCount())}),t("return expected host matrix attribute ratings",()=>{a.deepEqual(X.hostMatrixAttributeRatings(1),[2,3,4,5]),a.deepEqual(X.hostMatrixAttributeRatings(2),[3,4,5,6]),a.deepEqual(X.hostMatrixAttributeRatings(10),[11,12,13,14])})})};var Go=n=>{let{describe:e,it:t,assert:a,before:r,after:i}=n,s,o;r(()=>u(void 0,null,function*(){s=new dt(st),o=new dt(nt)})),i(()=>u(void 0,null,function*(){yield s.teardown(),yield o.teardown()})),e("SR5Actor",()=>{t("create a naked actor of any type",()=>u(void 0,null,function*(){var d;let l=yield s.create({type:"character"});a.notStrictEqual(l.id,""),a.notStrictEqual(l.id,void 0),a.notStrictEqual(l.id,null);let c=(d=game.actors)==null?void 0:d.get(l.id);a.isOk(c),a.strictEqual(l.id,c==null?void 0:c.id)})),t("update an actor of any time",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"});a.notProperty(l.data.data,"test"),yield l.update({"data.test":!0}),a.property(l.data.data,"test"),a.propertyVal(l.data.data,"test",!0)})),t("embedd a weapon into an actor and not the global item colection",()=>u(void 0,null,function*(){var y;let l=yield s.create({type:"character"}),c=yield o.create({type:"weapon"});yield l.createEmbeddedDocuments("Item",[c.data]);let d=Array.from(l.items);a.isNotEmpty(d),a.lengthOf(d,1);let p=d[0];a.strictEqual(p.type,c.data.type);let g=(y=game.items)==null?void 0:y.get(p.id);a.isNotOk(g)}))})};var zo=n=>{let{describe:e,it:t,assert:a,before:r,after:i}=n,s,o;r(()=>u(void 0,null,function*(){s=new dt(st),o=new dt(nt)})),i(()=>u(void 0,null,function*(){yield s.teardown(),yield o.teardown()})),e("CharacterDataPrep",()=>{t("Character default attribute values",()=>u(void 0,null,function*(){let l=yield s.create({type:"character",metatype:"human"});console.log("Physical attributes"),a.strictEqual(l.data.data.attributes.body.value,K.attributes.ranges.body.min),a.strictEqual(l.data.data.attributes.agility.value,K.attributes.ranges.agility.min),a.strictEqual(l.data.data.attributes.reaction.value,K.attributes.ranges.reaction.min),a.strictEqual(l.data.data.attributes.strength.value,K.attributes.ranges.strength.min),a.strictEqual(l.data.data.attributes.willpower.value,K.attributes.ranges.willpower.min),a.strictEqual(l.data.data.attributes.logic.value,K.attributes.ranges.logic.min),a.strictEqual(l.data.data.attributes.intuition.value,K.attributes.ranges.intuition.min),a.strictEqual(l.data.data.attributes.charisma.value,K.attributes.ranges.charisma.min),console.log("Comon special attributes"),a.strictEqual(l.data.data.attributes.edge.value,K.attributes.ranges.edge.min),a.strictEqual(l.data.data.attributes.essence.value,K.attributes.defaults.essence),console.log("Special special attributes"),a.strictEqual(l.data.data.attributes.resonance.value,K.attributes.ranges.resonance.min),a.strictEqual(l.data.data.attributes.magic.value,K.attributes.ranges.magic.min)})),t("Character monitor calculation",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=l.asCharacterData();a.strictEqual(c.data.track.stun.max,9),a.strictEqual(c.data.track.physical.max,9),a.strictEqual(c.data.track.physical.overflow.max,K.attributes.ranges.body.min),yield l.update({"data.attributes.body.base":6,"data.attributes.willpower.base":6}),a.strictEqual(c.data.track.stun.max,11),a.strictEqual(c.data.track.physical.max,11),a.strictEqual(c.data.track.physical.overflow.max,6)})),t("Character initiative calculation",()=>u(void 0,null,function*(){let c=(yield s.create({type:"character"})).asCharacterData();console.log("Meatspace Ini"),a.strictEqual(c.data.initiative.meatspace.base.base,2),a.strictEqual(c.data.initiative.meatspace.dice.base,1),console.log("Matrix AR Ini"),a.strictEqual(c.data.initiative.matrix.base.base,1),a.strictEqual(c.data.initiative.matrix.dice.base,3),console.log("Magic Ini"),a.strictEqual(c.data.initiative.astral.base.base,2),a.strictEqual(c.data.initiative.astral.dice.base,2)})),t("Character limit calculation",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=l.asCharacterData();a.strictEqual(c.data.limits.physical.value,2),a.strictEqual(c.data.limits.mental.value,2),a.strictEqual(c.data.limits.social.value,3),yield l.update({"data.attributes.strength.base":6,"data.attributes.body.base":6,"data.attributes.reaction.base":6,"data.attributes.logic.base":6,"data.attributes.intuition.base":6,"data.attributes.willpower.base":6,"data.attributes.charisma.base":6,"data.attributes.essence.base":6}),a.strictEqual(c.data.limits.physical.value,8),a.strictEqual(c.data.limits.mental.value,8),a.strictEqual(c.data.limits.social.value,8)})),t("Character movement calculation",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=l.asCharacterData();a.strictEqual(c.data.movement.walk.value,2),a.strictEqual(c.data.movement.run.value,4),yield l.update({"data.attributes.agility.base":6}),a.strictEqual(c.data.movement.walk.value,12),a.strictEqual(c.data.movement.run.value,24)})),t("Character skill calculation",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=l.asCharacterData();yield l.update({"data.skills.active.arcana.base":6,"data.skills.active.arcana.bonus":[{key:"Test",value:1}],"data.skills.active.arcana.specs":["Test"]}),a.strictEqual(c.data.skills.active.arcana.value,7)})),t("Character damage application",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=l.asCharacterData();a.strictEqual(c.data.track.stun.value,0),a.strictEqual(c.data.track.stun.wounds,0),a.strictEqual(c.data.track.physical.value,0),a.strictEqual(c.data.track.physical.wounds,0),a.strictEqual(c.data.wounds.value,0),yield l.update({"data.track.stun.value":3,"data.track.physical.value":3}),a.strictEqual(c.data.track.stun.value,3),a.strictEqual(c.data.track.stun.wounds,1),a.strictEqual(c.data.track.physical.value,3),a.strictEqual(c.data.track.physical.wounds,1),a.strictEqual(c.data.wounds.value,2)})),t("Character damage application with high pain/wound tolerance",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=l.asCharacterData();yield l.update({"data.track.stun.value":6,"data.track.physical.value":6,"data.modifiers.wound_tolerance":3}),a.strictEqual(c.data.track.stun.value,6),a.strictEqual(c.data.track.stun.wounds,1),a.strictEqual(c.data.track.physical.value,6),a.strictEqual(c.data.track.physical.wounds,1),a.strictEqual(c.data.wounds.value,2)}))}),e("SpiritDataPrep",()=>{t("Spirits are always magical",()=>u(void 0,null,function*(){let l=yield s.create({type:"spirit"});a.strictEqual(l.data.data.special,"magic")})),t("Spirit default/overrides by example type",()=>u(void 0,null,function*(){let l=yield s.create({type:"spirit","data.spiritType":"air"}),c=l.asSpiritData();a.strictEqual(c.data.attributes.body.base,-2),a.strictEqual(c.data.attributes.agility.base,3),a.strictEqual(c.data.attributes.reaction.base,4),a.strictEqual(c.data.attributes.strength.base,-3),a.strictEqual(c.data.attributes.intuition.base,0),a.strictEqual(c.data.initiative.meatspace.base.base,4),a.strictEqual(c.data.skills.active.assensing.base,0),yield l.update({"data.force":6}),a.strictEqual(c.data.attributes.body.base,4),a.strictEqual(c.data.attributes.agility.base,9),a.strictEqual(c.data.attributes.reaction.base,10),a.strictEqual(c.data.attributes.strength.base,3),a.strictEqual(c.data.attributes.intuition.base,6),a.strictEqual(c.data.initiative.meatspace.base.base,16),a.strictEqual(c.data.skills.active.assensing.base,6),a.strictEqual(c.data.skills.active.arcana.base,0)}))}),e("SpriteDataPrep",()=>{t("Sprites are always awakened",()=>u(void 0,null,function*(){let l=yield s.create({type:"sprite"});a.strictEqual(l.data.data.special,"resonance")})),t("Sprites default/override values by example type",()=>u(void 0,null,function*(){let l=yield s.create({type:"sprite","data.spriteType":"courier"}),c=l.asSpriteData();a.strictEqual(c.data.matrix.sleaze.base,3),a.strictEqual(c.data.matrix.data_processing.base,1),a.strictEqual(c.data.matrix.firewall.base,2),a.strictEqual(c.data.matrix.sleaze.base,3),a.strictEqual(c.data.initiative.matrix.base.base,1),a.strictEqual(c.data.skills.active.hacking.base,0),yield l.update({"data.level":6}),a.strictEqual(c.data.level,6),a.strictEqual(c.data.matrix.sleaze.base,9),a.strictEqual(c.data.matrix.data_processing.base,7),a.strictEqual(c.data.matrix.firewall.base,8),a.strictEqual(c.data.matrix.sleaze.base,9),a.strictEqual(c.data.initiative.matrix.base.base,13),a.strictEqual(c.data.initiative.matrix.dice.base,4),a.strictEqual(c.data.skills.active.hacking.base,6),a.strictEqual(c.data.skills.active.computer.base,6),a.strictEqual(c.data.skills.active.electronic_warfare.base,0)}))})};var Wo=n=>{let{describe:e,it:t,assert:a,before:r,after:i}=n,s,o;r(()=>u(void 0,null,function*(){s=new dt(st),o=new dt(nt)})),i(()=>u(void 0,null,function*(){yield s.teardown(),yield o.teardown()})),e("SR5ActiveEffect",()=>{t("apply the custom modify mode",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"}),c=yield l.createEmbeddedDocuments("ActiveEffect",[{origin:l.uuid,disabled:!1,label:"Test Effect"}]);yield c[0].update({changes:[{key:"data.attributes.body.mod",value:2,mode:CONST.ACTIVE_EFFECT_MODES.CUSTOM},{key:"data.attributes.body",value:2,mode:CONST.ACTIVE_EFFECT_MODES.CUSTOM}]}),a.deepEqual(l.data.data.attributes.body.mod,[{name:"Test Effect",value:2},{name:"Test Effect",value:2}]),a.strictEqual(l.data.data.attributes.body.value,4),yield c[0].update({changes:[{key:"data.attributes.body.mod",value:2,mode:CONST.ACTIVE_EFFECT_MODES.CUSTOM},{key:"data.attributes.body.mod",value:2,mode:CONST.ACTIVE_EFFECT_MODES.CUSTOM}]})})),t("apply custom modify mode, none ModifiableValue should work as the add mode",()=>u(void 0,null,function*(){let l=yield s.create({type:"character"});yield(yield l.createEmbeddedDocuments("ActiveEffect",[{origin:l.uuid,disabled:!1,label:"Test Effect"}]))[0].update({changes:[{key:"data.modifiers.global",value:3,mode:CONST.ACTIVE_EFFECT_MODES.CUSTOM}]}),a.strictEqual(l.data.data.modifiers.global,3),a.strictEqual(l.data.data.modifiers.global.mod,void 0),a.strictEqual(l.data.data.modifiers.global.override,void 0),t("apply the custom override mode",()=>u(void 0,null,function*(){let d=yield s.create({type:"character"});yield(yield d.createEmbeddedDocuments("ActiveEffect",[{origin:d.uuid,disabled:!1,label:"Test Effect"}]))[0].update({changes:[{key:"data.attributes.body",value:3,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE},{key:"data.attributes.body.value",value:3,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE}]}),a.deepEqual(d.data.data.attributes.body.override,{name:"Test Effect",value:3}),a.deepEqual(d.data.data.attributes.body.mod,[]),a.strictEqual(d.data.data.attributes.body.value,3)})),t("apply custom override mode, should override all existing .mod values",()=>u(void 0,null,function*(){t("apply the custom override mode",()=>u(void 0,null,function*(){let d=yield s.create({type:"character"});yield(yield d.createEmbeddedDocuments("ActiveEffect",[{origin:d.uuid,disabled:!1,label:"Test Effect"}]))[0].update({changes:[{key:"data.attributes.body.mod",value:5,mode:CONST.ACTIVE_EFFECT_MODES.ADD},{key:"data.attributes.body.value",value:3,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE}]}),a.strictEqual(d.data.data.attributes.body.mod.length,1),a.deepEqual(d.data.data.attributes.body.override,{name:"Test Effect",value:3}),a.deepEqual(d.data.data.attributes.body.mod,[{name:"Test Effect",value:5}]),a.strictEqual(d.data.data.attributes.body.value,3)}))})),t("apply custom override mode, none ModifiableValue should work without altering anything",()=>u(void 0,null,function*(){let d=yield s.create({type:"character"});yield(yield d.createEmbeddedDocuments("ActiveEffect",[{origin:d.uuid,disabled:!1,label:"Test Effect"}]))[0].update({changes:[{key:"data.modifiers.global",value:3,mode:CONST.ACTIVE_EFFECT_MODES.OVERRIDE}]}),a.strictEqual(d.data.data.modifiers.global,3),a.strictEqual(d.data.data.modifiers.global.mod,void 0),a.strictEqual(d.data.data.modifiers.global.override,void 0)}))}))})};var Xo=n=>{let{describe:e,it:t,assert:a,should:r,before:i,after:s}=n,o,l,c;i(()=>u(void 0,null,function*(){o=new dt(st),l=new dt(nt),c=new dt(Scene)})),s(()=>u(void 0,null,function*(){yield o.teardown(),yield l.teardown(),yield c.teardown()})),e("Network Devices handling",()=>{t("give a network link to given document class",()=>u(void 0,null,function*(){let d=yield o.create({type:"character"}),g=H.buildLink(d).split(".");a.strictEqual(g[0],"Actor"),a.strictEqual(g.length,2)})),t("resolve a network link back to a sidebar document",()=>u(void 0,null,function*(){let d=yield o.create({type:"character"}),p=H.buildLink(d),g=yield H.resolveLink(p);a.isNotNull(g),a.strictEqual(g==null?void 0:g.id,d.id)})),t("resolve a network link back to a embedded collection document",()=>u(void 0,null,function*(){let d=yield o.create({type:"character"}),p=yield l.create({type:"weapon"}),y=(yield d.createEmbeddedDocuments("Item",[p.data]))[0],S=H.buildLink(y),M=yield H.resolveLink(S);a.isNotNull(M),a.strictEqual(M==null?void 0:M.id,y==null?void 0:y.id)})),t("resolve a network link back to a token collection document",()=>u(void 0,null,function*(){let d=yield c.create({name:"Test"}),p=yield o.create({type:"character"}),g=yield getDocumentClass("Token").create(yield p.getTokenData({x:0,y:0}),{parent:d}),y=H.buildLink(g),S=yield H.resolveLink(y);a.isNotNull(S),a.strictEqual(g==null?void 0:g.id,S==null?void 0:S.id)})),t("connect a device controller to a network device",()=>u(void 0,null,function*(){let d=yield l.create({type:"device"}),p=yield l.create({type:"weapon"});yield H.addDeviceToNetwork(d,p),a.strictEqual(p.data.data.technology.networkController,d.uuid),a.strictEqual(yield H.resolveLink(p.data.data.technology.networkController),d),a.deepEqual(d.data.data.networkDevices,[p.uuid])})),t("connect a host controller to a network device",()=>u(void 0,null,function*(){let d=yield l.create({type:"host"}),p=yield l.create({type:"weapon"});yield H.addDeviceToNetwork(d,p),a.strictEqual(p.data.data.technology.networkController,d.uuid),a.strictEqual(yield H.resolveLink(p.data.data.technology.networkController),d),a.deepEqual(d.data.data.networkDevices,[p.uuid])})),t("get all connected network devices of a controller as their Document",()=>u(void 0,null,function*(){let d=yield l.create({type:"device"}),p=[yield l.create({type:"weapon"})];for(let y of p)yield H.addDeviceToNetwork(d,y);let g=H.getNetworkDevices(d);a.strictEqual(d.data.data.networkDevices.length,1),a.strictEqual(g.length,1);for(let y of g)a.include(p,y)})),t("remove a device from a network",()=>u(void 0,null,function*(){let d=yield l.create({type:"device"}),p=yield l.create({type:"weapon"});yield H.addDeviceToNetwork(d,p),yield H.removeDeviceLinkFromNetwork(d,p.uuid),a.deepEqual(d.data.data.networkDevices,[]),a.strictEqual(p.data.data.technology.networkController,"")})),t("remove a device from a network when it is added to a new one",()=>u(void 0,null,function*(){let d=yield l.create({type:"device"}),p=yield l.create({type:"device"}),g=yield l.create({type:"weapon"});yield H.addDeviceToNetwork(d,g),yield H.addDeviceToNetwork(p,g),a.deepEqual(d.data.data.networkDevices,[]),a.deepEqual(p.data.data.networkDevices,[g.uuid]),a.strictEqual(g.data.data.technology.networkController,p.uuid)})),t("remove a network device that doesnt exist anymore",()=>u(void 0,null,function*(){var S;let d=yield l.create({type:"device"}),p=yield l.create({type:"weapon"}),g=p.id;yield H.addDeviceToNetwork(d,p),yield l.delete(g);let y=(S=game.items)==null?void 0:S.get(g);a.strictEqual(y,void 0),a.strictEqual(d.data.data.networkDevices.length,1),yield H.removeDeviceLinkFromNetwork(d,d.data.data.networkDevices[0]),a.deepEqual(d.data.data.networkDevices,[])})),t("remove all devices from a controller",()=>u(void 0,null,function*(){let d=yield l.create({type:"device"}),p=[yield l.create({type:"weapon"})];for(let g of p)yield H.addDeviceToNetwork(d,g);yield H.removeAllDevicesFromNetwork(d),a.deepEqual(d.data.data.networkDevices,[]);for(let g of p)a.strictEqual(g.data.data.technology.networkController,"")}))})};var Ko=n=>{let{describe:e,it:t,assert:a,before:r,after:i}=n,s,o;r(()=>u(void 0,null,function*(){s=new dt(st),o=new dt(nt)})),i(()=>u(void 0,null,function*(){yield s.teardown(),yield o.teardown()})),e("SuccessTest",()=>{t("evaluate a roll from action data",()=>u(void 0,null,function*(){let l={"data.action.test":"SuccessTest",type:"action","data.action.type":"simple","data.action.attribute":"body","data.action.skill":"automatics","data.action.spec":!1,"data.action.limit":{base:1,value:1,attribute:"physical"},"data.action.threshold":{base:1,value:1},"data.action.damage":{ap:{value:5,base:5,mod:Array(0)},attribute:"",base:5,base_formula_operator:"add",element:{value:"",base:""},itemSource:{actorId:"",itemId:"",itemType:"",itemName:""},mod:[],type:{value:"physical",base:"physical"},value:5}},c=yield o.create(l),d={type:"character","data.attributes.body.base":5,"data.skills.active.automatics.base":45},p=yield s.create(d),g=yield W.fromItem(c,p);g||a.strictEqual(!0,!1),g&&(yield g.evaluate(),console.error(g.data),a.strictEqual(g.pool.value,50),a.strictEqual(g.threshold.value,1),a.strictEqual(g.limit.value,4),a.strictEqual(g.netHits.value,3),a.strictEqual(g.hasReducedHits,!0),a.strictEqual(g.hasThreshold,!0),a.strictEqual(g.hasLimit,!0))})),t("evaluate a roll from simple pool data",()=>u(void 0,null,function*(){let l=W.fromPool({pool:10});yield l.evaluate(),a.strictEqual(l.pool.value,10)})),t("evaluate an opposed roll from a opposed action",()=>u(void 0,null,function*(){let l={type:"action","data.action.test":"SuccessTest","data.action.type":"simple","data.action.attribute":"body","data.action.skill":"automatics","data.action.spec":!1,"data.action.limit":{base:1,value:1,attribute:"physical"},"data.action.threshold":{base:1,value:1},"data.action.opposed":{type:"custom",test:"OpposedTest",attribute:"reaction",attribute2:"intuition",skill:"",mod:0,description:""}},c=yield o.create(l),d={type:"character","data.attributes.body.base":5,"data.skills.active.automatics.base":45},p=yield s.create(d),g=yield W.fromItem(c,p);g&&(yield g.toMessage())}))}),e("OpposedTest",()=>{})};var Yo=n=>{let{describe:e,it:t,assert:a,should:r,before:i,after:s}=n,o,l;i(()=>u(void 0,null,function*(){o=new dt(st),l=new dt(nt)})),s(()=>u(void 0,null,function*(){yield o.teardown(),yield l.teardown()})),e("InventoryFlow testing",()=>{t("create a new inventory and know of its existance",()=>u(void 0,null,function*(){let c=yield o.create({type:"character"});yield c.inventory.create("test"),a.deepEqual(c.data.data.inventories,{test:{name:"test",label:"test",itemIds:[]}}),a.strictEqual(c.inventory.exists("test"),!0)})),t("remove an inventory",()=>u(void 0,null,function*(){let c={test:{name:"test",label:"test",itemIds:[]}},d=yield o.create({type:"character","data.inventories":c});yield d.inventory.remove("test"),a.deepEqual(d.data.data.inventories,{})})),t("add and remove an item to and from an inventory",()=>u(void 0,null,function*(){let c={test:{name:"test",label:"test",itemIds:[]}},d=yield o.create({type:"character","data.inventories":c}),p=yield d.createEmbeddedDocuments("Item",[{type:"weapon",name:"Test Weapon"}]);yield d.inventory.addItems("test",p);let g=p.map(y=>y.id);a.deepEqual(d.data.data.inventories.test.itemIds,g),yield d.inventory.removeItem(p[0]),a.deepEqual(d.data.data.inventories.test.itemIds,[])})),t("rename an existing inventory",()=>u(void 0,null,function*(){let c={test:{name:"test",label:"test",itemIds:["asd"]}},d=yield o.create({type:"character","data.inventories":c});yield d.inventory.rename("test","betterTest"),a.deepEqual(d.data.data.inventories,{betterTest:{name:"betterTest",label:"betterTest",itemIds:["asd"]}})}))})};var Qo=()=>{!quench||(console.warn("Shadowrun 5e | Be aware that FoundryVTT will tank in update performance when a lot of documents are in collections. This is the case if you have all Chummer items imported and might cause tests to cross the 2000ms quench timeout threshold. Clear those collections in a test world. :)"),quench.registerBatch("shadowrun5e.rules.matrix",jo,{displayName:"SHADOWRUN5e: Matrix Test"}),quench.registerBatch("shadowrun5e.rules.modifiers",Ho,{displayName:"SHADOWRUN5e: Modifiers Test"}),quench.registerBatch("shadowrun5e.entities.items",$o,{displayName:"SHADOWRUN5e: SR5Item Test"}),quench.registerBatch("shadowrun5e.entities.actors",Go,{displayName:"SHADOWRUN5e: SR5Actor Test"}),quench.registerBatch("shadowrun5e.entities.effects",Wo,{displayName:"SHADOWRUN5e: SR5ActiveEffect Test"}),quench.registerBatch("shadowrun5e.data_prep.actor",zo,{displayName:"SHADOWRUN5e: SR5ActorDataPreparation Test"}),quench.registerBatch("shadowrun5e.flow.networkDevices",Xo,{displayName:"SHADOWRUN5e: Matrix Network Devices Test"}),quench.registerBatch("shadowrun5e.flow.inventory",Yo,{displayName:"SHADOWRUN5e: InventoryFlow Test"}),quench.registerBatch("shadowrun5e.flow.tests",Ko,{displayName:"SHADOWRUN5e: SuccessTest Test"}))};var Ke=class extends DocumentSheet{constructor(t,a,r){super(t,a);this.skillId=r}get document(){return super.document}_updateString(){return`data.skills.active.${this.skillId}`}static get defaultOptions(){let t=super.defaultOptions;return mergeObject(t,{id:"skill-editor",classes:["sr5","sheet","skill-edit-window"],template:"systems/shadowrun5e/dist/templates/apps/skill-edit.html",width:300,height:"auto",submitOnClose:!0,submitOnChange:!0,closeOnSubmit:!1,resizable:!0})}get title(){let t=this.document.getSkillLabel(this.skillId);return`${game.i18n.localize("SR5.EditSkill")} - ${game.i18n.localize(t)}`}_onUpdateObject(t,a,r){let i=a["data.name"],s=a["data.attribute"],o=a["data.base"],l=a["data.canDefault"],c=/data\.specs\.(\d+)/,d=Object.entries(a).reduce((S,[M,L])=>{let R=M.match(c);return R&&R[0]&&S.push(L),S},[]),p=/data\.bonus\.(\d+).key/,g=/data\.bonus\.(\d+).value/,y=Object.entries(a).reduce((S,[M,L])=>{let R=M.match(p),F=M.match(g);if(R&&R[0]&&R[1]){let D=R[1];S[D]===void 0&&(S[D]={}),S[D].key=L}else if(F&&F[0]&&F[1]){let D=F[1];S[D]===void 0&&(S[D]={}),S[D].value=L}return S},[]);r[this._updateString()]={specs:d,bonus:y,name:i,attribute:s,canDefault:l},t.currentTarget.name==="data.base"&&(r[this._updateString()].base=o)}_updateObject(t,a){return u(this,null,function*(){if(t.currentTarget){let r={};this._onUpdateObject(t,a,r),yield this.document.update(r)}})}activateListeners(t){super.activateListeners(t),$(t).find(".add-spec").on("click",this._addNewSpec.bind(this)),$(t).find(".remove-spec").on("click",this._removeSpec.bind(this)),$(t).find(".add-bonus").on("click",this._addNewBonus.bind(this)),$(t).find(".remove-bonus").on("click",this._removeBonus.bind(this))}_addNewBonus(t){return u(this,null,function*(){t.preventDefault();let a={},r=this.getData().data;if(!r)return;let{bonus:i=[]}=r;a[`${this._updateString()}.bonus`]=[...i,{key:"",value:0}],yield this.document.update(a)})}_removeBonus(t){return u(this,null,function*(){t.preventDefault();let a={},r=this.getData().data;if(r!=null&&r.bonus){let{bonus:i}=r,s=t.currentTarget.dataset.spec;s>=0&&(i.splice(s,1),a[`${this._updateString()}.bonus`]=i,yield this.document.update(a))}})}_addNewSpec(t){return u(this,null,function*(){t.preventDefault();let a={},r=this.getData().data;if(r!=null&&r.specs){let{specs:i}=r;a[`${this._updateString()}.specs`]=[...i,""]}yield this.document.update(a)})}_removeSpec(t){return u(this,null,function*(){t.preventDefault();let a={},r=this.getData().data;if(r!=null&&r.specs){let{specs:i}=r,s=t.currentTarget.dataset.spec;s>=0&&(i.splice(s,1),a[`${this._updateString()}.specs`]=i,yield this.document.update(a))}})}_getSkillAttributesForSelect(){return ut(J({},q.attributes),{"":""})}_allowSkillNameEditing(){let t=this.document.getSkill(this.skillId);return!!(!(t!=null&&t.name)&&!(t!=null&&t.label)||(t==null?void 0:t.name)&&!(t!=null&&t.label))}getData(){let t=super.getData(),a=t.data;return t.data=a?getProperty(a,this._updateString()):{},t.editable_name=this._allowSkillNameEditing(),t.editable_canDefault=!0,t.editable_attribute=!0,t.attributes=this._getSkillAttributesForSelect(),t}};var pa=class extends Ke{_updateString(){return`data.skills.language.value.${this.skillId}`}getData(){return mergeObject(super.getData(),{editable_name:!0,editable_canDefault:!1,editable_attribute:!1})}_onUpdateObject(e,t,a){super._onUpdateObject(e,t,a);let r=t["data.name"],i=a[this._updateString()]||{};a[this._updateString()]=ut(J({},i),{name:r})}};var Kr=class extends pa{constructor(t,a,r,i){super(t,a,r);this.category=i}_updateString(){return`data.skills.knowledge.${this.category}.value.${this.skillId}`}};var fa=class extends It{constructor(e,t,a){let r=fa.getDialogData(e,t);super(r,a)}static get defaultOptions(){let e=super.defaultOptions;return e.id="move-inventory-application",e.classes=["sr5","form-dialog"],e.height="auto",e}static getDialogData(e,t){let a=Object.values(e.data.data.inventories).filter(r=>r.name!==t);return t!==e.defaultInventory.name&&a.unshift(e.defaultInventory),{title:game.i18n.localize("SR5.MoveInventoryDialog.Title"),buttons:{move:{label:game.i18n.localize("SR5.MoveInventoryDialog.Move")},cancel:{label:game.i18n.localize("SR5.MoveInventoryDialog.Cancel")}},default:"cancel",templateData:{inventories:a},templatePath:"systems/shadowrun5e/dist/templates/apps/dialogs/move-inventory-dialog.html",onAfterClose:r=>u(this,null,function*(){return r.find('input[name="inventories"]:checked').val()})}}};var Yr=class{constructor(){ge(this,"parseAttName",e=>{if(e.toLowerCase()==="bod")return"body";if(e.toLowerCase()==="agi")return"agility";if(e.toLowerCase()==="rea")return"reaction";if(e.toLowerCase()==="str")return"strength";if(e.toLowerCase()==="cha")return"charisma";if(e.toLowerCase()==="int")return"intuition";if(e.toLowerCase()==="log")return"logic";if(e.toLowerCase()==="wil")return"willpower";if(e.toLowerCase()==="edg")return"edge";if(e.toLowerCase()==="mag")return"magic";if(e.toLowerCase()==="res")return"resonance"});ge(this,"getArray",e=>Array.isArray(e)?e:[e]);ge(this,"parseAttBaseValue",e=>e.name.toLowerCase()==="edg"?parseInt(e.base):parseInt(e.total))}update(e,t){let a=duplicate(e);return t.alias?a.name=t.alias:a.name=t.name?t.name:"[Name not found]",this.importBasicData(a.data,t),this.importBio(a.data,t),this.importAttributes(a.data,t),this.importInitiative(a.data,t),this.importSkills(a.data,t),a}importBasicData(e,t){try{if(t.playername&&(e.player_name=t.playername),t.alias&&(e.name=t.alias),t.metatype&&(e.metatype=t.metatype),t.sex&&(e.sex=t.sex),t.age&&(e.age=t.age),t.height&&(e.height=t.height),t.weight&&(e.weight=t.weight),t.calculatedstreetcred&&(e.street_cred=t.calculatedstreetcred),t.calculatednotoriety&&(e.notoriety=t.calculatednotoriety),t.calculatedpublicawareness&&(e.public_awareness=t.calculatedpublicawareness),t.karma&&(e.karma.value=t.karma),t.totalkarma&&(e.karma.max=t.totalkarma),t.technomancer&&t.technomancer.toLowerCase()==="true"&&(e.special="resonance"),t.magician&&t.magician.toLowerCase()==="true"||t.adept&&t.adept.toLowerCase()==="true"){e.special="magic";let a=[];t.tradition&&t.tradition.drainattribute&&t.tradition.drainattribute.attr?a=t.tradition.drainattribute.attr:t.tradition&&t.tradition.drainattributes&&(a=t.tradition.drainattributes.split("+").map(r=>r.trim())),a.forEach(r=>{this.parseAttName(r)!=="willpower"&&(e.magic.attribute=r)})}t.totaless&&(e.attributes.essence.value=t.totaless),t.nuyen&&(e.nuyen=parseInt(t.nuyen.replace(",","")))}catch(a){console.error(`Error while parsing character information ${a}`)}}importBio(e,t){e.description.value="",t.description&&(e.description.value+=TextEditor.enrichHTML(t.description+"<br/>")),t.background&&(e.description.value+=TextEditor.enrichHTML(t.background+"<br/>")),t.concept&&(e.description.value+=TextEditor.enrichHTML(t.concept+"<br/>")),t.notes&&(e.description.value+=TextEditor.enrichHTML(t.notes+"<br/>"))}importAttributes(e,t){t.attributes[1].attribute.forEach(r=>{try{let i=this.parseAttName(r.name);i&&(e.attributes[i].base=this.parseAttBaseValue(r))}catch(i){console.error(`Error while parsing attributes ${i}`)}})}importInitiative(e,t){try{e.modifiers.meat_initiative=t.initbonus,e.modifiers.meat_initiative_dice=t.initdice-1}catch(a){console.error(`Error while parsing initiative ${a}`)}}importSkills(e,t){let a=t.skills.skill;for(let r=0;r<a.length;r++)try{let i=a[r];if(i.rating>0&&i.islanguage){let s="active",o=null;if(i.islanguage&&i.islanguage.toLowerCase()==="true"){let l=randomID(16);o={},e.skills.language.value[l]=o,s="language"}else if(i.knowledge&&i.knowledge.toLowerCase()==="true"){let l=randomID(16),c=i.skillcategory_english;o={};let d;if(c){let p=c.toLowerCase();p==="street"&&(d=e.skills.knowledge.street.value),p==="academic"&&(d=e.skills.knowledge.academic.value),p==="professional"&&(d=e.skills.knowledge.professional.value),p==="interest"&&(d=e.skills.knowledge.interests.value),d&&(d[l]=o)}else i.attribute.toLowerCase()==="int"&&(e.skills.knowledge.street.value[l]=o),i.attribute.toLowerCase()==="log"&&(e.skills.knowledge.professional.value[l]=o);s="knowledge"}else{let l=i.name.toLowerCase().trim().replace(/\s/g,"_").replace(/-/g,"_");l.includes("exotic")&&l.includes("_weapon")&&(l=l.replace("_weapon","")),l==="pilot_watercraft"&&(l="pilot_water_craft"),o=e.skills.active[l]}o?(s!=="active"&&(o.name=i.name),o.base=parseInt(i.rating),i.skillspecializations&&(o.specs=this.getArray(i.skillspecializations.skillspecialization.name)),Ri(o)):console.error(`Couldn't parse skill ${i.name}`)}}catch(i){console.error(i)}}};var Qr=n=>{let e=/(-?[0-9]+)(?:([0-9]+))*/g;return n.match(e)||["0"]},vt=n=>Array.isArray(n)?n:[n],kt=n=>{let e=P.descriptionData();return n.source&&n.page&&(e.source=`${n.source} ${n.page}`),n.description&&(e.value=TextEditor.enrichHTML(n.description)),e},Ee=n=>{let e=P.technologyData();return n.rating&&(e.rating=n.rating),n.avail&&(e.availability=n.avail),n.qty&&(e.quantity=n.qty),n.cost&&(e.cost=parseFloat(n.cost.replace(/[^\d\.\-]/g,""))),n.equipped&&n.equipped.toLowerCase()==="true"&&(e.equipped=!0),n.conditionmonitor&&(e.condition_monitor.max=Number(n.conditionmonitor)),n.conceal&&(e.conceal.base=Number(n.conceal)),e},Ct=(n,e,t)=>({name:n,_id:"",folder:"",flags:{},img:"icons/svg/mystery-man.svg",type:e,data:t,permission:{default:2}});var Qt=class{parse(e){let t=this.getDefaultData();return t.name=e.name,e.extra&&(t.name+=` (${e.extra})`),t.data.technology=Ee(e),t.data.description=kt(e),t}getDefaultData(){return{name:"",type:"equipment",data:P.equipmentData()}}};var Jr=class extends Qt{parse(e){let t=super.parse(e);if(t.type="sin",e.children){let a=[];Array.isArray(e.children.gear)?a.push(...e.children.gear):a.push(e.children.gear),t.data.licenses=this.parseLicenses(a)}return t}parseLicenses(e){let t=[];return e.forEach(a=>{a.category==="ID/Credsticks"&&t.push({name:a.extra,rtg:a.rating,description:""})}),t}};var Zr=class extends Qt{parse(e){let t=super.parse(e);return t.type="device",t.data.technology.rating=e.devicerating,t.data.atts={att1:{value:e.attack,att:"attack"},att2:{value:e.sleaze,att:"sleaze"},att3:{value:e.dataprocessing,att:"data_processing"},att4:{value:e.firewall,att:"firewall"}},e.category==="Cyberdecks"&&(t.data.category="cyberdeck"),e.category==="Commlinks"&&(t.data.category="commlink"),e.category==="Rigger Command Consoles"&&(t.data.category="commlink"),t}};var ti=class extends Qt{parse(e){let t=super.parse(e);return t.type="program",e.category==="Common Programs"?t.data.type="common_program":e.category==="Hacking Programs"?t.data.type="hacking_program":e.category==="Software"&&(t.data.type="agent"),t}};var ei=class extends Qt{parse(e){let t=super.parse(e);return t.type="ammo",e.weaponbonusap&&(t.data.ap=parseInt(e.weaponbonusap)),e.weaponbonusdamage&&(t.data.damage=parseInt(e.weaponbonusdamage),e.weaponbonusdamage.includes("P")?t.data.damageType="physical":e.weaponbonusdamage.includes("S")?t.data.damageType="stun":e.weaponbonusdamage.includes("M")?t.data.damageType="matrix":t.data.damageType="physical"),t}};var ai=class{select(e){return e.issin==="True"?new Jr:e.iscommlink==="True"?new Zr:e.isammo==="True"?new ei:e.category==="Common Programs"||e.category==="Hacking Programs"||e.category==="Software"?new ti:new Qt}};var ri=class{parseGears(e){let t=[];return e.forEach(a=>{try{if(!this.gearShouldBeParsed(a))return;let r=this.parseGearEntry(a);t.push(r)}catch(r){console.error(r)}}),t}parseGearEntry(e){return new ai().select(e).parse(e)}gearShouldBeParsed(e){let t=e.name_english.toLowerCase();return!(t.startsWith("grenade")||t.startsWith("minigrenade")||t.startsWith("rocket"))}};var ii=class{parseArmors(e){let t=vt(e.armors.armor),a=[];return t.forEach(r=>{try{let i=this.parseArmor(r);a.push(i)}catch(i){console.error(i)}}),a}parseArmor(e){let t={},a={};t.armor=a;let r="";if(a.mod=e.armor.includes("+"),a.value=parseInt(e.armor.replace("+","")),e.description&&(r=e.description),console.log(e),e.armormods&&e.armormods.armormod){a.fire=0,a.electricity=0,a.cold=0,a.acid=0,a.radiation=0;let i=[];vt(e.armormods.armormod).forEach(o=>{o.name.toLowerCase().includes("fire resistance")?a.fire+=parseInt(o.rating):o.name.toLowerCase().includes("nonconductivity")?a.electricity+=parseInt(o.rating):o.name.toLowerCase().includes("insulation")?a.cold+=parseInt(o.rating):o.name.toLowerCase().includes("radiation shielding")&&(a.radiation+=parseInt(o.rating)),o.rating!==""?i.push(`${o.name} R${o.rating}`):i.push(o.name)}),i.length>0&&(r=`${i.join(",")}

${r}`)}return t.technology=Ee(e),t.description=kt(e),Ct(e.name,"armor",t)}};var ni=class{parseCyberwares(e){let t=vt(e.cyberwares.cyberware),a=[];return t.forEach(r=>{try{let i=this.parseCyberware(r);a.push(i)}catch(i){console.error(i)}}),a}parseCyberware(e){let t={};return t.description=kt(e),t.technology=Ee(e),t.technology.equipped=!0,t.essence=e.ess,t.grade=e.grade,Ct(e.name,"cyberware",t)}};var si=class{parseQualities(e){let t=vt(e.qualities.quality),a=[];return t.forEach(r=>{try{let i=this.parseQuality(r);a.push(i)}catch(i){console.error(i)}}),a}parseQuality(e){let t=P.qualityData();return t.type=e.qualitytype.toLowerCase(),t.description=kt(e),Ct(e.name,"quality",t)}};var oi=class{parsePowers(e){let t=vt(e.powers.power),a=[];return t.forEach(r=>{let i=this.parsePower(r);a.push(i)}),a}parsePower(e){let t={};return t.description=kt(e),t.level=parseInt(e.rating),t.pp=parseFloat(e.totalpoints),Ct(e.fullname,"adept_power",t)}};var li=class{parseSpells(e){let t=vt(e.spells.spell),a=[];return t.forEach(r=>{try{if(r.alchemy.toLowerCase()!=="true"){let i=this.parseSpell(r);a.push(i)}}catch(i){console.error(i)}}),a}parseSpell(e){let t={},a={};a.action=t,a.category=e.category.toLowerCase().replace(/\s/g,"_"),a.name=e.name,a.type=e.type==="M"?"mana":"physical",a.range=e.range==="T"?"touch":e.range.toLowerCase().replace(/\s/g,"_").replace("(","").replace(")",""),a.drain=parseInt(e.dv.replace("F","")),a.description=kt(e);let r="";if(e.descriptors&&(r=e.descriptors),e.description&&(r+=`
${e.description}`),a.description.value=TextEditor.enrichHTML(r),e.duration.toLowerCase()==="s"?a.duration="sustained":e.duration.toLowerCase()==="i"?a.duration="instant":e.duration.toLowerCase()==="p"&&(a.duration="permanent"),t.type="varies",t.skill="spellcasting",t.attribute="magic",t.damage=P.damageData(),t.damage.type.base="",t.damage.type.value="",e.descriptors){let i=e.descriptors.toLowerCase();e.category.toLowerCase()==="combat"&&(a.combat={},i.includes("indirect")?(a.combat.type="indirect",t.opposed={type:"defense"}):(a.combat.type="direct",a.type==="mana"?(t.damage.type.base="stun",t.damage.type.value="stun",t.opposed={type:"soak",attribute:"willpower"}):a.type==="physical"&&(t.damage.type.base="physical",t.damage.type.value="physical",t.opposed={type:"soak",attribute:"body"}))),e.category.toLowerCase()==="detection"&&(a.detection={},i.split(",").forEach(o=>{o=o||"",o=o.replace(" detection spell",""),o&&(o.includes("area")||(o.includes("passive")?a.detection.passive=!0:o.includes("active")?a.detection.passive=!1:o&&(a.detection.type=o.toLowerCase())))}),a.detection.passive||(t.opposed={type:"custom",attribute:"willpower",attribute2:"logic"})),e.category.toLowerCase()==="illusion"&&(a.illusion={},i.split(",").forEach(o=>{o=o||"",o=o.replace(" illusion spell",""),o&&(o.includes("area")||(o.includes("sense")?a.illusion.sense=o.toLowerCase():o&&(a.illusion.type=o.toLowerCase())))}),a.type==="mana"?t.opposed={type:"custom",attribute:"willpower",attribute2:"logic"}:t.opposed={type:"custom",attribute:"intuition",attribute2:"logic"}),e.category.toLowerCase()==="manipulation"&&(a.manipulation={},i.includes("environmental")&&(a.manipulation.environmental=!0),i.includes("physical")&&(a.manipulation.physical=!0),i.includes("mental")&&(a.manipulation.mental=!0),a.manipulation.mental&&(t.opposed={type:"custom",attribute:"willpower",attribute2:"logic"}),a.manipulation.physical&&(t.opposed={type:"custom",attribute:"body",attribute2:"strength"}))}return Ct(e.name,"spell",a)}};var ci=class{constructor(){ge(this,"parseDamage",e=>{let t={damage:0,type:"physical",radius:0,dropoff:0},a=e.split(",");if(a.length>0){let r=a[0].match(/(\d+)(\w+)/);r&&r[1]&&(t.damage=parseInt(r[1])),r&&r[2]&&(t.type=r[2]==="P"?"physical":"stun")}for(let r=1;r<a.length;r++){let i=a[r].match(/(-?\d+)(.*)/);i&&i[2]&&(i[2].toLowerCase().includes("/m")?t.dropoff=parseInt(i[1]):t.radius=parseInt(i[1]))}return t})}parseWeapons(e){let t=vt(e.weapons.weapon),a=[];return t.forEach(r=>{try{let i=this.parseWeapon(r);a.push(i)}catch(i){console.error(i)}}),a}parseWeapon(e){let t={},a={},r={};if(a.damage=r,t.action=a,t.description=kt(e),t.technology=Ee(e),r.ap={base:parseInt(Qr(e.ap)[0])},a.type="varies",e.skill?a.skill=e.skill.toLowerCase().replace(/\s/g,"_"):e.category&&e.category.toLowerCase().includes("exotic")?a.skill=e.category.toLowerCase().replace(" weapons","").replace(/\s/g,"_"):e.category&&e.category.toLowerCase().includes("laser weapons")&&(a.skill="exotic_range"),a.skill.includes("exotic")&&(a.skill=a.skill.replace("_weapon","")),a.attribute="agility",a.limit={base:parseInt(Qr(e.accuracy)[0])},a.opposed={type:"defense"},e.type.toLowerCase()==="melee"){a.type="complex",t.category="melee";let s={};t.melee=s,s.reach=parseInt(e.reach)}else if(e.type.toLowerCase()==="ranged"){t.category="range",a.skill.toLowerCase().includes("throw")&&(t.category="thrown");let s={};if(t.range=s,s.rc={base:parseInt(Qr(e.rc)[0])},e.mode){let o=e.mode.toLowerCase();s.modes={single_shot:o.includes("ss"),semi_auto:o.includes("sa"),burst_fire:o.includes("bf"),full_auto:o.includes("fa")}}e.clips!=null&&e.clips.clip!=null&&(Array.isArray(e.clips.clip)?e.clips.clip:[e.clips.clip]).forEach(l=>{console.log(l)}),e.ranges&&e.ranges.short&&e.ranges.medium&&e.ranges.long&&e.ranges.extreme&&(console.log(e.ranges),s.ranges={short:parseInt(e.ranges.short.split("-")[1]),medium:parseInt(e.ranges.medium.split("-")[1]),long:parseInt(e.ranges.long.split("-")[1]),extreme:parseInt(e.ranges.extreme.split("-")[1])})}else e.type.toLowerCase()==="thrown"&&(t.category="thrown");{let s=this.parseDamage(e.damage_english);if(r.base=s.damage,r.type={},r.type.base=s.type,s.dropoff||s.radius){let o={};t.thrown=o,o.blast={radius:s.radius,dropoff:s.dropoff}}}return Ct(e.name,"weapon",t)}};var di=class{parseLifestyles(e){let t=vt(e.lifestyles.lifestyle),a=[];return t.forEach(r=>{try{let i=this.parseLifestyle(r);a.push(i)}catch(i){console.error(i)}}),a}parseLifestyle(e){let t={},a=e.baselifestyle.toLowerCase();a in q.lifestyleTypes?t.type=a:a==="luxury"?t.type="luxory":t.type="other",t.cost=e.totalmonthlycost,t.permanent=e.purchased,t.description=kt(e);let r=e.name?e.name:e.baselifestyle;return Ct(r,"lifestyle",t)}};var mi=class{parseContacts(e){let t=vt(e.contacts.contact),a=[];return t.forEach(r=>{try{let i=this.parseContact(r);a.push(i)}catch(i){console.error(i)}}),a}parseContact(e){let t={};t.type=e.role,e.connection.toLowerCase().includes("group")?t.connection=e.connection.toLowerCase().replace("group(","").replace(")",""):t.connection=e.connection,t.loyalty=e.loyalty,t.family=e.family.toLowerCase()==="true",t.blackmail=e.blackmail.toLowerCase()==="true",t.description=kt(e);let a=e.name?e.name:"[Unnamed connection]";return Ct(a,"contact",t)}};var pi=class{parse(e,t){let a=[];if(t.qualities&&e.qualities&&e.qualities.quality){let r=new si().parseQualities(e);Array.prototype.push.apply(a,r)}if(t.weapons&&e.weapons!=null&&e.weapons.weapon!=null){let r=new ci().parseWeapons(e);Array.prototype.push.apply(a,r)}if(t.armor&&e.armors&&e.armors.armor){let r=new ii().parseArmors(e);Array.prototype.push.apply(a,r)}if(t.cyberware&&e.cyberwares&&e.cyberwares.cyberware){let r=new ni().parseCyberwares(e);Array.prototype.push.apply(a,r)}if(t.powers&&e.powers&&e.powers.power){let r=new oi().parsePowers(e);Array.prototype.push.apply(a,r)}if(t.equipment&&e.gears&&e.gears.gear){let r=vt(e.gears.gear),i=new ri().parseGears(r);Array.prototype.push.apply(a,i)}if(t.spells&&e.spells&&e.spells.spell){let r=new li().parseSpells(e);Array.prototype.push.apply(a,r)}if(t.contacts&&e.contacts&&e.contacts.contact){let r=new mi().parseContacts(e);Array.prototype.push.apply(a,r)}if(t.lifestyles&&e.lifestyles&&e.lifestyles.lifestyle){let r=new di().parseLifestyles(e);Array.prototype.push.apply(a,r)}return a}};var fi=class{importChummerCharacter(e,t,a){return u(this,null,function*(){if(console.log("Importing the following character file content:"),console.log(t),console.log("Using the following import options:"),console.log(a),!t.characters||!t.characters.character){console.log("Did not find a valid character to import  - aborting import");return}let r=t.characters.character,i=new Yr().update(e.data,r),s=new pi().parse(r,a);yield e.update(i),yield e.createEmbeddedDocuments("Item",s)})}};var hi=class extends FormApplication{static get defaultOptions(){let e=super.defaultOptions;return e.id="chummer-import",e.classes=["shadowrun5e"],e.title="Chummer/Hero Lab Import",e.template="systems/shadowrun5e/dist/templates/apps/import.html",e.width=600,e.height="auto",e}getData(){return{}}activateListeners(e){e.find(".submit-chummer-import").click(t=>u(this,null,function*(){var s;t.preventDefault();let a=JSON.parse($(".chummer-text").val()),r={weapons:$(".weapons").is(":checked"),armor:$(".armor").is(":checked"),cyberware:$(".cyberware").is(":checked"),equipment:$(".gear").is(":checked"),qualities:$(".qualities").is(":checked"),powers:$(".powers").is(":checked"),spells:$(".spells").is(":checked"),contacts:$(".contacts").is(":checked"),lifestyles:$(".lifestyles").is(":checked")};yield new fi().importChummerCharacter(this.object,a,r),(s=ui.notifications)==null||s.info("Complete! Check everything. Notably: Ranged weapon mods and ammo; Strength based weapon damage; Specializations on all spells, powers, and weapons;"),this.close()}))}};var Pa=-1,Jo=(n,e)=>n.name>e.name?1:n.name<e.name?-1:0,fc=(n,e)=>{var r,i,s,o;let t=(i=(r=n.data)==null?void 0:r.technology)==null?void 0:i.equipped,a=(o=(s=e.data)==null?void 0:s.technology)==null?void 0:o.equipped;return t&&!a?-1:a&&!t||n.name>e.name?1:n.name<e.name?-1:0},hc=(n,e)=>n.data.type==="positive"&&e.data.type==="negative"?-1:n.data.type==="negative"&&e.data.type==="positive"?1:n.name<e.name?-1:1,_t=class extends ActorSheet{constructor(...t){super(...t);this._shownDesc=[];this._filters={skills:"",showUntrainedSkills:!0};this.selectedInventory=this.document.defaultInventory.name}getHandledItemTypes(){return["action"]}getInventoryItemTypes(){return[]}getForbiddenItemTypes(){return[]}static get defaultOptions(){return mergeObject(super.defaultOptions,{classes:["sr5","sheet","actor"],width:905,height:690,tabs:[{navSelector:".tabs",contentSelector:".sheetbody",initial:"skills"}]})}get template(){let t="systems/shadowrun5e/dist/templates";return this.actor.limited?`${t}/actor-limited/${this.actor.data.type}.html`:`${t}/actor/${this.actor.data.type}.html`}getData(){let t=super.getData();return t=ut(J({},t),{data:t.data.data}),t.config=q,t.filters=this._filters,this._prepareActorAttributes(t),this._prepareActorModifiers(t),this._prepareActorTypeFields(t),this._prepareSpecialFields(t),this._prepareSkillsWithFilters(t),t.itemType=this._prepareItemTypes(t),t.effects=Za(this.document.effects),t.inventories=this._prepareItemsInventory(),t.inventory=this._prepareSelectedInventory(t.inventories),t.hasInventory=this._prepareHasInventory(t.inventories),t.selectedInventory=this.selectedInventory,t}activateListeners(t){super.activateListeners(t),w.setupCustomCheckbox(this,t),t.find(".effect-control").on("click",a=>Ja(a,this.document)),t.find(".item-create").on("click",this._onItemCreate.bind(this)),t.find(".item-edit").on("click",this._onItemEdit.bind(this)),t.find(".item-delete").on("click",this._onItemDelete.bind(this)),t.find(".item-qty").on("change",this._onListItemChangeQuantity.bind(this)),t.find(".item-rtg").on("change",this._onListItemChangeRating.bind(this)),t.find(".item-equip-toggle").on("click",this._onListItemToggleEquipped.bind(this)),t.find(".hidden").hide(),t.find(".has-desc").on("click",this._onListItemToggleDescriptionVisibility.bind(this)),t.find(".item-roll").on("click",this._onItemRoll.bind(this)),t.find(".Roll").on("click",this._onRoll.bind(this)),t.find(".inventory-inline-create").on("click",this._onInventoryCreate.bind(this)),t.find(".inventory-remove").on("click",this._onInventoryRemove.bind(this)),t.find(".inventory-edit").on("click",this._onInplaceInventoryEdit.bind(this)),t.find(".inventory-input-cancel").on("click",this._onInplaceInventoryEditCancel.bind(this)),t.find(".inventory-input-save").on("click",this._onInplaceInventoryEditSave.bind(this)),t.find("input#input-inventory").on("keydown",this._onInplaceInventoryEditCancel.bind(this)),t.find("input#input-inventory").on("keydown",this._onInplaceInventoryEditSave.bind(this)),t.find("#select-inventory").on("change",this._onSelectInventory.bind(this)),t.find(".inventory-item-move").on("click",this._onItemMoveToInventory.bind(this)),t.find(".horizontal-cell-input .cell").on("click",this._onSetConditionTrackCell.bind(this)),t.find(".horizontal-cell-input .cell").on("contextmenu",this._onClearConditionTrack.bind(this)),t.find(".marks-qty").on("change",this._onMarksQuantityChange.bind(this)),t.find(".marks-add-one").on("click",a=>u(this,null,function*(){return this._onMarksQuantityChangeBy(a,1)})),t.find(".marks-remove-one").on("click",a=>u(this,null,function*(){return this._onMarksQuantityChangeBy(a,-1)})),t.find(".marks-delete").on("click",this._onMarksDelete.bind(this)),t.find(".marks-clear-all").on("click",this._onMarksClearAll.bind(this)),t.find(".skill-header").find(".item-name").on("click",this._onFilterUntrainedSkills.bind(this)),t.find(".skill-header").find(".skill-spec-item").on("click",this._onFilterUntrainedSkills.bind(this)),t.find(".skill-header").find(".rtg").on("click",this._onFilterUntrainedSkills.bind(this)),t.find("#filter-skills").on("input",this._onFilterSkills.bind(this)),t.find(".skill-edit").on("click",this._onShowEditSkill.bind(this)),t.find(".knowledge-skill-edit").on("click",this._onShowEditKnowledgeSkill.bind(this)),t.find(".language-skill-edit").on("click",this._onShowEditLanguageSkill.bind(this)),t.find(".add-knowledge").on("click",this._onAddKnowledgeSkill.bind(this)),t.find(".add-language").on("click",this._onAddLanguageSkill.bind(this)),t.find(".add-active").on("click",this._onAddActiveSkill.bind(this)),t.find(".remove-knowledge").on("click",this._onRemoveKnowledgeSkill.bind(this)),t.find(".remove-language").on("click",this._onRemoveLanguageSkill.bind(this)),t.find(".remove-active").on("click",this._onRemoveActiveSkill.bind(this)),t.find(".attribute-roll").on("click",this._onRollAttribute.bind(this)),t.find(".cell-input-roll").on("click",this._onRollCellInput.bind(this)),t.find(".skill-roll").on("click",this._onRollSkill.bind(this)),t.find(".knowledge-skill").on("click",this._onRollSkill.bind(this)),t.find(".language-skill").on("click",this._onRollSkill.bind(this)),t.find(".skill-spec-roll").on("click",this._onRollSkillSpec.bind(this)),t.find(".show-hidden-skills").on("click",this._onShowHiddenSkills.bind(this)),t.find(".open-source-pdf").on("click",this._onOpenSourcePDF.bind(this)),t.find(".list-item").each(this._addDragSupportToListItemTemplatePartial.bind(this)),t.find(".import-character").on("click",this._onShowImportCharacter.bind(this)),t.find(".reload-ammo").on("click",this._onReloadAmmo.bind(this)),t.find(".matrix-att-selector").on("change",this._onMatrixAttributeSelected.bind(this))}_addInventoryItemTypes(t){let a=this.getInventoryItemTypes();for(let r of Object.keys(t.types))a.includes(r)||t.types[r].items.length===0&&delete t.types[r];return t}_addInventoryTypes(t){for(let a of this.getInventoryItemTypes())t.types.hasOwnProperty(a)||(t.types[a]={type:a,label:q.itemTypes[a],items:[]})}_onDragStart(t){return u(this,null,function*(){var i,s;let a={actorId:this.actor.id,sceneId:this.actor.isToken?(i=canvas.scene)==null?void 0:i.id:null,tokenId:this.actor.isToken?(s=this.actor.token)==null?void 0:s.id:null,type:"",data:{}},r=t.currentTarget;switch(r.dataset.itemType){case"skill":a.type="Skill",a.data={skillId:r.dataset.itemId,skill:this.actor.getSkill(r.dataset.itemId)},t.dataTransfer.setData("text/plain",JSON.stringify(a));return;case"knowledgeskill":let o=r.dataset.itemId.includes(".")?r.dataset.itemId.split(".")[0]:r.dataset.itemId;a.type="Skill",a.data={skillId:o,skill:this.actor.getSkill(o)},t.dataTransfer.setData("text/plain",JSON.stringify(a));return;default:return Y(_t.prototype,this,"_onDragStart").call(this,t)}})}_onDrop(t){return u(this,null,function*(){if(t.preventDefault(),t.stopPropagation(),!t.dataTransfer)return;let a=yield Y(_t.prototype,this,"_onDrop").call(this,t);if(Array.isArray(a)){let r=a.filter(i=>i instanceof nt);yield this.document.inventory.addItems(this.selectedInventory,r)}return a})}_render(...t){return u(this,null,function*(){let a=this._saveInputCursorPosition();this._saveScrollPositions(),yield Y(_t.prototype,this,"_render").call(this,...t),this._restoreScrollPositions(),this._restoreInputCursorPosition(a)})}_saveInputCursorPosition(){let t=$(this.element).find("input:focus");return t.length?t[0]:null}_restoreInputCursorPosition(t){if(t&&t.name){if(!this.form)return;let a=this.form[t.name];if(a){if(a.focus(),["checkbox","radio"].includes(a.type))return;a.setSelectionRange&&a.setSelectionRange(t.selectionStart,t.selectionEnd)}}}_saveScrollPositions(){let t=this._findActiveList();t.length&&(this._scroll=t.prop("scrollTop"))}_restoreScrollPositions(){let t=this._findActiveList();t.length&&this._scroll!=null&&t.prop("scrollTop",this._scroll)}_findActiveList(){return $(this.element).find(".tab.active .scroll-area")}_onItemCreate(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t),r={name:`New ${a}`,type:a},i=yield this.actor.createEmbeddedDocuments("Item",[r],{renderSheet:!0});!i||this.selectedInventory!==this.document.defaultInventory.name&&(yield this.document.inventory.addItems(this.selectedInventory,i))})}_onItemEdit(t){return u(this,null,function*(){var i;t.preventDefault();let a=w.listItemId(t),r=this.actor.items.get(a);r&&(yield(i=r.sheet)==null?void 0:i.render(!0))})}_onItemDelete(t){return u(this,null,function*(){if(t.preventDefault(),!(yield w.confirmDeletion()))return;let r=w.listItemId(t),i=this.actor.items.get(r);if(!!i)return yield this.actor.inventory.removeItem(i),yield this.actor.deleteEmbeddedDocuments("Item",[r])})}_onItemRoll(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t),r=this.actor.items.get(a);r&&(yield r.castAction(t))})}_onRoll(t){return u(this,null,function*(){var s;t.preventDefault();let a=(s=$(t.currentTarget).data())==null?void 0:s.rollId;a=a!=null?a:$(t.currentTarget).parent(".RollId").data().rollId;let r=a.split("."),i={event:t};switch(r[0]){case"prompt-roll":yield this.actor.promptRoll();break;case"armor":yield this.actor.rollGeneralAction("armor",i);break;case"fade":yield this.actor.rollGeneralAction("fade",i);break;case"drain":yield this.actor.rollGeneralAction("drain",i);break;case"defense":yield this.actor.rollGeneralAction("physical_defense",i);break;case"damage-resist":yield this.actor.rollGeneralAction("physical_damage_resist",i);break;case"composure":yield this.actor.rollGeneralAction("composure",i);break;case"judge-intentions":yield this.actor.rollGeneralAction("judge_intentions",i);break;case"lift-carry":yield this.actor.rollGeneralAction("lift_carry",i);break;case"memory":yield this.actor.rollGeneralAction("memory",i);break;case"vehicle-stat":console.log("roll vehicle stat",a);break;case"drone":switch(r[1]){case"perception":yield this.actor.rollDronePerception(i);break;case"infiltration":yield this.actor.rollDroneInfiltration(i);break;case"pilot-vehicle":yield this.actor.rollPilotVehicle(i);break}break;case"attribute":{let c=r[1];c&&(yield this.actor.rollAttribute(c,i));break}case"skill":{let c=r[2];yield this.actor.rollSkill(c,i);break}case"matrix":switch(r[1]){case"attribute":let c=r[2];yield this.actor.rollAttribute(c,i);break;case"device-rating":yield this.actor.rollDeviceRating(i);break}break}})}_onSetConditionTrackCell(t){return u(this,null,function*(){t.preventDefault();let a=Number(t.currentTarget.dataset.value),r=$(t.currentTarget).closest(".horizontal-cell-input").data().id,i={};if(r==="stun"||r==="physical"){let s=`data.track.${r}.value`;i[s]=a}else if(r==="edge"){let s="data.attributes.edge.uses";i[s]=a}else if(r==="overflow"){let s="data.track.physical.overflow.value";i[s]=a}else if(r==="matrix"){let s=this.actor.getMatrixDevice();if(s&&!isNaN(a)){let o={};o["data.technology.condition_monitor.value"]=a,yield s.update(o)}else{let o="data.track.matrix.value";i[o]=a}}yield this.actor.update(i)})}_onClearConditionTrack(t){return u(this,null,function*(){t.preventDefault();let a=$(t.currentTarget).closest(".horizontal-cell-input").data().id,r={};if(a==="stun")r["data.track.stun.value"]=0;else if(a==="physical")r["data.track.physical.value"]=0,r["data.track.physical.overflow.value"]=0;else if(a==="edge")r["data.attributes.edge.uses"]=0;else if(a==="overflow")r["data.track.physical.overflow.value"]=0;else if(a==="matrix"){let i=this.actor.getMatrixDevice();if(i){let s={};s["data.technology.condition_monitor.value"]=0,yield i.update(s)}else r["data.track.matrix.value"]=0}yield this.actor.update(r)})}_prepareSpecialFields(t){let{modifiers:a}=t.data;t.awakened=t.data.special==="magic",t.emerged=t.data.special==="resonance",t.woundTolerance=3+(Number(a.wound_tolerance)||0)}_prepareActorModifiers(t){let{modifiers:a}=t.data;for(let[r,i]of Object.entries(a))i===0&&(a[r]="")}_prepareActorAttributes(t){let a=t.data.attributes;for(let[,r]of Object.entries(a))r.hidden||r.temp===0&&delete r.temp}_prepareMatrixAttributes(t){let{matrix:a}=t.data;if(a){let r=i=>{let s=a[i];s&&(s.mod||(s.mod=[]),s.temp===0&&delete s.temp)};["firewall","data_processing","sleaze","attack"].forEach(i=>r(i))}}_prepareItemsInventory(){let t={},a={};t[this.document.defaultInventory.name]={name:this.document.defaultInventory.name,label:this.document.defaultInventory.label,types:{}},this._addInventoryTypes(t[this.document.defaultInventory.name]),Object.values(this.document.data.data.inventories).forEach(({name:i,label:s,itemIds:o})=>{t[i]={name:i,label:s,types:{}},this._addInventoryTypes(t[i]),o.forEach(l=>{a[l]&&console.warn(`Shadowrun5e | Item id ${l} has been added to both ${i} and ${a[l]}. Will only show in ${i}`),a[l]=i})});let r=this.getHandledItemTypes();return this.document.items.forEach(i=>{if(r.includes(i.type))return;let s=this._prepareSheetItem(i),o=a[i.id]||this.document.defaultInventory.name,l=t[o];l.types[i.type]||(l.types[i.type]={type:i.type,label:q.itemTypes[i.type],items:[]}),l.types[i.type].items.push(s)}),Object.values(t).forEach(i=>{this._addInventoryItemTypes(i),Object.values(i.types).forEach(s=>{s.items.sort(Jo)})}),t}_prepareSelectedInventory(t){return t[this.selectedInventory]}_prepareHasInventory(t){if(this.getInventoryItemTypes().length>0)return!0;for(let a of Object.values(t))if(Object.keys(a.types).length>0)return!0;return!1}_prepareSheetItem(t){let a=t.toObject(),r=t.getChatData();return a.description=r.description,a.properties=r.properties,a}_prepareItemTypes(t){let a={};return Object.keys(CONFIG.Item.typeLabels).forEach(r=>{a[r]=[]}),this.document.items.forEach(r=>{let i=this._prepareSheetItem(r);a[i.type].push(i)}),Object.entries(a).forEach(([r,i])=>{switch(r){case"quality":i.sort(hc);break;case"program":i.sort(fc);break;default:i.sort(Jo);break}}),a}_prepareActorTypeFields(t){t.isCharacter=this.actor.isCharacter(),t.isSpirit=this.actor.isSpirit(),t.isCritter=this.actor.isCritter(),t.hasSkills=this.actor.hasSkills,t.hasSpecial=this.actor.hasSpecial,t.hasFullDefense=this.actor.hasFullDefense}_onMarksQuantityChange(t){return u(this,null,function*(){var c;if(t.stopPropagation(),this.object.isIC()&&this.object.hasHost())return(c=ui.notifications)==null?void 0:c.info(game.i18n.localize("SR5.Infos.CantModifyHostContent"));let a=t.currentTarget.dataset.markId;if(!a)return;let r=w.getMarkIdDocuments(a);if(!r)return;let{scene:i,target:s,item:o}=r;if(!i||!s)return;let l=parseInt(t.currentTarget.value);yield this.object.setMarks(s,l,{scene:i,item:o,overwrite:!0})})}_onMarksQuantityChangeBy(t,a){return u(this,null,function*(){var c;if(t.stopPropagation(),this.object.isIC()&&this.object.hasHost())return(c=ui.notifications)==null?void 0:c.info(game.i18n.localize("SR5.Infos.CantModifyHostContent"));let r=t.currentTarget.dataset.markId;if(!r)return;let i=w.getMarkIdDocuments(r);if(!i)return;let{scene:s,target:o,item:l}=i;!s||!o||(yield this.object.setMarks(o,a,{scene:s,item:l}))})}_onMarksDelete(t){return u(this,null,function*(){var i;if(t.stopPropagation(),this.object.isIC()&&this.object.hasHost())return(i=ui.notifications)==null?void 0:i.info(game.i18n.localize("SR5.Infos.CantModifyHostContent"));let a=t.currentTarget.dataset.markId;!a||!(yield w.confirmDeletion())||(yield this.object.clearMark(a))})}_onMarksClearAll(t){return u(this,null,function*(){var r;if(t.stopPropagation(),this.object.isIC()&&this.object.hasHost())return(r=ui.notifications)==null?void 0:r.info(game.i18n.localize("SR5.Infos.CantModifyHostContent"));!(yield w.confirmDeletion())||(yield this.object.clearMarks())})}_prepareSkillsWithFilters(t){this._filterActiveSkills(t),this._filterKnowledgeSkills(t),this._filterLanguageSkills(t)}_filterSkills(t,a){let r={};for(let[i,s]of Object.entries(a))s.hidden||this._showSkill(i,s,t)&&(r[i]=s);return w.sortSkills(r)}_showSkill(t,a,r){return this._showMagicSkills(t,a,r)||this._showResonanceSkills(t,a,r)?!0:this._showGeneralSkill(t,a)}_showGeneralSkill(t,a){return!this._isSkillMagic(t,a)&&!this._isSkillResonance(a)&&this._isSkillFiltered(t,a)}_showMagicSkills(t,a,r){return this._isSkillMagic(t,a)&&r.data.special==="magic"&&this._isSkillFiltered(t,a)}_showResonanceSkills(t,a,r){return this._isSkillResonance(a)&&r.data.special==="resonance"&&this._isSkillFiltered(t,a)}_isSkillFiltered(t,a){let r=this._getSkillLabelOrName(a).length>0,i=!this._doesSkillContainText(t,a,this._filters.skills),s=!this._filters.showUntrainedSkills&&a.value===0;return!(r&&(s||i))}_getSkillLabelOrName(t){return w.getSkillLabelOrName(t)}_doesSkillContainText(t,a,r){if(!r)return!0;let i=this._getSkillLabelOrName(a),s=a.name===void 0?t:"",o=a.specs!==void 0&&Array.isArray(a.specs)?a.specs.join(" "):"";return`${s} ${i} ${o}`.toLowerCase().search(r.toLowerCase())>-1}_filterKnowledgeSkills(t){Object.keys(q.knowledgeSkillCategories).forEach(a=>{if(!t.data.skills.knowledge.hasOwnProperty(a)){console.warn(`Knowledge Skill doesn't provide configured category ${a}`);return}t.data.skills.knowledge[a].value=this._filterSkills(t,t.data.skills.knowledge[a].value)})}_filterLanguageSkills(t){t.data.skills.language.value=this._filterSkills(t,t.data.skills.language.value)}_filterActiveSkills(t){t.data.skills.active=this._filterSkills(t,t.data.skills.active)}_isSkillMagic(t,a){return a.attribute==="magic"||t==="astral_combat"||t==="assensing"}_isSkillResonance(t){return t.attribute==="resonance"}_onFilterUntrainedSkills(t){return u(this,null,function*(){t.preventDefault(),this._filters.showUntrainedSkills=!this._filters.showUntrainedSkills,yield this.render()})}_onFilterSkills(t){return u(this,null,function*(){this._filters.skills=t.currentTarget.value,yield this.render()})}_onRollSkill(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t);return this.actor.rollSkill(a,{event:t})})}_onRollSkillSpec(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t);return this.actor.rollSkill(a,{event:t,specialization:!0})})}_onShowEditSkill(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t);yield this._showSkillEditForm(Ke,this.actor,{event:t},a)})}_showSkillEditForm(t,a,r,...i){return u(this,null,function*(){yield this._closeOpenSkillApp();let s=new t(a,r,...i);Pa=s.appId,yield s.render(!0)})}_onShowEditKnowledgeSkill(t){t.preventDefault();let[a,r]=w.listItemId(t).split(".");this._showSkillEditForm(Kr,this.actor,{event:t},a,r)}_onShowEditLanguageSkill(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t);yield this._showSkillEditForm(pa,this.actor,{event:t},a)})}_closeOpenSkillApp(){return u(this,null,function*(){Pa!==-1&&(ui.windows[Pa]&&(yield ui.windows[Pa].close()),Pa=-1)})}_onAddLanguageSkill(t){return u(this,null,function*(){t.preventDefault(),yield this.actor.addLanguageSkill({name:""})})}_onRemoveLanguageSkill(t){return u(this,null,function*(){if(t.preventDefault(),!(yield w.confirmDeletion()))return;let r=w.listItemId(t);yield this.actor.removeLanguageSkill(r)})}_onAddKnowledgeSkill(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t);yield this.actor.addKnowledgeSkill(a)})}_onRemoveKnowledgeSkill(t){return u(this,null,function*(){if(t.preventDefault(),!(yield w.confirmDeletion()))return;let[r,i]=w.listItemId(t).split(".");yield this.actor.removeKnowledgeSkill(r,i)})}_onAddActiveSkill(t){return u(this,null,function*(){t.preventDefault();let a=yield this.actor.addActiveSkill();!a||(yield this._showSkillEditForm(Ke,this.actor,{event:t},a))})}_onRemoveActiveSkill(t){return u(this,null,function*(){if(t.preventDefault(),!(yield w.confirmDeletion()))return;let r=w.listItemId(t);yield this.actor.removeActiveSkill(r)})}_onRollAttribute(t){return u(this,null,function*(){t.preventDefault();let a=t.currentTarget.closest(".attribute").dataset.attribute;return this.actor.rollAttribute(a,{event:t})})}_onRollCellInput(t){return u(this,null,function*(){switch(t.preventDefault(),$(t.currentTarget).closest(".horizontal-cell-input").data().id){case"stun":yield this.actor.rollGeneralAction("natural_recovery_stun",{event:t});break;case"physical":yield this.actor.rollGeneralAction("natural_recovery_physical",{event:t});break;case"edge":yield this.actor.rollAttribute("edge",{event:t});break}})}_onShowHiddenSkills(t){return u(this,null,function*(){t.preventDefault(),yield this.actor.showHiddenSkills()})}_onOpenSourcePDF(t){return u(this,null,function*(){t.preventDefault();let a=$(t.currentTarget).parents(".list-item"),r=$(a).data().itemId,i=this.actor.items.get(r);i&&(yield i.openPdfSource())})}_addDragSupportToListItemTemplatePartial(t,a){a.dataset&&a.dataset.itemId&&(a.setAttribute("draggable",!0),a.addEventListener("dragstart",this._onDragStart.bind(this),!1))}_onListItemChangeQuantity(t){return u(this,null,function*(){let a=w.listItemId(t),r=this.actor.items.get(a),i=parseInt(t.currentTarget.value);r&&i&&"technology"in r.data.data&&(r.data.data.technology.quantity=i,yield r.update({"data.technology.quantity":i}))})}_onListItemChangeRating(t){return u(this,null,function*(){let a=w.listItemId(t),r=this.actor.items.get(a),i=parseInt(t.currentTarget.value);r&&i&&(yield r.update({"data.technology.rating":i}))})}_onListItemToggleEquipped(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t),r=this.actor.items.get(a);if(r){let i=[];if(r.isDevice())for(let s of this.actor.items.filter(o=>o.isDevice()))i.push({_id:s.id,"data.technology.equipped":s.id===a});else i.push({_id:a,"data.technology.equipped":!r.isEquipped()});yield this.actor.updateEmbeddedDocuments("Item",i),this.actor.render(!1)}})}_onListItemToggleDescriptionVisibility(t){return u(this,null,function*(){t.preventDefault();let a=$(t.currentTarget).parents(".list-item"),r=$(a).data().item,i=a.next();i.toggle(),r&&(i.is(":visible")?this._shownDesc.push(r):this._shownDesc=this._shownDesc.filter(s=>s!==r))})}_onInventoryCreate(t){return u(this,null,function*(){t.preventDefault(),$("#input-inventory").val(""),yield this._onInplaceInventoryEdit(t,"create")})}_onInventoryRemove(t){return u(this,null,function*(){t.preventDefault(),(yield w.confirmDeletion())&&(yield this.document.inventory.remove(this.selectedInventory),this.selectedInventory=this.document.defaultInventory.name,this.render())})}_onInplaceInventoryEdit(t,a="edit"){return u(this,null,function*(){var r;if(t.preventDefault(),a==="edit"&&this.selectedInventory===this.document.defaultInventory.name)return(r=ui.notifications)==null?void 0:r.warn(game.i18n.localize("SR5.Warnings.CantEditDefaultInventory"));$(".selection-inventory").hide(),$(".inline-input-inventory").show(),$("#input-inventory").data("action",a).select()})}_onInplaceInventoryEditCancel(t){return u(this,null,function*(){t.type==="keydown"&&t.code!=="Escape"||(t.preventDefault(),$(".selection-inventory").show(),$(".inline-input-inventory").hide(),$("#input-inventory").data("action",void 0).val(this.selectedInventory))})}_onInplaceInventoryEditSave(t){return u(this,null,function*(){if(t.type==="keydown"&&t.code!=="Enter")return;t.preventDefault();let a=$("#input-inventory"),r=a.data("action"),i=String(a.val());if(!!i){switch(r){case"edit":yield this.document.inventory.rename(this.selectedInventory,i);break;case"create":yield this.document.inventory.create(i);break}yield this._onInplaceInventoryEditCancel(t),this.selectedInventory=i,this.render()}})}_onSelectInventory(t){return u(this,null,function*(){t.preventDefault();let a=String($(t.currentTarget).val());a&&(this.selectedInventory=a),this.render()})}_onItemMoveToInventory(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t),r=this.document.items.get(a);if(!r)return;let i=new fa(this.document,this.selectedInventory),s=yield i.select();i.canceled||(yield this.document.inventory.addItems(s,r))})}_onReloadAmmo(t){return u(this,null,function*(){t.preventDefault();let a=w.listItemId(t),r=this.actor.items.get(a);if(r)return r.reloadAmmo()})}_onMatrixAttributeSelected(t){return u(this,null,function*(){if(!("matrix"in this.actor.data.data))return;let a=this.actor.data.data.matrix.device,r=this.actor.items.get(a);if(!r){console.error("could not find item");return}let i=t.currentTarget.dataset.att,s=t.currentTarget.value,o=r.data.data,l=o.atts[s].att,c={_id:a};for(let d=1;d<=4;d++){let p=`att${d}`,g=`data.atts.att${d}.att`;p===s?c[g]=i:o.atts[`att${d}`].att===i&&(c[g]=l)}yield this.actor.updateEmbeddedDocuments("Item",[c])})}_onShowImportCharacter(t){t.preventDefault();let a={name:"chummer-import",title:"Chummer Import"};new hi(this.actor,a).render(!0)}_setupCustomCheckbox(t){let a=r=>{let i=$(r).children("input[type=checkbox]"),s=$(r).children(".checkmark");$(i).prop("checked")?($(s).addClass("fa-check-circle"),$(s).removeClass("fa-circle")):($(s).addClass("fa-circle"),$(s).removeClass("fa-check-circle"))};t.find("label.checkbox").each(function(){a(this)}),t.find("label.checkbox").click(r=>a(r.currentTarget)),t.find(".submit-checkbox").change(r=>this._onSubmit(r))}};var ha=class extends _t{getHandledItemTypes(){return super.getHandledItemTypes()}getData(){let e=super.getData();return e.host=this.object.getICHost(),e.markedDocuments=this.object.getAllMarkedDocuments(),e.disableMarksEdit=this.object.hasHost(),e}activateListeners(e){super.activateListeners(e),e.find(".entity-remove").on("click",this._removeHost.bind(this))}_removeHost(e){return u(this,null,function*(){e.stopPropagation(),yield this.object.removeICHost()})}_onDrop(e){return u(this,null,function*(){if(e.preventDefault(),e.stopPropagation(),!e.dataTransfer)return;let t=JSON.parse(e.dataTransfer.getData("text/plain"));switch(t.type){case"Item":return yield this.object.addICHost(t.id)}return Y(ha.prototype,this,"_onDrop").call(this,e)})}};var Oa=class extends ActiveEffect{get isOriginOwned(){if(!this.data.origin)return!1;let e=this.data.origin.split(".");return e[0]==="Scene"&&e.length===6||e[0]==="Actor"&&e.length===4}get source(){return this.data.origin?fromUuid(this.data.origin):null}renderSourceSheet(){return u(this,null,function*(){var t;let e=yield this.source;return(t=e==null?void 0:e.sheet)==null?void 0:t.render(!0)})}toggleDisabled(){return u(this,null,function*(){return this.update({disabled:!this.data.disabled})})}disable(e){return u(this,null,function*(){return this.update({disabled:e})})}_applyCustom(e,t){return this._applyModify(e,t)}_applyModify(e,t){if(this._isKeyModifiableValue(e,t.key))return foundry.utils.getProperty(e.data,t.key).mod.push({name:this.data.label,value:Number(t.value)}),null;let a=t.key.split(".");a.pop();let r=a.join(".");return this._isKeyModifiableValue(e,r)?(foundry.utils.getProperty(e.data,r).mod.push({name:this.data.label,value:Number(t.value)}),null):super._applyAdd(e,t)}_applyOverride(e,t){if(this._isKeyModifiableValue(e,t.key)){let i=foundry.utils.getProperty(e.data,t.key);return i.override={name:this.data.label,value:Number(t.value)},i.value=t.value,null}let a=t.key.split(".");a.pop();let r=a.join(".");if(this._isKeyModifiableValue(e,r)){let i=foundry.utils.getProperty(e.data,r);return i.override={name:this.data.label,value:Number(t.value)},null}return super._applyOverride(e,t)}_isKeyModifiableValue(e,t){let a=foundry.utils.getProperty(e.data,t),r=foundry.utils.getType(a);return a&&r==="Object"&&w.objectHasKeys(a,this.minValueKeys)}get minValueKeys(){return["value","mod"]}};var gi=class extends ActiveEffectConfig{get template(){return"systems/shadowrun5e/dist/templates/effect/active-effect-config.html"}getData(e){let t=super.getData(e);return t.modes=ut(J({},t.modes),{0:game.i18n.localize("SR5.ActiveEffect.Modes.Modify")}),t}};var ga=class extends _t{getHandledItemTypes(){return[...super.getHandledItemTypes(),"program"]}getInventoryItemTypes(){return[...super.getInventoryItemTypes(),"weapon","ammo","armor","bioware","cyberware","device","equipment","modification"]}getData(){let e=super.getData();return e.vehicle=this._prepareVehicleFields(),e}activateListeners(e){super.activateListeners(e),e.find(".driver-remove").on("click",this._handleRemoveVehicleDriver.bind(this))}_onDrop(e){return u(this,null,function*(){if(e.preventDefault(),e.stopPropagation(),!e.dataTransfer)return;let t=JSON.parse(e.dataTransfer.getData("text/plain"));switch(t.type){case"Actor":return yield this.actor.addVehicleDriver(t.id)}return Y(ga.prototype,this,"_onDrop").call(this,e)})}_prepareVehicleFields(){return{driver:this.actor.getVehicleDriver()}}_handleRemoveVehicleDriver(e){return u(this,null,function*(){e.preventDefault(),yield this.actor.removeVehicleDriver()})}};var yi=class extends _t{getHandledItemTypes(){return[...super.getHandledItemTypes(),"program","sin","lifestyle","contact","spell","adept_power","complex_form","quality","critter_power"]}getInventoryItemTypes(){return[...super.getInventoryItemTypes(),"weapon","ammo","armor","bioware","cyberware","device","equipment","modification"]}getData(){let e=super.getData();return super._prepareMatrixAttributes(e),e.markedDocuments=this.object.getAllMarkedDocuments(),e}};var bi=class extends _t{getHandledItemTypes(){return[...super.getHandledItemTypes(),"critter_power","spell","quality"]}};var wi=class extends _t{getHandledItemTypes(){return[...super.getHandledItemTypes(),"sprite_power"]}};var Di=class{static defenseReachModifier(e,t){return t-e}};var Jt=class extends at{constructor(t,a,r){super(t,a,r);let i=t.against?W._getTestClass(t.against.type):at;this.against=new i(t.against||{})}_prepareData(t,a){return t=super._prepareData(t,a),delete t.opposed,delete t.targetActorsUuid,t}populateDocuments(){return u(this,null,function*(){yield Y(Jt.prototype,this,"populateDocuments").call(this),yield this.against.populateDocuments()})}static _getOpposedActionTestData(t,a,r){return u(this,null,function*(){if(!t.opposed){console.error("Shadowrun 5e | Supplied test data doesn't contain an opposed action",t,this);return}if(t.opposed.type!==""&&console.warn(`Shadowrun 5e | Supplied test defines a opposed test type ${t.opposed.type} but only type '' is supported`,this),!a){console.error("Shadowrun 5e | Can't resolve opposed test values due to missing actor",this);return}let i={title:t.opposed.description||void 0,previousMessageId:r,pool:P.valueData({label:"SR5.DicePool"}),limit:P.valueData({label:"SR5.Limit"}),threshold:P.valueData({label:"SR5.Threshold"}),values:{},sourceItemUuid:t.sourceItemUuid,against:t};i.threshold.base=t.values.netHits.value;let s=P.actionData();if(s=W._mergeMinimalActionDataInOrder(s,t.opposed,this._getDefaultTestAction()),t.sourceItemUuid){let o=yield fromUuid(t.sourceItemUuid);if(o){let l=yield this._getDocumentTestAction(o,a);s=W._mergeMinimalActionDataInOrder(s,l)}}return yield this._prepareActionTestData(s,a,i)})}get opposed(){return!1}get opposing(){return!0}get canBeExtended(){return!1}get _canShowDescription(){return!1}get _canPlaceBlastTemplate(){return!1}prepareItemModifiers(){return u(this,null,function*(){if(!this.item)return;let t=this.item.getOpposedTestMod();for(let a of t.list)O.AddUniquePart(this.data.modifiers.mod,a.name,a.value,!0)})}static _castOpposedAction(t){return u(this,null,function*(){t.preventDefault();let a=$(t.currentTarget),i=a.closest(".chat-message").data("messageId"),s=a.data("action"),o=!W.shouldHideDialog(t);yield W.fromMessageAction(i,s,{showDialog:o})})}static chatMessageListeners(t,a,r){return u(this,null,function*(){a.find(".opposed-action").on("click",Jt._castOpposedAction)})}};var ya=class extends Jt{_prepareData(t,a){t=super._prepareData(t,a);let r=t.against?t.against.damage:P.damageData();return t.incomingDamage=foundry.utils.duplicate(r),t.modifiedDamage=foundry.utils.duplicate(r),t}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/defense-test-message.html"}get successLabel(){return"SR5.AttackDodged"}get failureLabel(){return"SR5.AttackHits"}get hasChangedInitiative(){return this.data.iniMod!==void 0}get initiativeModifier(){return this.data.iniMod||0}};var me=class extends ya{_prepareData(t,a){return t=super._prepareData(t,a),t.cover=0,t.activeDefense="",t.activeDefenses={},t.isMeleeAttack=!1,t.defenseReach=0,t}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/physical-defense-test-dialog.html"}static _getDefaultTestAction(){return P.minimalActionData({attribute:"reaction",attribute2:"intuition"})}get testModifiers(){return["global","wounds","defense"]}prepareDocumentData(){return u(this,null,function*(){this.prepareActiveDefense(),this.prepareMeleeReach()})}prepareActiveDefense(){var r,i,s;if(!this.actor)return;let t=this.actor;this.data.activeDefenses={full_defense:{label:"SR5.FullDefense",value:(r=t.getFullDefenseAttribute())==null?void 0:r.value,initMod:-10},dodge:{label:"SR5.Dodge",value:(i=t.findActiveSkill("gymnastics"))==null?void 0:i.value,initMod:-5},block:{label:"SR5.Block",value:(s=t.findActiveSkill("unarmed_combat"))==null?void 0:s.value,initMod:-5}},t.getEquippedWeapons().filter(o=>o.isMeleeWeapon()).forEach(o=>{var l;this.data.activeDefenses[`parry-${o.name}`]={label:"SR5.Parry",weapon:o.name||"",value:(l=t.findActiveSkill(o.getActionSkill()))==null?void 0:l.value,initMod:-5}})}prepareMeleeReach(){if(!this.against.item||(this.data.isMeleeAttack=this.against.item.isMeleeWeapon(),!this.data.isMeleeAttack)||!this.actor)return;this.actor.getEquippedWeapons().filter(s=>s.isMeleeWeapon()).forEach(s=>{this.data.defenseReach=Math.max(this.data.defenseReach,s.getReach())});let r=this.against.data.reach||0,i=this.data.defenseReach;this.data.defenseReach=Di.defenseReachModifier(r,i)}applyPoolModifiers(){this.applyPoolCoverModifier(),this.applyPoolActiveDefenseModifier(),this.applyPoolMeleeReachModifier(),super.applyPoolModifiers()}applyPoolCoverModifier(){this.data.cover=foundry.utils.getType(this.data.cover)==="string"?Number(this.data.cover):this.data.cover,O.AddUniquePart(this.data.modifiers.mod,"SR5.Cover",this.data.cover)}applyPoolActiveDefenseModifier(){let t=this.data.activeDefenses[this.data.activeDefense]||{label:"SR5.ActiveDefense",value:0,init:0};O.AddUniquePart(this.data.modifiers.mod,"SR5.ActiveDefense",t.value)}applyPoolMeleeReachModifier(){!this.data.isMeleeAttack||O.AddUniquePart(this.data.modifiers.mod,"SR5.WeaponReach",this.data.defenseReach)}get success(){return wt.attackMisses(this.against.hits.value,this.hits.value)}get failure(){return wt.attackHits(this.against.hits.value,this.hits.value)}processSuccess(){return u(this,null,function*(){this.data.modifiedDamage=wt.modifyDamageAfterMiss(this.data.incomingDamage),yield Y(me.prototype,this,"processSuccess").call(this)})}processFailure(){return u(this,null,function*(){this.data.modifiedDamage=wt.modifyDamageAfterHit(this.against.hits.value,this.hits.value,this.data.incomingDamage),yield Y(me.prototype,this,"processFailure").call(this)})}afterFailure(){return u(this,null,function*(){let t=yield W.fromOpposedTestResistTest(this,this.data.options);!t||(yield t.execute())})}processResults(){return u(this,null,function*(){yield this.applyIniModFromActiveDefense(),yield Y(me.prototype,this,"processResults").call(this)})}applyIniModFromActiveDefense(){return u(this,null,function*(){if(!this.actor||!this.data.activeDefense)return;let t=this.data.activeDefenses[this.data.activeDefense];!t||(yield this.actor.changeCombatInitiative(t.initMod),this.data.iniMod=t.initMod)})}};var La=class extends at{_prepareData(t,a){return t=super._prepareData(t,a),t.fireModes={},t.fireMode={value:0,defense:0,label:""},t.ranges={},t.range=0,t.targetRanges=[],t.targetRangesSelected=0,t.recoilCompensation=0,t.damage=t.damage||P.damageData(),t}get canBeExtended(){return!1}_prepareFireMode(){var r,i;let t=(r=this.item)==null?void 0:r.asWeaponData();if(!t)return;let{modes:a}=t.data.range;a.single_shot&&(this.data.fireModes[1]=game.i18n.localize("SR5.WeaponModeSingleShotShort")),a.semi_auto&&(this.data.fireModes[1]=game.i18n.localize("SR5.WeaponModeSemiAutoShort"),this.data.fireModes[3]=game.i18n.localize("SR5.WeaponModeSemiAutoBurst")),a.burst_fire&&(this.data.fireModes[3]=`${a.semi_auto?`${game.i18n.localize("SR5.WeaponModeSemiAutoBurst")}/`:""}${game.i18n.localize("SR5.WeaponModeBurstFireShort")}`,this.data.fireModes[6]=game.i18n.localize("SR5.WeaponModeBurstFireLong")),a.full_auto&&(this.data.fireModes[6]=`${a.burst_fire?"LB/":""}${game.i18n.localize("SR5.WeaponModeFullAutoShort")}(s)`,this.data.fireModes[10]=`${game.i18n.localize("SR5.WeaponModeFullAutoShort")}(c)`,this.data.fireModes[20]=game.i18n.localize("SR5.Suppressing")),this.data.fireMode=((i=this.item)==null?void 0:i.getLastFireMode())||{value:0,defense:0,label:""}}_prepareWeaponRanges(){return u(this,null,function*(){var l;let t=(l=this.item)==null?void 0:l.asWeaponData();if(!t)return;let{ranges:a}=t.data.range,{range_modifiers:r}=K.combat.environmental,i={};for(let[c,d]of Object.entries(a)){let p=d;i[c]=w.createRangeDescription(q.weaponRanges[c],p,r[c])}this.data.ranges=i;let s=this.actor;if(!s)return;let o=yield s.getModifiers();this.data.range=o.environmental.active.range||0})}_prepareTargetRanges(){return u(this,null,function*(){var r;if(foundry.utils.isObjectEmpty(this.data.ranges)||!this.actor||!this.hasTargets)return;let t=this.actor.getToken();if(!t)return(r=ui.notifications)==null||r.warn(game.i18n.localize("SR5.TargetingNeedsActorWithToken")),[];console.log("asd"),this.data.targetRanges=this.targets.map(i=>{let s=w.measureTokenDistance(t,i),o=w.getWeaponRange(s,this.data.ranges);return{uuid:i.uuid,name:i.name||"",unit:Ha,range:o,distance:s}}),this.data.targetRanges=this.data.targetRanges.sort((i,s)=>i.distance<s.distance?-1:i.distance>s.distance?1:0);let a=yield this.actor.getModifiers();this.data.range=a.environmental.active.range||this.data.targetRanges[0].range.modifier})}_prepareRecoilCompensation(){var t;this.data.recoilCompensation=((t=this.item)==null?void 0:t.getRecoilCompensation(!0))||0}get testModifiers(){return["global","wounds","environmental"]}prepareDocumentData(){return u(this,null,function*(){yield this._prepareWeaponRanges(),yield this._prepareTargetRanges(),this._prepareFireMode(),this._prepareRecoilCompensation()})}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/ranged-attack-test-dialog.html"}_alterTestDataFromDialogData(){return u(this,null,function*(){var l;let{fireMode:t,fireModes:a}=this.data;t.value=Number(t.value||0);let r=a[t.value],i=w.mapRoundsToDefenseDesc(t.value);if(this.data.fireMode={label:r,value:t.value,defense:i},yield(l=this.item)==null?void 0:l.setLastFireMode(this.data.fireMode),this.hasTargets){let c=this.data.targetRanges[this.data.targetRangesSelected];this.data.range=c.range.modifier}this.data.range=Number(this.data.range);let s=this.actor;if(!s)return;let o=yield s.getModifiers();o.activateEnvironmentalCategory("range",this.data.range),yield s.setModifiers(o)})}prepareBaseValues(){if(!this.actor)return;let t=new O(this.data.modifiers.mod),{fireMode:a,recoilCompensation:r}=this.data,i=r-a.value;i<0?t.addUniquePart("SR5.Recoil",i):t.removePart("SR5.Recoil");let s=this.hasTargets?this.data.targetRanges[this.data.targetRangesSelected].range.modifier:this.data.range,o=Z.getModifiersFromEntity(this.actor);o.activateEnvironmentalCategory("range",Number(s));let l=o.environmental.total;t.addUniquePart(q.modifierTypes.environmental,l),super.prepareBaseValues()}};var Ce=class{static createDefenseDialog(e,t,a){return u(this,null,function*(){let r=Ce.getDefenseDialogData(e,t,a);return new It(r)})}static createSoakDialog(e,t){return u(this,null,function*(){let a=Ce.getSoakDialogData(e,t);return new It(a)})}static createSkillDialog(e,t,a){return u(this,null,function*(){let r=Ce.getSkillDialogData(e,t,a);return new It(r)})}static getDefenseDialogData(e,t,a){var y,S,M,L;let r=game.i18n.localize("SR5.Defense"),i={full_defense:{label:"SR5.FullDefense",value:(y=e.getFullDefenseAttribute())==null?void 0:y.value,initMod:-10},dodge:{label:"SR5.Dodge",value:(S=e.findActiveSkill("gymnastics"))==null?void 0:S.value,initMod:-5},block:{label:"SR5.Block",value:(M=e.findActiveSkill("unarmed_combat"))==null?void 0:M.value,initMod:-5}},s=e.getEquippedWeapons().filter(R=>R.isMeleeWeapon()),o=0;s.forEach(R=>{var F;i[`parry-${R.name}`]={label:"SR5.Parry",weapon:R.name,value:(F=e.findActiveSkill(R.getActionSkill()))==null?void 0:F.value,init:-5},o=Math.max(o,R.getReach())});let l=new O(a);if(e._addDefenseParts(l),(L=t.attack)!=null&&L.reach){let R=t.attack.reach,F=o-R;F!==0&&l.addUniquePart("SR5.Reach",F)}let c={continue:{label:game.i18n.localize("SR5.Continue"),callback:()=>{}}},d=R=>{let F=w.parseInputToNumber($(R).find("[name=cover]").val()),D=w.parseInputToString($(R).find("[name=activeDefense]").val()),h={};if(F&&l.addUniquePart("SR5.Cover",F),D){let m=i[D];l.addUniquePart(m.label,m.value),h.initiative=m.initMod}return{cover:F,special:D,parts:l,combat:h}},p="systems/shadowrun5e/dist/templates/rolls/roll-defense.html",g={parts:l.getMessageOutput(),cover:t.cover,activeDefenses:i};return{title:r,templateData:g,templatePath:p,buttons:c,onAfterClose:d}}static getSoakDialogData(e,t){let a=game.i18n.localize("SR5.DamageResistanceTest"),r="systems/shadowrun5e/dist/templates/rolls/roll-soak.html",i={damage:e==null?void 0:e.damage,parts:t.getMessageOutput(),elementTypes:q.elementTypes,damageTypes:q.damageTypes},s={continue:{label:game.i18n.localize("SR5.Continue"),callback:()=>{}}};return{title:a,templatePath:r,templateData:i,buttons:s,onAfterClose:l=>{let c=w.parseInputToNumber($(l).find("[name=incomingDamage]").val()),d=w.parseInputToNumber($(l).find("[name=ap]").val()),p=w.parseInputToString($(l).find("[name=element]").val()),g=w.parseInputToString($(l).find("[name=damageType]").val());return{incomingDamage:c,damageType:g,ap:d,element:p}}}}static getSkillDialogData(e,t,a){var g;let r=game.i18n.localize(t.skill.label||t.skill.name),i="systems/shadowrun5e/dist/templates/rolls/skill-roll.html",s=e.getAttributes(),o=e.getAttribute(t.attribute?t.attribute:t.skill.attribute),l=e.getLimits(),c={attribute:t.skill.attribute,attributes:w.filter(s,([,y])=>y.value>0),limit:o.limit,limits:l},d={roll:{label:game.i18n.localize("SR5.NormalSkillButton"),callback:()=>{}}};return(g=t.skill.specs)!=null&&g.length&&t.skill.specs.forEach(y=>d[y]={label:y,callback:()=>{}}),{title:r,templatePath:i,templateData:c,buttons:d,onAfterClose:(y,S)=>{let M=w.parseInputToString($(y).find('[name="attribute"]').val()),L=w.parseInputToString($(y).find('[name="attribute.limit"]').val()),R=e.getAttribute(M),F=e.getLimit(L),D=game.i18n.localize(t.skill.label||t.skill.name),h=game.i18n.localize(q.attributes[M]),m=game.i18n.localize("SR5.Test"),T=`${D} + ${h} ${m}`;return a.addUniquePart(R.label,R.value),Mt.handleDefaulting(t.skill,a),t.skill.specs.includes(S)&&a.addUniquePart("SR5.Specialization",2),{title:T,attribute:R,limit:F,skill:t.skill,parts:a}}}}};var Si=class{runSoakTest(r,i){return u(this,arguments,function*(e,t,a=[]){})}knocksDown(e,t){let a=this.isDamageFromGelRounds(e)?-2:0,r=this.isDamageFromImpactDispersion(e)?-2:0,s=t.getLimit("physical").value+a+r,o=e.value>s||e.value>=10;return console.log(`Shadowrun5e | Determined target ${t.id} knocked down status as: ${o}`,e,t),o}isDamageFromGelRounds(e){var t;if(e.source&&e.source.actorId&&e.source.itemId){let a=(t=game.actors)==null?void 0:t.find(r=>{var i;return r.id==((i=e.source)==null?void 0:i.actorId)});if(a){let r=a.items.find(i=>{var s;return i.id==((s=e.source)==null?void 0:s.itemId)});if(r)return r.items.filter(i=>{var s;return(s=i.getTechnologyData())==null?void 0:s.equipped}).filter(i=>i.name==game.i18n.localize("SR5.AmmoGelRounds")).length>0}}return!1}isDamageFromImpactDispersion(e){return!1}promptDamageData(e,t){return u(this,null,function*(){let a=yield Ce.createSoakDialog(e,t),r=yield a.select();if(a.canceled)return;let i=e!=null&&e.damage?e.damage:P.damageData();return this.updateDamageWithUserData(i,r.incomingDamage,r.damageType,r.ap,r.element)})}updateDamageWithUserData(e,t,a,r,i){let s=duplicate(e),o=w.calcTotal(s);if(o!==t){let c=t-o;s.mod=O.AddUniquePart(s.mod,"SR5.UserInput",c),s.value=w.calcTotal(s)}e.type.base!==a&&(s.type.base=a,s.type.value=a);let l=w.calcTotal(s.ap);if(l!==r){let c=r-l;s.ap.mod=O.AddUniquePart(s.ap.mod,"SR5.UserInput",c),s.ap.value=w.calcTotal(s.ap)}return i&&(s.element.value=i),s}};var _e=class extends at{_prepareData(t,a){var r;return t=super._prepareData(t,a),t.incomingDamage=foundry.utils.duplicate(((r=t.following)==null?void 0:r.modifiedDamage)||P.damageData()),t.modifiedDamage=duplicate(t.incomingDamage),t}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/defense-test-message.html"}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/physical-resist-test-dialog.html"}get canBeExtended(){return!1}static _getDefaultTestAction(){return P.minimalActionData({attribute:"body",armor:!0})}get testModifiers(){return["soak"]}applyPoolModifiers(){if(super.applyPoolModifiers(),this.data.action.armor&&this.actor){let t=foundry.utils.duplicate(this.actor.getArmor());t.mod=O.AddUniquePart(t.mod,"SR5.AP",this.data.incomingDamage.ap.value),w.calcTotal(t,{min:0}),this.data.pool.mod=O.AddUniquePart(this.data.pool.mod,"SR5.Armor",t.value)}}calculateBaseValues(){super.calculateBaseValues(),w.calcTotal(this.data.incomingDamage,{min:0}),w.calcTotal(this.data.incomingDamage.ap),this.data.modifiedDamage=foundry.utils.duplicate(this.data.incomingDamage),this.data.modifiedDamage.base=this.data.incomingDamage.value,this.data.modifiedDamage.mod=[],delete this.data.modifiedDamage.override,this.data.modifiedDamage.ap.base=this.data.incomingDamage.ap.value,this.data.modifiedDamage.ap.mod=[],delete this.data.modifiedDamage.ap.override,w.calcTotal(this.data.modifiedDamage),w.calcTotal(this.data.modifiedDamage.ap)}get canSucceed(){return!0}get success(){return this.data.incomingDamage.value<=this.hits.value}get successLabel(){return"SR5.ResistedAllDamage"}get failureLabel(){return"SR5.ResistedSomeDamage"}processResults(){return u(this,null,function*(){yield Y(_e.prototype,this,"processResults").call(this),this.actor&&(this.data.modifiedDamage=wt.modifyDamageAfterResist(this.actor,this.data.modifiedDamage,this.hits.value),this.data.knockedDown=new Si().knocksDown(this.data.modifiedDamage,this.actor))})}};var Fa=class extends at{_prepareData(t,a){return t=super._prepareData(t,a),t.damage=t.damage||P.damageData(),t}get canBeExtended(){return!1}get testModifiers(){return["global","wounds","environmental"]}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/melee-attack-test-dialog.html"}prepareDocumentData(){return u(this,null,function*(){!this.item||!this.item.isMeleeWeapon()||(this.data.reach=this.item.getReach())})}};var ba=class{static calculateDrain(e,t,a=!1){let r=a?this.recklessDrainModifier:0,i=e+t+r;return Math.max(this.minimalDrain,i)}static get minimalDrain(){return 2}static get recklessDrainModifier(){return 3}static calculateMinimalForce(e){return Math.max(1,this.minimalDrain-e)}static calculateLimit(e){return e}};var Pe=class{static calcDrainDamage(e,t,a,r){t<0&&(t=1),a<0&&(a=1),r<0&&(r=0);let i=P.damageData();return i.base=e,w.calcTotal(i,{min:0}),i.type.base=i.type.value=Pe.calcDrainDamageType(r,a),i}static calcDrainDamageType(e,t){return e<0&&(e=0),t<0&&(t=1),e>t?"physical":"stun"}static modifyDrainDamage(e,t){return t<0&&(t=0),e=foundry.utils.duplicate(e),O.AddUniquePart(e.mod,"SR5.Hits",-t),w.calcTotal(e,{min:0}),e}};var pe=class extends at{_prepareData(t,a){return t=super._prepareData(t,a),t.force=t.force||0,t.drain=t.drain||0,t.reckless=t.reckless||!1,t.drainDamage=t.drainDamage||P.damageData(),t}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/spellcasting-test-dialog.html"}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/spellcasting-test-message.html"}get canBeExtended(){return!1}static _getDefaultTestAction(){return P.minimalActionData({skill:"spellcasting",attribute:"magic"})}get testModifiers(){return["global","wounds"]}prepareDocumentData(){return u(this,null,function*(){this.prepareInitialForceValue()})}prepareInitialForceValue(){if(!this.item)return;let t=this.item.getLastSpellForce(),a=ba.calculateMinimalForce(this.item.getDrain());this.data.force=t.value||a}prepareBaseValues(){super.prepareBaseValues(),this.prepareLimitValue()}prepareLimitValue(){let t=Number(this.data.force);this.data.limit.mod=O.AddUniquePart(this.data.limit.mod,"SR5.Force",ba.calculateLimit(t))}calculateBaseValues(){super.calculateBaseValues(),this.calculateDrainValue()}calculateDrainValue(){var i;let t=Number(this.data.force),a=Number(((i=this.item)==null?void 0:i.getDrain())||0),r=this.data.reckless;this.data.drain=ba.calculateDrain(t,a,r)}calcDrainDamage(){if(!this.actor)return P.damageData();let t=Number(this.data.force),a=Number(this.data.drain),r=this.actor.getAttribute("magic").value;this.data.drainDamage=Pe.calcDrainDamage(a,t,r,this.hits.value)}processResults(){return u(this,null,function*(){this.calcDrainDamage(),yield Y(pe.prototype,this,"processResults").call(this)})}afterTestComplete(){return u(this,null,function*(){yield this.saveLastUsedForce(),yield Y(pe.prototype,this,"afterTestComplete").call(this)})}saveLastUsedForce(){return u(this,null,function*(){!this.item||(yield this.item.setLastSpellForce({value:this.data.force,reckless:!1}))})}};var ve=class extends at{_prepareData(t,a){return t=super._prepareData(t,a),t.against=t.against||new pe({},{},a).data,t.incomingDrain=foundry.utils.duplicate(t.against.drainDamage),t.modifiedDrain=foundry.utils.duplicate(t.incomingDrain),t}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/drain-test-dialog.html"}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/drain-test-message.html"}static _getDefaultTestAction(){return{attribute2:"willpower"}}get canBeExtended(){return!1}get testModifiers(){return["global","drain"]}static _getDocumentTestAction(t,a){return u(this,null,function*(){let r=yield Y(ve,this,"_getDocumentTestAction").call(this,t,a);if(!a.isAwakened)return console.error(`Shadowrun 5e | A ${this.name} expected an awakened actor but got this`,a),r;let i=a.data.data.magic.attribute;return foundry.utils.mergeObject(r,{attribute:i}),r})}calculateBaseValues(){super.calculateBaseValues(),this.data.modifiedDrain.base=w.calcTotal(this.data.incomingDrain,{min:0})}get success(){return this.data.modifiedDrain.value<=0}get successLabel(){return"SR5.ResistedAllDamage"}get failureLabel(){return"SR5.ResistedSomeDamage"}processResults(){return u(this,null,function*(){this.data.modifiedDrain=Pe.modifyDrainDamage(this.data.modifiedDrain,this.hits.value),yield Y(ve.prototype,this,"processResults").call(this)})}};var Ht=class{static calculateDirectDamage(e){return foundry.utils.duplicate(e)}static calculateIndirectDamage(e,t){e=foundry.utils.duplicate(e);let a=-t;return e.ap.mod=O.AddUniquePart(e.ap.mod,"SR5.Force",a),e.mod=O.AddUniquePart(e.mod,"SR5.Force",t),w.calcTotal(e.ap),w.calcTotal(e,{min:0}),e}static modifyDirectDamageAfterHit(e,t,a){return wt.modifyDamageAfterHit(t,a,e)}static modifyIndirectDamageAfterHit(e,t,a){return wt.modifyDamageAfterHit(t,a,e)}static modifyDamageAfterMiss(e){return wt.modifyDamageAfterMiss(e)}static allowDamageResist(e){return e==="indirect"}static calculateBaseDamage(e,t,a){switch(e){case"indirect":return Ht.calculateIndirectDamage(t,a);case"direct":return Ht.calculateDirectDamage(t)}return foundry.utils.duplicate(t)}static modifyDamageAfterHit(e,t,a,r,i){return e==="mana"&&t==="direct"||e==="physical"&&t==="direct"?Ht.modifyDirectDamageAfterHit(a,r,i):t==="indirect"?Ht.modifyIndirectDamageAfterHit(a,r,i):foundry.utils.duplicate(a)}static defenseTestAction(e,t){(e===""||t==="")&&console.warn("Shadowrun5e | The given spell or combat spell types are empty and won't form a complete defense test action");let a=P.minimalActionData();return e==="mana"&&t==="direct"&&(a.attribute="willpower"),e==="physical"&&t==="direct"&&(a.attribute="body"),t==="indirect"&&(a.attribute="reaction",a.attribute2="intuition"),a}};var Te=class extends ya{static _getDocumentTestAction(t,a){return u(this,null,function*(){let r=P.minimalActionData(yield Y(Te,this,"_getDocumentTestAction").call(this,t,a)),i=t.asSpellData();if(!i)return r;let s=Ht.defenseTestAction(i.data.type,i.data.combat.type);return W._mergeMinimalActionDataInOrder(r,s)})}prepareBaseValues(){super.prepareBaseValues(),this.calculateCombatSpellDamage()}get testModifiers(){var a;let t=(a=this.item)==null?void 0:a.asSpellData();return t?t.data.type==="mana"&&t.data.combat.type==="direct"?["global"]:t.data.type==="physical"&&t.data.combat.type==="direct"?["global"]:t.data.combat.type==="indirect"?["global","defense","wounds"]:["global"]:["global"]}calculateCombatSpellDamage(){var a;let t=(a=this.item)==null?void 0:a.asSpellData();!t||(this.data.incomingDamage=Ht.calculateBaseDamage(t.data.combat.type,this.data.incomingDamage,this.data.against.force))}processSuccess(){return u(this,null,function*(){this.data.modifiedDamage=Ht.modifyDamageAfterMiss(this.data.incomingDamage),yield Y(Te.prototype,this,"processSuccess").call(this)})}processFailure(){return u(this,null,function*(){var a;let t=(a=this.item)==null?void 0:a.asSpellData();!t||(this.data.modifiedDamage=Ht.modifyDamageAfterHit(t.data.type,t.data.combat.type,this.data.incomingDamage,this.against.hits.value,this.hits.value),yield Y(Te.prototype,this,"processFailure").call(this))})}afterFailure(){return u(this,null,function*(){var a;let t=(a=this.item)==null?void 0:a.asSpellData();if(!!t&&Ht.allowDamageResist(t.data.combat.type)){let r=yield W.fromOpposedTestResistTest(this,this.data.options);if(!r)return;yield r.execute()}})}};var Na={minimalFade:2,calculateMinimalLevel:function(n){return Math.max(1,this.minimalFade-n)},calculateLevel:function(n){return Math.max(1,n)},calculateLimit:function(n){return n},calculateFade:function(n,e){let t=n+e;return Math.max(this.minimalFade,t)}};var qa={calcFadeDamage:function(n,e,t){e<0&&(e=0),t<1&&(t=1);let a=P.damageData();return a.base=n,w.calcTotal(a,{min:0}),a.type.base=a.type.value=qa.calcFadeDamageType(e,t),a},calcFadeDamageType:function(n,e){return n<0&&(n=0),e<0&&(e=1),n>e?"physical":"stun"},modifyFadeDamage:function(n,e){return e<0&&(e=0),n=foundry.utils.duplicate(n),O.AddUniquePart(n.mod,"SR5.Hits",-e),w.calcTotal(n,{min:0}),n}};var fe=class extends at{_prepareData(t,a){return t=super._prepareData(t,a),t.level=t.level||0,t.fade=t.face||0,t.fadeDamage=P.damageData(),t}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/complexform-test-dialog.html"}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/complexform-test-message.html"}get canBeExtended(){return!1}static _getDefaultTestAction(){return P.minimalActionData({skill:"software",attribute:"resonance"})}get testModifiers(){return["global","wounds"]}prepareDocumentData(){return u(this,null,function*(){this.prepareInitialLevelValue()})}prepareInitialLevelValue(){if(!this.item)return;let t=this.item.getLastComplexFormLevel(),a=Na.calculateMinimalLevel(this.item.getFade());this.data.level=t.value||a}prepareBaseValues(){super.prepareBaseValues(),this.prepareLevelValue(),this.prepareLimitValue()}prepareLevelValue(){this.data.level=Na.calculateLevel(this.data.level)}prepareLimitValue(){let t=Number(this.data.level);this.data.limit.mod=O.AddUniquePart(this.data.limit.mod,"SR5.Level",Na.calculateLimit(t))}calculateBaseValues(){super.calculateBaseValues(),this.calculateFadeValue()}calculateFadeValue(){var r;let t=Number(this.data.level),a=Number(((r=this.item)==null?void 0:r.getFade())||0);this.data.fade=Na.calculateFade(t,a)}calculateFadeDamage(){if(!this.actor)return P.valueData();let t=Number(this.data.fade),a=this.actor.getAttribute("resonance").value;this.data.fadeDamage=qa.calcFadeDamage(t,this.hits.value,a)}processResults(){return u(this,null,function*(){this.calculateFadeDamage(),yield Y(fe.prototype,this,"processResults").call(this)})}afterTestComplete(){return u(this,null,function*(){yield this.saveLastUsedLevel(),yield Y(fe.prototype,this,"afterTestComplete").call(this)})}saveLastUsedLevel(){return u(this,null,function*(){!this.item||(yield this.item.setLastComplexFormLevel({value:this.data.level}))})}};var Ye=class extends at{prepareBaseValues(){super.prepareBaseValues(),this.prepareThreshold()}prepareThreshold(){if(!this.actor)return;let e=this.actor.getStunTrack(),t=(e==null?void 0:e.value)||0;new O(this.threshold.mod).addUniquePart("SR5.StunTrack",t)}processResults(){return u(this,null,function*(){yield Y(Ye.prototype,this,"processResults").call(this),this.actor&&(!this.actor.hasNaturalRecovery||this.hits.value!==0&&(yield this.actor.healStunDamage(this.hits.value)))})}};var Oe=class extends at{execute(){return u(this,null,function*(){var e;return this.actor?this.actor.canRecoverPhysicalDamage?Y(Oe.prototype,this,"execute").call(this):((e=ui.notifications)==null||e.warn(game.i18n.localize("SR5.Warnings.CantRecoverPhysicalWithStunDamage")),this):this})}prepareBaseValues(){super.prepareBaseValues(),this.prepareThreshold()}prepareThreshold(){if(!this.actor)return;let e=this.actor.getPhysicalTrack(),t=(e==null?void 0:e.value)||0;new O(this.threshold.mod).addUniquePart("SR5.PhysicalTrack",t)}processResults(){return u(this,null,function*(){yield Y(Oe.prototype,this,"processResults").call(this),this.actor&&(!this.actor.hasNaturalRecovery||this.hits.value!==0&&(yield this.actor.healPhysicalDamage(this.hits.value)))})}};var Le=class extends at{_prepareData(t,a){return t=super._prepareData(t,a),t.against=t.against||new fe({},{},a).data,t.incomingFade=foundry.utils.duplicate(t.against.fadeDamage),t.modifiedFade=foundry.utils.duplicate(t.incomingFade),t}get _dialogTemplate(){return"systems/shadowrun5e/dist/templates/apps/dialogs/fade-test-dialog.html"}get _chatMessageTemplate(){return"systems/shadowrun5e/dist/templates/rolls/fade-test-message.html"}static _getDefaultTestAction(){return{attribute:"resonance",attribute2:"willpower"}}get testModifiers(){return["global","fade"]}get canBeExtended(){return!1}get success(){return this.data.modifiedFade.value<=0}get successLabel(){return"SR5.ResistedAllDamage"}get failureLabel(){return"SR5.ResistedSomeDamage"}calculateBaseValues(){super.calculateBaseValues(),this.data.modifiedFade.base=w.calcTotal(this.data.incomingFade,{min:0})}processResults(){return u(this,null,function*(){this.data.modifiedFade=qa.modifyFadeDamage(this.data.modifiedFade,this.hits.value),yield Y(Le.prototype,this,"processResults").call(this)})}};var Ba=class extends at{};var Rt=class{static registerHooks(){console.log("Shadowrun 5e | Registering system hooks"),Hooks.once("init",Rt.init),Hooks.once("setup",Rt.setupAutocompleteInlinePropertiesSupport),Hooks.on("canvasInit",Rt.canvasInit),Hooks.on("ready",Rt.ready),Hooks.on("hotbarDrop",Rt.hotbarDrop),Hooks.on("renderSceneControls",Rt.renderSceneControls),Hooks.on("getSceneControlButtons",Rt.getSceneControlButtons),Hooks.on("getCombatTrackerEntryContext",ft.addCombatTrackerContextOptions),Hooks.on("renderItemDirectory",Rt.renderItemDirectory),Hooks.on("renderTokenHUD",re.addTokenHUDFields),Hooks.on("updateItem",Rt.updateIcConnectedToHostItem),Hooks.on("deleteItem",Rt.removeDeletedItemsFromNetworks),Hooks.on("getChatLogEntryContext",at.chatMessageContextOptions),Hooks.on("renderChatLog",Rt.chatLogListeners),Hooks.on("init",Qo)}static init(){console.log(`Loading Shadowrun 5e System
___________________
 ___________ _____ 
/  ___| ___ \\  ___|
\\ \`--.| |_/ /___ \\ 
 \`--. \\    /    \\ \\
/\\__/ / |\\ \\/\\__/ /
\\____/\\_| \\_\\____/ 
===================
`),game.shadowrun5e={SR5Actor:st,SR5Item:nt,SR5ActiveEffect:Oa,rollItemMacro:Tn,rollSkillMacro:An,ShadowrunRoller:ee,SR5Roll:te,test:W,tests:{SuccessTest:at,OpposedTest:Jt,MeleeAttackTest:Fa,RangedAttackTest:La,ThrownAttackTest:Ba,PhysicalDefenseTest:me,PhysicalResistTest:_e,SpellCastingTest:pe,CombatSpellDefenseTest:Te,DrainTest:ve,FadeTest:Le,ComplexFormTest:fe,AttributeOnlyTest:ea,NaturalRecoveryStunTest:Ye,NaturalRecoveryPhysicalTest:Oe},activeTests:{SuccessTest:at,MeleeAttackTest:Fa,RangedAttackTest:La,ThrownAttackTest:Ba,PhysicalResistTest:_e,SpellCastingTest:pe,ComplexFormTest:fe,PhysicalDefenseTest:me,NaturalRecoveryStunTest:Ye,NaturalRecoveryPhysicalTest:Oe,DrainTest:ve,FadeTest:Le},opposedTests:{OpposedTest:Jt,PhysicalDefenseTest:me,CombatSpellDefenseTest:Te},resistTests:{PhysicalResistTest:_e},followedTests:{DrainTest:ve,FadeTest:Le}},CONFIG.Actor.documentClass=st,CONFIG.Item.documentClass=nt,CONFIG.Combat.documentClass=ft,CONFIG.ActiveEffect.documentClass=Oa,CONFIG.ActiveEffect.sheetClass=gi,CONFIG.Token.objectClass=tr,CONFIG.Combat.initiative.formula="@initiative.current.base.value[Base] + @initiative.current.dice.text[Dice] - @wounds.value[Wounds]",Combatant.prototype._getInitiativeFormula=kn,CONFIG.Dice.rolls.push(te),CONFIG.Dice.SR5oll=te,CONFIG.SR5=q,Dn(),Actors.unregisterSheet("core",ActorSheet),Actors.registerSheet(V,yi,{label:"SR5.SheetActor",makeDefault:!0,types:["critter","character"]}),Actors.registerSheet(V,ha,{label:"SR5.SheetActor",makeDefault:!0,types:["ic"]}),Actors.registerSheet(V,ga,{label:"SR5.SheetActor",makeDefault:!0,types:["vehicle"]}),Actors.registerSheet(V,bi,{label:"SR5.SheetActor",makeDefault:!0,types:["spirit"]}),Actors.registerSheet(V,wi,{label:"SR5.SheetActor",makeDefault:!0,types:["sprite"]}),Items.unregisterSheet("core",ItemSheet),Items.registerSheet(V,ra,{label:"SR5.SheetItem",makeDefault:!0}),Rt.registerSocketListeners(),aa.loadTemplates()}static ready(){return u(this,null,function*(){var a;(a=game.user)!=null&&a.isGM&&(yield Ta.BeginMigration(),Xe.showApplication&&(yield new Xe().render(!0)));let e="#chat-controls .roll-type-select .fa-dice-d20";$(document).on("click",e,()=>u(this,null,function*(){return yield ee.promptSuccessTest()}));let t="#chat-controls .chat-control-icon .fa-dice-d20";$(document).on("click",t,()=>u(this,null,function*(){return yield ee.promptSuccessTest()})),Hooks.on("renderChatMessage",Rt.chatMessageListeners)})}static canvasInit(){!(canvas!=null&&canvas.ready)||(canvas.grid.diagonalRule=game.settings.get(V,"diagonalMovement"),SquareGrid.prototype.measureDistances=Sn)}static hotbarDrop(e,t,a){return u(this,null,function*(){switch(t.type){case"Item":return yield vn(t.data,a),!1;case"Skill":return yield In(t.data,a),!1;default:return}})}static renderSceneControls(e,t){t.find('[data-tool="overwatch-score-tracker"]').on("click",a=>{a.preventDefault(),new ia().render(!0)})}static getSceneControlButtons(e){var a;let t=e.find(r=>r.name==="token");(a=game.user)!=null&&a.isGM&&t.tools.push({name:"overwatch-score-tracker",title:"CONTROLS.SR5.OverwatchScoreTracker",icon:"fas fa-network-wired",button:!0}),t.tools.push(re.getControl())}static renderChatMessage(){console.debug("Shadowrun5e | Registering new chat messages related hooks")}static renderItemDirectory(e,t){let a=$('<button class="sr5 flex0">Import Chummer Data</button>');t.find("footer").before(a),a.on("click",r=>{new _a().render(!0)})}static updateIcConnectedToHostItem(e,t,a){return u(this,null,function*(){if(!(!canvas.ready||!game.actors)&&e.isHost()){let r=[...game.actors.filter(s=>s.isIC()&&s.hasHost()),...canvas.scene.tokens.filter(s=>{var o,l;return!s.data.actorLink&&((o=s.actor)==null?void 0:o.isIC())&&((l=s.actor)==null?void 0:l.hasHost())}).map(s=>s.actor)],i=e.asHostData();if(!i)return;for(let s of r)!s||(yield s._updateICHostData(i))}})}static removeDeletedItemsFromNetworks(e,t,a){return u(this,null,function*(){yield H.handleOnDeleteItem(e,t,a)})}static registerSocketListeners(){if(!game.socket||!game.user)return;console.log("Registering Shadowrun5e system socket messages...");let e={[j.addNetworkController]:[H._handleAddNetworkControllerSocketMessage],[j.DoNextRound]:[ft._handleDoNextRoundSocketMessage],[j.DoInitPass]:[ft._handleDoInitPassSocketMessage]};game.socket.on(wa,t=>u(this,null,function*(){var r,i;console.log("Shadowrun 5e | Received system socket message.",t);let a=e[t.type];if(!a||a.length===0)return console.warn("Shadowrun 5e | System socket message has no registered handler!",t);if(!(t.userId&&((r=game.user)==null?void 0:r.id)!==t.userId)){t.userId&&((i=game.user)==null?void 0:i.id)&&console.log("Shadowrun 5e | GM is handling system socket message");for(let s of a)console.log("Shadowrun 5e | Handover system socket message to handler",s),yield s(t)}}))}static setupAutocompleteInlinePropertiesSupport(){let e=game.modules.get("autocomplete-inline-properties");if(!e)return;let t=e.API;if(!t)return;console.log("Shadowrun 5e | Registering support for autocomplete-inline-properties");let a=t.CONST.DATA_MODE,r={packageName:"shadowrun5e",sheetClasses:[{name:"ActiveEffectConfig",fieldConfigs:[{selector:'.tab[data-tab="effects"] .key input[type="text"]',defaultPath:"data",showButton:!0,allowHotkey:!0,dataMode:a.OWNING_ACTOR_DATA}]}]};t.PACKAGE_CONFIG.push(r)}static chatMessageListeners(e,t,a){return u(this,null,function*(){yield at.chatMessageListeners(e,t,a),yield Jt.chatMessageListeners(e,t,a),gn(e,t,a)})}static chatLogListeners(e,t,a){return u(this,null,function*(){yield at.chatLogListeners(e,t,a),yield Jt.chatLogListeners(e,t,a)})}};Rt.registerHooks();aa.registerHelpers();})();
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
/*! http://mths.be/fromcodepoint v0.1.0 by @mathias */
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
//# sourceMappingURL=bundle.js.map
